<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ููุฑ ุงููุฒุงุฑู</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
 <style>
        /* --- Global Reset & Variables --- */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --bg-app: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-app);
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0; padding: 0;
        }

        /* --- Smooth Transitions --- */
        .screen {
            display: none; height: 100vh; width: 100vw;
            position: absolute; top: 0; left: 0; background: var(--bg-app); z-index: 10;
            opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .screen.active { display: flex; flex-direction: column; z-index: 20; opacity: 1; }

        /* --- Intro Animation --- */
        .intro-container {
            position: fixed; inset: 0; background: #0f172a; z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .intro-logo {
            font-size: 3.5rem; font-weight: 900;
            background: linear-gradient(to right, #6366f1, #a855f7, #ec4899);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: introScale 2s infinite alternate;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        .intro-sub { color: #94a3b8; margin-top: 10px; animation: fadeInUp 1s ease-out; }
        
        @keyframes introScale { from { transform: scale(1); filter: blur(0px); } to { transform: scale(1.1); filter: blur(1px); } }

        /* --- VS Screen Animation --- */
        .vs-overlay {
            position: fixed; inset: 0; background: #000; z-index: 15000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .vs-text {
            font-size: 6rem; font-weight: 900; color: #ef4444;
            text-shadow: 0 0 30px #ef4444; animation: vsPulse 0.5s infinite alternate;
            font-style: italic;
        }
        .player-vs-card {
            width: 120px; height: 120px; border-radius: 50%; border: 4px solid white;
            object-fit: cover; box-shadow: 0 0 20px rgba(255,255,255,0.5);
            animation: slideInSide 1s ease-out;
        }
        @keyframes vsPulse { from { transform: scale(1); } to { transform: scale(1.2); } }

        /* --- Custom Scroll --- */
        .scroll-container {
            height: 100%; overflow-y: auto;
            -webkit-overflow-scrolling: touch; padding-bottom: 250px;
            flex: 1;
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Animations --- */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- Components --- */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }
        .input-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 14px; width: 100%; outline: none; font-size: 1rem; transition: border-color 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn-main {
            background: var(--primary); color: white; padding: 14px;
            border-radius: 12px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); transition: transform 0.1s, background-color 0.2s;
            text-align: center; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:hover { background-color: var(--primary-dark); }

        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item { position: relative; transition: all 0.2s; } 
        
        .stat-btn {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative;
        }
        .stat-btn:active { transform: scale(0.98); background-color: #f9fafb; }

        .red-dot {
            position: absolute; top: -2px; right: 25%;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .red-dot.visible { display: block; }
        .btn-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 10px; display: none; }
        .btn-dot.visible { display: inline-block; }

        .hacker-text {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: slideUp 1s ease-out;
        }

        .auth-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 14px; margin-bottom: 24px; }
        .auth-tab {
            flex: 1; text-align: center; padding: 10px;
            font-weight: bold; color: #64748b; cursor: pointer;
            border-radius: 10px; transition: all 0.3s; font-size: 0.95rem;
        }
        .auth-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* --- RANKING STYLES --- */
        .rank-img-container { position: relative; display: flex; align-items: center; justify-content: center; width: 60px; height: 60px; margin-right: 5px; }
        .rank-img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; padding: 2px; background: white; position: relative; z-index: 5; }
        .rank-badge-top { position: absolute; top: -5px; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 8px; border: 2px solid white; z-index: 20; min-width: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .rank-rays { position: absolute; inset: 0; border-radius: 50%; z-index: 1; animation: spin-slow 10s linear infinite; mask-image: radial-gradient(transparent 58%, black 60%); -webkit-mask-image: radial-gradient(transparent 58%, black 60%); opacity: 0.8; }
        
        .rays-gold { background: repeating-conic-gradient(from 0deg, #FFD700 0deg 10deg, transparent 10deg 20deg); }
        .rays-silver { background: repeating-conic-gradient(from 0deg, #C0C0C0 0deg 10deg, transparent 10deg 20deg); }
        .rays-bronze { background: repeating-conic-gradient(from 0deg, #CD7F32 0deg 10deg, transparent 10deg 20deg); }
        .rays-blue { background: repeating-conic-gradient(from 0deg, #3b82f6 0deg 10deg, transparent 10deg 20deg); }
        .rays-red { background: repeating-conic-gradient(from 0deg, #ef4444 0deg 10deg, transparent 10deg 20deg); }
        .rays-green { background: repeating-conic-gradient(from 0deg, #10b981 0deg 10deg, transparent 10deg 20deg); }
        .rays-purple { background: repeating-conic-gradient(from 0deg, #8b5cf6 0deg 10deg, transparent 10deg 20deg); }

        .frame-rank-1 { border: 3px solid #FFD700; }
        .frame-rank-2 { border: 3px solid #C0C0C0; }
        .frame-rank-3 { border: 3px solid #CD7F32; }
        .frame-rank-common { border: 2px solid #e2e8f0; }
        .frame-rank-other-top { border: 2px solid #6366f1; }
        .name-crown { margin-right: 6px; font-size: 14px; animation: bounce 2s infinite; display: inline-block; }

        /* --- Daily Reward --- */
        .reward-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .reward-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px; }
        .day-box { background: #f1f5f9; border-radius: 8px; padding: 6px 2px; text-align: center; position: relative; border: 2px solid transparent; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50px; }
        .day-box p { font-size: 0.6rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }
        .day-box span { font-size: 0.7rem; font-weight: 900; display: block; line-height: 1.1; }
        .day-box.claimed { background: #10B981; border-color: #059669; }
        .day-box.claimed p, .day-box.claimed span { color: white; }
        .day-box.claimed::after { content: 'โ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.3); font-size: 20px; }
        .day-box.active { background: #FFFBEB; border-color: #F59E0B; transform: scale(1.05); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); z-index: 10; }
        .day-box.active span { color: #D97706; }
        .day-box.active p { color: #D97706; }
        .day-box.locked { opacity: 0.6; }

        /* --- Maintenance Modal --- */
        .new-maintenance-overlay { position: fixed; inset: 0; z-index: 11000; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; }
        .new-maintenance-card { background: linear-gradient(145deg, #ffffff, #f8fafc); border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 32px; padding: 40px 30px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); position: relative; overflow: hidden; animation: slideUp 0.5s; }
        .maint-icon-wrapper { width: 100px; height: 100px; margin: 0 auto 20px; background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5); border: 4px solid white; }
        .maint-icon-wrapper i { font-size: 40px; color: white; animation: pulse-border 2s infinite; }
        .maint-title { font-size: 1.8rem; font-weight: 900; color: #1e293b; margin-bottom: 10px; background: linear-gradient(to right, #EF4444, #B91C1C); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- General Modals --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 12000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 500px; max-height: 90vh; border-radius: 20px; padding: 20px; overflow-y: auto; animation: slideUp 0.3s ease-out; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

        /* Toggle Switch */
        .toggle-wrapper { position: relative; width: 50px; height: 26px; }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #9CA3AF; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-checkbox:checked + .toggle-slider { background-color: #10B981; }
        .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(24px); }

        /* Answer Colors */
        .answer-correct { background: #DCFCE7 !important; border-color: #22C55E !important; color: #166534 !important; position: relative; }
        .answer-correct::after { content: 'โ'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #22C55E; }
        .answer-wrong { background: #FEE2E2 !important; border-color: #EF4444 !important; color: #991B1B !important; position: relative; }
        .answer-wrong::after { content: 'โ'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #EF4444; }
        .answer-neutral { background: white !important; border-color: #E5E7EB !important; color: #374151 !important; }

        /* Banned Screen */
        .banned-overlay { position: fixed; inset: 0; z-index: 25000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }

        /* YELLOW WARNING STYLE */
        .yellow-warning {
            background-color: #FEF3C7 !important;
            border: 1px solid #F59E0B !important;
            color: #92400E !important;
            padding: 10px !important;
            border-radius: 8px !important;
            font-weight: bold !important;
            margin-top: 8px !important;
            text-align: center !important;
        }

        /* NEW: Withdrawal Button Style */
        .withdraw-btn {
            background: linear-gradient(to right, #EF4444, #DC2626) !important;
            color: white !important;
            font-weight: bold !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        }
        .withdraw-btn:hover {
            background: linear-gradient(to right, #DC2626, #B91C1C) !important;
            transform: translateY(-2px) !important;
        }

        /* NEW: Responsive Design for All Devices */
        @media (min-width: 640px) {
            .container-padding { padding-left: 2rem; padding-right: 2rem; }
            .game-overlay-header { padding-left: 3rem; padding-right: 3rem; }
            .hacker-text { font-size: 3rem; }
        }

        @media (min-width: 768px) {
            .input-box { font-size: 1.1rem; }
            .auth-overlay > div { max-width: 500px; }
            .screen { padding: 0 2rem; }
            .game-overlay-header { height: 100px; }
            .player-vs-card { width: 140px; height: 140px; }
            .vs-text { font-size: 7rem; }
        }

        @media (min-width: 1024px) {
            .screen { padding: 0 4rem; }
            .hacker-text { font-size: 3.5rem; }
            .game-overlay-header { height: 120px; }
            .player-vs-card { width: 160px; height: 160px; }
            .vs-text { font-size: 8rem; }
            .reward-grid { grid-template-columns: repeat(7, 1fr); }
        }

        @media (min-width: 1280px) {
            .screen { max-width: 1200px; margin: 0 auto; }
        }

        /* NEW: Game Overlay Improvements */
        .game-overlay-header {
            background: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            flex-shrink: 0;
        }

        .player-game-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30%;
        }

        .player-game-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid;
            object-fit: cover;
            margin-bottom: 5px;
        }

        @media (min-width: 768px) {
            .player-game-img {
                width: 60px;
                height: 60px;
            }
        }

        /* NEW: Withdrawal Confirmation Modal */
        .withdraw-confirm-modal {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px;
            padding: 30px 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        .withdraw-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            border: 4px solid white;
        }

        .withdraw-icon-wrapper i {
            font-size: 32px;
            color: white;
        }

        /* NEW: Game Exit Button */
        .game-exit-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #EF4444, #DC2626);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }

        .game-exit-btn:hover {
            background: linear-gradient(to right, #DC2626, #B91C1C);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .game-exit-btn:active {
            transform: translateX(-50%) scale(0.98);
        }

        /* NEW: Game Exit Confirmation */
        .exit-confirm-modal {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px;
            padding: 30px 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        .exit-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #4F46E5 0%, #3730A3 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.4);
            border: 4px solid white;
        }

        .exit-icon-wrapper i {
            font-size: 32px;
            color: white;
        }
    </style>
</head>
<body>

    <!-- 0. INTRO ANIMATION (NEW) -->
    <div id="intro-animation" class="intro-container">
        <h1 class="intro-logo">ููุฑ ุงููุฒุงุฑู</h1>
        <p class="intro-sub">ุจูุงุจุชู ููุชููู ูุงูุชููุฒ</p>
    </div>

    <!-- 0.5 VS SCREEN (NEW) -->
    <div id="vs-screen" class="vs-overlay hidden">
        <div class="flex justify-between items-center w-full px-8 mb-10">
            <div class="text-center">
                <img id="vs-p1-img" src="" class="player-vs-card mb-4 border-indigo-500" onerror="this.src='https://ui-avatars.com/api/?name=Player&background=random&size=128'">
                <h3 id="vs-p1-name" class="text-white font-bold text-xl">...</h3>
            </div>
            <div class="text-center">
                <img id="vs-p2-img" src="" class="player-vs-card mb-4 border-red-500" onerror="this.src='https://ui-avatars.com/api/?name=Opponent&background=random&size=128'">
                <h3 id="vs-p2-name" class="text-white font-bold text-xl">...</h3>
            </div>
        </div>
        <div class="vs-text">VS</div>
        <p class="text-gray-400 mt-8 font-bold animate-pulse">ุฌุงุฑู ุจุฏุก ุงูุชุญุฏู...</p>
    </div>

    <!-- BANNED SCREEN (NEW) -->
    <div id="banned-screen" class="banned-overlay hidden">
        <i class="fas fa-ban text-6xl text-red-500 mb-6"></i>
        <h1 class="text-3xl font-bold mb-2">ุชู ุญุธุฑ ุญุณุงุจู</h1>
        <p class="text-gray-400">ููุฏ ุชู ููุนู ูู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุจู ุงูุฅุฏุงุฑุฉ.</p>
        <p class="text-gray-400 mt-2 text-sm">ูู ุชุชููู ูู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ุญุชู ุฅูุบุงุก ุงูุญุธุฑ.</p>
    </div>

    <!-- 1. LOADING SCREEN -->
    <div id="intro-screen" class="auth-overlay flex-col" style="z-index: 10000; display: none;">
        <h1 class="hacker-text mb-4">ููุฑ ุงููุฒุงุฑู</h1>
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-medium animate-pulse">ุฌุงุฑู ุงูุชุญููู...</p>
    </div>

    <!-- 2. DAILY REWARD POPUP (MODIFIED) -->
    <div id="daily-reward-screen" class="fixed inset-0 reward-overlay z-[9000] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden animate-[slideUp_0.4s_ease-out]">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-indigo-800">ุณุฌู ุงูุญุถูุฑ ุงููููู ๐</h2>
                <p class="text-xs text-gray-500">ููุงูุขุช ูุชุตุงุนุฏุฉ (5-10-15 ููุทุฉ)</p>
            </div>
            
            <div id="reward-grid-container" class="reward-grid"></div>

            <div class="text-center mt-6">
                <button onclick="claimReward()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                      <span>ุงุณุชูุงู ุงููุฏูุฉ</span>
                      <i class="fas fa-gift animate-bounce"></i>
                </button>
            </div>
            
            <button onclick="document.getElementById('daily-reward-screen').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 3. MAINTENANCE MODAL -->
    <div id="maintenance-popup" class="new-maintenance-overlay hidden">
        <div class="new-maintenance-card">
            <div class="maint-icon-wrapper">
                <i class="fas fa-tools"></i>
            </div>
            <h2 class="maint-title">ุงููุธุงู ุชุญุช ุงูุตูุงูุฉ</h2>
            <p class="text-sm text-red-500 font-bold mb-6 tracking-wide uppercase">System Maintenance</p>
            
            <div class="bg-white/90 border border-slate-200 rounded-xl p-5 mb-6 font-bold text-slate-700">
                <p id="maintenance-msg-display">ุฑุณุงูุฉ ุงูุฅุฏุงุฑุฉ...</p>
            </div>
            
            <button onclick="closeMaintenancePopup()" class="bg-gradient-to-r from-gray-800 to-gray-900 text-white px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transition shadow-xl w-full flex items-center justify-center gap-2 relative z-10 cursor-pointer">
                <i class="fas fa-check-circle"></i> ุญุณูุง
            </button>
        </div>
    </div>

    <!-- 4. FORGOT PASSWORD MODAL -->
    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-key text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800">ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ</h3>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                <input type="email" id="forgot-email" placeholder="ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู ุงููุณุฌู" class="input-box">
                <p class="text-xs yellow-warning mt-2">ุชูุจูู: ุงูุฑุณุงูุฉ ูููู ุชูุตู "ุงูุฑุณุงุฆู ุบูุฑ ุงููุฑุบูุจ ูููุง"</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeForgotPassword()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">ุฅูุบุงุก</button>
                <button onclick="sendResetLink()" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition">ุฅุฑุณุงู</button>
            </div>
        </div>
    </div>

    <!-- 5. AUTH SCREEN -->
    <div id="auth-screen" class="auth-overlay hidden">
        <div class="w-full max-w-md p-8 h-full overflow-y-auto flex flex-col justify-center">
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-indigo-600 mb-2">ููุฑ ุงููุฒุงุฑู</h1>
                <p class="text-gray-500 text-sm">ุจูุงุจุชู ููุชููู ูู ุงูุงูุชุญุงูุงุช ุงููุฒุงุฑูุฉ</p>
            </div>

            <div class="auth-tabs">
                <div id="tab-login-btn" onclick="switchAuthTab('login')" class="auth-tab active">ุชุณุฌูู ุงูุฏุฎูู</div>
                <div id="tab-signup-btn" onclick="switchAuthTab('signup')" class="auth-tab">ุฅูุดุงุก ุญุณุงุจ</div>
            </div>

            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                        <input type="email" id="login-email" placeholder="example@gmail.com" class="input-box" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ูููุฉ ุงููุฑูุฑ</label>
                        <input type="password" id="login-pass" placeholder="โขโขโขโขโขโขโขโข" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-8">ุฏุฎูู</button>
                
                <div class="text-center mt-4">
                    <button type="button" onclick="openForgotPassword()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:underline transition-all duration-200">
                        ูู ูุณูุช ูููุฉ ุงูุณุฑุ
                    </button>
                </div>
            </form>

            <form id="signup-form" class="hidden" onsubmit="event.preventDefault(); handleSignup();">
                <div class="flex justify-center mb-6">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('signup-img').click()">
                        <img id="preview-img" src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100 shadow-md transition group-hover:border-indigo-200" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random&size=128'">
                        <div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm">
                            <i class="fas fa-camera text-xs"></i>
                        </div>
                    </div>
                    <input type="file" id="signup-img" hidden accept="image/*" onchange="handleImagePreview(this)">
                </div>
                <div class="space-y-3">
                    <div>
                        <input type="text" id="signup-name" placeholder="ุงูุงุณู ุงูุธุงูุฑ" class="input-box" required>
                    </div>
                    <div>
                        <input type="email" id="signup-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู" class="input-box" required>
                    </div>
                    <div>
                        <input type="password" id="signup-pass" placeholder="ูููุฉ ุงููุฑูุฑ" class="input-box" required>
                    </div>
                    <!-- NEW REFERRAL FIELD -->
                    <div>
                         <label class="block text-xs font-bold text-indigo-600 mb-1 mr-1">ุฑูุฒ ุงูุญุงูุฉ (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="signup-referral" placeholder="ุฃุฏุฎู ุฑูุฒ ุงูุฏุนูุฉ ูุฑุจุญ 25 ููุทุฉ" class="input-box border-dashed border-indigo-300 bg-indigo-50">
                    </div>
                </div>
                <button type="submit" class="btn-main mt-6 bg-indigo-600">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</button>
                <p class="text-xs text-center text-gray-400 mt-4">ุณูุชู ุฑุจุท ูุฐุง ุงูุญุณุงุจ ุจุฌูุงุฒู ุงูุญุงูู</p>
            </form>
        </div>
    </div>

    <!-- 6. MAIN APP CONTAINER -->
    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- HEADER -->
        <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center justify-between px-5 pt-2">
            <div>
                <h1 class="font-bold text-lg text-gray-800">ููุฑ ุงููุฒุงุฑู</h1>
                <p id="header-grade-badge" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full hidden">...</p>
            </div>
            <div class="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2">
                <span id="header-points" class="font-bold text-yellow-700">0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>
        </div>

        <!-- === TABS === -->

        <!-- TAB 1: CHALLENGES -->
        <div id="tab-challenges" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                
                <!-- Select Grade First Time -->
                <div id="grade-selector-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-school text-xl"></i></div>
                        <h3 class="font-bold text-gray-800">ุญุฏุฏ ูุฑุญูุชู ุงูุฏุฑุงุณูุฉ</h3>
                        <p class="text-xs text-gray-400">ูุชู ุชุญุฏูุฏูุง ูุฑุฉ ูุงุญุฏุฉ ููุท</p>
                    </div>
                    <select id="grade-select" class="input-box mb-4 text-center">
                        <option value="">-- ุงุฎุชุฑ ุงููุฑุญูุฉ --</option>
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                        <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                        <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>
                    <button onclick="saveUserGrade()" class="btn-main py-3 text-sm">ุญูุธ ุงููุฑุญูุฉ</button>
                </div>

                <!-- Active Challenge Card -->
                <div id="challenge-active-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">ุจุฏุก ุชุญุฏู ุฌุฏูุฏ ๐ฅ</h3>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ุงููุงุฏุฉ</label>
                    <select id="challenge-subject" class="input-box mb-4 bg-gray-50"></select>

                    <label class="block text-sm font-bold text-gray-600 mb-2">ููุน ุงูุชุญุฏู</label>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setQType('mcq')" id="btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ุงุฎุชูุงุฑุงุช</button>
                        <button onclick="setQType('tf')" id="btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ุตุญ ูุฎุทุฃ</button>
                    </div>

                    <!-- PVP Button -->
                    <button onclick="startMatchmaking('online')" class="btn-main bg-gradient-to-r from-indigo-600 to-purple-600 mb-4">
                        <i class="fas fa-user-graduate ml-2"></i> ุงููุนุจ ุถุฏ ุทุงูุจ (ุญูููู)
                    </button>

                    <!-- AI Button Section -->
                    <div class="flex gap-2 items-center">
                        <button onclick="startMatchmaking('ai')" class="btn-main bg-gradient-to-r from-emerald-500 to-green-600 flex-1">
                            <i class="fas fa-robot ml-2"></i> ุถุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                        </button>
                        <div class="w-1/3">
                            <select id="ai-difficulty" class="input-box text-xs font-bold text-center h-[52px] bg-green-50 border-green-200 text-green-800 focus:border-green-500">
                                <option value="easy">ุจุณูุท (25%)</option>
                                <option value="medium" selected>ูุชูุณุท (50%)</option>
                                <option value="hard">ุฐูู (70%)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ADMIN CONTROL PANEL -->
                <div id="admin-challenge-controls" class="hidden mt-8 mb-6 bg-gray-900 rounded-2xl p-5 border-2 border-indigo-600 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-indigo-600 opacity-20 rounded-full -mr-10 -mt-10"></div>
                    
                    <div class="flex items-center justify-between mb-4 relative z-10">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-user-shield text-indigo-400 text-xl"></i>
                            <h3 class="font-bold text-white text-sm">ููุญุฉ ุงูุชุญูู ุจุงููุธุงู</h3>
                        </div>
                        
                        <!-- Toggle Switch -->
                        <label class="toggle-wrapper">
                            <input type="checkbox" id="system-toggle" class="toggle-checkbox" onchange="toggleSystemUI()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <p id="system-status-text" class="text-xs font-bold text-green-400 mb-2">ุงููุธุงู ูุนูู ุญุงููุงู โ</p>
                    
                    <div class="mt-4">
                        <label class="block text-xs font-bold text-gray-400 mb-2">ุฑุณุงูุฉ ุงูุชูุจูู ููุทูุงุจ (ุณุจุจ ุงูุฅููุงู):</label>
                        <textarea id="maintenance-msg-input" class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl p-3 text-sm focus:border-indigo-500 outline-none h-20 mb-3" placeholder="ูุซูุงู: ุชููู ููุตูุงูุฉุ ูุนูุฏ ุจุนุฏ ุณุงุนุฉ..."></textarea>
                        
                        <button onclick="saveSystemSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl text-sm transition shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                        </button>
                    </div>
                </div>

                <!-- Searching UI -->
                <div id="searching-ui" class="hidden flex-col items-center justify-center py-10 min-h-[300px]">
                    <div class="w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center relative mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-indigo-500 opacity-20 animate-ping"></div>
                        <i class="fas fa-search text-3xl text-indigo-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="search-msg">ุฌุงุฑู ุงูุจุญุซ...</h3>
                    <button onclick="cancelSearch()" class="mt-8 text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full">ุฅูุบุงุก</button>
                </div>
            </div>
        </div>

        <!-- GAME OVERLAY (UPDATED WITH IMAGES) -->
        <div id="game-overlay" class="fixed inset-0 bg-gray-50 z-[100] hidden flex-col">
            <div class="game-overlay-header">
                <div class="player-game-info">
                    <img id="p1-img-game" src="" class="player-game-img border-indigo-500" onerror="this.src='https://ui-avatars.com/api/?name=Player&background=random&size=128'">
                    <p id="p1-name" class="text-xs text-gray-500 font-bold truncate w-full text-center">...</p>
                    <p id="game-my-score" class="text-2xl font-bold text-indigo-600 leading-none">0</p>
                </div>
                <div class="flex flex-col items-center">
                    <div id="game-timer" class="w-12 h-12 bg-gray-800 text-white rounded-full flex items-center justify-center font-bold text-lg">15</div>
                    <p class="text-xs text-gray-400 mt-1">ุซุงููุฉ</p>
                </div>
                <div class="player-game-info">
                    <img id="p2-img-game" src="" class="player-game-img border-red-500" onerror="this.src='https://ui-avatars.com/api/?name=Opponent&background=random&size=128'">
                    <p id="p2-name" class="text-xs text-gray-500 font-bold truncate w-full text-center">...</p>
                    <p id="game-op-score" class="text-2xl font-bold text-red-500 leading-none">0</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-32">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 text-center border-t-4 border-indigo-500 relative mt-4">
                    <span id="q-progress" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-3 py-1 rounded-full">1 / 10</span>
                    <p id="q-text" class="text-lg font-bold text-gray-800 leading-relaxed mt-2">...</p>
                </div>
                <div id="answers-container" class="space-y-3"></div>
                <p id="waiting-msg" class="text-center text-gray-400 text-sm hidden animate-pulse mt-4">ุจุงูุชุธุงุฑ ุฅุฌุงุจุฉ ุงูุฎุตู...</p>
                <p id="ai-thinking-msg" class="text-center text-green-600 text-sm hidden animate-pulse mt-4 font-bold">ุงูุฑูุจูุช ูููุฑ...</p>
            </div>

            <!-- NEW: Exit/Withdraw Button -->
            <button id="game-exit-btn" class="game-exit-btn hidden" onclick="showExitConfirmation()">
                <i class="fas fa-sign-out-alt ml-2"></i> ุงูุณุญุงุจ
            </button>
        </div>

        <!-- EXIT CONFIRMATION MODAL -->
        <div id="exit-confirmation-modal" class="modal-overlay hidden">
            <div class="exit-confirm-modal">
                <div class="exit-icon-wrapper">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">ุชุฃููุฏ ุงูุงูุณุญุงุจ</h2>
                <p class="text-sm text-red-500 font-bold mb-4 tracking-wide">ุณูุชู ุฎุตู 5 ููุงุท ูู ุฑุตูุฏู!</p>
                
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6 font-bold text-red-700 text-sm">
                    <p>โ๏ธ ุนูุฏ ุงูุงูุณุญุงุจ:</p>
                    <ul class="list-disc list-inside mt-2 text-right">
                        <li>ุณุชุฎุณุฑ 5 ููุงุท ูู ุฑุตูุฏู</li>
                        <li>ุณูุชู ุฅุถุงูุฉ 5 ููุงุท ูุฎุตูู</li>
                        <li>ุณุชุฎุณุฑ ุงูุชุญุฏู ุชููุงุฆูุงู</li>
                    </ul>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="cancelExit()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">ุฅูุบุงุก</button>
                    <button onclick="confirmExit()" class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition">ุชุฃููุฏ ุงูุงูุณุญุงุจ</button>
                </div>
            </div>
        </div>

        <!-- POST MATCH RESULT SCREEN -->
        <div id="result-screen" class="fixed inset-0 bg-white z-[200] hidden flex-col items-center justify-center p-6 animate-[fadeIn_0.3s_ease-out]">
            <button onclick="closeResultScreen()" class="absolute top-6 right-6 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>

            <div id="result-icon-container" class="mb-6 text-6xl">๐</div>
            <h2 id="result-title" class="text-3xl font-extrabold text-gray-800 mb-2">ูุจุฑูู!</h2>
            <p id="result-msg" class="text-gray-500 mb-8 text-center">ููุฏ ููุช ุจุฃุฏุงุก ุฑุงุฆุน</p>
            
            <div class="flex items-center gap-8 mb-8 bg-gray-50 p-6 rounded-2xl w-full justify-center">
                <div class="text-center">
                    <p class="text-xs text-gray-400">ููุงุทู</p>
                    <p id="final-my-score" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="text-2xl text-gray-300">VS</div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ุงูุฎุตู</p>
                    <p id="final-op-score" class="text-3xl font-bold text-red-500">0</p>
                </div>
            </div>

            <div class="bg-yellow-50 px-6 py-3 rounded-full border border-yellow-200 mb-8 flex items-center gap-2">
                <span>ุญุตูุช ุนูู:</span>
                <span id="result-points-gained" class="font-bold text-yellow-700">+0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>

            <button onclick="closeResultScreen()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-home"></i>
                <span>ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</span>
            </button>
        </div>

        <!-- TAB 2: LEADERBOARD (UPDATED WITH WEEKLY TIMER) -->
        <div id="tab-leaderboard" class="screen pt-20">
            <div class="scroll-container px-4">
                
                <!-- NEW WEEKLY RESET TIMER -->
                <div class="bg-gray-900 rounded-2xl p-4 mb-4 text-white text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-indigo-900 to-purple-900 opacity-50"></div>
                    <div class="relative z-10">
                        <p class="text-xs text-gray-400 font-bold mb-1">ุงูุฌูุงุฆุฒ ุงูุฃุณุจูุนูุฉ ุชูุฒุน ุจุนุฏ:</p>
                        <!-- ุชู ุชุนุฏูู ุงูุชูุณูู: ุฅุฒุงูุฉ ูููุฉ "ููู" -->
                        <div id="weekly-timer" class="text-2xl font-mono font-bold text-yellow-400">00:00:00:00</div>
                        <p class="text-[10px] text-gray-500 mt-1">ููู ุงูุฎููุณ 12:00 ูููุงู ุจุชูููุช ุงูุนุฑุงู (ุงูุณูุฑูุฑ)</p>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-2xl mb-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm opacity-90">ุชุฑุชูุจู ุงูุญุงูู</p>
                        <h2 id="my-rank-text" class="text-2xl font-bold">#...</h2>
                    </div>
                    <i class="fas fa-trophy text-4xl opacity-50"></i>
                </div>
                <div id="leaderboard-list" class="space-y-4 pb-10 flex flex-col"></div>
            </div>
        </div>

        <!-- TAB 3: UPLOAD -->
        <div id="tab-upload" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- NOTES SECTION -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <h3 class="font-bold text-blue-800 text-sm mb-2"><i class="fas fa-info-circle ml-1"></i> ุชุนูููุงุช ุฑูุน ุงูุฃุณุฆูุฉ:</h3>
                    <ul class="text-xs text-blue-700 space-y-1 list-decimal list-inside font-medium">
                        <li>ูุฌุจ ุงู ุชููู ุงูุฃุณุฆูุฉ ุงููุถุงูุฉ ูู ุถูู ุงููููุฌ.</li>
                        <li>ูุฌุจ ุงูุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุงูุฌูุงุจ ุงูุตุญูุญ ุจุฏูุฉ.</li>
                    </ul>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 flex-shrink-0">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-green-800">ุงุฑุจุญ 10 ููุงุท</p>
                        <p class="text-xs text-green-600">ุนู ูู ุณุคุงู ูุชู ูุจููู</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <!-- Step 1 -->
                    <div id="up-step-1">
                        <label class="block text-sm font-bold text-gray-500 mb-1">ุงููุงุฏุฉ</label>
                        <select id="up-subject" class="input-box mb-4 bg-gray-50"></select>
                        
                        <label class="block text-sm font-bold text-gray-500 mb-1">ุงูููุน</label>
                        <select id="up-type" class="input-box mb-6 bg-gray-50">
                            <option value="mcq">ุงุฎุชูุงุฑุงุช</option>
                            <option value="tf">ุตุญ ูุฎุทุฃ</option>
                        </select>
                        <button onclick="nextUploadStep()" class="btn-main">ุงูุชุงูู</button>
                    </div>

                    <!-- Step 2 -->
                    <div id="up-step-2" class="hidden">
                        <textarea id="up-q-text" class="input-box h-24 mb-4" placeholder="ุงูุชุจ ูุต ุงูุณุคุงู..."></textarea>
                        
                        <div id="up-mcq-container">
                            <p class="text-xs text-gray-400 mb-2">ุฃุฏุฎู ุงูุฎูุงุฑุงุช ูุญุฏุฏ ุงูุตุญูุญ</p>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="0" checked>
                                    <input type="text" id="ans-0" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุฃูู">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="1">
                                    <input type="text" id="ans-1" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูู">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="2">
                                    <input type="text" id="ans-2" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูุซ">
                                </div>
                            </div>
                        </div>

                        <div id="up-tf-container" class="hidden mb-4">
                            <label class="block text-xs text-gray-400 mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                            <select id="up-tf-val" class="input-box">
                                <option value="true">ุตุญ</option>
                                <option value="false">ุฎุทุฃ</option>
                            </select>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="document.getElementById('up-step-2').classList.add('hidden');document.getElementById('up-step-1').classList.remove('hidden')" class="bg-gray-100 text-gray-600 px-4 rounded-xl font-bold">ุฑุฌูุน</button>
                            <button onclick="submitUploadQuestion()" class="btn-main bg-green-600">ุฅุฑุณุงู</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: PROFILE -->
        <div id="tab-profile" class="screen pt-20">
            <div class="scroll-container px-5">
                <div class="bg-white p-6 rounded-3xl shadow-sm text-center mb-6 mt-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                    <div class="relative z-10">
                        <img id="profile-img" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-md mb-3 object-cover" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random&size=128'">
                        <h2 id="profile-name-text" class="text-xl font-bold text-gray-800">...</h2>
                        <p class="text-xs text-gray-400 mt-1" id="profile-id-text">ID: ...</p>
                        <button onclick="document.getElementById('edit-pic-input').click()" class="text-indigo-600 text-xs font-bold mt-2 hover:underline">ุชุบููุฑ ุงูุตูุฑุฉ</button>
                        <input type="file" id="edit-pic-input" hidden accept="image/*" onchange="updateProfilePic(this)">
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <!-- NEW MONEY BUTTON (11) -->
                    <button onclick="openPage('screen-money')" class="stat-btn border-green-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fas fa-wallet"></i></div>
                            <span class="font-bold text-gray-700">ุฃููุงูู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <!-- NEW REFERRAL BUTTON (6) -->
                    <button onclick="openPage('screen-referral')" class="stat-btn border-indigo-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-share-alt"></i></div>
                            <span class="font-bold text-gray-700">ุฑูุฒ ุงูุญุงูุฉ $</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <!-- ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู -->
                    <button onclick="openPage('screen-stats')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-chart-pie"></i></div>
                            <span class="font-bold text-gray-700">ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <!-- ููุงุทู ูุชุงุฑูุฎู -->
                    <button onclick="openPage('screen-my-points')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i class="fas fa-star"></i></div>
                            <span class="font-bold text-gray-700">ููุงุทู ูุชุงุฑูุฎู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <!-- ุฃุณุฆูุชู ุงููุฑููุนุฉ -->
                    <button onclick="openPage('screen-my-questions')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="fas fa-question"></i></div>
                            <span class="font-bold text-gray-700">ุฃุณุฆูุชู ุงููุฑููุนุฉ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>
                    
                    <div id="admin-buttons" class="hidden space-y-3 border-t pt-3 mt-3">
                        <p class="text-xs text-red-400 font-bold px-2">ููุญุฉ ุงูุชุญูู</p>
                        
                        <!-- NEW USER MANAGEMENT BUTTON (8) -->
                        <button onclick="openPage('screen-admin-users')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-users-cog"></i></div>
                                <span class="font-bold text-red-700">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</span>
                            </div>
                        </button>

                        <!-- ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ -->
                        <button onclick="openPage('screen-admin-review')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600 relative">
                                    <i class="fas fa-gavel"></i>
                                    <div id="admin-btn-badge" class="red-dot"></div>
                                </div>
                                <span class="font-bold text-red-700">ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ</span>
                            </div>
                        </button>
                        
                        <!-- ุชุนุฏูู ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ -->
                        <button onclick="openPage('screen-admin-all')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-edit"></i></div>
                                <span class="font-bold text-red-700">ุชุนุฏูู ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</span>
                            </div>
                        </button>
                        
                        <!-- ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ -->
                        <button onclick="openPage('screen-admin-stats')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-list-ol"></i></div>
                                <span class="font-bold text-red-700">ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</span>
                            </div>
                        </button>
                        
                        <!-- ุงูููุงุฏ ุงูุชู ุชุณุชูุจู ุฃุณุฆูุฉ -->
                        <button onclick="openPage('screen-admin-subjects')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-book"></i></div>
                                <span class="font-bold text-red-700">ุงูููุงุฏ ุงูุชู ุชุณุชูุจู ุฃุณุฆูุฉ</span>
                            </div>
                        </button>
                    </div>

                    <button onclick="logout()" class="stat-btn mt-6 border-red-100 text-red-500">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sign-out-alt px-3"></i>
                            <span class="font-bold">ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SUB SCREENS === -->
        
        <!-- Screen: Referral (NEW) -->
        <div id="screen-referral" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฑูุฒ ุงูุญุงูุฉ $</h1>
            </div>
            <div class="scroll-container px-5 py-6 text-center">
                <div class="bg-indigo-600 rounded-3xl p-8 text-white mb-6 shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-indigo-200 text-sm mb-2">ุฑูุฒู ุงูุฎุงุต</p>
                        <h1 id="my-referral-code" class="text-4xl font-black mb-4 tracking-widest">...</h1>
                        <button onclick="copyReferral()" class="bg-white text-indigo-600 px-6 py-2 rounded-full font-bold text-sm hover:scale-105 transition shadow-lg">ูุณุฎ ุงูุฑูุฒ</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs text-gray-400 mb-1">ุงููุฏุนููู</p>
                        <p id="ref-count-display" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <p class="text-xs text-gray-400 mb-1">ุงูุฃุฑุจุงุญ</p>
                        <p class="text-2xl font-bold text-green-600">+<span id="ref-earnings">0</span></p>
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-xl text-right text-xs text-yellow-800 leading-6 border border-yellow-200">
                    <p class="font-bold mb-2">๐ก ููู ูุนููุ</p>
                    <ul class="list-disc list-inside">
                        <li>ุดุงุฑู ุงูุฑูุฒ ูุน ุฃุตุฏูุงุฆู.</li>
                        <li>ุนูุฏ ุชุณุฌูููู ุจุงูุฑูุฒ: ูุญุตููู ุนูู <b>25 ููุทุฉ</b>.</li>
                        <li>ุฃูุช ุชุญุตู ุนูู <b>50 ููุทุฉ</b> ููุฑุงู.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Screen: Money (NEW) -->
        <div id="screen-money" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฃููุงูู</h1>
            </div>
            <div class="scroll-container px-5 py-6 text-center">
                <div class="bg-emerald-600 rounded-3xl p-8 text-white mb-6 shadow-xl">
                    <p class="text-emerald-200 text-sm mb-2">ุงูุฑุตูุฏ ุงูููู</p>
                    <h1 class="text-5xl font-black mb-1">$<span id="wallet-balance">0</span></h1>
                    <p class="text-xs opacity-70 mt-4">ูููู ุณุญุจ ุฃูู ุดู 100$</p>
                    <p class="text-xs opacity-70">ูู 50 ุฏููุงุฑ ุชุณุงูู 5$ ุจุงูุฃููุงู ุงูุนุฑุงููุฉ</p>
                </div>

                <button id="withdraw-btn" onclick="showWithdrawalConfirmation()" class="w-full withdraw-btn text-white py-4 rounded-xl font-bold shadow-lg hover:scale-[1.02] transition mb-6">
                    <i class="fas fa-money-bill-wave ml-2"></i>
                    ุงููุทุงูุจุฉ ุจุงูุฃููุงู
                </button>
                
                <p class="text-xs text-gray-400">ูุชู ุชุฌููุน ุงูุฑุตูุฏ ูู ุงูุฌูุงุฆุฒ ุงูุฃุณุจูุนูุฉ ูู ูุงุฆูุฉ ุงูุชุตููู.</p>
            </div>
        </div>

        <!-- WITHDRAWAL CONFIRMATION MODAL -->
        <div id="withdrawal-confirmation-modal" class="modal-overlay hidden">
            <div class="withdraw-confirm-modal">
                <div class="withdraw-icon-wrapper">
                    <i class="fas fa-money-check-alt"></i>
                </div>
                <h2 class="text-2xl font-black text-gray-800 mb-2">ุชุฃููุฏ ุงูุณุญุจ</h2>
                <p class="text-sm text-green-500 font-bold mb-4 tracking-wide">ุณูุชู ุชุญูููู ูุชุทุจูู ุงูุชููุฌุฑุงู</p>
                
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 font-bold text-green-700 text-sm">
                    <p>๐ ุดุฑูุท ุงูุณุญุจ:</p>
                    <ul class="list-disc list-inside mt-2 text-right">
                        <li>ูุฌุจ ุฃู ูููู ุฑุตูุฏู 100$ ุนูู ุงูุฃูู</li>
                        <li>ูุชู ุงูุชุญููู ุนุจุฑ ุงูุชููุฌุฑุงู</li>
                        <li>ุณูุชู ุฎุตู ุงููุจูุบ ูู ุฑุตูุฏู ููุฑ ุงูุชุฃููุฏ</li>
                    </ul>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="cancelWithdrawal()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">ุฅูุบุงุก</button>
                    <button onclick="confirmWithdrawal()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition">ุชุฃููุฏ ููุชุญ ุงูุชููุฌุฑุงู</button>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Users (NEW) -->
        <div id="screen-admin-users" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="admin-search-id" placeholder="ุฃุฏุฎู ูุนุฑู ุงููุณุชุฎุฏู (ID)" class="input-box text-center uppercase">
                    <button onclick="adminSearchUser()" class="btn-main w-auto px-6"><i class="fas fa-search"></i></button>
                </div>
                
                <div id="admin-user-result" class="hidden bg-white p-5 rounded-2xl shadow-lg border border-gray-200">
                    <img id="admin-u-img" src="" class="w-16 h-16 rounded-full mx-auto mb-3" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random&size=128'">
                    <h3 id="admin-u-name" class="text-center font-bold text-lg mb-1">...</h3>
                    <p id="admin-u-id" class="text-center text-xs text-gray-400 mb-4">ID: ...</p>
                    
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg mb-4">
                        <span class="text-sm font-bold text-gray-600">ุงูุฑุตูุฏ: $<span id="admin-u-balance">0</span></span>
                        <span id="admin-u-status" class="text-xs font-bold">...</span>
                    </div>

                    <div class="space-y-2">
                        <button id="btn-ban-toggle" onclick="toggleBan()" class="w-full py-3 rounded-xl font-bold text-white transition"></button>
                        <button id="btn-reset-money" onclick="resetUserMoney()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-xl font-bold">ุชุตููุฑ ุงูุฃููุงู</button>
                        <button onclick="resetUserPointsAdmin()" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold">ุชุตููุฑ ุงูููุงุท</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: App Stats -->
        <div id="screen-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="stats-content" class="space-y-4">
                    <p class="text-center text-gray-400">ุฌุงุฑู ุงูุชุญููู...</p>
                </div>
            </div>
        </div>

        <!-- Screen: My Points -->
        <div id="screen-my-points" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ููุงุทู ูุชุงุฑูุฎู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="points-content" class="text-center">
                    <div class="bg-white p-8 rounded-3xl shadow-sm mb-6">
                        <i class="fas fa-gem text-5xl text-yellow-500 mb-4 animate-bounce"></i>
                        <h1 class="text-6xl font-black text-gray-800 mb-2" id="detail-points">0</h1>
                        <p class="text-gray-400">ูุฌููุน ุงูููุงุท</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm">
                            <p class="text-xs text-gray-400 mb-1">ุชุงุฑูุฎ ุงูุงูุถูุงู</p>
                            <p class="font-bold text-gray-700 text-sm" id="detail-join-date">...</p>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm">
                            <p class="text-xs text-gray-400 mb-1">ุนุฏุฏ ุงูุฃูุงู</p>
                            <p class="font-bold text-indigo-600 text-xl" id="detail-days">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: My Questions -->
        <div id="screen-my-questions" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฃุณุฆูุชู ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="my-questions-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Screen: Admin Review -->
        <div id="screen-admin-review" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="admin-review-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Screen: Admin ALL Questions -->
        <div id="screen-admin-all" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุชุนุฏูู ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- Filters -->
                <div class="bg-white p-3 rounded-xl mb-4 shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 mb-2">ุชุตููุฉ ุญุณุจ:</p>
                    <div class="flex gap-2">
                        <select id="admin-filter-grade" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ูู ุงููุฑุงุญู</option>
                            <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                            <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                            <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                        </select>
                        <select id="admin-filter-subject" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ูู ุงูููุงุฏ</option>
                        </select>
                    </div>
                </div>
                
                <div id="admin-all-list" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <!-- Screen: Admin Question Stats -->
        <div id="screen-admin-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ุงุฎุชุฑ ุงููุฑุญูุฉ</label>
                    <select id="stat-grade" class="input-box mb-3 text-sm">
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                        <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                        <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>

                    <label class="block text-xs font-bold text-gray-500 mb-1">ููุน ุงูุณุคุงู</label>
                    <select id="stat-type" class="input-box mb-4 text-sm">
                        <option value="mcq">ุงุฎุชูุงุฑุงุช</option>
                        <option value="tf">ุตุญ ูุฎุทุฃ</option>
                    </select>

                    <button onclick="calculateQuestionStats()" class="btn-main bg-indigo-600">
                        <i class="fas fa-calculator ml-2"></i> ุญุณุงุจ ุงูุนุฏุฏ
                    </button>
                </div>

                <div id="stats-result-container" class="space-y-2 pb-40">
                    <p class="text-center text-gray-400 text-sm mt-10">ุงุฎุชุฑ ุงูุจูุงูุงุช ูุงุถุบุท ุญุณุงุจ</p>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Subject Management -->
        <div id="screen-admin-subjects" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุงูููุงุฏ ุงูุชู ุชุณุชูุจู ุฃุณุฆูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <div class="flex gap-3 mb-4">
                        <select id="subject-grade" class="input-box text-sm p-2 flex-1" onchange="loadSubjectManagement()">
                            <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                            <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                            <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                        </select>
                        <select id="subject-type" class="input-box text-sm p-2 flex-1" onchange="loadSubjectManagement()">
                            <option value="mcq">ุงุฎุชูุงุฑุงุช</option>
                            <option value="tf">ุตุญ ูุฎุทุฃ</option>
                        </select>
                    </div>
                    <p class="text-xs text-gray-500 text-center mb-4">ุชูููู/ุชุนุทูู ุงุณุชูุจุงู ุฃุณุฆูุฉ ููููุงุฏ ุญุณุจ ุงูููุน</p>
                </div>

                <div id="subject-management-list" class="space-y-3 pb-20">
                    <p class="text-center text-gray-400">ุฌุงุฑู ุชุญููู ุงูููุงุฏ...</p>
                </div>
            </div>
        </div>
        
        <!-- EDIT QUESTION MODAL -->
        <div id="edit-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">ุชุนุฏูู ุงูุณุคุงู ุงูุดุงูู</h3>
                
                <input type="hidden" id="edit-q-id">
                
                <label class="block text-xs font-bold text-gray-500 mb-1">ูุต ุงูุณุคุงู</label>
                <textarea id="edit-q-text" class="input-box h-20 mb-3 text-sm"></textarea>
                
                <div class="flex gap-2 mb-3">
                     <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุตู</label>
                        <select id="edit-q-grade" class="input-box text-sm p-2">
                            <option value="6sci">6 ุนููู</option>
                            <option value="6lit">6 ุฃุฏุจู</option>
                            <option value="3med">3 ูุชูุณุท</option>
                        </select>
                     </div>
                     <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ุงููุงุฏุฉ</label>
                        <select id="edit-q-subject" class="input-box text-sm p-2">
                        </select>
                     </div>
                </div>

                <!-- MCQ Fields -->
                <div id="edit-mcq-fields" class="hidden">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 1</label>
                     <input type="text" id="edit-ans-0" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 2</label>
                     <input type="text" id="edit-ans-1" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 3</label>
                     <input type="text" id="edit-ans-2" class="input-box mb-3 p-2 text-sm">
                     
                     <label class="block text-xs font-bold text-green-600 mb-1">ุฑูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (0, 1, 2)</label>
                     <select id="edit-correct-mcq" class="input-box p-2 text-sm">
                         <option value="0">ุงูุฎูุงุฑ 1</option>
                         <option value="1">ุงูุฎูุงุฑ 2</option>
                         <option value="2">ุงูุฎูุงุฑ 3</option>
                     </select>
                </div>

                <!-- TF Fields -->
                <div id="edit-tf-fields" class="hidden">
                    <label class="block text-xs font-bold text-green-600 mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                    <select id="edit-correct-tf" class="input-box p-2 text-sm">
                        <option value="true">ุตุญ</option>
                        <option value="false">ุฎุทุฃ</option>
                    </select>
                </div>

                <button onclick="saveFullEditQ()" class="btn-main mt-6 bg-indigo-600 text-sm">ุญูุธ ุงูุชุนุฏููุงุช</button>
            </div>
        </div>
        
        <!-- BOTTOM NAV -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="switchTab('challenges')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-gamepad text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุชุญุฏูุงุช</span>
            </div>
            <div onclick="switchTab('leaderboard')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-trophy text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุชุตููู</span>
            </div>
            <div onclick="switchTab('upload')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg -mt-6 border-4 border-gray-50"><i class="fas fa-plus"></i></div>
                <span class="text-[10px] font-bold mt-1">ุฑูุน</span>
            </div>
            <div onclick="switchTab('profile')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">ุญุณุงุจู</span>
                <div id="profile-tab-badge" class="red-dot"></div>
            </div>
        </div>

    </div>

    <!-- JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, increment, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfLOjiPiSQW9opdiIgQif3pAp8zsezy58",
            authDomain: "ministerial-hacker.firebaseapp.com",
            databaseURL: "https://ministerial-hacker-default-rtdb.firebaseio.com",
            projectId: "ministerial-hacker",
            storageBucket: "ministerial-hacker.firebasestorage.app",
            messagingSenderId: "557133038084",
            appId: "1:557133038084:web:c8cb7df6ef0abef2beab51",
            measurementId: "G-WYMSX2LRTW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";

        setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence Error", e));

        let currentUser = null;
        let userData = null;
        let selectedQType = null;
        let currentMatchId = null;
        let gameTimer = null;
        let hasAnsweredCurrentQ = false;
        let allAdminQuestions = [];
        let adminListenerUnsubscribe = null;
        let matchListenerUnsubscribe = null; 
        
        // --- GAME LOGIC VARS ---
        let isExitingGame = false;
        let currentGameMode = 'online'; 
        let aiDifficulty = 'medium'; 
        let localMatchData = null; 
        let aiTimeoutId = null; 
        let currentQuestionCorrectAnswer = null; 
        let userAnsweredCorrectly = false; 

        // --- SYSTEM VARS ---
        let systemConfig = { enabled: true, msg: "ุงููุธุงู ูู ูุถุน ุงูุตูุงูุฉ ุญุงููุงู" };
        let disabledSubjects = {};
        let searchedUser = null; // Admin searching

        // --- WEEKLY REWARD VARS ---
        let weeklyRewardDistributed = false;
        let lastRewardCheck = null;

        const subjects = {
            '6sci': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุงุญูุงุก', 'ุฑูุงุถูุงุช', 'ููููุงุก', 'ููุฒูุงุก'],
            '6lit': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุชุงุฑูุฎ', 'ุฑูุงุถูุงุช', 'ุฌุบุฑุงููุฉ', 'ุงูุชุตุงุฏ'],
            '3med': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุฑูุงุถูุงุช', 'ููููุงุก', 'ููุฒูุงุก', 'ุงุฌุชูุงุนูุงุช']
        };

        // Initialize
        onAuthStateChanged(auth, async (user) => {
            const intro = document.getElementById('intro-screen');
            const introAnim = document.getElementById('intro-animation');
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');

            if (user) {
                currentUser = user;
                listenToSystemStatus();
                loadDisabledSubjects();
                checkWeeklyRewards(); // Check for weekly rewards

                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        
                        // BAN CHECK - FIXED: Proper ban check that prevents re-entry
                        if(userData.isBanned) {
                            document.getElementById('banned-screen').classList.remove('hidden');
                            await signOut(auth);
                            return;
                        }

                        // Update last active with server timestamp
                        await updateDoc(doc(db, "users", user.uid), { 
                            lastActive: serverTimestamp(),
                            lastLogin: serverTimestamp()
                        });
                        
                        setupProfileUI();
                        setupHeaderUI();
                        setupAdminUI();
                        checkDailyReward(); 
                        if(userData.email === ADMIN_EMAIL) checkAdminNotifications(); 

                        if (userData.grade) {
                            document.getElementById('grade-selector-card').classList.add('hidden');
                            document.getElementById('challenge-active-card').classList.remove('hidden');
                            document.getElementById('header-grade-badge').innerText = getGradeName(userData.grade);
                            document.getElementById('header-grade-badge').classList.remove('hidden');
                            populateSubjects(userData.grade, 'challenge-subject');
                        } else {
                            document.getElementById('grade-selector-card').classList.remove('hidden');
                            document.getElementById('challenge-active-card').classList.add('hidden');
                            document.getElementById('header-grade-badge').classList.add('hidden');
                        }
                        
                        setTimeout(() => { 
                            introAnim.style.display = 'none'; 
                            introAnim.classList.add('hidden');
                        }, 2000); 
                        intro.style.display = 'none';
                        intro.classList.add('hidden');
                        authScreen.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        if(!document.querySelector('.screen.active')) switchTab('challenges');
                        
                    } else {
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) { 
                    console.error("Auth Data Error:", e); 
                    alert("ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู");
                }
            } else {
                setTimeout(() => { 
                    introAnim.style.display = 'none'; 
                    introAnim.classList.add('hidden');
                }, 2000);
                intro.style.display = 'none';
                intro.classList.add('hidden');
                mainApp.classList.add('hidden');
                authScreen.classList.remove('hidden');
                window.switchAuthTab('login');
            }
        });

        // --- WEEKLY TIMER FUNCTION (ุชู ุงูุชุนุฏูู ุญุณุจ ุทูุจู) ---
        function updateWeeklyTimer() {
            // Target: Thursday 00:00 AM (Iraq Time - Server Time)
            const now = new Date();
            const iraqOffset = 3 * 60; // UTC+3 in minutes
            const localOffset = now.getTimezoneOffset(); // in minutes
            const iraqTime = new Date(now.getTime() + (iraqOffset + localOffset) * 60000);

            // Find next Thursday
            const day = iraqTime.getDay(); // 0=Sun, 4=Thu
            let daysUntilThu = 4 - day;
            if (daysUntilThu < 0) daysUntilThu += 7;
            
            const target = new Date(iraqTime);
            target.setDate(iraqTime.getDate() + daysUntilThu);
            target.setHours(24, 0, 0, 0); // Midnight Thursday/Friday

            const diff = target - iraqTime;
            
            // Check if it's time to distribute rewards (Thursday 00:00)
            if (diff <= 1000 && diff > -5000 && !weeklyRewardDistributed) { 
                distributeWeeklyRewards();
            }

            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            
            // ุชู ุงูุชุนุฏูู ููุง ููููู ุจุงูุชูุณูู: ุฃูุงู:ุณุงุนุงุช:ุฏูุงูู:ุซูุงูู (ุจุฏูู ูููุฉ ููู)
            const daysStr = d.toString().padStart(2, '0');
            const hoursStr = h.toString().padStart(2, '0');
            const minutesStr = m.toString().padStart(2, '0');
            const secondsStr = s.toString().padStart(2, '0');
            
            document.getElementById('weekly-timer').innerText = `${daysStr}:${hoursStr}:${minutesStr}:${secondsStr}`;
        }

        // Run timer every second
        setInterval(updateWeeklyTimer, 1000);
        updateWeeklyTimer(); // Initial call

        // --- WEEKLY REWARDS DISTRIBUTION FUNCTION ---
        async function checkWeeklyRewards() {
            // Check if rewards were already distributed this week
            const lastDistributed = localStorage.getItem('lastWeeklyRewardDistribution');
            const currentWeek = getCurrentWeekNumber();
            
            if (lastDistributed && parseInt(lastDistributed) === currentWeek) {
                weeklyRewardDistributed = true;
                return;
            }
            
            weeklyRewardDistributed = false;
        }

        async function distributeWeeklyRewards() {
            if (weeklyRewardDistributed) return;
            
            try {
                // Get top 5 users ordered by points
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(5));
                const snapshot = await getDocs(q);
                
                const topUsers = [];
                snapshot.forEach((doc, index) => {
                    topUsers.push({
                        id: doc.id,
                        data: doc.data(),
                        rank: index + 1
                    });
                });
                
                // Define prizes based on rank
                const prizes = {
                    1: 10, // $10 for 1st place
                    2: 7,  // $7 for 2nd place
                    3: 5,  // $5 for 3rd place
                    4: 3,  // $3 for 4th place
                    5: 2   // $2 for 5th place
                };
                
                // Distribute prizes to top 5 users
                const batch = writeBatch(db);
                
                topUsers.forEach(user => {
                    const prizeAmount = prizes[user.rank] || 0;
                    if (prizeAmount > 0) {
                        const userRef = doc(db, "users", user.id);
                        batch.update(userRef, {
                            walletBalance: increment(prizeAmount),
                            lastWeeklyPrize: prizeAmount,
                            lastWeeklyRank: user.rank
                        });
                    }
                });
                
                // Reset all users' points to 0
                const allUsersQuery = query(collection(db, "users"));
                const allUsersSnapshot = await getDocs(allUsersQuery);
                
                allUsersSnapshot.forEach(docSnap => {
                    const userRef = doc(db, "users", docSnap.id);
                    batch.update(userRef, {
                        points: 0
                    });
                });
                
                // Execute batch writes
                await batch.commit();
                
                // Update local flag
                weeklyRewardDistributed = true;
                localStorage.setItem('lastWeeklyRewardDistribution', getCurrentWeekNumber().toString());
                
                console.log("Weekly rewards distributed successfully!");
                
            } catch (error) {
                console.error("Error distributing weekly rewards:", error);
            }
        }

        function getCurrentWeekNumber() {
            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const pastDaysOfYear = (now - startOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
        }

        // --- 1. SMOOTH NAVIGATION ---
        window.openPage = async (screenId) => {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => {
                s.classList.remove('active');
                // Reset scroll position when leaving screen
                const scrollContainer = s.querySelector('.scroll-container');
                if (scrollContainer) {
                    scrollContainer.scrollTop = 0;
                }
            });
            const target = document.getElementById(screenId);
            target.classList.add('active');
            
            // Logic dispatch with auto-refresh
            if (screenId === 'screen-admin-users') { 
                // Reset search when opening
                document.getElementById('admin-search-id').value = '';
                document.getElementById('admin-user-result').classList.add('hidden');
            }
            else if (screenId === 'screen-stats') loadStatsContent();
            else if (screenId === 'screen-my-points') loadMyPointsContent();
            else if (screenId === 'screen-my-questions') loadMyQuestionsContent();
            else if (screenId === 'screen-admin-review') loadAdminReviewContent();
            else if (screenId === 'screen-referral') loadReferralData();
            else if (screenId === 'screen-money') loadWalletData();
            else if (screenId === 'screen-admin-all') {
                populateAdminFilterSubjects();
                loadAdminAllContent();
            }
            else if (screenId === 'screen-admin-stats') resetStatsUI();
            else if (screenId === 'screen-admin-subjects') loadSubjectManagement();
            
            // Force refresh of any data that might be stale
            if (userData) {
                setTimeout(() => {
                    refreshUserData();
                }, 300);
            }
        };

        async function refreshUserData() {
            try {
                const docSnap = await getDoc(doc(db, "users", currentUser.uid));
                if (docSnap.exists()) {
                    userData = docSnap.data();
                    setupHeaderUI();
                    setupProfileUI();
                    
                    // Update current screen if needed
                    const activeScreen = document.querySelector('.screen.active');
                    if (activeScreen) {
                        const screenId = activeScreen.id;
                        if (screenId === 'screen-referral') loadReferralData();
                        if (screenId === 'screen-money') loadWalletData();
                        if (screenId === 'screen-my-points') loadMyPointsContent();
                        if (screenId === 'tab-leaderboard') loadLeaderboard();
                    }
                }
            } catch (e) {
                console.error("Error refreshing user data:", e);
            }
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
                // Reset scroll position when leaving tab
                const scrollContainer = s.querySelector('.scroll-container');
                if (scrollContainer) {
                    scrollContainer.scrollTop = 0;
                }
            });
            document.getElementById('tab-'+tab).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => { 
                n.classList.remove('active'); 
                n.classList.remove('text-indigo-600'); 
                n.classList.add('text-gray-400'); 
            });
            const navs = document.querySelectorAll('.nav-item');
            if(tab==='challenges') {
                navs[0].classList.add('active', 'text-indigo-600');
                // Refresh challenge subjects
                if (userData && userData.grade) {
                    populateSubjects(userData.grade, 'challenge-subject');
                }
            }
            if(tab==='leaderboard') { 
                navs[1].classList.add('active', 'text-indigo-600'); 
                loadLeaderboard(); 
            }
            if(tab==='upload') { 
                navs[2].classList.add('active', 'text-indigo-600'); 
                updateUploadUI(); 
            }
            if(tab==='profile') navs[3].classList.add('active', 'text-indigo-600');
        };

        window.backToProfile = () => { 
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => { 
                if(s.id.startsWith('screen-')) {
                    s.classList.remove('active');
                    // Reset scroll position
                    const scrollContainer = s.querySelector('.scroll-container');
                    if (scrollContainer) {
                        scrollContainer.scrollTop = 0;
                    }
                } 
            });
            switchTab('profile');
        };

        // --- AUTH & SIGNUP WITH RESTRICTIONS - FIXED REFERRAL SYSTEM ---
        window.handleSignup = async () => {
            // DEVICE RESTRICTION (LocalStorage)
            let accountsCount = localStorage.getItem('hacker_accounts_count') || 0;
            if (parseInt(accountsCount) >= 2) {
                alert("โ ุนุฐุฑุงูุ ูุง ูููู ุฅูุดุงุก ุฃูุซุฑ ูู ุญุณุงุจูู ุนูู ููุณ ุงูุฌูุงุฒ.");
                return;
            }

            try {
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const pass = document.getElementById('signup-pass').value;
                const refCode = document.getElementById('signup-referral').value.trim().toUpperCase();
                const imgFile = document.getElementById('signup-img').files[0];
                
                if(!name || !email || !pass) return alert("ูุฑุฌู ููุก ูุงูุฉ ุงูุญููู");
                if(!email.endsWith("@gmail.com")) return alert("ูุฌุจ ุงุณุชุฎุฏุงู ุงูููู Gmail");
                if(pass.length < 6) return alert("ูููุฉ ุงููุฑูุฑ ูุตูุฑุฉ ุฌุฏุงู");

                // CHECK REFERRAL CODE - FIXED PERMISSIONS
                let referrerId = null;
                let referrerData = null;
                if (refCode) {
                    const qRef = query(collection(db, "users"), where("uniqueId", "==", refCode));
                    const snap = await getDocs(qRef);
                    if (snap.empty) {
                        alert("ุฑูุฒ ุงูุฏุนูุฉ ุบูุฑ ุตุญูุญ");
                        return;
                    }
                    referrerId = snap.docs[0].id;
                    referrerData = snap.docs[0].data();
                    
                    // Check if referrer is banned
                    if (referrerData.isBanned) {
                        alert("ูุง ูููู ุงุณุชุฎุฏุงู ุฑูุฒ ุฏุนูุฉ ูู ูุณุชุฎุฏู ูุญุธูุฑ");
                        return;
                    }
                }

                let photoURL = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=128`;
                if(imgFile) {
                    try {
                        photoURL = await compressImage(imgFile);
                    } catch (e) {
                        console.error("Error compressing image:", e);
                        // Use default avatar if compression fails
                    }
                }

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                // Increase local account count
                localStorage.setItem('hacker_accounts_count', parseInt(accountsCount) + 1);

                const newId = generateId();
                // User Data - FIXED: Start with 25 points if using referral code
                let startPoints = 0;
                if (referrerId) startPoints = 25; // Bonus for new user

                // Create user document with proper data structure
                const userDocData = {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    photo: photoURL,
                    uniqueId: newId,
                    points: startPoints,
                    role: 'user',
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                    isBanned: false,
                    walletBalance: 0,
                    referrals: 0,
                    referredBy: referrerId || null,
                    grade: null,
                    // Rewards
                    lastRewardDayKey: null, 
                    rewardMonthKey: null,   
                    daysClaimedInMonth: 0,
                    deviceId: localStorage.getItem('deviceId') || generateDeviceId()
                };

                await setDoc(doc(db, "users", cred.user.uid), userDocData);

                // Reward Referrer - FIXED: Use transaction for consistency
                if (referrerId) {
                    try {
                        // Add 50 points to referrer
                        await updateDoc(doc(db, "users", referrerId), {
                            points: increment(50),
                            referrals: increment(1),
                            lastReferral: serverTimestamp()
                        });
                        
                        // Also update local referrer data if it's the current user
                        if (currentUser && currentUser.uid === referrerId) {
                            userData.points += 50;
                            userData.referrals = (userData.referrals || 0) + 1;
                            setupHeaderUI();
                        }
                        
                        console.log("Referral reward processed successfully");
                    } catch (referralError) {
                        console.error("Error processing referral reward:", referralError);
                        // Don't fail the signup if referral reward fails
                    }
                }

                alert("โ ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ! ููููู ุชุณุฌูู ุงูุฏุฎูู ุงูุขู.");
                window.switchAuthTab('login');

            } catch (e) { 
                console.error("Signup error:", e);
                alert(getArabicError(e.code)); 
            }
        };

        // --- NEW DAILY REWARDS LOGIC ---
        window.checkDailyReward = async () => {
            if (!currentUser || !userData) return;
            
            const iraqDate = new Date().toLocaleString("en-US", {timeZone: "Asia/Baghdad"});
            const d = new Date(iraqDate);
            const currentDayKey = `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`;
            const currentMonthKey = `${d.getMonth()}-${d.getFullYear()}`;

            if (userData.lastRewardDayKey === currentDayKey) return; 

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const nextDayToClaim = userDaysClaimed + 1;
            const grid = document.getElementById('reward-grid-container');
            grid.innerHTML = '';
            
            for(let i=1; i<=30; i++) {
                let pts = 5;
                if(i > 10) pts = 10;
                if(i > 20) pts = 15;

                let cls = "day-box";
                if (i < nextDayToClaim) cls += " claimed"; 
                else if (i === nextDayToClaim) cls += " active"; 
                else cls += " locked"; 
                grid.innerHTML += `<div class="${cls}"><p>ููู ${i}</p><span>${pts}</span></div>`;
            }
            document.getElementById('daily-reward-screen').classList.remove('hidden');
            document.getElementById('daily-reward-screen').style.display = 'flex';
        };

        window.claimReward = async () => {
            const iraqDate = new Date().toLocaleString("en-US", {timeZone: "Asia/Baghdad"});
            const d = new Date(iraqDate);
            const currentDayKey = `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`;
            const currentMonthKey = `${d.getMonth()}-${d.getFullYear()}`;

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;
            const dayToClaim = userDaysClaimed + 1;
            
            let rewardAmount = 5;
            if(dayToClaim > 10) rewardAmount = 10;
            if(dayToClaim > 20) rewardAmount = 15;

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(rewardAmount),
                lastRewardDayKey: currentDayKey,
                rewardMonthKey: currentMonthKey,
                daysClaimedInMonth: increment(1) 
            });
            userData.points += rewardAmount;
            userData.lastRewardDayKey = currentDayKey;
            userData.rewardMonthKey = currentMonthKey;
            userData.daysClaimedInMonth = dayToClaim;
            setupHeaderUI();
            document.getElementById('daily-reward-screen').classList.add('hidden');
            document.getElementById('daily-reward-screen').style.display = 'none';
            alert(`๐ ูุจุฑูู! ููุฏ ุญุตูุช ุนูู ${rewardAmount} ููุงุท ููุงูุฃุฉ ุงูููู!`);
        };

        // --- VS SCREEN & MATCHMAKING - IMPROVED WITH BETTER ERROR HANDLING ---
        window.startMatchmaking = async (mode) => {
            if (!systemConfig.enabled) {
                const modal = document.getElementById('maintenance-popup');
                document.getElementById('maintenance-msg-display').innerText = systemConfig.msg;
                modal.classList.remove('hidden'); 
                modal.style.display = 'flex';
                return;
            }
            const sub = document.getElementById('challenge-subject').value;
            if(!sub || !selectedQType) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฏุฉ ูููุน ุงูุฃุณุฆูุฉ");

            currentGameMode = mode;
            if (mode === 'ai') aiDifficulty = document.getElementById('ai-difficulty').value;

            document.getElementById('challenge-active-card').classList.add('hidden');
            document.getElementById('searching-ui').classList.remove('hidden');
            document.getElementById('searching-ui').style.display = 'flex';
            document.getElementById('search-msg').innerText = mode === 'online' ? "ุฌุงุฑู ุงูุจุญุซ ุนู ุทุงูุจ..." : "ุฌุงุฑู ุชุญุถูุฑ ุงูุจูุช...";

            const grade = userData.grade;
            let group = `${grade}_${sub}`;
            if(['ุงุณูุงููุฉ','ุนุฑุจู','ุงููููุฒู'].includes(sub) && grade.startsWith('6')) group = `6shared_${sub}`;

            if (mode === 'online') {
                await startOnlineMatch(group, sub);
            } else {
                startAIMatch(sub);
            }
        };

        async function startOnlineMatch(group, sub) {
            try {
                const qRef = collection(db, "match_queue");
                // Clean old sessions for this user
                const oldDocs = await getDocs(query(qRef, where("player1.uid", "==", currentUser.uid), where("status", "==", "waiting")));
                const deletePromises = [];
                oldDocs.forEach(async (d) => { 
                    deletePromises.push(deleteDoc(d.ref));
                });
                await Promise.all(deletePromises);

                // Look for existing match
                const qWait = query(qRef, where("group", "==", group), where("status", "==", "waiting"), limit(10));
                const snap = await getDocs(qWait);
                let foundMatchId = null;
                let opponentData = null;
                
                snap.forEach((doc) => { 
                    if (doc.data().player1.uid !== currentUser.uid) {
                        foundMatchId = doc.id;
                        opponentData = doc.data().player1;
                    }
                });

                if(foundMatchId && opponentData) {
                    currentMatchId = foundMatchId;
                    // Get questions for the match
                    const qDocs = await getQuestions(sub, selectedQType);
                    if(qDocs.length === 0) { 
                        alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ"); 
                        cancelSearch(); 
                        return; 
                    }
                    const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
                    
                    await updateDoc(doc(db, "match_queue", foundMatchId), {
                        player2: { 
                            uid: currentUser.uid, 
                            name: userData.name, 
                            photo: userData.photo, 
                            score: 0 
                        },
                        questions: shuffledQs,
                        status: 'active', 
                        answersCount: 0,
                        startedAt: serverTimestamp()
                    });
                    listenToMatch(foundMatchId);
                } else {
                    // Create new match
                    const qDocs = await getQuestions(sub, selectedQType);
                    if(qDocs.length === 0) { 
                        alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ"); 
                        cancelSearch(); 
                        return; 
                    }
                    const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
                    const newMatch = await addDoc(qRef, {
                        group: group, 
                        status: 'waiting',
                        player1: { 
                            uid: currentUser.uid, 
                            name: userData.name, 
                            photo: userData.photo, 
                            score: 0 
                        },
                        questions: shuffledQs, 
                        currentIdx: 0, 
                        answersCount: 0,
                        createdAt: serverTimestamp(),
                        subject: sub,
                        type: selectedQType
                    });
                    currentMatchId = newMatch.id;
                    listenToMatch(newMatch.id);
                    
                    // Set timeout to cancel match if no one joins
                    setTimeout(async () => {
                        if (currentMatchId === newMatch.id) {
                            const matchDoc = await getDoc(doc(db, "match_queue", newMatch.id));
                            if (matchDoc.exists() && matchDoc.data().status === 'waiting') {
                                cancelSearch();
                                alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ููุงูุณ. ุญุงูู ูุฑุฉ ุฃุฎุฑู.");
                            }
                        }
                    }, 30000); // 30 seconds timeout
                }
            } catch(e) { 
                console.error("Matchmaking error:", e); 
                cancelSearch(); 
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ ุนู ููุงูุณ");
            }
        }

        async function startAIMatch(sub) {
            const qDocs = await getQuestions(sub, selectedQType);
            if(qDocs.length === 0) { 
                alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ"); 
                cancelSearch(); 
                return; 
            }
            const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
            
            let botPhoto = "https://cdn-icons-png.flaticon.com/512/4712/4712035.png"; 

            localMatchData = {
                status: 'active',
                player1: { 
                    uid: currentUser.uid, 
                    name: userData.name, 
                    photo: userData.photo, 
                    score: 0 
                },
                player2: { 
                    uid: 'AI_BOT', 
                    name: "ุงูุฐูุงุก ุงูุงุตุทูุงุนู ๐ค", 
                    photo: botPhoto, 
                    score: 0 
                },
                questions: shuffledQs, 
                currentIdx: 0, 
                answersCount: 0,
                startedAt: new Date().toISOString()
            };
            
            showVSScreen(userData, localMatchData.player2, () => {
                document.getElementById('game-overlay').classList.remove('hidden');
                document.getElementById('game-overlay').style.display = 'flex';
                document.getElementById('game-exit-btn').classList.remove('hidden');
                renderGame(localMatchData);
            });
        }

        function listenToMatch(id) {
            if(matchListenerUnsubscribe) matchListenerUnsubscribe(); 
            matchListenerUnsubscribe = onSnapshot(doc(db, "match_queue", id), (snap) => {
                if(isExitingGame) return;
                if(!snap.exists()) {
                    // Match was deleted (opponent left)
                    if (!isExitingGame) {
                        alert("ุบุงุฏุฑ ุงูููุงูุณ ุงููุจุงุฑุงุฉ");
                        cancelSearch();
                        switchTab('challenges');
                    }
                    return;
                }
                const d = snap.data();
                if(d.status === 'active') {
                    if (document.getElementById('vs-screen').classList.contains('hidden') && document.getElementById('game-overlay').classList.contains('hidden')) {
                         showVSScreen(d.player1, d.player2, () => {
                            document.getElementById('game-overlay').classList.remove('hidden');
                            document.getElementById('game-overlay').style.display = 'flex';
                            document.getElementById('game-exit-btn').classList.remove('hidden');
                            renderGame(d);
                         });
                    } else if (!document.getElementById('game-overlay').classList.contains('hidden')) {
                        renderGame(d);
                    }
                } else if (d.status === 'completed') {
                    // Game ended naturally
                    endGame(d);
                }
            }, (error) => {
                console.error("Match listener error:", error);
            });
        }

        function showVSScreen(p1, p2, callback) {
            document.getElementById('searching-ui').classList.add('hidden');
            const vs = document.getElementById('vs-screen');
            
            // Set player 1 data
            document.getElementById('vs-p1-img').src = p1.photo || userData.photo;
            document.getElementById('vs-p1-name').innerText = p1.name || "ูุงุนุจ";
            
            // Set player 2 data
            document.getElementById('vs-p2-img').src = p2.photo || "https://ui-avatars.com/api/?name=Opponent&background=random&size=128";
            document.getElementById('vs-p2-name').innerText = p2.name || "ุงูุฎุตู";
            
            vs.classList.remove('hidden');
            setTimeout(() => {
                vs.classList.add('hidden');
                callback();
            }, 3000);
        }

        // --- LOAD LEADERBOARD ---
        async function loadLeaderboard() {
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '<p class="text-center text-gray-400 mt-10">ุชุญููู...</p>';
            
            try {
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
                const snap = await getDocs(q);
                let users = [];
                snap.forEach(d => {
                    const data = d.data();
                    if (data && !data.isBanned) {
                        users.push(data);
                    }
                });

                const myIndex = users.findIndex(u => u.uid === currentUser.uid);
                if(myIndex !== -1) document.getElementById('my-rank-text').innerText = "#" + (myIndex + 1);
                else document.getElementById('my-rank-text').innerText = "ุบูุฑ ูุตูู";

                div.innerHTML = ''; 
                let i = 1;

                users.forEach(u => {
                    let frameClass = "frame-rank-common";
                    let crown = "";
                    let rankBadge = `<div class="rank-badge-top">${i}</div>`;
                    let raysHtml = "";
                    let prizeHtml = "";

                    if (i === 1) { 
                        frameClass = "frame-rank-1"; 
                        crown = `<i class="fas fa-crown text-yellow-500 name-crown"></i>`; 
                        raysHtml = `<div class="rank-rays rays-gold"></div>`; 
                        prizeHtml=`<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded ml-2 font-bold">$10</span>`; 
                    }
                    else if (i === 2) { 
                        frameClass = "frame-rank-2"; 
                        raysHtml = `<div class="rank-rays rays-silver"></div>`; 
                        prizeHtml=`<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded ml-2 font-bold">$7</span>`; 
                    }
                    else if (i === 3) { 
                        frameClass = "frame-rank-3"; 
                        raysHtml = `<div class="rank-rays rays-bronze"></div>`; 
                        prizeHtml=`<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded ml-2 font-bold">$5</span>`; 
                    }
                    else if (i === 4) { 
                        frameClass = "frame-rank-other-top"; 
                        raysHtml = `<div class="rank-rays rays-blue"></div>`; 
                        prizeHtml=`<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2 font-bold">$3</span>`; 
                    }
                    else if (i === 5) { 
                        frameClass = "frame-rank-other-top"; 
                        raysHtml = `<div class="rank-rays rays-red"></div>`; 
                        prizeHtml=`<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded ml-2 font-bold">$2</span>`; 
                    }
                    else if (i <= 10) { 
                        frameClass = "frame-rank-other-top"; 
                        raysHtml = `<div class="rank-rays rays-purple"></div>`; 
                    }

                    // NEW: ADD RESET BUTTON FOR ADMIN
                    let resetBtn = "";
                    if (currentUser && userData.email === ADMIN_EMAIL) {
                        resetBtn = `<button onclick="resetUserPoints('${u.uid}', '${u.name}')" class="w-6 h-6 rounded bg-red-100 text-red-500 flex items-center justify-center mr-2"><i class="fas fa-trash-alt text-xs"></i></button>`;
                    }

                    div.innerHTML += `
                        <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden">
                            <div class="flex items-center gap-4 z-10">
                                <div class="rank-img-container">
                                    ${rankBadge} ${raysHtml}
                                    <img src="${u.photo}" class="rank-img ${frameClass}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=random&size=128'">
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 text-sm flex items-center">${crown} ${u.name} ${prizeHtml}</p>
                                    <p class="text-[10px] text-gray-400">ID: ${u.uniqueId}</p>
                                </div>
                            </div>
                            <div class="flex items-center z-10">
                                ${resetBtn}
                                <span class="font-black text-indigo-600 text-lg">${u.points} ๐</span>
                            </div>
                        </div>`;
                    i++;
                });
                
                if (users.length === 0) {
                    div.innerHTML = '<p class="text-center text-gray-400 mt-10">ูุง ููุฌุฏ ูุณุชุฎุฏููู ุจุนุฏ</p>';
                }
            } catch (error) {
                console.error("Error loading leaderboard:", error);
                div.innerHTML = '<p class="text-center text-red-500 mt-10">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุชุตููู</p>';
            }
        }

        // --- NEW: RESET USER POINTS FUNCTION (ูู ุงูููุฏ ุงูุซุงูู) ---
        window.resetUserPoints = async (uid, name) => {
            if(confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ููุงุท ุงูุทุงูุจ: ${name}ุ\n(ุงูููุงุท ุณุชุนูุฏ ููุตูุฑ ููุท ููู ูุฎุชูู ูู ุงููุงุฆูุฉ)`)) {
                try {
                    await updateDoc(doc(db, "users", uid), { points: 0 });
                    alert("ุชู ุชุตููุฑ ุงูููุงุท ุจูุฌุงุญ!");
                    loadLeaderboard(); 
                } catch (error) {
                    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตููุฑ ุงูููุงุท");
                    console.error("Error resetting points:", error);
                }
            }
        };

        // --- WALLET LOGIC ---
        window.loadWalletData = () => {
             document.getElementById('wallet-balance').innerText = userData.walletBalance || 0;
             const btn = document.getElementById('withdraw-btn');
             if((userData.walletBalance || 0) >= 100) {
                 btn.disabled = false;
                 btn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'shadow-none');
                 btn.classList.add('withdraw-btn', 'text-white', 'hover:scale-[1.02]');
             } else {
                 btn.disabled = true;
                 btn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'shadow-none');
                 btn.classList.remove('withdraw-btn', 'text-white', 'hover:scale-[1.02]');
             }
        };

        // --- WITHDRAWAL FUNCTIONS ---
        window.showWithdrawalConfirmation = () => {
            if ((userData.walletBalance || 0) < 100) {
                alert("ูุฌุจ ุฃู ูููู ุฑุตูุฏู 100$ ุนูู ุงูุฃูู ูุณุญุจ ุงูุฃููุงู");
                return;
            }
            document.getElementById('withdrawal-confirmation-modal').classList.remove('hidden');
        };

        window.cancelWithdrawal = () => {
            document.getElementById('withdrawal-confirmation-modal').classList.add('hidden');
        };

        window.confirmWithdrawal = async () => {
            try {
                // Deduct 100 from wallet balance
                await updateDoc(doc(db, "users", currentUser.uid), {
                    walletBalance: increment(-100)
                });
                
                userData.walletBalance = Math.max(0, (userData.walletBalance || 0) - 100);
                loadWalletData();
                
                document.getElementById('withdrawal-confirmation-modal').classList.add('hidden');
                
                // Open Telegram
                window.open('https://t.me/mslmh19', '_blank');
                
                alert("โ ุชู ุฎุตู 100$ ูู ุฑุตูุฏู. ุฑุงุณููุง ุนูู ุงูุชููุฌุฑุงู ูุฅุชูุงู ุนูููุฉ ุงูุณุญุจ.");
                
            } catch (error) {
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจ ุงูุณุญุจ");
                console.error("Withdrawal error:", error);
            }
        };

        // --- REFERRAL PAGE ---
        window.loadReferralData = () => {
             document.getElementById('my-referral-code').innerText = userData.uniqueId || "ุบูุฑ ูุชููุฑ";
             document.getElementById('ref-count-display').innerText = userData.referrals || 0;
             document.getElementById('ref-earnings').innerText = (userData.referrals || 0) * 50;
        };

        window.copyReferral = () => {
             const code = userData.uniqueId;
             if (!code) {
                 alert("ูุง ููุฌุฏ ุฑูุฒ ุฏุนูุฉ");
                 return;
             }
             navigator.clipboard.writeText(code).then(() => {
                 alert("ุชู ูุณุฎ ุฑูุฒ ุงูุฏุนูุฉ!");
             }).catch(err => {
                 alert("ุชุนุฐุฑ ูุณุฎ ุงูุฑูุฒ. ููููู ูุณุฎู ูุฏููุงู: " + code);
             });
        };

        // --- ADMIN USER MANAGEMENT ---
        window.adminSearchUser = async () => {
             const id = document.getElementById('admin-search-id').value.trim().toUpperCase();
             if(!id) {
                 alert("ูุฑุฌู ุฅุฏุฎุงู ูุนุฑู ุงููุณุชุฎุฏู");
                 return;
             }
             
             try {
                 const q = query(collection(db, "users"), where("uniqueId", "==", id));
                 const snap = await getDocs(q);
                 
                 if(snap.empty) { 
                     alert("ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ"); 
                     return; 
                 }
                 
                 const d = snap.docs[0];
                 searchedUser = { id: d.id, ...d.data() };
                 
                 document.getElementById('admin-user-result').classList.remove('hidden');
                 document.getElementById('admin-u-img').src = searchedUser.photo || "https://ui-avatars.com/api/?name=User&background=random&size=128";
                 document.getElementById('admin-u-name').innerText = searchedUser.name || "ุบูุฑ ูุนุฑูู";
                 document.getElementById('admin-u-id').innerText = "ID: " + (searchedUser.uniqueId || "ุบูุฑ ูุนุฑูู");
                 document.getElementById('admin-u-balance').innerText = searchedUser.walletBalance || 0;
                 
                 const statusEl = document.getElementById('admin-u-status');
                 if (searchedUser.isBanned) {
                     statusEl.innerText = "ูุญุธูุฑ โ"; 
                     statusEl.className = "text-xs font-bold text-red-600";
                 } else if ((searchedUser.walletBalance || 0) >= 100) {
                     statusEl.innerText = "ูุณุชุญู ุงูุณุญุจ โ"; 
                     statusEl.className = "text-xs font-bold text-green-600";
                 } else {
                     statusEl.innerText = "ูุง ูุณุชุญู ุงูุณุญุจ โ"; 
                     statusEl.className = "text-xs font-bold text-gray-600";
                 }

                 updateBanButton();
             } catch (error) {
                 console.error("Error searching user:", error);
                 alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู");
             }
        };

        function updateBanButton() {
             if (!searchedUser) return;
             
             const btn = document.getElementById('btn-ban-toggle');
             if(searchedUser.isBanned) {
                 btn.innerText = "ุฅูุบุงุก ุงูุญุธุฑ (Unban)";
                 btn.className = "w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold mb-2 transition";
             } else {
                 btn.innerText = "ุญุธุฑ ุงููุณุชุฎุฏู (Ban)";
                 btn.className = "w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold mb-2 transition";
             }
        }

        window.toggleBan = async () => {
             if(!searchedUser) return;
             
             const newStatus = !searchedUser.isBanned;
             const action = newStatus ? "ุญุธุฑ" : "ุฅูุบุงุก ุญุธุฑ";
             
             if(!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ${action} ุงููุณุชุฎุฏู ${searchedUser.name}ุ`)) {
                 return;
             }
             
             try {
                 await updateDoc(doc(db, "users", searchedUser.id), { 
                     isBanned: newStatus,
                     banUpdatedAt: serverTimestamp()
                 });
                 searchedUser.isBanned = newStatus;
                 updateBanButton();
                 
                 // If banning current user, log them out
                 if (currentUser && currentUser.uid === searchedUser.id && newStatus === true) {
                     alert("ุชู ุญุธุฑ ุญุณุงุจู. ุณูุชู ุชุณุฌูู ุฎุฑูุฌู ุงูุขู.");
                     await signOut(auth);
                     location.reload();
                 } else {
                     alert(newStatus ? "ุชู ุญุธุฑ ุงููุณุชุฎุฏู ุจูุฌุงุญ" : "ุชู ุฅูุบุงุก ุญุธุฑ ุงููุณุชุฎุฏู ุจูุฌุงุญ");
                 }
                 
             } catch (error) {
                 alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุญุงูุฉ ุงูุญุธุฑ");
                 console.error("Ban toggle error:", error);
             }
        };

        window.resetUserMoney = async () => {
             if(!searchedUser) return;
             
             if(confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ุฃููุงู ุงููุณุชุฎุฏู ${searchedUser.name} ุฅูู 0ุ`)) {
                 try {
                     await updateDoc(doc(db, "users", searchedUser.id), { 
                         walletBalance: 0,
                         walletResetAt: serverTimestamp()
                     });
                     document.getElementById('admin-u-balance').innerText = "0";
                     searchedUser.walletBalance = 0;
                     alert("ุชู ุชุตููุฑ ุงูุฑุตูุฏ ุจูุฌุงุญ.");
                 } catch (error) {
                     alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตููุฑ ุงูุฑุตูุฏ");
                     console.error("Reset money error:", error);
                 }
             }
        };

        window.resetUserPointsAdmin = async () => {
            if(!searchedUser) return;
            
            if(confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ููุงุท ุงููุณุชุฎุฏู ${searchedUser.name} ุฅูู 0ุ`)) {
                try {
                    await updateDoc(doc(db, "users", searchedUser.id), { 
                        points: 0,
                        pointsResetAt: serverTimestamp()
                    });
                    searchedUser.points = 0;
                    alert("ุชู ุชุตููุฑ ุงูููุงุท ุจูุฌุงุญ.");
                } catch (error) {
                    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุตููุฑ ุงูููุงุท");
                    console.error("Reset points error:", error);
                }
            }
        };

        // --- STATISTICS CONTENT ---
        async function loadStatsContent() {
             const div = document.getElementById('stats-content');
             div.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุชุญููู ุงูุฅุญุตุงุฆูุงุช...</p>';
             
             try {
                 const usersSnap = await getDocs(collection(db, "users"));
                 const total = usersSnap.size;
                 const today = new Date(); 
                 today.setHours(0,0,0,0);
                 
                 let newUsers = 0; 
                 let activeNow = 0; 
                 let bannedUsers = 0;
                 const now = new Date();
                 
                 usersSnap.forEach(d => {
                     const u = d.data();
                     if(!u) return;
                     
                     // Count new users today
                     if(u.createdAt && u.createdAt.toDate && u.createdAt.toDate() >= today) newUsers++;
                     
                     // Count active users (last 15 minutes)
                     if (u.lastActive && u.lastActive.toDate && (now - u.lastActive.toDate()) < 15 * 60 * 1000) activeNow++;
                     
                     // Count banned users
                     if (u.isBanned) bannedUsers++;
                 });
                 
                 // Ensure activeNow is at least 1 if there are users
                 if(activeNow === 0 && total > 0) activeNow = 1; 
                 
                 div.innerHTML = `
                    <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-500">ุงููุณุชุฎุฏููู ุงูููู</p>
                            <p class="text-2xl font-bold text-gray-800">${total}</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-500">ูุดุทูู ุงูุขู</p>
                            <p class="text-2xl font-bold text-green-500">${activeNow}</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                            <i class="fas fa-wifi"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-500">ุณุฌููุง ุงูููู</p>
                            <p class="text-2xl font-bold text-purple-500">${newUsers}</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                            <i class="fas fa-user-plus"></i>
                        </div>
                    </div>
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-500">ุงููุญุธูุฑูู</p>
                            <p class="text-2xl font-bold text-red-500">${bannedUsers}</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                            <i class="fas fa-ban"></i>
                        </div>
                    </div>`;
                 
             } catch (error) {
                 console.error("Error loading stats:", error);
                 div.innerHTML = '<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฅุญุตุงุฆูุงุช</p>';
             }
        }

        async function loadMyPointsContent() {
             document.getElementById('detail-points').innerText = userData.points || 0;
             const joinDate = userData.createdAt ? userData.createdAt.toDate() : new Date();
             document.getElementById('detail-join-date').innerText = joinDate.toLocaleDateString('ar-EG', {
                 year: 'numeric',
                 month: 'long',
                 day: 'numeric'
             });
             const diffTime = Math.abs(new Date() - joinDate);
             const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
             document.getElementById('detail-days').innerText = diffDays;
        }

        async function loadMyQuestionsContent() {
            const div = document.getElementById('my-questions-list');
            div.innerHTML = '<p class="text-center text-gray-400">ุชุญููู...</p>';
            
            try {
                const q1 = query(collection(db, "pending_questions"), where("authorId", "==", currentUser.uid));
                const s1 = await getDocs(q1);
                let html = "";
                let qs = [];
                s1.forEach(d => qs.push({id: d.id, ...d.data()}));
                
                qs.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

                if (qs.length === 0) {
                    html = "<p class='text-center text-gray-400 mt-10'>ูู ุชูู ุจุฑูุน ุฃู ุฃุณุฆูุฉ ุญุชู ุงูุขู.</p>";
                } else {
                    qs.forEach(q => { 
                        let statusBadge = "";
                        let statusColor = "";
                        
                        if(q.status === 'approved') {
                            statusBadge = "ุชูุช ุงูููุงููุฉ (+10)";
                            statusColor = "green";
                        } else if (q.status === 'rejected') {
                            statusBadge = "ูุฑููุถ";
                            statusColor = "red";
                        } else {
                            statusBadge = "ููุฏ ุงููุฑุงุฌุนุฉ";
                            statusColor = "yellow";
                        }

                        const dateStr = q.createdAt?.toDate ? 
                            q.createdAt.toDate().toLocaleDateString('ar-EG') : 
                            "ุชุงุฑูุฎ ุบูุฑ ูุนุฑูู";
                        
                        html += `
                        <div class="bg-white p-4 rounded-xl border border-gray-100 mb-3 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded font-bold">${q.subject || 'ุบูุฑ ูุญุฏุฏ'}</span>
                                    <span class="text-xs text-gray-400">${dateStr}</span>
                                </div>
                                <span class="text-xs bg-${statusColor}-100 text-${statusColor}-600 px-2 py-1 rounded font-bold">${statusBadge}</span>
                            </div>
                            <p class="font-bold text-gray-800 text-sm mb-2">${q.question || 'ุจุฏูู ูุต'}</p>
                            ${q.type === 'mcq' ? `
                            <div class="bg-gray-50 p-3 rounded-lg text-xs space-y-1">
                                <p class="font-bold text-gray-500 mb-1">ุงูุฎูุงุฑุงุช:</p>
                                <div class="space-y-1">
                                    ${q.answers?.map((ans, idx) => `
                                    <div class="flex items-center gap-2 ${idx === q.correct ? 'bg-green-50 text-green-700' : ''} p-1 rounded">
                                        <span class="w-4 h-4 rounded-full ${idx === q.correct ? 'bg-green-500' : 'bg-gray-300'}"></span>
                                        <span>${ans || 'ุฎูุงุฑ ูุงุฑุบ'}</span>
                                    </div>
                                    `).join('') || ''}
                                </div>
                            </div>
                            ` : ''}
                        </div>`; 
                    });
                }
                
                div.innerHTML = html;
                
            } catch(e) { 
                console.error("Error loading my questions:", e);
                div.innerHTML = "<p class='text-red-500 text-center'>ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช.</p>"; 
            }
        }

        // --- FIXED: ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ (ุฒุฑ ูุจูู/ุฑูุถ) ---
        async function loadAdminReviewContent() {
            const div = document.getElementById('admin-review-list');
            div.innerHTML = '<p class="text-center text-gray-400">ุชุญููู...</p>';
            
            try {
                const q = await getDocs(query(collection(db, "pending_questions"), where("status", "==", "pending")));
                
                if(q.empty) { 
                    div.innerHTML = "<p class='text-center py-10 text-gray-400'>ูุง ููุฌุฏ ุดูุก ูููุฑุงุฌุนุฉ โ</p>"; 
                    return; 
                }
                
                let html = "";
                q.forEach(d => {
                   const val = d.data(); 
                   const author = val.authorName || 'ูุฌููู';
                   const dateStr = val.createdAt?.toDate ? 
                       val.createdAt.toDate().toLocaleDateString('ar-EG') : 
                       "ุชุงุฑูุฎ ุบูุฑ ูุนุฑูู";
                   
                   html += `
                   <div class="bg-white rounded-xl p-4 mb-4 shadow-sm border border-gray-100" id="review-card-${d.id}">
                       <div class="flex justify-between items-start mb-3">
                           <div class="flex items-center gap-2">
                               <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg font-bold">${val.grade || 'ุบูุฑ ูุญุฏุฏ'} | ${val.subject || 'ุบูุฑ ูุญุฏุฏ'}</span>
                               <span class="text-xs text-gray-500">${dateStr}</span>
                           </div>
                           <span class="text-xs text-gray-400">ุจูุงุณุทุฉ: ${author}</span>
                       </div>
                       
                       <p class="font-bold mb-3 text-gray-800 text-sm leading-6 border-r-2 border-indigo-200 pr-2">${val.question || 'ุจุฏูู ูุต'}</p>
                       
                       <div class="bg-gray-50 p-3 rounded-lg mb-4 text-xs space-y-2 border border-gray-100">
                           <p class="font-bold text-gray-500">${val.type==='mcq'?'ุงูุฎูุงุฑุงุช':'ููุน ุงูุณุคุงู'}:</p>
                           ${val.type==='mcq' ? `
                           <ul class="space-y-1">
                               ${val.answers?.map((ans, idx) => `
                               <li class="flex items-center gap-2 p-1 rounded ${idx === val.correct ? 'bg-green-50 text-green-700 font-bold' : 'text-gray-600'}">
                                   <span class="w-3 h-3 rounded-full ${idx === val.correct ? 'bg-green-500' : 'bg-gray-300'}"></span>
                                   <span>${ans || 'ุฎูุงุฑ ูุงุฑุบ'}</span>
                               </li>
                               `).join('') || ''}
                           </ul>
                           ` : `<p class="text-center font-bold ${val.correct==='true'?'text-green-600':'text-red-600'}">${val.correct==='true'?'ุตุญ':'ุฎุทุฃ'}</p>`}
                           
                           <p class="mt-2 text-green-600 font-bold text-center">
                               ุงูุฌูุงุจ ุงูุตุญูุญ: ${val.type==='mcq' ? (val.answers && val.answers[val.correct]) || 'ุบูุฑ ูุญุฏุฏ' : (val.correct==='true'?'ุตุญ':'ุฎุทุฃ')}
                           </p>
                       </div>
                       
                       <div class="flex gap-2">
                           <button onclick="approveQ('${d.id}')" class="flex-1 bg-green-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-green-600 transition flex items-center justify-center gap-1">
                               <i class="fas fa-check"></i> ูุจูู (+10)
                           </button>
                           <button onclick="rejectQ('${d.id}')" class="flex-1 bg-red-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-red-600 transition flex items-center justify-center gap-1">
                               <i class="fas fa-times"></i> ุฑูุถ
                           </button>
                       </div>
                   </div>`; 
                });
                
                div.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading review content:", error);
                div.innerHTML = '<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฃุณุฆูุฉ ูููุฑุงุฌุนุฉ</p>';
            }
        }

        // --- FIXED: ูุธุงุฆู ูุจูู ูุฑูุถ ุงูุฃุณุฆูุฉ ---
        window.approveQ = async (id) => {
            if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ูุจูู ูุฐุง ุงูุณุคุงูุ ุณูุญุตู ุงููุคูู ุนูู 10 ููุงุท.")) {
                return;
            }
            
            try {
                const card = document.getElementById(`review-card-${id}`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }
                
                const ref = doc(db, "pending_questions", id);
                const d = (await getDoc(ref)).data();
                
                if (!d) {
                    alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุคุงู");
                    return;
                }
                
                // Add to active questions
                await addDoc(collection(db, "questions"), {
                    ...d, 
                    status: 'approved',
                    approvedAt: serverTimestamp(),
                    approvedBy: currentUser.uid
                });
                
                // Reward 10 Points to author
                if (d.authorId) {
                    await updateDoc(doc(db, "users", d.authorId), { 
                        points: increment(10),
                        lastQuestionApproved: serverTimestamp()
                    });
                }
                
                // Update pending doc status to approved
                await updateDoc(ref, { 
                    status: 'approved',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: currentUser.uid
                });
                
                // Remove card from UI
                if (card) {
                    card.remove();
                }
                
                alert("โ ุชู ูุจูู ุงูุณุคุงู ูุชู ููุญ 10 ููุงุท ูููุณุชุฎุฏู!");
                
                // Update badge count
                checkAdminNotifications();
                
            } catch (error) {
                console.error("Error approving question:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุจูู ุงูุณุคุงู");
            }
        };

        window.rejectQ = async (id) => {
            if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฑูุถ ูุฐุง ุงูุณุคุงูุ")) {
                return;
            }
            
            try {
                const card = document.getElementById(`review-card-${id}`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                }
                
                // Update status to rejected
                await updateDoc(doc(db, "pending_questions", id), { 
                    status: 'rejected',
                    reviewedAt: serverTimestamp(),
                    reviewedBy: currentUser.uid
                });
                
                // Remove card from UI
                if (card) {
                    card.remove();
                }
                
                alert("ุชู ุฑูุถ ุงูุณุคุงู!");
                
                // Update badge count
                checkAdminNotifications();
                
            } catch (error) {
                console.error("Error rejecting question:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฑูุถ ุงูุณุคุงู");
            }
        };

        window.checkAdminNotifications = () => {
            if (!currentUser || userData.email !== ADMIN_EMAIL) return;
            
            const q = query(collection(db, "pending_questions"), where("status", "==", "pending"));
            
            if (adminListenerUnsubscribe) {
                adminListenerUnsubscribe();
            }
            
            adminListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                const badgeTab = document.getElementById('profile-tab-badge');
                const badgeBtn = document.getElementById('admin-btn-badge');
                
                if (count > 0) { 
                    badgeTab.classList.add('visible'); 
                    badgeBtn.classList.add('visible'); 
                } else { 
                    badgeTab.classList.remove('visible'); 
                    badgeBtn.classList.remove('visible'); 
                }
            }, (error) => {
                console.error("Admin notifications error:", error);
            });
        };

        // --- GAME FUNCTIONS - IMPROVED WITH EXIT BUTTON ---
        window.showExitConfirmation = () => {
            document.getElementById('exit-confirmation-modal').classList.remove('hidden');
        };

        window.cancelExit = () => {
            document.getElementById('exit-confirmation-modal').classList.add('hidden');
        };

        window.confirmExit = async () => {
            document.getElementById('exit-confirmation-modal').classList.add('hidden');
            
            // Deduct 5 points from current user
            try {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    points: increment(-5)
                });
                userData.points = Math.max(0, userData.points - 5);
                setupHeaderUI();
                
                // Add 5 points to opponent if online mode
                if (currentGameMode === 'online' && currentMatchId) {
                    const matchDoc = await getDoc(doc(db, "match_queue", currentMatchId));
                    if (matchDoc.exists()) {
                        const matchData = matchDoc.data();
                        const isP1 = matchData.player1.uid === currentUser.uid;
                        const opponentId = isP1 ? matchData.player2.uid : matchData.player1.uid;
                        
                        if (opponentId && opponentId !== 'AI_BOT') {
                            await updateDoc(doc(db, "users", opponentId), {
                                points: increment(5)
                            });
                        }
                    }
                    
                    // Delete the match from queue
                    await deleteDoc(doc(db, "match_queue", currentMatchId));
                }
                
                alert("ุชู ุงูุงูุณุญุงุจ. ุชู ุฎุตู 5 ููุงุท ูู ุฑุตูุฏู ูุฅุถุงูุชูุง ููููุงูุณ.");
                
            } catch (error) {
                console.error("Exit error:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงูุณุญุงุจ");
            }
            
            // Close game and return to challenges
            closeResultScreen();
        };

        function renderGame(data) {
             if (isExitingGame) return;
             if(!data.questions || data.currentIdx >= data.questions.length) { 
                 endGame(data); 
                 return; 
             }
             
             // Update player info
             if (currentGameMode === 'online') {
                const isP1 = data.player1.uid === currentUser.uid;
                
                // Player 1 (current user or opponent)
                document.getElementById('p1-name').innerText = userData.name;
                document.getElementById('p1-img-game').src = userData.photo || "https://ui-avatars.com/api/?name=User&background=random&size=128";
                document.getElementById('game-my-score').innerText = isP1 ? data.player1.score : data.player2.score;
                
                // Player 2 (opponent)
                const opponent = isP1 ? data.player2 : data.player1;
                document.getElementById('p2-name').innerText = opponent.name || "ุงูุฎุตู";
                document.getElementById('p2-img-game').src = opponent.photo || "https://ui-avatars.com/api/?name=Opponent&background=random&size=128";
                document.getElementById('game-op-score').innerText = isP1 ? data.player2.score : data.player1.score;
                
            } else {
                // AI mode
                document.getElementById('p1-name').innerText = userData.name;
                document.getElementById('p1-img-game').src = userData.photo || "https://ui-avatars.com/api/?name=User&background=random&size=128";
                document.getElementById('game-my-score').innerText = data.player1.score;
                
                document.getElementById('p2-name').innerText = data.player2.name;
                document.getElementById('p2-img-game').src = data.player2.photo;
                document.getElementById('game-op-score').innerText = data.player2.score;
            }

             const q = data.questions[data.currentIdx];
             const qTextEl = document.getElementById('q-text');

             if(qTextEl.innerText !== q.question) {
                hasAnsweredCurrentQ = false; 
                userAnsweredCorrectly = false; 
                currentQuestionCorrectAnswer = null;
                clearTimeout(aiTimeoutId);
                
                // Enable answers
                document.getElementById('answers-container').classList.remove('pointer-events-none', 'opacity-50');
                document.getElementById('waiting-msg').classList.add('hidden');
                document.getElementById('ai-thinking-msg').classList.add('hidden');
                
                // Start timer
                clearInterval(gameTimer);
                let t = 15;
                document.getElementById('game-timer').innerText = t;
                gameTimer = setInterval(() => {
                    if (isExitingGame) { 
                        clearInterval(gameTimer); 
                        return; 
                    }
                    t--; 
                    document.getElementById('game-timer').innerText = t;
                    
                    // Update timer color when time is running out
                    if (t <= 5) {
                        document.getElementById('game-timer').classList.add('bg-red-600');
                        document.getElementById('game-timer').classList.remove('bg-gray-800');
                    }
                    
                    if(t <= 0) { 
                        clearInterval(gameTimer); 
                        if(!hasAnsweredCurrentQ) {
                            submitGameAnswer(null, q, data); 
                        } else if (currentGameMode === 'ai') {
                            handleAINextTurn(); 
                        }
                    }
                }, 1000);
                
                // Update progress
                document.getElementById('q-progress').innerText = `${data.currentIdx + 1} / 10`;
                qTextEl.innerText = q.question || "ุณุคุงู ุจุฏูู ูุต";
                
                // Create answer buttons
                const div = document.getElementById('answers-container');
                div.innerHTML = '';
                let ansList = [];
                
                if(q.type === 'mcq') {
                    ansList = q.answers.map((txt, idx) => ({ 
                        txt: txt || `ุงูุฎูุงุฑ ${idx + 1}`, 
                        isCorrect: idx === q.correct, 
                        value: idx 
                    }));
                } else {
                    ansList = [ 
                        { txt: 'ุตุญ', isCorrect: q.correct === 'true' || q.correct === true, value: 'true' }, 
                        { txt: 'ุฎุทุฃ', isCorrect: q.correct === 'false' || q.correct === false, value: 'false' } 
                    ];
                }
                
                const correctAns = ansList.find(ans => ans.isCorrect);
                if (correctAns) currentQuestionCorrectAnswer = correctAns.value;
                
                // Shuffle answers
                ansList.sort(() => 0.5 - Math.random());
                
                ansList.forEach(ansObj => {
                    const btn = document.createElement('button');
                    btn.className = "answer-neutral w-full py-4 border-2 rounded-xl text-lg font-bold shadow-sm active:scale-95 transition hover:bg-gray-50";
                    btn.innerText = ansObj.txt;
                    btn.dataset.value = ansObj.value;
                    btn.onclick = () => { 
                        if(hasAnsweredCurrentQ) return; 
                        submitGameAnswer(ansObj, q, data); 
                    };
                    div.appendChild(btn);
                });
             }
        }

        async function submitGameAnswer(ansObj, q, matchData) {
            if(hasAnsweredCurrentQ || isExitingGame) return;
            hasAnsweredCurrentQ = true;
            userAnsweredCorrectly = ansObj && ansObj.isCorrect;
            
            const answerButtons = document.querySelectorAll('#answers-container button');
            answerButtons.forEach(btn => {
                btn.classList.remove('answer-correct', 'answer-wrong', 'answer-neutral', 'hover:bg-gray-50');
                if (btn.dataset.value.toString() === currentQuestionCorrectAnswer.toString()) {
                    btn.classList.add('answer-correct');
                } else if (ansObj && btn.dataset.value.toString() === (ansObj.value?.toString())) {
                    btn.classList.add('answer-wrong');
                } else {
                    btn.classList.add('answer-neutral');
                }
                btn.style.pointerEvents = 'none';
            });
            
            document.getElementById('answers-container').classList.add('pointer-events-none', 'opacity-90');
            
            if (currentGameMode === 'online') {
                document.getElementById('waiting-msg').classList.remove('hidden');
                if (!currentMatchId) return;
                
                const isP1 = matchData.player1.uid === currentUser.uid;
                const scoreIncrement = ansObj && ansObj.isCorrect ? 1 : 0;
                const updates = { 
                    answersCount: increment(1),
                    lastAnswerAt: serverTimestamp()
                };
                
                if(ansObj && ansObj.isCorrect) {
                    updates[isP1 ? 'player1.score' : 'player2.score'] = increment(scoreIncrement);
                }
                
                await updateDoc(doc(db, "match_queue", currentMatchId), updates);
                
                // Check if both players have answered
                const newAnswersCount = (matchData.answersCount || 0) + 1;
                if (newAnswersCount >= 2) {
                    // Move to next question after short delay
                    setTimeout(async () => {
                        if (isExitingGame) return;
                        
                        const nextIdx = (matchData.currentIdx || 0) + 1;
                        await updateDoc(doc(db, "match_queue", currentMatchId), {
                            currentIdx: nextIdx,
                            answersCount: 0
                        });
                    }, 2000);
                }
                
            } else {
                // AI mode
                document.getElementById('waiting-msg').classList.add('hidden');
                if(ansObj && ansObj.isCorrect) {
                    localMatchData.player1.score += 1;
                    document.getElementById('game-my-score').innerText = localMatchData.player1.score;
                }
                triggerAIResponse();
            }
        }

        function triggerAIResponse() {
            document.getElementById('waiting-msg').classList.add('hidden');
            document.getElementById('ai-thinking-msg').classList.remove('hidden');
            
            let delay = 3000; 
            let accuracy = 0.5;
            
            if (aiDifficulty === 'hard') { 
                delay = 3500; 
                accuracy = 0.7; 
            }
            if (aiDifficulty === 'easy') { 
                delay = 2500; 
                accuracy = 0.25; 
            }
            
            aiTimeoutId = setTimeout(() => {
                if(Math.random() < accuracy) {
                    localMatchData.player2.score += 1;
                    document.getElementById('game-op-score').innerText = localMatchData.player2.score;
                }
                localMatchData.currentIdx += 1;
                localMatchData.answersCount = 0;
                renderGame(localMatchData);
            }, delay);
        }

        function handleAINextTurn() {
            localMatchData.currentIdx += 1;
            localMatchData.answersCount = 0;
            renderGame(localMatchData);
        }

        async function endGame(d) {
            clearInterval(gameTimer);
            clearTimeout(aiTimeoutId);
            
            if (isExitingGame) return;
            
            let myScore, opScore, opponentId = null;
            
            if (currentGameMode === 'online') {
                const isP1 = d.player1.uid === currentUser.uid;
                myScore = isP1 ? d.player1.score : d.player2.score; 
                opScore = isP1 ? d.player2.score : d.player1.score;
                opponentId = isP1 ? d.player2.uid : d.player1.uid;
                
                // Mark match as completed
                if (currentMatchId) {
                    try {
                        await updateDoc(doc(db, "match_queue", currentMatchId), {
                            status: 'completed',
                            completedAt: serverTimestamp(),
                            winner: myScore > opScore ? currentUser.uid : (myScore < opScore ? opponentId : 'draw')
                        });
                    } catch (e) {
                        console.error("Error marking match as completed:", e);
                    }
                }
            } else {
                myScore = localMatchData.player1.score; 
                opScore = localMatchData.player2.score;
            }
            
            let pointsGained = 0; 
            let msg = ""; 
            let icon = "";
            
            if (myScore > opScore) { 
                msg = "ููุฒ ุณุงุญู!"; 
                icon = "๐"; 
                pointsGained = myScore * 2; 
            } else if (myScore < opScore) { 
                msg = "ุญุธ ุฃููุฑ!"; 
                icon = "๐ข"; 
                pointsGained = Math.floor(myScore / 2); // Some points even if you lose
            } else { 
                if(myScore > 0) { 
                    msg = "ุชุนุงุฏู ุฅูุฌุงุจู!"; 
                    icon = "๐ค"; 
                    pointsGained = myScore; 
                } else { 
                    msg = "ุชุนุงุฏู ุณูุจู!"; 
                    icon = "๐"; 
                    pointsGained = 0; 
                } 
            }

            if(pointsGained > 0) {
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { 
                        points: increment(pointsGained),
                        lastGamePoints: pointsGained,
                        lastGamePlayed: serverTimestamp()
                    });
                    userData.points += pointsGained;
                    setupHeaderUI();
                } catch (e) {
                    console.error("Error updating points:", e);
                }
            }
            
            document.getElementById('result-icon-container').innerText = icon;
            document.getElementById('result-title').innerText = msg;
            document.getElementById('final-my-score').innerText = myScore;
            document.getElementById('final-op-score').innerText = opScore;
            document.getElementById('result-points-gained').innerText = `+${pointsGained}`;
            
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-screen').style.display = 'flex';
        }

        // --- FIXED: ุฒุฑ ุงูุนูุฏุฉ ูX ุนูุฏ ุงูุชูุงุก ุงูุชุญุฏู (ุชู ุฅุตูุงุญู ุชูุงูุงู) ---
        window.closeResultScreen = async () => {
             isExitingGame = true;
             
             if (matchListenerUnsubscribe) { 
                 matchListenerUnsubscribe(); 
                 matchListenerUnsubscribe = null; 
             }
             
             if (adminListenerUnsubscribe && userData.email === ADMIN_EMAIL) {
                 // Keep admin listener if user is admin
             } else if (adminListenerUnsubscribe) {
                 adminListenerUnsubscribe();
                 adminListenerUnsubscribe = null;
             }
             
             clearInterval(gameTimer); 
             clearTimeout(aiTimeoutId);
             
             // Hide all game related screens
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('game-overlay').classList.add('hidden');
             document.getElementById('searching-ui').classList.add('hidden');
             document.getElementById('vs-screen').classList.add('hidden');
             document.getElementById('exit-confirmation-modal').classList.add('hidden');
             
             // Reset all game variables
             currentMatchId = null; 
             localMatchData = null; 
             hasAnsweredCurrentQ = false;
             currentGameMode = 'online';
             aiDifficulty = 'medium';
             currentQuestionCorrectAnswer = null;
             userAnsweredCorrectly = false;
             
             // Show challenge card
             document.getElementById('challenge-active-card').classList.remove('hidden');
             
             // Refresh user data
             if(currentUser) {
                 try {
                     const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                     if(userDoc.exists()) { 
                         userData = userDoc.data(); 
                         setupHeaderUI(); 
                         setupProfileUI(); 
                     }
                     loadLeaderboard();
                 } catch(e) {
                     console.error("Error refreshing user data:", e);
                 }
             }
             
             // Switch back to challenges tab
             switchTab('challenges');
             
             // Reset exiting flag after delay
             setTimeout(() => { 
                 isExitingGame = false; 
                 
                 // Ensure all overlays are hidden
                 document.getElementById('game-overlay').style.display = 'none';
                 document.getElementById('result-screen').style.display = 'none';
                 document.getElementById('searching-ui').style.display = 'none';
                 document.getElementById('vs-screen').style.display = 'none';
                 document.getElementById('exit-confirmation-modal').style.display = 'none';
                 
                 // Reset timer color
                 const timerEl = document.getElementById('game-timer');
                 if (timerEl) {
                     timerEl.classList.remove('bg-red-600');
                     timerEl.classList.add('bg-gray-800');
                 }
                 
             }, 100);
        };
        
        window.cancelSearch = async () => {
            if(currentMatchId && currentGameMode === 'online') { 
                try { 
                    await deleteDoc(doc(db, "match_queue", currentMatchId)); 
                } catch(e) {
                    console.error("Error deleting match:", e);
                }
            }
            
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            
            // Reset match variables
            currentMatchId = null;
            isExitingGame = false;
        };

        // --- AUTH & OTHER HELPERS ---
        window.handleLogin = async () => { 
            try { 
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-pass').value;
                
                if (!email || !password) {
                    alert("ูุฑุฌู ููุก ูุงูุฉ ุงูุญููู");
                    return;
                }
                
                await signInWithEmailAndPassword(auth, email, password);
            } catch (e) { 
                console.error("Login error:", e);
                alert(getArabicError(e.code)); 
            } 
        };
        
        window.switchAuthTab = (tab) => {
            if(tab === 'login') { 
                document.getElementById('login-form').classList.remove('hidden'); 
                document.getElementById('signup-form').classList.add('hidden'); 
                document.getElementById('tab-login-btn').classList.add('active'); 
                document.getElementById('tab-signup-btn').classList.remove('active'); 
            } else { 
                document.getElementById('login-form').classList.add('hidden'); 
                document.getElementById('signup-form').classList.remove('hidden'); 
                document.getElementById('tab-login-btn').classList.remove('active'); 
                document.getElementById('tab-signup-btn').classList.add('active'); 
            }
        };
        
        window.openForgotPassword = () => { 
            document.getElementById('forgot-password-modal').classList.remove('hidden'); 
            document.getElementById('forgot-password-modal').style.display = 'flex'; 
        };
        
        window.closeForgotPassword = () => { 
            document.getElementById('forgot-password-modal').classList.add('hidden'); 
        };
        
        window.sendResetLink = async () => {
            const email = document.getElementById('forgot-email').value;
            if (!email) {
                alert("ูุฑุฌู ุฅุฏุฎุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู");
                return;
            }
            
            try { 
                await sendPasswordResetEmail(auth, email); 
                alert('โ ุชู ุฅุฑุณุงู ุฑุงุจุท ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ุฅูู ุจุฑูุฏู ุงูุฅููุชุฑููู'); 
                closeForgotPassword(); 
            } catch(e) { 
                console.error("Password reset error:", e);
                alert(getArabicError(e.code)); 
            }
        };
        
        window.logout = () => { 
            if(adminListenerUnsubscribe) adminListenerUnsubscribe(); 
            if(matchListenerUnsubscribe) matchListenerUnsubscribe();
            signOut(auth); 
        };
        
        function getArabicError(code) {
             switch(code) {
                case 'auth/email-already-in-use': return 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู';
                case 'auth/user-disabled': return 'ุชู ุชุนุทูู ูุฐุง ุงูุญุณุงุจ';
                case 'auth/user-not-found': return 'ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ';
                case 'auth/wrong-password': return 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ';
                case 'auth/too-many-requests': return 'ุชู ุชุฌุงูุฒ ุนุฏุฏ ุงููุญุงููุงุช ุงููุณููุญ ุจูุง. ุญุงูู ูุฑุฉ ุฃุฎุฑู ูุงุญูุงู';
                case 'auth/network-request-failed': return 'ุฎุทุฃ ูู ุงูุดุจูุฉ. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช';
                case 'auth/invalid-email': return 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุงูุญ';
                case 'auth/weak-password': return 'ูููุฉ ุงููุฑูุฑ ุถุนููุฉ ุฌุฏุงู';
                default: return 'ุญุฏุซ ุฎุทุฃ: ' + code;
             }
        }
        
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => { 
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set maximum dimensions
                        let width = img.width;
                        let height = img.height;
                        const maxWidth = 400;
                        const maxHeight = 400;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = height * (maxWidth / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = width * (maxHeight / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }
        
        function generateId() { 
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function generateDeviceId() {
            return 'DEV_' + Math.random().toString(36).substr(2, 9).toUpperCase();
        }
        
        window.handleImagePreview = (input) => { 
            if(input.files && input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => {
                    const img = document.getElementById('preview-img');
                    img.src = e.target.result;
                    img.onerror = () => {
                        img.src = 'https://ui-avatars.com/api/?name=User&background=random&size=128';
                    };
                }; 
                reader.readAsDataURL(input.files[0]); 
            } 
        };
        
        // --- ADMIN UI SETUP ---
        function setupAdminUI() { 
            if (userData.email === ADMIN_EMAIL) { 
                document.getElementById('admin-buttons').classList.remove('hidden'); 
                document.getElementById('admin-challenge-controls').classList.remove('hidden');
                checkAdminNotifications();
            } 
        }
        
        function listenToSystemStatus() {
             onSnapshot(doc(db, "system_settings", "config"), (docSnap) => {
                 if (docSnap.exists()) { 
                     const d = docSnap.data(); 
                     systemConfig.enabled = d.challengesEnabled !== undefined ? d.challengesEnabled : true; 
                     systemConfig.msg = d.maintenanceMessage || "ุงููุธุงู ูู ูุถุน ุงูุตูุงูุฉ";
                     
                     const toggle = document.getElementById('system-toggle');
                     const statusText = document.getElementById('system-status-text');
                     const msgInput = document.getElementById('maintenance-msg-input');
                     
                     if (toggle) {
                         toggle.checked = systemConfig.enabled;
                         if (!systemConfig.enabled) {
                             statusText.innerText = "ุงููุธุงู ูุชููู โ (ุงูุทูุงุจ ูุฑูู ุงูุฑุณุงูุฉ)";
                             statusText.className = "text-xs font-bold text-red-400 mb-2";
                         } else {
                             statusText.innerText = "ุงููุธุงู ูุนูู ุญุงููุงู โ";
                             statusText.className = "text-xs font-bold text-green-400 mb-2";
                         }
                         if (msgInput && document.activeElement !== msgInput) {
                              msgInput.value = systemConfig.msg;
                         }
                     }
                 }
             }, (error) => {
                 console.error("System status listener error:", error);
             });
        }
        
        async function loadDisabledSubjects() { 
            try { 
                const d = await getDoc(doc(db, "system_settings", "disabled_subjects")); 
                disabledSubjects = d.exists() ? d.data() : {}; 
            } catch(e){ 
                console.error("Error loading disabled subjects:", e);
                disabledSubjects = {}; 
            } 
        }

        function isSubjectEnabled(grade, type, subject) {
            const key = `${grade}_${type}`;
            return !disabledSubjects[key] || !disabledSubjects[key][subject];
        }

        function getEnabledSubjects(grade, type) {
            if (!subjects[grade]) return [];
            return subjects[grade].filter(subject => isSubjectEnabled(grade, type, subject));
        }

        function updateUploadUIBasedOnSubjects() {
            if (!userData || !userData.grade) return;
            
            const grade = userData.grade;
            const mcqEnabled = getEnabledSubjects(grade, 'mcq').length > 0;
            const tfEnabled = getEnabledSubjects(grade, 'tf').length > 0;
            
            const typeSelect = document.getElementById('up-type');
            const originalHTML = typeSelect.innerHTML;
            let newHTML = '';
            
            if (mcqEnabled) newHTML += '<option value="mcq">ุงุฎุชูุงุฑุงุช</option>';
            if (tfEnabled) newHTML += '<option value="tf">ุตุญ ูุฎุทุฃ</option>';
            
            if (newHTML === '') {
                newHTML = '<option value="" disabled>ูุง ุชูุฌุฏ ุฃููุงุน ูุชุงุญุฉ</option>';
            }
            
            typeSelect.innerHTML = newHTML;
            
            if (mcqEnabled && !tfEnabled) typeSelect.value = 'mcq';
            if (!mcqEnabled && tfEnabled) typeSelect.value = 'tf';
            
            // Update subject dropdown based on selected type
            const selectedType = typeSelect.value;
            populateSubjects(userData.grade, 'up-subject', selectedType);
        }

        // --- UPLOAD ---
        window.nextUploadStep = () => {
             const sub = document.getElementById('up-subject').value; 
             if (!sub) {
                 alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฏุฉ");
                 return;
             }
             
             document.getElementById('up-step-1').classList.add('hidden'); 
             document.getElementById('up-step-2').classList.remove('hidden');
             
             const type = document.getElementById('up-type').value;
             if(type === 'mcq') { 
                 document.getElementById('up-mcq-container').classList.remove('hidden'); 
                 document.getElementById('up-tf-container').classList.add('hidden'); 
             } else { 
                 document.getElementById('up-mcq-container').classList.add('hidden'); 
                 document.getElementById('up-tf-container').classList.remove('hidden'); 
             }
        };
        
        window.submitUploadQuestion = async () => {
             const sub = document.getElementById('up-subject').value; 
             const type = document.getElementById('up-type').value; 
             const txt = document.getElementById('up-q-text').value.trim();
             
             if(!txt) {
                 alert("ูุฑุฌู ูุชุงุจุฉ ูุต ุงูุณุคุงู");
                 return;
             }
             
             if(txt.length < 5) {
                 alert("ูุต ุงูุณุคุงู ูุตูุฑ ุฌุฏุงู");
                 return;
             }
             
             let q = { 
                 grade: userData.grade, 
                 subject: sub, 
                 type, 
                 question: txt, 
                 authorId: currentUser.uid, 
                 authorName: userData.name, 
                 createdAt: serverTimestamp(), 
                 status: 'pending' 
             };
             
             if(type === 'mcq') { 
                 const a0 = document.getElementById('ans-0').value.trim();
                 const a1 = document.getElementById('ans-1').value.trim();
                 const a2 = document.getElementById('ans-2').value.trim();
                 
                 if(!a0 || !a1 || !a2) {
                     alert("ูุฑุฌู ููุก ุฌููุน ุงูุฎูุงุฑุงุช");
                     return;
                 }
                 
                 q.answers = [a0, a1, a2]; 
                 q.correct = parseInt(document.querySelector('input[name="correct"]:checked').value); 
             } else { 
                 q.correct = document.getElementById('up-tf-val').value; 
             }
             
             try {
                 await addDoc(collection(db, "pending_questions"), q);
                 
                 // Reset form
                 document.getElementById('up-q-text').value = "";
                 if (type === 'mcq') {
                     document.getElementById('ans-0').value = "";
                     document.getElementById('ans-1').value = "";
                     document.getElementById('ans-2').value = "";
                 }
                 
                 document.getElementById('up-step-2').classList.add('hidden'); 
                 document.getElementById('up-step-1').classList.remove('hidden');
                 
                 alert("โ ุชู ุฅุฑุณุงู ุงูุณุคุงู ุจูุฌุงุญ ูููุฑุงุฌุนุฉ!");
                 
             } catch (error) {
                 console.error("Error submitting question:", error);
                 alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุณุคุงู");
             }
        };
        
        function updateUploadUI() { 
            if(userData && userData.grade) { 
                updateUploadUIBasedOnSubjects();
                const type = document.getElementById('up-type').value;
                populateSubjects(userData.grade, 'up-subject', type);
                
                document.getElementById('up-type').onchange = function() {
                    populateSubjects(userData.grade, 'up-subject', this.value);
                };
            } 
        }
        
        function populateSubjects(grade, elementId, type = null) {
            const sel = document.getElementById(elementId);
            if(!sel) return;
            
            let filteredSubjects = [];
            if (type) {
                filteredSubjects = getEnabledSubjects(grade, type);
            } else {
                filteredSubjects = subjects[grade] || [];
            }
            
            sel.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>';
            filteredSubjects.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            
            if (filteredSubjects.length === 0) {
                sel.innerHTML += '<option value="" disabled>ูุง ุชูุฌุฏ ููุงุฏ ูุชุงุญุฉ</option>';
            }
        }
        
        window.saveUserGrade = async () => { 
            const g = document.getElementById('grade-select').value; 
            if (!g) {
                alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ");
                return;
            }
            
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { 
                    grade: g,
                    gradeSetAt: serverTimestamp()
                });
                location.reload();
            } catch (error) {
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุฑุญูุฉ");
                console.error("Save grade error:", error);
            }
        };
        
        window.updateProfilePic = async (input) => { 
            if(input.files && input.files[0]) { 
                try {
                    const p = await compressImage(input.files[0]);
                    await updateDoc(doc(db, "users", currentUser.uid), { 
                        photo: p,
                        photoUpdatedAt: serverTimestamp()
                    });
                    document.getElementById('profile-img').src = p;
                    alert("โ ุชู ุชุญุฏูุซ ุงูุตูุฑุฉ ุจูุฌุงุญ!");
                } catch (error) {
                    console.error("Error updating profile picture:", error);
                    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุตูุฑุฉ");
                }
            } 
        };
        
        // --- FIXED: ุฒุฑ "ุญุณูุง" ูู ูุงูุฐุฉ ุงูุฅููุงู (ุชู ุฅุตูุงุญู ุชูุงูุงู) ---
        window.closeMaintenancePopup = () => { 
            document.getElementById('maintenance-popup').classList.add('hidden'); 
            document.getElementById('maintenance-popup').style.display = 'none';
            switchTab('challenges'); 
        };

        // --- SYSTEM TOGGLE FUNCTIONS ---
        window.toggleSystemUI = () => {
             const toggle = document.getElementById('system-toggle');
             const statusText = document.getElementById('system-status-text');

             if (!toggle.checked) {
                 statusText.innerText = "ุงููุธุงู ูุชููู โ (ุณูุชู ุงูุญูุธ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ)";
                 statusText.className = "text-xs font-bold text-red-400 mb-2";
             } else {
                 statusText.innerText = "ุงููุธุงู ูุนูู ุญุงููุงู โ (ุณูุชู ุงูุญูุธ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ)";
                 statusText.className = "text-xs font-bold text-green-400 mb-2";
             }
        };

        window.saveSystemSettings = async () => {
            const isEnabled = document.getElementById('system-toggle').checked;
            const msg = document.getElementById('maintenance-msg-input').value.trim();
            
            if (!isEnabled && !msg) {
                alert("ูุฑุฌู ูุชุงุจุฉ ุฑุณุงูุฉ ุชูุถูุญูุฉ ูููุณุชุฎุฏููู ุนูุฏ ุฅููุงู ุงููุธุงู.");
                return;
            }

            try {
                await setDoc(doc(db, "system_settings", "config"), {
                    challengesEnabled: isEnabled,
                    maintenanceMessage: msg,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                }, { merge: true });
                
                alert("โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ุจูุฌุงุญ!");
                
            } catch (e) {
                console.error("Error saving system settings:", e);
                alert("ุฎุทุฃ ูู ุงูุญูุธ: " + e.message);
            }
        };

        // --- NEW ADMIN FEATURES FROM SECOND CODE ---
        async function loadAdminAllContent() {
             const div = document.getElementById('admin-all-list');
             if(allAdminQuestions.length === 0) {
                 div.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุฌูุจ ูู ุงูุฃุณุฆูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...</p>';
                 try {
                     const q = await getDocs(collection(db, "questions"));
                     allAdminQuestions = [];
                     q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
                     filterAdminQuestions();
                 } catch (error) {
                     console.error("Error loading admin questions:", error);
                     div.innerHTML = '<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฃุณุฆูุฉ</p>';
                 }
             } else {
                 filterAdminQuestions();
             }
        }

        window.populateAdminFilterSubjects = () => {
            const grade = document.getElementById('admin-filter-grade').value;
            const subSel = document.getElementById('admin-filter-subject');
            subSel.innerHTML = '<option value="">ูู ุงูููุงุฏ</option>';
            if(grade && subjects[grade]) {
                subjects[grade].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            }
        }

        window.renderAdminAllList = (list) => {
            const div = document.getElementById('admin-all-list');
            if(list.length === 0) { 
                div.innerHTML = "<p class='text-center text-gray-400 mt-4'>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>"; 
                return; 
            }
            
            let html = `<p class="text-xs text-gray-400 mb-2">ุชู ุงูุนุซูุฑ ุนูู: ${list.length} ุณุคุงู</p>`;
            
            list.slice(0, 50).forEach(q => { 
                const dateStr = q.createdAt?.toDate ? 
                    q.createdAt.toDate().toLocaleDateString('ar-EG') : 
                    "ุชุงุฑูุฎ ุบูุฑ ูุนุฑูู";
                    
                html += `
                <div class="bg-white rounded-xl p-3 mb-3 border border-gray-100 shadow-sm flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">${q.grade || 'ุบูุฑ ูุญุฏุฏ'} | ${q.subject || 'ุบูุฑ ูุญุฏุฏ'}</span>
                            <span class="text-xs text-gray-400">${q.type==='mcq'?'ุงุฎุชูุงุฑุงุช':'ุตุญ/ุฎุทุฃ'}</span>
                            <span class="text-xs text-gray-400">${dateStr}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="openEditModal('${q.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200 transition flex items-center gap-1">
                                <i class="fas fa-edit"></i> ุชุนุฏูู
                            </button>
                            <button onclick="deleteApprovedQ('${q.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200 transition flex items-center gap-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="font-bold text-gray-700 text-sm leading-6 border-r-2 border-indigo-200 pr-2">${q.question || 'ุจุฏูู ูุต'}</p>
                </div>`;
            });
            
            div.innerHTML = html;
        };

        window.filterAdminQuestions = () => {
            if(event && event.target && event.target.id === 'admin-filter-grade') {
                 populateAdminFilterSubjects();
            }

            const gr = document.getElementById('admin-filter-grade').value;
            const sub = document.getElementById('admin-filter-subject').value;
            
            const filtered = allAdminQuestions.filter(q => {
                const matchesGrade = gr ? (q.grade === gr) : true;
                const matchesSubject = sub ? (q.subject === sub) : true;
                return matchesGrade && matchesSubject;
            });
            
            renderAdminAllList(filtered);
        };

        // QUESTION STATS
        window.resetStatsUI = () => {
             document.getElementById('stats-result-container').innerHTML = '<p class="text-center text-gray-400 text-sm mt-10">ุงุฎุชุฑ ุงูุจูุงูุงุช ูุงุถุบุท ุญุณุงุจ</p>';
        }

        window.calculateQuestionStats = async () => {
            const grade = document.getElementById('stat-grade').value;
            const type = document.getElementById('stat-type').value;
            const resultDiv = document.getElementById('stats-result-container');
            
            resultDiv.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุงูุญุณุงุจ ุจุฏูุฉ...</p>';

            try {
                if(allAdminQuestions.length === 0) {
                     const q = await getDocs(collection(db, "questions"));
                     allAdminQuestions = [];
                     q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
                }

                const gradeSubjects = subjects[grade] || [];
                
                let html = "";
                let totalForGrade = 0;

                gradeSubjects.forEach(sub => {
                    const count = allAdminQuestions.filter(q => 
                        q.grade === grade && 
                        q.type === type && 
                        q.subject === sub &&
                        (q.status === 'approved' || !q.status)
                    ).length;

                    totalForGrade += count;

                    html += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100">
                        <span class="font-bold text-gray-700">${sub}</span>
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg font-bold text-sm">${count}</span>
                    </div>`;
                });

                const summaryHtml = `
                <div class="bg-indigo-50 p-3 rounded-xl mb-3 border border-indigo-100 text-center">
                    <p class="text-xs text-indigo-500 font-bold">ุงููุฌููุน ุงูููู ููุฐุง ุงููุณู</p>
                    <p class="text-2xl font-black text-indigo-800">${totalForGrade}</p>
                    <p class="text-xs text-indigo-400 mt-1">${getGradeName(grade)} - ${type === 'mcq' ? 'ุงุฎุชูุงุฑุงุช' : 'ุตุญ ูุฎุทุฃ'}</p>
                </div>
                `;

                resultDiv.innerHTML = summaryHtml + (html || '<p class="text-center text-gray-400">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ</p>');
                
            } catch (error) {
                console.error("Error calculating stats:", error);
                resultDiv.innerHTML = '<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุงูุญุณุงุจ</p>';
            }
        };

        // SUBJECT MANAGEMENT
        async function loadSubjectManagement() {
            const grade = document.getElementById('subject-grade').value;
            const type = document.getElementById('subject-type').value;
            const container = document.getElementById('subject-management-list');
            
            if (!grade || !type) return;
            
            container.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุชุญููู ุงูููุงุฏ...</p>';
            
            try {
                const key = `${grade}_${type}`;
                const currentDisabled = disabledSubjects[key] || {};
                
                let html = '';
                const gradeSubjects = subjects[grade] || [];
                
                gradeSubjects.forEach(subject => {
                    const isDisabled = currentDisabled[subject] === true;
                    html += `
                    <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm flex justify-between items-center">
                        <div>
                            <p class="font-bold text-gray-800">${subject}</p>
                            <p class="text-xs text-gray-400">${getGradeName(grade)} - ${type === 'mcq' ? 'ุงุฎุชูุงุฑุงุช' : 'ุตุญ ูุฎุทุฃ'}</p>
                        </div>
                        <label class="toggle-wrapper">
                            <input type="checkbox" class="toggle-checkbox" ${isDisabled ? '' : 'checked'} 
                                   onchange="toggleSubject('${grade}', '${type}', '${subject}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>`;
                });
                
                if (gradeSubjects.length === 0) {
                    html = '<p class="text-center text-gray-400">ูุง ุชูุฌุฏ ููุงุฏ ููุฐู ุงููุฑุญูุฉ</p>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading subject management:", error);
                container.innerHTML = '<p class="text-center text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูููุงุฏ</p>';
            }
        }

        window.toggleSubject = async function(grade, type, subject, enabled) {
            const key = `${grade}_${type}`;
            
            if (!disabledSubjects[key]) {
                disabledSubjects[key] = {};
            }
            
            if (enabled) {
                delete disabledSubjects[key][subject];
            } else {
                disabledSubjects[key][subject] = true;
            }
            
            try {
                await setDoc(doc(db, "system_settings", "disabled_subjects"), disabledSubjects, { merge: true });
                alert(`โ ุชู ${enabled ? 'ุชูุนูู' : 'ุชุนุทูู'} ุงููุงุฏุฉ ${subject} ูููุน ${type === 'mcq' ? 'ุงูุงุฎุชูุงุฑุงุช' : 'ุตุญ ูุฎุทุฃ'}`);
                
                // Reload the management list
                loadSubjectManagement();
                
                // Update upload UI if user is on upload tab
                updateUploadUIBasedOnSubjects();
                if (document.getElementById('tab-upload').classList.contains('active')) {
                    const currentType = document.getElementById('up-type').value;
                    populateSubjects(userData.grade, 'up-subject', currentType);
                }
                
            } catch (e) {
                console.error("Error toggling subject:", e);
                alert('โ ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูุชุบููุฑุงุช: ' + e.message);
            }
        };

        // EDIT QUESTION MODAL FUNCTIONS
        window.openEditModal = (id) => {
            const q = allAdminQuestions.find(i => i.id === id);
            if(!q) {
                alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุคุงู");
                return;
            }

            document.getElementById('edit-q-id').value = id;
            document.getElementById('edit-q-text').value = q.question || '';
            document.getElementById('edit-q-grade').value = q.grade || '6sci';
            
            const subSel = document.getElementById('edit-q-subject');
            subSel.innerHTML = "";
            const gradeSubjects = subjects[q.grade || '6sci'] || [];
            gradeSubjects.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            subSel.value = q.subject || '';

            // Update subject dropdown when grade changes
            document.getElementById('edit-q-grade').onchange = () => {
                const g = document.getElementById('edit-q-grade').value;
                subSel.innerHTML = "";
                const subjectsList = subjects[g] || [];
                subjectsList.forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            };

            if(q.type === 'mcq') {
                document.getElementById('edit-mcq-fields').classList.remove('hidden');
                document.getElementById('edit-tf-fields').classList.add('hidden');
                
                document.getElementById('edit-ans-0').value = q.answers ? q.answers[0] || '' : '';
                document.getElementById('edit-ans-1').value = q.answers ? q.answers[1] || '' : '';
                document.getElementById('edit-ans-2').value = q.answers ? q.answers[2] || '' : '';
                document.getElementById('edit-correct-mcq').value = q.correct || '0';
            } else {
                document.getElementById('edit-mcq-fields').classList.add('hidden');
                document.getElementById('edit-tf-fields').classList.remove('hidden');
                document.getElementById('edit-correct-tf').value = q.correct || 'true';
            }

            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveFullEditQ = async () => {
            const id = document.getElementById('edit-q-id').value;
            const originalQ = allAdminQuestions.find(i => i.id === id);
            
            if (!originalQ) {
                alert("ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุคุงู");
                return;
            }
            
            const type = originalQ.type;
            const questionText = document.getElementById('edit-q-text').value.trim();
            
            if (!questionText) {
                alert("ูุฑุฌู ุฅุฏุฎุงู ูุต ุงูุณุคุงู");
                return;
            }

            const updates = {
                question: questionText,
                grade: document.getElementById('edit-q-grade').value,
                subject: document.getElementById('edit-q-subject').value,
                updatedAt: serverTimestamp(),
                updatedBy: currentUser.uid
            };

            if(type === 'mcq') {
                const ans0 = document.getElementById('edit-ans-0').value.trim();
                const ans1 = document.getElementById('edit-ans-1').value.trim();
                const ans2 = document.getElementById('edit-ans-2').value.trim();
                
                if (!ans0 || !ans1 || !ans2) {
                    alert("ูุฑุฌู ููุก ุฌููุน ุงูุฎูุงุฑุงุช");
                    return;
                }
                
                updates.answers = [ans0, ans1, ans2];
                updates.correct = parseInt(document.getElementById('edit-correct-mcq').value);
            } else {
                updates.correct = document.getElementById('edit-correct-tf').value;
            }

            try {
                await updateDoc(doc(db, "questions", id), updates);
                
                // Update local array
                const idx = allAdminQuestions.findIndex(i => i.id === id);
                if(idx !== -1) {
                    allAdminQuestions[idx] = { ...allAdminQuestions[idx], ...updates };
                }
                
                // Refresh current view
                const activeScreen = document.querySelector('.screen.active').id;
                if (activeScreen === 'screen-admin-all') filterAdminQuestions();
                if (activeScreen === 'screen-admin-stats') calculateQuestionStats();

                document.getElementById('edit-modal').classList.add('hidden');
                alert("โ ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ!");
                
            } catch (error) {
                console.error("Error saving edit:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุชุนุฏููุงุช");
            }
        };

        window.deleteApprovedQ = async (id) => {
            if(!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงู ููุงุฆูุงูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.")) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, "questions", id));
                allAdminQuestions = allAdminQuestions.filter(q => q.id !== id);
                
                // Refresh views
                filterAdminQuestions();
                calculateQuestionStats();
                
                alert("โ ุชู ุญุฐู ุงูุณุคุงู ุจูุฌุงุญ!");
                
            } catch (error) {
                console.error("Error deleting question:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุณุคุงู");
            }
        };

        // --- Setup UI Helpers ---
        function setupProfileUI() { 
            document.getElementById('profile-name-text').innerText = userData.name || "ุบูุฑ ูุนุฑูู";
            document.getElementById('profile-id-text').innerText = "ID: " + (userData.uniqueId || "ุบูุฑ ูุนุฑูู");
            document.getElementById('profile-img').src = userData.photo || "https://ui-avatars.com/api/?name=User&background=random&size=128";
        }
        
        function setupHeaderUI() { 
            document.getElementById('header-points').innerText = userData.points || 0; 
        }
        
        function getGradeName(code) { 
            return code==='6sci'?'ุงูุณุงุฏุณ ุงูุนููู':code==='6lit'?'ุงูุณุงุฏุณ ุงูุฃุฏุจู':code==='3med'?'ุงูุซุงูุซ ูุชูุณุท':'ุบูุฑ ูุญุฏุฏ'; 
        }
        
        async function getQuestions(sub, type) {
            try {
                const q = query(collection(db, "questions"), 
                    where("subject", "==", sub), 
                    where("type", "==", type), 
                    limit(50));
                const snap = await getDocs(q);
                const list = [];
                snap.forEach(d => {
                    const data = d.data();
                    if (data && (data.status === 'approved' || !data.status)) {
                        list.push(data);
                    }
                });
                return list;
            } catch (error) {
                console.error("Error getting questions:", error);
                return [];
            }
        }

        window.setQType = (t) => {
            selectedQType = t;
            document.getElementById('btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            
            // Update subjects based on selected type
            if (userData && userData.grade) {
                populateSubjects(userData.grade, 'challenge-subject', t);
            }
        };

        // Initialize subjects when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add error handling for images
            document.querySelectorAll('img').forEach(img => {
                img.onerror = function() {
                    const name = this.alt || 'User';
                    this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=128`;
                };
            });
            
            // Initialize tooltips if needed
            if (userData && userData.grade) {
                setTimeout(() => {
                    if (document.getElementById('challenge-subject')) {
                        populateSubjects(userData.grade, 'challenge-subject');
                    }
                }, 1000);
            }
        });

        // Add responsive behavior
        function handleResize() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', handleResize);
        handleResize();

    </script>
</body>
</html>
