<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ููุฑ ุงููุฒุงุฑู - ุงููุณุฎุฉ ุงููููุฒุฉ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Reset & Variables --- */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --bg-app: #f8fafc;
            --gold: #FFD700;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-app);
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0; padding: 0;
            overscroll-behavior: none;
        }

        /* --- Performance & Smooth Transitions --- */
        .screen {
            display: none; 
            height: 100vh; 
            width: 100vw;
            position: absolute; 
            top: 0; 
            left: 0; 
            background: var(--bg-app); 
            z-index: 10;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out;
            will-change: opacity, transform;
        }
        .screen.active { 
            display: block; 
            z-index: 20; 
            opacity: 1;
            transform: scale(1);
        }

        /* --- Custom Scroll --- */
        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 250px; 
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Animations --- */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Hacker Intro Animation */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glitch { 0% { opacity: 1; transform: translate(0); } 20% { opacity: 0.8; transform: translate(-2px, 2px); } 40% { opacity: 1; transform: translate(2px, -2px); } 60% { opacity: 0.9; transform: translate(-1px, 1px); } 80% { opacity: 1; transform: translate(1px, -1px); } 100% { opacity: 1; transform: translate(0); } }

        /* VS Animation */
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes zoomInBounce { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }

        /* --- PREMIUM ANIMATIONS & STYLES --- */
        /* Medical Theme */
        .bg-medical { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); position: relative; overflow: hidden; }
        .bg-medical::before { content: 'โ'; position: absolute; font-size: 40px; color: rgba(14, 165, 233, 0.2); animation: float 3s infinite; top: 10px; left: 10px; }
        .bg-medical::after { content: '๐'; position: absolute; font-size: 30px; opacity: 0.3; animation: spin-slow 10s infinite; bottom: 10px; right: 10px; }
        
        /* Law Theme */
        .bg-law { background: linear-gradient(135deg, #fef3c7 0%, #d97706 100%); position: relative; overflow: hidden; }
        .bg-law::before { content: 'โ๏ธ'; position: absolute; font-size: 40px; opacity: 0.3; animation: float 4s infinite; top: 5px; right: 20px; }
        .bg-law::after { content: '๐'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 5s infinite reverse; bottom: 5px; left: 20px; }

        /* Education Theme */
        .bg-edu { background: linear-gradient(135deg, #dcfce7 0%, #4ade80 100%); position: relative; overflow: hidden; }
        .bg-edu::before { content: '๐'; position: absolute; font-size: 35px; opacity: 0.3; animation: float 3s infinite; top: 10px; left: 20px; }
        .bg-edu::after { content: 'โ๏ธ'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 4s infinite reverse; bottom: 10px; right: 20px; }

        /* Engineering Theme */
        .bg-eng { background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); position: relative; overflow: hidden; }
        .bg-eng::before { content: '๐'; position: absolute; font-size: 35px; opacity: 0.3; animation: spin-slow 8s infinite; top: 5px; left: 10px; }
        .bg-eng::after { content: 'โ๏ธ'; position: absolute; font-size: 40px; opacity: 0.2; animation: spin-slow 4s infinite reverse; bottom: 5px; right: 10px; }

        /* Smart Theme */
        .bg-smart { background: linear-gradient(135deg, #ffedd5 0%, #fb923c 100%); position: relative; overflow: hidden; }
        .bg-smart::before { content: '๐ก'; position: absolute; font-size: 40px; opacity: 0.4; animation: pulse-border 2s infinite; top: 10px; right: 10px; }
        .bg-smart::after { content: '๐ง'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 3s infinite; bottom: 10px; left: 10px; }

        /* Love Theme */
        .bg-love { background: linear-gradient(135deg, #fce7f3 0%, #f472b6 100%); position: relative; overflow: hidden; }
        .bg-love::before { content: 'โค'; position: absolute; font-size: 20px; color: rgba(255,255,255,0.6); animation: float 2s infinite; top: 20px; left: 20%; }
        .bg-love::after { content: '๐'; position: absolute; font-size: 30px; opacity: 0.5; animation: float 3s infinite reverse; bottom: 10px; right: 20%; }

        /* Default Rank BG */
        .bg-rank-default { background: white; }

        /* Badge Styles */
        .premium-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            margin-right: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            vertical-align: middle;
        }

        /* Bio Text Styles */
        .bio-text {
            font-size: 0.7rem;
            color: #64748b;
            max-width: 200px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        /* --- Components --- */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .input-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 14px; width: 100%; outline: none; font-size: 1rem; transition: border-color 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn-main {
            background: var(--primary); color: white; padding: 14px;
            border-radius: 12px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); transition: transform 0.1s, background-color 0.2s;
            text-align: center; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:hover { background-color: var(--primary-dark); }

        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item { position: relative; transition: all 0.2s; color: #9CA3AF; } 
        .nav-item.active { color: var(--primary); }
        
        .stat-btn {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative; cursor: pointer;
        }
        .stat-btn:active { transform: scale(0.98); background-color: #f9fafb; }

        .red-dot {
            position: absolute; top: -2px; right: 25%;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .red-dot.visible { display: block; }
        .btn-dot {
            position: absolute; top: 0; right: 0;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .btn-dot.visible { display: block; }

        /* Hacker Intro Styles */
        .hacker-avatar {
            font-size: 80px;
            color: #1e293b;
            position: relative;
            animation: float 3s ease-in-out infinite;
            margin-bottom: 20px;
        }
        .hacker-avatar .fa-user-secret {
            filter: drop-shadow(0 0 15px rgba(79, 70, 229, 0.5));
        }
        .hacker-text-intro {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            animation: glitch 3s infinite;
        }

        .auth-tabs {
            display: flex; background: #f1f5f9; padding: 4px;
            border-radius: 14px; margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1; text-align: center; padding: 10px;
            font-weight: bold; color: #64748b; cursor: pointer;
            border-radius: 10px; transition: all 0.3s; font-size: 0.95rem;
        }
        .auth-tab.active {
            background: white; color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- RANKING FRAMES & RAYS --- */
        .rank-img-container { 
            position: relative; display: flex; align-items: center; justify-content: center;
            width: 60px; height: 60px; margin-right: 5px;
        }
        .rank-img { 
            width: 48px; height: 48px; border-radius: 50%; object-fit: cover;
            padding: 2px; background: white; position: relative; z-index: 5;
        }
        .rank-badge-top {
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; font-size: 10px; font-weight: 900;
            padding: 2px 6px; border-radius: 8px; border: 2px solid white; z-index: 20;
            min-width: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .rank-rays {
            position: absolute; inset: 0; border-radius: 50%; z-index: 1; 
            animation: spin-slow 10s linear infinite;
            mask-image: radial-gradient(transparent 58%, black 60%); 
            -webkit-mask-image: radial-gradient(transparent 58%, black 60%);
            opacity: 0.8;
        }
        .rays-gold { background: repeating-conic-gradient(from 0deg, #FFD700 0deg 10deg, transparent 10deg 20deg); }
        .rays-silver { background: repeating-conic-gradient(from 0deg, #C0C0C0 0deg 10deg, transparent 10deg 20deg); }
        .rays-bronze { background: repeating-conic-gradient(from 0deg, #CD7F32 0deg 10deg, transparent 10deg 20deg); }
        .rays-blue { background: repeating-conic-gradient(from 0deg, #3b82f6 0deg 10deg, transparent 10deg 20deg); }
        .rays-red { background: repeating-conic-gradient(from 0deg, #ef4444 0deg 10deg, transparent 10deg 20deg); }
        .rays-green { background: repeating-conic-gradient(from 0deg, #22c55e 0deg 10deg, transparent 10deg 20deg); }
        .rays-purple { background: repeating-conic-gradient(from 0deg, #a855f7 0deg 10deg, transparent 10deg 20deg); }
        
        .frame-rank-1 { border: 3px solid #FFD700; }
        .frame-rank-2 { border: 3px solid #C0C0C0; }
        .frame-rank-3 { border: 3px solid #CD7F32; }
        .frame-rank-common { border: 2px solid #e2e8f0; }
        .frame-rank-other-top { border: 2px solid #6366f1; }
        .name-crown { margin-right: 6px; font-size: 14px; animation: bounce 2s infinite; display: inline-block; }

        /* --- Daily Reward --- */
        .reward-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .reward-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px; }
        .day-box {
            background: #f1f5f9; border-radius: 8px; padding: 6px 2px;
            text-align: center; position: relative; border: 2px solid transparent;
            transition: all 0.2s; display: flex; flex-direction: column;
            align-items: center; justify-content: center; min-height: 50px;
        }
        .day-box p { font-size: 0.6rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }
        .day-box span { font-size: 0.7rem; font-weight: 900; display: block; line-height: 1.1; }
        .day-box.claimed { background: #10B981; border-color: #059669; }
        .day-box.claimed p, .day-box.claimed span { color: white; }
        .day-box.claimed::after { content: 'โ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.3); font-size: 20px; }
        .day-box.active { background: #FFFBEB; border-color: #F59E0B; transform: scale(1.05); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); z-index: 10; }
        .day-box.active span { color: #D97706; }
        .day-box.active p { color: #D97706; }
        .day-box.locked { opacity: 0.6; }

        /* --- Maintenance Modal --- */
        .new-maintenance-overlay {
            position: fixed; inset: 0; z-index: 11000;
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: center;
        }
        .new-maintenance-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 32px;
            padding: 40px 30px;
            width: 90%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.8);
            position: relative; overflow: hidden;
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .maint-icon-wrapper {
            position: relative; z-index: 1;
            width: 100px; height: 100px; margin: 0 auto 20px;
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5);
            border: 4px solid white;
        }
        .maint-icon-wrapper i { font-size: 40px; color: white; animation: pulse-border 2s infinite; }
        .maint-title { 
            position: relative; z-index: 1; 
            font-size: 1.8rem; font-weight: 900; color: #1e293b; margin-bottom: 10px; 
            background: linear-gradient(to right, #EF4444, #B91C1C);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- Ban Overlay --- */
        .ban-overlay {
            position: fixed; inset: 0; z-index: 20000;
            background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: white; padding: 20px;
        }
        .ban-icon { font-size: 80px; color: #ef4444; margin-bottom: 20px; }

        /* Toggle Switch */
        .toggle-wrapper { position: relative; width: 50px; height: 26px; }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #9CA3AF; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-checkbox:checked + .toggle-slider { background-color: #10B981; }
        .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(24px); }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 12000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: 20px; padding: 20px; overflow-y: auto;
            animation: slideUp 0.3s ease-out; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Answer Colors */
        .answer-correct { background: #DCFCE7 !important; border-color: #22C55E !important; color: #166534 !important; position: relative; }
        .answer-correct::after { content: 'โ'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #22C55E; }
        .answer-wrong { background: #FEE2E2 !important; border-color: #EF4444 !important; color: #991B1B !important; position: relative; }
        .answer-wrong::after { content: 'โ'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #EF4444; }
        .answer-neutral { background: white !important; border-color: #E5E7EB !important; color: #374151 !important; }

        /* --- Countdown Timer --- */
        .countdown-container {
            background: linear-gradient(to right, #1e293b, #0f172a);
            color: white; padding: 10px; border-radius: 12px;
            margin-bottom: 15px; text-align: center;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        .timer-digits { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #ffd700; letter-spacing: 2px; }

        /* --- VS Screen & Avatar Styles --- */
        .vs-screen-overlay {
            position: fixed; inset: 0; z-index: 15000;
            background: radial-gradient(circle at center, #2e1065, #0f172a);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .vs-player-card {
            display: flex; flex-direction: column; align-items: center;
            z-index: 10;
        }
        .vs-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            border: 4px solid #fff; box-shadow: 0 0 20px rgba(79, 70, 229, 0.6);
            object-fit: cover; background: #fff;
        }
        .vs-text { font-size: 5rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 30px #d97706; font-style: italic; z-index: 20; }
        .animate-slide-left { animation: slideInLeft 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-right { animation: slideInRight 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-zoom-bounce { animation: zoomInBounce 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        
        .game-avatar-small {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;
            object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; vertical-align: middle;
        }

        /* Withdraw Button */
        .withdraw-btn {
            background: linear-gradient(to right, #10B981, #059669);
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.3s;
        }
        .withdraw-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* Study Schedule Styles */
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        .word-table {
            border-collapse: separate; border-spacing: 0; width: 100%;
            border: 2px solid #4F46E5; border-radius: 8px; overflow: hidden; background: #fff;
        }
        .word-table th { background: #4F46E5; color: white; padding: 12px; font-weight: 800; }
        .word-table td { border-bottom: 1px solid #eee; padding: 12px; font-weight: 600; color: #333; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Solutions Section */
        .solution-image-preview {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px dashed #e2e8f0;
        }
        .solution-image-preview:hover {
            border-color: #4F46E5;
        }
        .solution-answer-box {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 16px;
            margin: 10px 0;
        }

        /* Admin Button in Solutions */
        .admin-btn-solutions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #dc2626;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 100;
        }

        @media (min-width: 768px) {
            .input-box { font-size: 1.1rem; }
            .auth-overlay > div { max-width: 500px; }
        }

        /* Game Withdraw Button */
        .withdraw-game-btn {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            z-index: 100;
        }
        
        /* --- HIDE POINTS IN SOLUTIONS HEADER --- */
#tab-solutions #header-points {
    display: none !important;
}

/* --- ADMIN BUTTON IN HEADER --- */
.solutions-header-admin-btn {
    background: #dc2626;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 0.75rem;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 5px;
}

.solutions-header-admin-btn:hover {
    background: #b91c1c;
}

/* ุชุญุณูู ุฌูุฏุฉ ุนุฑุถ ุงูุตูุฑ ูููุดุฑููู */
.solution-image-preview {
    width: 100%;
    height: 300px; /* ุฒูุงุฏุฉ ุงูุงุฑุชูุงุน */
    object-fit: contain;
    background: #f8fafc;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    image-rendering: -webkit-optimize-contrast; /* ุชุญุณูู ุงูุฌูุฏุฉ ูู ูุฑูู */
    image-rendering: crisp-edges; /* ุญูุงู ุฃูุถุญ */
}

.solution-image-preview:hover {
    border-color: #4F46E5;
    transform: scale(1.01);
    transition: transform 0.3s ease;
}

/* ูููุดุงูุฏุฉ ุงููุงููุฉ */
#full-solution-image {
    max-width: 95vw;
    max-height: 85vh;
    object-fit: contain;
    image-rendering: high-quality;
}

/* ุชุญุณูู ุฌูุฏุฉ ุงูุตูุฑ ูู ุงููุณู */
.solution-image-preview {
    width: 100%;
    height: 350px !important; /* ุฒูุงุฏุฉ ุงูุงุฑุชูุงุน */
    max-height: 500px;
    object-fit: contain !important;
    background: linear-gradient(45deg, #f8fafc, #ffffff);
    border-radius: 12px;
    border: 3px solid #e2e8f0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    image-rendering: auto !important; /* ุฌูุฏุฉ ุชููุงุฆูุฉ */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ุนูุฏ ุงูุชูุฑูุฑ */
.solution-image-preview:hover {
    border-color: #4F46E5;
    box-shadow: 0 6px 20px rgba(79, 70, 229, 0.15);
    transform: scale(1.005);
    transition: all 0.3s ease;
}

/* ุตูุฑุฉ ุงูุนุฑุถ ุงููุงูู */
#full-solution-image {
    max-width: 90vw !important;
    max-height: 80vh !important;
    object-fit: contain !important;
    image-rendering: optimizeQuality !important;
    background: #000;
    border-radius: 8px;
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
}

    </style>
</head>
<body>

    <!-- 0. BANNED SCREEN -->
    <div id="ban-screen" class="ban-overlay hidden">
        <i class="fas fa-ban ban-icon"></i>
        <h1 class="text-3xl font-black mb-4">ุชู ุญุธุฑ ุญุณุงุจู</h1>
        <p class="text-gray-400 mb-6">ููุฏ ุชู ุญุธุฑ ุฌูุงุฒู ูุญุณุงุจู ูู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ุจุดูู ููุงุฆู ูุงูุชูุงู ุงูุดุฑูุท.</p>
        <div class="bg-red-900 bg-opacity-50 p-4 rounded-xl border border-red-700">
            <p class="text-red-300 text-sm font-bold">ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก</p>
        </div>
    </div>

    <!-- 1. INTRO SCREEN -->
    <div id="intro-screen" class="auth-overlay flex-col bg-slate-50" style="z-index: 10000;">
        <div class="hacker-avatar">
            <i class="fas fa-user-secret"></i>
        </div>
        <h1 class="hacker-text-intro mb-6">ููุฑ ุงููุฒุงุฑู</h1>
        <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden relative">
            <div class="absolute top-0 left-0 h-full bg-indigo-600 animate-[width_2s_ease-out_forwards]" style="width: 0%; animation-name: loadBar; animation-duration: 2s; animation-fill-mode: forwards;"></div>
        </div>
        <p class="mt-4 text-gray-500 font-bold text-sm tracking-widest animate-pulse">ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ...</p>
        <style> @keyframes loadBar { 0% { width: 0%; } 100% { width: 100%; } } </style>
    </div>

    <!-- 1.5 VS SCREEN -->
    <div id="vs-screen" class="vs-screen-overlay hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
        <div class="flex items-center justify-center gap-6 w-full max-w-lg relative">
            <div class="vs-player-card animate-slide-left">
                <img id="vs-p1-img" src="" class="vs-avatar mb-3">
                <p id="vs-p1-name" class="text-white font-bold text-lg text-center truncate w-32"></p>
            </div>
            
            <div class="vs-text animate-zoom-bounce">VS</div>
            
            <div class="vs-player-card animate-slide-right">
                <img id="vs-p2-img" src="" class="vs-avatar mb-3">
                <p id="vs-p2-name" class="text-white font-bold text-lg text-center truncate w-32"></p>
            </div>
        </div>
        <p class="text-indigo-300 font-bold mt-10 tracking-widest animate-pulse">ุฌุงุฑู ุจุฏุก ุงูุชุญุฏู...</p>
    </div>

    <!-- 2. DAILY REWARD POPUP -->
    <div id="daily-reward-screen" class="fixed inset-0 reward-overlay z-[9000] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden animate-[slideUp_0.4s_ease-out]">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-indigo-800">ุณุฌู ุงูุญุถูุฑ ุงููููู ๐</h2>
                <p class="text-xs text-gray-500">ุงูุชูููุช ุญุณุจ ุจุบุฏุงุฏ (12:00 ุต)</p>
            </div>
            <div id="reward-grid-container" class="reward-grid"></div>
            <div class="text-center mt-6">
                <button onclick="claimReward()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                      <span>ุงุณุชูุงู ุงููุฏูุฉ</span>
                      <i class="fas fa-gift animate-bounce"></i>
                </button>
            </div>
            <button onclick="document.getElementById('daily-reward-screen').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 3. MAINTENANCE MODAL -->
    <div id="maintenance-popup" class="new-maintenance-overlay hidden">
        <div class="new-maintenance-card">
            <div class="maint-icon-wrapper"><i class="fas fa-tools"></i></div>
            <h2 class="maint-title">ุงููุธุงู ุชุญุช ุงูุตูุงูุฉ</h2>
            <p class="text-sm text-red-500 font-bold mb-6 tracking-wide uppercase">System Maintenance</p>
            <div class="bg-white/90 border border-slate-200 rounded-2xl p-5 mb-6 text-slate-700 font-bold leading-relaxed">
                <p id="maintenance-msg-display">ุฑุณุงูุฉ ุงูุฅุฏุงุฑุฉ...</p>
            </div>
            <button onclick="closeMaintenancePopup()" class="bg-slate-800 text-white px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transition shadow-xl w-full flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i> ุญุณูุง
            </button>
        </div>
    </div>

    <!-- 4. FORGOT PASSWORD MODAL -->
    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-3xl p-8 w-11/12 max-w-sm shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-key text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800">ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ</h3>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                <input type="email" id="forgot-email" placeholder="ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู ุงููุณุฌู" class="input-box">
                <p class="text-xs bg-yellow-50 text-yellow-700 p-2 rounded mt-2 border border-yellow-200">ุชูุจูู: ุงูุฑุณุงูุฉ ูููู ุชูุตู "ุงูุฑุณุงุฆู ุบูุฑ ุงููุฑุบูุจ ูููุง"</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeForgotPassword()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">ุฅูุบุงุก</button>
                <button onclick="sendResetLink()" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition">ุฅุฑุณุงู</button>
            </div>
        </div>
    </div>

    <!-- 5. AUTH SCREEN -->
    <div id="auth-screen" class="auth-overlay hidden">
        <div class="w-full max-w-md p-8 h-full overflow-y-auto flex flex-col justify-center">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-indigo-600 mb-2">ููุฑ ุงููุฒุงุฑู</h1>
                <p class="text-gray-500 text-sm">ุจูุงุจุชู ููุชููู ูู ุงูุงูุชุญุงูุงุช ุงููุฒุงุฑูุฉ</p>
            </div>
            <div class="auth-tabs">
                <div id="tab-login-btn" onclick="switchAuthTab('login')" class="auth-tab active">ุชุณุฌูู ุงูุฏุฎูู</div>
                <div id="tab-signup-btn" onclick="switchAuthTab('signup')" class="auth-tab">ุฅูุดุงุก ุญุณุงุจ</div>
            </div>

            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                        <input type="email" id="login-email" placeholder="example@gmail.com" class="input-box" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ูููุฉ ุงููุฑูุฑ</label>
                        <input type="password" id="login-pass" placeholder="โขโขโขโขโขโขโขโข" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-8">ุฏุฎูู</button>
                <div class="text-center mt-4">
                    <button type="button" onclick="openForgotPassword()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:underline">ูู ูุณูุช ูููุฉ ุงูุณุฑุ</button>
                </div>
            </form>

            <form id="signup-form" class="hidden" onsubmit="event.preventDefault(); handleSignup();">
                <div class="flex justify-center mb-6">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('signup-img').click()">
                        <img id="preview-img" src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100 shadow-md transition group-hover:border-indigo-200">
                        <div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm">
                            <i class="fas fa-camera text-xs"></i>
                        </div>
                    </div>
                    <input type="file" id="signup-img" hidden accept="image/*" onchange="handleImagePreview(this)">
                </div>
                <div class="space-y-3">
                    <div><input type="text" id="signup-name" placeholder="ุงูุงุณู ุงูุธุงูุฑ" class="input-box" required></div>
                    <div><input type="email" id="signup-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (@gmail.com)" class="input-box" required></div>
                    <div><input type="password" id="signup-pass" placeholder="ูููุฉ ุงููุฑูุฑ (6+ ุฃุญุฑู)" class="input-box" required></div>
                </div>
                <button type="submit" class="btn-main mt-6 bg-indigo-600">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</button>
                <p class="text-xs text-center text-gray-400 mt-4">ูุณูุญ ุจุญุณุงุจูู ููุท ููุฌูุงุฒ ุงููุงุญุฏ</p>
            </form>
        </div>
    </div>

    <!-- 6. MAIN APP CONTAINER -->
    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- HEADER -->
        <div class="absolute top-0 w-full h-20 bg-white/95 backdrop-blur-sm shadow-sm z-30 flex items-center justify-between px-5 pt-2">
            <div>
                <h1 class="font-black text-lg text-indigo-900">ููุฑ ุงููุฒุงุฑู</h1>
                <p id="header-grade-badge" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full hidden">...</p>
            </div>
            <div class="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2 shadow-sm">
                <span id="header-points" class="font-bold text-yellow-700">0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>
        </div>

        <!-- === TABS === -->

        <!-- TAB 1: CHALLENGES -->
        <div id="tab-challenges" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- Select Grade First Time -->
                <div id="grade-selector-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-school text-xl"></i></div>
                        <h3 class="font-bold text-gray-800">ุญุฏุฏ ูุฑุญูุชู ุงูุฏุฑุงุณูุฉ</h3>
                        <p class="text-xs text-gray-400">ูุชู ุชุญุฏูุฏูุง ูุฑุฉ ูุงุญุฏุฉ ููุท</p>
                    </div>
                    <select id="grade-select" class="input-box mb-4 text-center">
                        <option value="">-- ุงุฎุชุฑ ุงููุฑุญูุฉ --</option>
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                        <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                        <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>
                    <button onclick="saveUserGrade()" class="btn-main py-3 text-sm">ุญูุธ ุงููุฑุญูุฉ</button>
                </div>

                <!-- Active Challenge Card -->
                <div id="challenge-active-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">ุจุฏุก ุชุญุฏู ุฌุฏูุฏ ๐ฅ</h3>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ุงููุงุฏุฉ</label>
                    <select id="challenge-subject" class="input-box mb-4 bg-gray-50"></select>

                    <label class="block text-sm font-bold text-gray-600 mb-2">ููุน ุงูุชุญุฏู</label>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setQType('mcq')" id="btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ุงุฎุชูุงุฑุงุช</button>
                        <button onclick="setQType('tf')" id="btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ุตุญ ูุฎุทุฃ</button>
                    </div>

                    <button onclick="startMatchmaking('online')" class="btn-main bg-gradient-to-r from-indigo-600 to-purple-600 mb-4 h-12">
                        <i class="fas fa-user-graduate ml-2"></i> ุงููุนุจ ุถุฏ ุทุงูุจ (ุญูููู)
                    </button>

                    <button onclick="startMatchmaking('ai')" class="btn-main bg-gradient-to-r from-emerald-500 to-green-600 mb-3 h-12">
                        <i class="fas fa-robot ml-2"></i> ุถุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                    </button>
                    
                    <div class="w-full">
                        <label class="text-xs text-gray-400 font-bold mb-1 block text-center">ุตุนูุจุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</label>
                        <select id="ai-difficulty" class="input-box text-xs font-bold text-center h-[40px] bg-green-50 border-green-200 text-green-800 focus:border-green-500 w-full">
                            <option value="easy">ุจุณูุท (25%)</option>
                            <option value="medium" selected>ูุชูุณุท (50%)</option>
                            <option value="hard">ุฐูู (70%)</option>
                        </select>
                    </div>
                </div>

                <!-- Searching UI -->
                <div id="searching-ui" class="hidden flex-col items-center justify-center py-10 min-h-[300px]">
                    <div class="w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center relative mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-indigo-500 opacity-20 animate-ping"></div>
                        <i class="fas fa-search text-3xl text-indigo-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="search-msg">ุฌุงุฑู ุงูุจุญุซ...</h3>
                    <button onclick="cancelSearch()" class="mt-8 text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full">ุฅูุบุงุก</button>
                </div>
            </div>
        </div>

        <!-- GAME OVERLAY -->
        <div id="game-overlay" class="fixed inset-0 bg-gray-50 z-[100] hidden flex-col">
            <div class="bg-white p-3 shadow-sm flex justify-between items-center z-10 border-b border-gray-100 h-20">
                <!-- Player 1 -->
                <div class="flex items-center gap-2 w-1/3 overflow-hidden">
                    <img id="game-p1-img" src="" class="game-avatar-small">
                    <div class="overflow-hidden">
                        <p id="p1-name" class="text-[10px] text-gray-500 font-bold truncate">...</p>
                        <p id="game-my-score" class="text-xl font-black text-indigo-600">0</p>
                    </div>
                </div>
                
                <!-- Timer -->
                <div class="w-1/3 flex justify-center">
                    <div id="game-timer" class="w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center font-bold text-md shadow-md">15</div>
                </div>

                <!-- Player 2 -->
                <div class="flex items-center gap-2 w-1/3 overflow-hidden justify-end">
                    <div class="overflow-hidden text-left">
                        <p id="p2-name" class="text-[10px] text-gray-500 font-bold truncate">...</p>
                        <p id="game-op-score" class="text-xl font-black text-red-500">0</p>
                    </div>
                    <img id="game-p2-img" src="" class="game-avatar-small">
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 text-center border-t-4 border-indigo-500 relative mt-4">
                    <span id="q-progress" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-3 py-1 rounded-full">1 / 10</span>
                    <p id="q-text" class="text-lg font-bold text-gray-800 leading-relaxed mt-2">...</p>
                </div>
                <div id="answers-container" class="space-y-3"></div>
                <p id="waiting-msg" class="text-center text-gray-400 text-sm hidden animate-pulse mt-4">ุจุงูุชุธุงุฑ ุฅุฌุงุจุฉ ุงูุฎุตู...</p>
                <p id="ai-thinking-msg" class="text-center text-green-600 text-sm hidden animate-pulse mt-4 font-bold">ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููุฑ...</p>
                
                <!-- Withdraw Button -->
                <button onclick="withdrawFromGame()" class="withdraw-game-btn">
                    <i class="fas fa-sign-out-alt ml-2"></i> ุงูุงูุณุญุงุจ ูู ุงูุชุญุฏู (-10 ููุงุท)
                </button>
            </div>
        </div>

        <!-- POST MATCH RESULT SCREEN -->
        <div id="result-screen" class="fixed inset-0 bg-white z-[200] hidden flex-col items-center justify-center p-6 animate-[fadeIn_0.3s_ease-out]">
            <button onclick="closeResultScreen()" class="absolute top-6 right-6 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>
            <div id="result-icon-container" class="mb-6 text-6xl">๐</div>
            <h2 id="result-title" class="text-3xl font-extrabold text-gray-800 mb-2">ูุจุฑูู!</h2>
            <p id="result-msg" class="text-gray-500 mb-8 text-center">ููุฏ ููุช ุจุฃุฏุงุก ุฑุงุฆุน</p>
            <div class="flex items-center gap-8 mb-8 bg-gray-50 p-6 rounded-2xl w-full justify-center">
                <div class="text-center">
                    <p class="text-xs text-gray-400">ููุงุทู</p>
                    <p id="final-my-score" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="text-2xl text-gray-300">VS</div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ุงูุฎุตู</p>
                    <p id="final-op-score" class="text-3xl font-bold text-red-500">0</p>
                </div>
            </div>
            <div class="bg-yellow-50 px-6 py-3 rounded-full border border-yellow-200 mb-8 flex items-center gap-2">
                <span>ุญุตูุช ุนูู:</span>
                <span id="result-points-gained" class="font-bold text-yellow-700">+0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>
            <button onclick="closeResultScreen()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-home"></i>
                <span>ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</span>
            </button>
        </div>

        <!-- TAB 2: LEADERBOARD -->
        <div id="tab-leaderboard" class="screen pt-20">
            <div class="scroll-container px-4">
                <!-- Weekly Countdown -->
                <div class="countdown-container">
                    <p class="text-xs text-gray-300 mb-1">ุงูุฌูุงุฆุฒ ุงูุงุณุจูุนูุฉ ๐ (ุงูุฎููุณ 12:00 ุต)</p>
                    <div id="weekly-timer" class="timer-digits">00:00:00:00</div>
                </div>

                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-2xl mb-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm opacity-90">ุชุฑุชูุจู ุงูุญุงูู</p>
                        <h2 id="my-rank-text" class="text-2xl font-bold">#...</h2>
                    </div>
                    <i class="fas fa-trophy text-4xl opacity-50"></i>
                </div>
                <div id="leaderboard-list" class="space-y-4 pb-10 flex flex-col"></div>
            </div>
        </div>

        <!-- TAB 3: STUDY SCHEDULE (ุฌุฏูู ูููู) -->
<div id="tab-schedule" class="screen pt-20">
    <div class="scroll-container px-5 py-6">
        <!-- Input Page -->
        <section id="schedule-input-page" class="glass-panel rounded-2xl p-6 slide-in">
            <header class="text-center mb-4">
                <div class="inline-block p-2 rounded-full bg-indigo-100 text-primary mb-2">
                    <i class="fa-solid fa-layer-group text-2xl text-indigo-600"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">ุฌุฏูู ุงูุฏุฑุงุณุฉ ุงููููู</h1>
                <p class="text-xs text-gray-500 mt-1">ุฎุทุท ูุฏุฑุงุณุชู ุจุฐูุงุก ูุญูู ุฃูุถู ุงููุชุงุฆุฌ!</p>
            </header>

                    <form onsubmit="handleScheduleFormSubmit(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">ุงููุงุฏุฉ</label>
                            <input type="text" id="subjectName" required placeholder="ุงุณู ุงููุงุฏุฉ..." 
                                class="input-box">
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">ุงููุตูู (ุงูุฃุตุนุจ ูุฃุฎุฐ ููุชุงู ุฃูุซุฑ)</label>
                            <div id="chaptersList" class="space-y-2 max-h-40 overflow-y-auto no-scrollbar mb-2"></div>
                            <button type="button" onclick="addChapterRow()" 
                                class="w-full py-2 border-2 border-dashed border-indigo-300 text-indigo-500 rounded-xl hover:bg-indigo-50 text-sm font-bold">
                                + ุฅุถุงูุฉ ูุตู
                            </button>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">ุงูููุช ุงููุชุจูู (ุณุงุนุงุช)</label>
                            <input type="number" id="totalHours" required min="1" max="999" placeholder="ูุซุงู: 10" 
                                class="input-box text-center font-bold text-lg">
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-2">ููุช ุงููููุ</label>
                                <select id="needSleep" class="input-box text-sm font-bold">
                                    <option value="yes">ุงุญุณุจ ููุช ุงูููู</option>
                                    <option value="no">ูุง ุชุญุณุจู</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-xs font-bold mb-2">ุงูุงุณุชุฑุงุญุฉ</label>
                                <select id="breakDuration" class="input-box text-sm font-bold">
                                    <option value="10">10 ุฏูุงุฆู</option>
                                    <option value="15">15 ุฏูููุฉ</option>
                                    <option value="20">20 ุฏูููุฉ</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" 
                            class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition-all text-lg">
                            ุฅูุดุงุก ุงูุฌุฏูู ุงูุขู
                        </button>
                    </form>
                </section>

                <!-- Result Page -->
                <section id="schedule-result-page" class="hidden slide-in">
                    <div id="schedule-card" class="bg-white rounded-2xl overflow-hidden shadow-xl border border-gray-200 mb-6">
                        <div class="h-3 bg-indigo-600 w-full"></div>
                        <div class="p-5">
                            <div class="text-center mb-6">
                                <h2 class="text-3xl font-black text-gray-800" id="displaySubject"></h2>
                                <p class="text-xs text-gray-500 mt-1">ุฎุทุฉ ุฏุฑุงุณูุฉ ุฐููุฉ</p>
                            </div>

                            <table class="word-table mb-6">
                                <thead>
                                    <tr>
                                        <th width="35%">ุงููุตู</th>
                                        <th width="40%">ุงูููุช ุงููุฎุตุต</th>
                                        <th width="25%">ุงูุฑุงุญุฉ</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleBody"></tbody>
                            </table>

                            <div class="flex justify-between bg-gray-100 p-3 rounded-lg text-center text-xs font-bold text-gray-600">
                                <div><span class="block text-indigo-600 text-lg" id="statStudy"></span>ุตุงูู ุงูุฏุฑุงุณุฉ</div>
                                <div><span class="block text-pink-600 text-lg" id="statBreak"></span>ูุฌููุน ุงูุฑุงุญุฉ</div>
                                <div><span class="block text-blue-600 text-lg" id="statSleep"></span>ููุช ุงูููู</div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div id="schedule-action-buttons" class="space-y-3">
                        <button onclick="shareSchedule()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl shadow hover:bg-black flex items-center justify-center gap-2">
                            <i class="fa-solid fa-link"></i> ูุณุฎ ุฑุงุจุท ุงููุดุงุฑูุฉ
                        </button>
                        <button onclick="downloadScheduleAsImage()" class="w-full bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl hover:bg-indigo-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i> ุญูุธ ูุตูุฑุฉ
                        </button>
                        <button onclick="resetSchedule()" class="w-full bg-white text-red-500 border border-red-200 font-bold py-3 rounded-xl hover:bg-red-50 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash-can"></i> ุญุฐู ูุฅูุดุงุก ุฌุฏูุฏ
                        </button>
                    </div>
                    
                    <div id="schedule-toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold opacity-0 transition-opacity pointer-events-none z-50">
                        ุชู ูุณุฎ ุงูุฑุงุจุท! โ
                    </div>
                </section>
            </div>
        </div>

        <!-- TAB 4: SOLUTIONS (ุงูุญููู) -->
        <div id="tab-solutions" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- Admin Button (Only for Admins/Moderators) -->
                <div id="solutions-admin-btn" class="hidden mb-4">
                    <button onclick="openSolutionsAdmin()" class="admin-btn-solutions">
                        <i class="fas fa-user-shield ml-2"></i> ููุญุฉ ุงููุดุฑููู
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex bg-gray-100 rounded-xl p-1 mb-6">
                    <button onclick="switchSolutionsTab('send')" id="solutions-tab-send" class="flex-1 py-3 rounded-lg font-bold text-center transition bg-white shadow-sm text-indigo-600">
                        <i class="fas fa-paper-plane ml-2"></i> ุฅุฑุณุงู ุณุคุงู
                    </button>
                    <button onclick="switchSolutionsTab('receive')" id="solutions-tab-receive" class="flex-1 py-3 rounded-lg font-bold text-center transition text-gray-500">
                        <i class="fas fa-inbox ml-2"></i> ุงุณุชูุงู ุฅุฌุงุจุงุช
                        <span id="solutions-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full hidden">0</span>
                    </button>
                </div>

                <!-- Send Question Section -->
<div id="solutions-send-section">
    <div class="bg-white p-6 rounded-2xl shadow-sm">
        <h3 class="font-bold text-gray-800 mb-4 text-center">ุฅุฑุณุงู ุณุคุงู ููุญู</h3>
        
        <div class="space-y-3 mb-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ *</label>
                <select id="solution-grade" class="input-box py-2 text-sm h-10" required>
                    <option value="">ุงุฎุชุฑ ุงููุฑุญูุฉ</option>
                    <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                    <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ุงููุงุฏุฉ *</label>
                <select id="solution-subject" class="input-box py-2 text-sm h-10" required>
                    <option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ุตูุฑุฉ ุงูุณุคุงู *</label>
                <div class="border border-gray-300 rounded-lg p-2 cursor-pointer hover:border-indigo-400 transition bg-gray-50 flex items-center justify-between h-10" onclick="document.getElementById('solution-image-input').click()">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-image text-sm text-gray-500"></i>
                        <p class="text-xs text-gray-600">ุงููุฑ ูุฑูุน ุตูุฑุฉ ุงูุณุคุงู</p>
                    </div>
                    <span class="text-xs text-gray-400">JPG, PNG - 5MB</span>
                    <!-- ูู ูุณู ุตูุฑุฉ ุงูุณุคุงู -->
<input type="file" id="solution-image-input" hidden accept="image/*" onchange="previewSolutionImage()" required>
                </div>
                <div id="solution-image-preview" class="mt-1 hidden">
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-image text-blue-500 text-xs"></i>
                            <span class="text-xs font-medium text-gray-700">ุชู ุฑูุน ุงูุตูุฑุฉ</span>
                        </div>
                        <button onclick="removeSolutionImage()" class="text-red-500 text-xs font-bold px-2 py-1 hover:bg-red-50 rounded">
                            <i class="fas fa-times ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1">ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
                <textarea id="solution-notes" class="input-box py-2 text-xs h-10" placeholder="ุงูุชุจ ููุงุญุธุงุช ุฅุถุงููุฉ..."></textarea>
            </div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 mb-4">
            <div class="flex items-center gap-1 mb-1">
                <i class="fas fa-info-circle text-blue-500 text-xs"></i>
                <p class="text-xs font-bold text-blue-700">ูุนูููุงุช ุงูุฅุฑุณุงู</p>
            </div>
            <p class="text-xs text-blue-600" id="solution-limit-info">
                <span id="solution-daily-count">0</span>/<span id="solution-daily-limit">1</span> - ููููู ุฅุฑุณุงู ุณุคุงู ูุงุญุฏ ููููุงู
            </p>
            <p class="text-xs text-yellow-600 mt-1 hidden" id="solution-premium-info">
                ๐ ุงููููุฒูู: 3 ุฃุณุฆูุฉ ููููุงู
            </p>
        </div>

        <button onclick="sendSolutionQuestion()" id="solution-send-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 shadow-md">
            <i class="fas fa-paper-plane"></i> ุฅุฑุณุงู ุงูุณุคุงู
        </button>
    </div>
</div>

                <!-- Receive Answers Section -->
                <div id="solutions-receive-section" class="hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                        <h3 class="font-bold text-gray-800 mb-4 text-center">ุฅุฌุงุจุงุช ุงูุฃุณุฆูุฉ ุงููุฑุณูุฉ</h3>
                        
                        <div id="solutions-received-list" class="space-y-4">
                            <p class="text-center text-gray-400 py-8">ูู ุชุณุชูู ุฃู ุฅุฌุงุจุงุช ุจุนุฏ</p>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel -->
                <div id="solutions-admin-panel" class="hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-4 text-center">ููุญุฉ ูุดุฑูู ุงูุญููู</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-500 mb-2">ุชุตููุฉ ุญุณุจ ุงููุฑุญูุฉ</label>
                            <select id="admin-solution-filter" class="input-box" onchange="filterAdminSolutions()">
                                <option value="all">ุฌููุน ุงููุฑุงุญู</option>
                                <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                                <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                                <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                            </select>
                        </div>

                        <div id="admin-solutions-list" class="space-y-4 max-h-[500px] overflow-y-auto">
                            <p class="text-center text-gray-400 py-8">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ุชุญุชุงุฌ ุฅูู ุญู</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 5: UPLOAD -->
        <div id="tab-upload" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- NOTES SECTION -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <h3 class="font-bold text-blue-800 text-sm mb-2"><i class="fas fa-info-circle ml-1"></i> ุชุนูููุงุช ุฑูุน ุงูุฃุณุฆูุฉ:</h3>
                    <ul class="text-xs text-blue-700 space-y-1 list-decimal list-inside font-medium">
                        <li>ูุฌุจ ุงู ุชููู ุงูุฃุณุฆูุฉ ุงููุถุงูุฉ ูู ุถูู ุงููููุฌ.</li>
                        <li>ูุฌุจ ุงูุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุงูุฌูุงุจ ุงูุตุญูุญ ุจุฏูุฉ.</li>
                    </ul>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 flex-shrink-0"><i class="fas fa-gift"></i></div>
                    <div>
                        <p class="text-sm font-bold text-green-800">ุงุฑุจุญ 10 ููุงุท</p>
                        <p class="text-xs text-green-600">ุนู ูู ุณุคุงู ูุชู ูุจููู</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <!-- Step 1 -->
                    <div id="up-step-1">
                        <label class="block text-sm font-bold text-gray-500 mb-1">ุงููุงุฏุฉ</label>
                        <select id="up-subject" class="input-box mb-4 bg-gray-50"></select>
                        <label class="block text-sm font-bold text-gray-500 mb-1">ุงูููุน</label>
                        <select id="up-type" class="input-box mb-6 bg-gray-50">
                            <option value="mcq">ุงุฎุชูุงุฑุงุช</option>
                            <option value="tf">ุตุญ ูุฎุทุฃ</option>
                        </select>
                        <button onclick="nextUploadStep()" class="btn-main">ุงูุชุงูู</button>
                    </div>
                    <!-- Step 2 -->
                    <div id="up-step-2" class="hidden">
                        <textarea id="up-q-text" class="input-box h-24 mb-4" placeholder="ุงูุชุจ ูุต ุงูุณุคุงู..."></textarea>
                        <div id="up-mcq-container">
                            <p class="text-xs text-gray-400 mb-2">ุฃุฏุฎู ุงูุฎูุงุฑุงุช ูุญุฏุฏ ุงูุตุญูุญ</p>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center gap-2"><input type="radio" name="correct" value="0" checked><input type="text" id="ans-0" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุฃูู"></div>
                                <div class="flex items-center gap-2"><input type="radio" name="correct" value="1"><input type="text" id="ans-1" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูู"></div>
                                <div class="flex items-center gap-2"><input type="radio" name="correct" value="2"><input type="text" id="ans-2" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูุซ"></div>
                            </div>
                        </div>
                        <div id="up-tf-container" class="hidden mb-4">
                            <label class="block text-xs text-gray-400 mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                            <select id="up-tf-val" class="input-box"><option value="true">ุตุญ</option><option value="false">ุฎุทุฃ</option></select>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('up-step-2').classList.add('hidden');document.getElementById('up-step-1').classList.remove('hidden')" class="bg-gray-100 text-gray-600 px-4 rounded-xl font-bold">ุฑุฌูุน</button>
                            <button onclick="submitUploadQuestion()" class="btn-main bg-green-600">ุฅุฑุณุงู</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 6: PROFILE -->
        <div id="tab-profile" class="screen pt-20">
            <div class="scroll-container px-5">
                <div class="bg-white p-6 rounded-3xl shadow-sm text-center mb-6 mt-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                    <div class="relative z-10">
                        <img id="profile-img" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-md mb-3 object-cover">
                        <div class="flex items-center justify-center gap-2 flex-wrap" id="profile-name-container">
                            <h2 id="profile-name-text" class="text-xl font-bold text-gray-800">...</h2>
                            <!-- Badge will be inserted here -->
                            <button onclick="editProfileName()" class="w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100 transition">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" id="profile-id-text">ID: ...</p>
                        
                        <!-- Bio Section -->
                        <div class="mt-3">
                            <div class="flex items-center justify-center gap-2">
                                <p class="bio-text" id="profile-bio-text">ูุง ุชูุฌุฏ ุณูุฑุฉ ุฐุงุชูุฉ</p>
                                <button onclick="editProfileBio()" class="w-6 h-6 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center hover:bg-gray-200 transition">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="document.getElementById('edit-pic-input').click()" class="text-indigo-600 text-xs font-bold mt-2 hover:underline">ุชุบููุฑ ุงูุตูุฑุฉ</button>
                        <input type="file" id="edit-pic-input" hidden accept="image/*" onchange="updateProfilePic(this)">
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <button onclick="openPage('screen-wallet')" class="stat-btn border-green-100 bg-green-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-600"><i class="fas fa-wallet"></i></div>
                            <span class="font-bold text-green-700">ุฃููุงูู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-premium')" class="stat-btn border-yellow-100 bg-yellow-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-yellow-600"><i class="fas fa-crown"></i></div>
                            <span class="font-bold text-yellow-700">ุงูุญุณุงุจ ุงููููุฒ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-stats')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-chart-pie"></i></div>
                            <span class="font-bold text-gray-700">ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-my-questions')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="fas fa-question"></i></div>
                            <span class="font-bold text-gray-700">ุฃุณุฆูุชู ุงููุฑููุนุฉ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>
                    
                    <!-- Unified Admin Button -->
                    <div id="admin-hub-btn-container" class="hidden mt-4">
                        <button onclick="openPage('screen-admin-hub')" class="stat-btn border-red-200 bg-red-50 shadow-md">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600 relative">
                                    <i class="fas fa-user-shield"></i>
                                    <div id="admin-btn-badge" class="btn-dot"></div>
                                </div>
                                <span class="font-bold text-red-800">ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ</span>
                            </div>
                            <i class="fas fa-chevron-left text-red-300"></i>
                        </button>
                    </div>

                    <button onclick="logout()" class="stat-btn mt-6 border-red-100 text-red-500">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sign-out-alt px-3"></i>
                            <span class="font-bold">ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SUB SCREENS === -->

        <!-- Screen: Wallet -->
        <div id="screen-wallet" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ูุญูุธุชู ๐ต</h1>
            </div>
            <div class="scroll-container px-5 py-6 text-center">
                <div class="bg-gradient-to-br from-green-500 to-emerald-700 text-white p-8 rounded-3xl shadow-lg mb-6">
                    <p class="text-green-100 text-sm mb-2 font-bold">ุงูุฑุตูุฏ ุงูุญุงูู</p>
                    <h1 class="text-5xl font-black mb-1">$<span id="wallet-balance">0</span></h1>
                    <p class="text-xs text-green-200 mt-4 border-t border-green-400 pt-2 leading-relaxed">
                        (ูููู ุณุญุจ ุงูู ุดู 100$ ููู 100$ ุชุณุงูู 10 ุงูู ุฏููุงุฑ ุนุฑุงูู)
                    </p>
                </div>
                <div id="withdraw-section" class="hidden">
                     <a href="https://t.me/mslmh19" target="_blank" class="w-full withdraw-btn flex items-center justify-center gap-2 animate-pulse">
                        <i class="fab fa-telegram-plane"></i>
                        <span>ุงููุทุงูุจุฉ ุจุงูุฃููุงู ุงูุขู</span>
                    </a>
                </div>
                <p id="withdraw-locked-msg" class="text-gray-400 text-sm mt-4">ุนุฐุฑุงูุ ูุฌุจ ุฃู ุชุตู ุฅูู 100$ ูุชุชููู ูู ุงูุณุญุจ.</p>
            </div>
        </div>

        <!-- Screen: Premium -->
        <div id="screen-premium" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุงูุญุณุงุจ ุงููููุฒ ๐</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- Header Card -->
                <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-6 rounded-3xl shadow-lg mb-6 relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-white opacity-10 rounded-full"></div>
                    <div class="absolute -bottom-10 -left-10 w-24 h-24 bg-white opacity-10 rounded-full"></div>
                    <div class="flex items-center gap-3 mb-2 relative z-10">
                        <i class="fas fa-crown text-3xl animate-bounce"></i>
                        <h2 class="text-2xl font-black">ุงูุญุณุงุจ ุงููููุฒ</h2>
                    </div>
                    <p class="text-yellow-100 text-sm relative z-10">ุงุณุชูุชุน ุจูููุฒุงุช ุญุตุฑูุฉ ูุชุฌุฑุจุฉ ูุฑูุฏุฉ!</p>
                </div>

                <!-- NON-PREMIUM VIEW -->
                <div id="premium-locked-view" class="">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4 text-center">ุชูุนูู ุงูุงุดุชุฑุงู ุงููููุฒ ๐</h3>
                        <input type="text" id="premium-code-input" placeholder="ุฃุฏุฎู ููุฏ ุงูุชูุนูู ููุง" class="input-box mb-3 text-center font-mono font-bold text-lg tracking-widest text-indigo-700 uppercase">
                        <button onclick="activatePremiumCode()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition mb-4">ุชุฃููุฏ ุงูููุฏ</button>
                        
                        <div class="flex flex-col gap-2">
                             <button onclick="window.open('https://t.me/mslmh19', '_blank')" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-600 transition flex items-center justify-center gap-2">
                                <i class="fab fa-telegram-plane"></i> ุงุญุตู ุนูู ููุฏ ุงูุชุญูู
                            </button>
                            <button onclick="showPremiumDetails()" class="w-full bg-yellow-50 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-200 hover:bg-yellow-100 transition">
                                <i class="fas fa-info-circle ml-1"></i> ุชูุงุตูู ุงูุญุณุงุจ ุงููููุฒ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PREMIUM ACTIVE VIEW -->
                <div id="premium-active-view" class="hidden">
                     <!-- Timer Card -->
                    <div class="bg-gray-800 text-white p-4 rounded-xl text-center mb-6 border border-gray-700 shadow-md">
                        <p class="text-xs text-gray-400 mb-1">ุงููุฏุฉ ุงููุชุจููุฉ ูุงุดุชุฑุงูู</p>
                        <div id="premium-countdown" class="text-2xl font-mono font-bold text-green-400 tracking-widest">ุชุญููู...</div>
                    </div>

                    <!-- Customization Buttons -->
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <button onclick="openBadgeSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">ุนูุงูุฉ ุงูุชูุซูู</h3>
                                <p class="text-xs text-gray-500">ุงุฎุชุฑ ุงูููุจ ูุงูููู ุจุฌุงูุจ ุงุณูู</p>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>

                        <button onclick="openBgSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-purple-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-image text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">ุฎูููุฉ ุงูุชุตููู</h3>
                                <p class="text-xs text-gray-500">ุงุฎุชุฑ ุฎูููุฉ ูููุฒุฉ ูุจุทุงูุชู</p>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>
                    </div>

                    <!-- Active Perks Status -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-green-50 p-3 rounded-xl border border-green-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-bolt text-green-600"></i>
                                <span class="font-bold text-sm text-green-800">ูุถุงุนูุฉ ุงูููุงุท (2x)</span>
                            </div>
                            <span class="bg-green-200 text-green-800 text-[10px] px-2 py-1 rounded font-bold">ูุดุท โ</span>
                        </div>
                        <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-xl border border-emerald-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-emerald-600"></i>
                                <span class="font-bold text-sm text-emerald-800">ูุถุงุนูุฉ ุงูุฃููุงู (2x)</span>
                            </div>
                            <span class="bg-emerald-200 text-emerald-800 text-[10px] px-2 py-1 rounded font-bold">ูุดุท โ</span>
                        </div>
                         <div class="flex items-center justify-between bg-blue-50 p-3 rounded-xl border border-blue-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-robot text-blue-600"></i>
                                <span class="font-bold text-sm text-blue-800">15 ุณุคุงู (ุงูุฐูุงุก ุงูุงุตุทูุงุนู)</span>
                            </div>
                            <span class="bg-blue-200 text-blue-800 text-[10px] px-2 py-1 rounded font-bold">ูุดุท โ</span>
                        </div>
                        <div class="flex items-center justify-between bg-purple-50 p-3 rounded-xl border border-purple-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-paper-plane text-purple-600"></i>
                                <span class="font-bold text-sm text-purple-800">3 ุฃุณุฆูุฉ ุญููู ููููุงู</span>
                            </div>
                            <span class="bg-purple-200 text-purple-800 text-[10px] px-2 py-1 rounded font-bold">ูุดุท โ</span>
                        </div>
                        <div class="flex items-center justify-between bg-pink-50 p-3 rounded-xl border border-pink-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-question-circle text-pink-600"></i>
                                <span class="font-bold text-sm text-pink-800">5 ุฃุณุฆูุฉ ุฑูุน ููููุฉ</span>
                            </div>
                            <span class="bg-pink-200 text-pink-800 text-[10px] px-2 py-1 rounded font-bold">ูุดุท โ</span>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- Screen: ADMIN HUB -->
        <div id="screen-admin-hub" class="screen pt-20">
             <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openPage('screen-admin-panel')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-cogs text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุงููุธุงู</span>
                    </button>
                    <button onclick="openPage('screen-admin-users')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users-cog text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุงููุณุชุฎุฏููู</span>
                    </button>
                    <button onclick="openPage('screen-admin-review')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50 relative">
                        <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600">
                             <i class="fas fa-gavel text-xl"></i>
                        </div>
                        <span class="font-bold text-sm text-gray-700">ูุฑุงุฌุนุฉ</span>
                    </button>
                    <button onclick="openPage('screen-admin-all')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-edit text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุชุนุฏูู</span>
                    </button>
                    <button onclick="openPage('screen-admin-stats')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-list-ol text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุนุฏุงุฏ ุงูุฃุณุฆูุฉ</span>
                    </button>
                    <button onclick="openPage('screen-admin-subjects')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"><i class="fas fa-book text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุงูููุงุฏ</span>
                    </button>
                    <!-- NEW: Add Subscription -->
                    <button onclick="openPage('screen-admin-subscription')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600"><i class="fas fa-ticket-alt text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช</span>
                    </button>
                    <!-- NEW: Add Moderators -->
                    <button onclick="openPage('screen-admin-moderators')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-cyan-100 rounded-full flex items-center justify-center text-cyan-600"><i class="fas fa-user-plus text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ุฑูุน ุงููุดุฑููู</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Subscription -->
<div id="screen-admin-subscription" class="screen pt-20">
     <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
        <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
        <h1 class="font-bold text-lg text-gray-800">ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช</h1>
    </div>
    <div class="scroll-container px-5 py-6">
        <!-- Generate Code Section -->
        <div class="mb-6">
            <h3 class="font-bold text-gray-800 mb-3">ุชูููู ููุฏ ุงุดุชุฑุงู ูููุฒ</h3>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                <label class="block text-xs font-bold text-gray-500 mb-2">ูุฏุฉ ุงูุงุดุชุฑุงู</label>
                <select id="admin-sub-duration" class="input-box mb-3">
                    <option value="7">ุฃุณุจูุน (7 ุฃูุงู)</option>
                    <option value="30">ุดูุฑ (30 ููู)</option>
                    <option value="90">3 ุฃุดูุฑ (90 ููู)</option>
                </select>
                <button onclick="generateSubscriptionCode()" class="btn-main bg-indigo-600 mb-4">
                    <i class="fas fa-key ml-2"></i> ุชูููู ูุชูููุฏ ููุฏ
                </button>
                
                <div id="generated-code-display" class="hidden bg-indigo-50 border border-indigo-200 p-3 rounded-xl text-center mt-3">
                    <p class="text-xs text-indigo-500 mb-1">ุงูููุฏ ุงูุฌุฏูุฏ:</p>
                    <h2 class="text-2xl font-mono font-bold text-indigo-800 select-all" id="gen-code-text">...</h2>
                    <div class="flex justify-center gap-2 mt-2">
                        <button onclick="copyGenCode()" class="bg-indigo-600 text-white px-4 py-1 rounded-lg text-xs font-bold hover:bg-indigo-700 transition">
                            <i class="fas fa-copy ml-1"></i> ูุณุฎ ุงูููุฏ
                        </button>
                        <button onclick="document.getElementById('generated-code-display').classList.add('hidden')" class="bg-gray-200 text-gray-700 px-4 py-1 rounded-lg text-xs font-bold hover:bg-gray-300 transition">
                            <i class="fas fa-times ml-1"></i> ุฅุฎูุงุก
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Code Section -->
        <div class="mb-6">
            <h3 class="font-bold text-red-800 mb-3">ุญุฐู ููุฏ ุงุดุชุฑุงู</h3>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-red-100">
                <input type="text" id="admin-delete-code-input" placeholder="ุฃุฏุฎู ุงูููุฏ ูุญุฐูู" class="input-box mb-3">
                <button onclick="deleteSubscriptionCode()" class="btn-main bg-red-600 hover:bg-red-700">
                    <i class="fas fa-trash-alt ml-2"></i> ุญุฐู ุงูููุฏ
                </button>
                <p class="text-xs text-gray-500 mt-2">ููุงุญุธุฉ: ูุฐุง ุงูุญุฐู ููุงุฆู ููุง ูููู ุงูุชุฑุงุฌุน ุนูู</p>
            </div>
        </div>

        <!-- Premium Users List -->
        <div>
            <h3 class="font-bold text-green-800 mb-3">ุงููุณุชุฎุฏููู ุงููููุฒูู</h3>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-green-100">
                <div id="premium-users-list" class="space-y-3 max-h-[300px] overflow-y-auto">
                    <p class="text-center text-gray-400 py-4">ุฌุงุฑู ุชุญููู ุงููุงุฆูุฉ...</p>
                </div>
                <button onclick="loadPremiumUsers()" class="btn-main bg-green-600 hover:bg-green-700 mt-4">
                    <i class="fas fa-sync-alt ml-2"></i> ุชุญุฏูุซ ุงููุงุฆูุฉ
                </button>
            </div>
        </div>
    </div>
</div>

        <!-- Screen: Admin Moderators -->
        <div id="screen-admin-moderators" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฑูุน ุงููุดุฑููู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- Search User -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <h3 class="font-bold text-gray-800 mb-3">ุงูุจุญุซ ุนู ูุณุชุฎุฏู</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="moderator-search-input" placeholder="ุฃุฏุฎู ูุนุฑู ุงููุณุชุฎุฏู (ID)" class="input-box flex-1">
                        <button onclick="searchUserForModerator()" class="btn-main w-auto px-6">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div id="moderator-search-result" class="hidden bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="text-center mb-4">
                            <img id="moderator-user-photo" src="" class="w-16 h-16 rounded-full mx-auto mb-2">
                            <h4 id="moderator-user-name" class="font-bold"></h4>
                            <p id="moderator-user-id" class="text-xs text-gray-500"></p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-500 mb-2">ุงููุฑุญูุฉ ุงููุณุคูู ุนููุง</label>
                            <select id="moderator-grade" class="input-box">
                                <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                                <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                                <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                            </select>
                        </div>
                        
                        <button onclick="promoteToModerator()" class="btn-main bg-blue-600 hover:bg-blue-700">
                            <i class="fas fa-user-shield ml-2"></i> ุฑูุน ููุดุฑู
                        </button>
                    </div>
                </div>

                <!-- Current Moderators List -->
                <div>
                    <h3 class="font-bold text-gray-800 mb-3">ุงููุดุฑููู ุงูุญุงูููู</h3>
                    <div id="current-moderators-list" class="space-y-3">
                        <p class="text-center text-gray-400 py-4">ุฌุงุฑู ุชุญููู ุงููุงุฆูุฉ...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: Admin System Panel -->
        <div id="screen-admin-panel" class="screen pt-20">
             <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฅุนุฏุงุฏุงุช ุงููุธุงู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-gray-900 rounded-2xl p-5 border-2 border-indigo-600 shadow-xl relative overflow-hidden mb-6">
                    <div class="flex items-center justify-between mb-4 relative z-10">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-power-off text-indigo-400 text-xl"></i>
                            <h3 class="font-bold text-white text-sm">ุญุงูุฉ ุงููุธุงู (ุงูุตูุงูุฉ)</h3>
                        </div>
                        <label class="toggle-wrapper">
                            <input type="checkbox" id="system-toggle" class="toggle-checkbox" onchange="toggleSystemUI()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p id="system-status-text" class="text-xs font-bold text-green-400 mb-2">ุงููุธุงู ูุนูู ุญุงููุงู โ</p>
                    <div class="mt-4">
                        <label class="block text-xs font-bold text-gray-400 mb-2">ุฑุณุงูุฉ ุงูุชูุจูู ููุทูุงุจ:</label>
                        <textarea id="maintenance-msg-input" class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl p-3 text-sm focus:border-indigo-500 outline-none h-20 mb-3" placeholder="ูุซูุงู: ุชููู ููุตูุงูุฉ..."></textarea>
                        <button onclick="saveSystemSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl text-sm transition shadow-lg flex items-center justify-center gap-2"><i class="fas fa-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-5 shadow-sm">
                    <h3 class="font-bold text-yellow-800 mb-2">๐ ุชูุฒูุน ุงูุฌูุงุฆุฒ ุงูุฃุณุจูุนูุฉ</h3>
                    <p class="text-xs text-yellow-600 mb-4">ุณูุชู ุงูุชูุฒูุน ุงูุชููุงุฆู ุนูุฏ ุงูุชูุงุก ุงูุนุฏุงุฏ.</p>
                    <button onclick="manualWeeklyDistribution()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-yellow-600">ุชูุฒูุน ูุฏูู ุงูุขู</button>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Users -->
        <div id="screen-admin-users" class="screen pt-20">
             <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="admin-user-search" placeholder="ุงุจุญุซ ุจูุนุฑู ุงููุณุชุฎุฏู (ID)" class="input-box">
                    <button onclick="searchUserForAdmin()" class="btn-main w-auto px-6"><i class="fas fa-search"></i></button>
                </div>
                <div id="admin-user-result" class="hidden bg-white p-5 rounded-2xl shadow-md border border-gray-100"></div>
            </div>
        </div>

        <!-- Screen: App Stats -->
        <div id="screen-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="stats-content" class="space-y-4"><p class="text-center text-gray-400">ุฌุงุฑู ุงูุชุญููู...</p></div>
            </div>
        </div>

        <!-- Screen: My Questions -->
        <div id="screen-my-questions" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฃุณุฆูุชู ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="my-questions-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Screen: Admin Review -->
        <div id="screen-admin-review" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="admin-review-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Screen: Admin ALL Questions -->
        <div id="screen-admin-all" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุชุนุฏูู ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-3 rounded-xl mb-4 shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 mb-2">ุชุตููุฉ ุญุณุจ:</p>
                    <div class="flex gap-2">
                        <select id="admin-filter-grade" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ูู ุงููุฑุงุญู</option><option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option><option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option><option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                        </select>
                        <select id="admin-filter-subject" class="input-box text-sm p-2" onchange="filterAdminQuestions()"><option value="">ูู ุงูููุงุฏ</option></select>
                    </div>
                </div>
                <div id="admin-all-list" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <!-- Screen: Admin Stats -->
        <div id="screen-admin-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ุงุฎุชุฑ ุงููุฑุญูุฉ</label>
                    <select id="stat-grade" class="input-box mb-3 text-sm">
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option><option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option><option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ููุน ุงูุณุคุงู</label>
                    <select id="stat-type" class="input-box mb-4 text-sm">
                        <option value="mcq">ุงุฎุชูุงุฑุงุช</option><option value="tf">ุตุญ ูุฎุทุฃ</option>
                    </select>
                    <button onclick="calculateQuestionStats()" class="btn-main bg-indigo-600"><i class="fas fa-calculator ml-2"></i> ุญุณุงุจ ุงูุนุฏุฏ</button>
                </div>
                <div id="stats-result-container" class="space-y-2 pb-40">
                    <p class="text-center text-gray-400 text-sm mt-10">ุงุฎุชุฑ ุงูุจูุงูุงุช ูุงุถุบุท ุญุณุงุจ</p>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Subjects -->
        <div id="screen-admin-subjects" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุงูููุงุฏ ุงูุชู ุชุณุชูุจู ุฃุณุฆูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
                    <div class="flex gap-3 mb-4">
                        <select id="subject-grade" class="input-box text-sm p-2 flex-1" onchange="loadSubjectManagement()"><option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option><option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option><option value="3med">ุงูุซุงูุซ ูุชูุณุท</option></select>
                        <select id="subject-type" class="input-box text-sm p-2 flex-1" onchange="loadSubjectManagement()"><option value="mcq">ุงุฎุชูุงุฑุงุช</option><option value="tf">ุตุญ ูุฎุทุฃ</option></select>
                    </div>
                    <p class="text-xs text-gray-500 text-center mb-4">ุชูููู/ุชุนุทูู ุงุณุชูุจุงู ุฃุณุฆูุฉ ููููุงุฏ ุญุณุจ ุงูููุน</p>
                </div>
                <div id="subject-management-list" class="space-y-3 pb-20"><p class="text-center text-gray-400">ุฌุงุฑู ุชุญููู ุงูููุงุฏ...</p></div>
            </div>
        </div>
        
        <!-- BOTTOM NAV -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="switchTab('challenges')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-gamepad text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุชุญุฏูุงุช</span>
            </div>
            <div onclick="switchTab('leaderboard')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-trophy text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุชุตููู</span>
            </div>
            <!-- STUDY SCHEDULE BUTTON -->
            <div onclick="switchTab('schedule')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-calendar-alt text-xl mb-1"></i><span class="text-[10px] font-bold">ุฌุฏูู ูููู</span>
            </div>
            <!-- SOLUTIONS BUTTON -->
            <div onclick="switchTab('solutions')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-question-circle text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุญููู</span>
                <div id="solutions-nav-badge" class="red-dot"></div>
            </div>
            <div onclick="switchTab('upload')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg -mt-6 border-4 border-gray-50"><i class="fas fa-plus"></i></div>
                <span class="text-[10px] font-bold mt-1">ุฑูุน</span>
            </div>
            <div onclick="switchTab('profile')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">ุญุณุงุจู</span>
                <div id="profile-tab-badge" class="red-dot"></div>
            </div>
        </div>
        
        <!-- POPUP: Premium Details -->
        <div id="premium-details-modal" class="modal-overlay hidden">
            <div class="modal-content relative bg-gradient-to-br from-indigo-900 to-indigo-800 text-white border-2 border-yellow-500">
                <button onclick="document.getElementById('premium-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <div class="text-center mb-6">
                    <i class="fas fa-crown text-5xl text-yellow-400 mb-3 animate-bounce"></i>
                    <h2 class="text-2xl font-black text-yellow-400">ูููุฒุงุช ุงูุญุณุงุจ ุงููููุฒ</h2>
                </div>
                <div class="space-y-4 text-right">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-check"></i></div>
                        <p class="font-bold">ุชูุซูู ูููุฒ ููุญุณุงุจ (ุนูุงูุฉ ุจุฌุงูุจ ุงูุงุณู).</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-check"></i></div>
                        <p class="font-bold">ุฎูููุฉ ูููุฒุฉ ูุชุญุฑูุฉ ูู ุงูุชุตููู.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">2x</div>
                        <p class="font-bold">ููุงุท ูุถุงุนูุฉ ูู ุงูุชุญุฏูุงุช.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">$$</div>
                        <p class="font-bold">ุฃููุงู ูุถุงุนูุฉ ุนูุฏ ุงูุชูุงุก ุงูุงุณุจูุน.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">15</div>
                        <p class="font-bold">15 ุณุคุงู ุจุฏู 10 ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">3</div>
                        <p class="font-bold">3 ุฃุณุฆูุฉ ุญููู ููููุงู ุจุฏูุงู ูู 1.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">5</div>
                        <p class="font-bold">5 ุฃุณุฆูุฉ ุฑูุน ููููุฉ ุจุฏูุงู ูู 1.</p>
                    </div>
                </div>
                <button onclick="document.getElementById('premium-details-modal').classList.add('hidden')" class="mt-8 w-full bg-yellow-500 text-indigo-900 font-bold py-3 rounded-xl hover:bg-yellow-400 transition">ูููุชุ ุดูุฑุงู</button>
            </div>
        </div>

        <!-- POPUP: Badge Selector -->
        <div id="badge-selector-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                 <button onclick="document.getElementById('badge-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                 <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ุงุฎุชุฑ ููุจ ุงูุชูุซูู</h3>
                 <p class="text-xs text-gray-500 text-center mb-4">ุณูุธูุฑ ูุฐุง ุงูููุจ ุจููู ุนุดูุงุฆู ุจุฌุงูุจ ุงุณูู</p>
                 <div class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto p-2" id="badge-grid"></div>
            </div>
        </div>

        <!-- POPUP: Background Selector -->
        <div id="bg-selector-modal" class="modal-overlay hidden">
             <div class="modal-content relative">
                 <button onclick="document.getElementById('bg-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                 <h3 class="font-bold text-lg mb-4 text-purple-700 text-center">ุงุฎุชุฑ ุฎูููุฉ ุงูุชุตููู</h3>
                 <div class="space-y-3" id="bg-grid"></div>
            </div>
        </div>
        
        <!-- EDIT QUESTION MODAL -->
        <div id="edit-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">ุชุนุฏูู ุงูุณุคุงู ุงูุดุงูู</h3>
                <input type="hidden" id="edit-q-id">
                <label class="block text-xs font-bold text-gray-500 mb-1">ูุต ุงูุณุคุงู</label>
                <textarea id="edit-q-text" class="input-box h-20 mb-3 text-sm"></textarea>
                <div class="flex gap-2 mb-3">
                     <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">ุงูุตู</label><select id="edit-q-grade" class="input-box text-sm p-2"><option value="6sci">6 ุนููู</option><option value="6lit">6 ุฃุฏุจู</option><option value="3med">3 ูุชูุณุท</option></select></div>
                     <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">ุงููุงุฏุฉ</label><select id="edit-q-subject" class="input-box text-sm p-2"></select></div>
                </div>
                <div id="edit-mcq-fields" class="hidden">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 1</label><input type="text" id="edit-ans-0" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 2</label><input type="text" id="edit-ans-1" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 3</label><input type="text" id="edit-ans-2" class="input-box mb-3 p-2 text-sm">
                     <label class="block text-xs font-bold text-green-600 mb-1">ุฑูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (0, 1, 2)</label>
                     <select id="edit-correct-mcq" class="input-box p-2 text-sm"><option value="0">ุงูุฎูุงุฑ 1</option><option value="1">ุงูุฎูุงุฑ 2</option><option value="2">ุงูุฎูุงุฑ 3</option></select>
                </div>
                <div id="edit-tf-fields" class="hidden">
                    <label class="block text-xs font-bold text-green-600 mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                    <select id="edit-correct-tf" class="input-box p-2 text-sm"><option value="true">ุตุญ</option><option value="false">ุฎุทุฃ</option></select>
                </div>
                <button onclick="saveFullEditQ()" class="btn-main mt-6 bg-indigo-600 text-sm">ุญูุธ ุงูุชุนุฏููุงุช</button>
            </div>
        </div>

        <!-- EDIT BIO MODAL -->
        <div id="edit-bio-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-bio-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">ุชุนุฏูู ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ</h3>
                <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุชุจ ุณูุฑุชู ุงูุฐุงุชูุฉ (ุงุฎุชูุงุฑู)</label>
                <textarea id="edit-bio-text" class="input-box h-32 mb-3 text-sm" placeholder="ูุซุงู: ุทุงูุจ ูุฌุชูุฏุ ุฃุญุจ ุงูุฑูุงุถูุงุช ูุงูุจุฑูุฌุฉ..."></textarea>
                <p class="text-xs text-gray-400 mb-4">ุณูุธูุฑ ูุฐุง ุงููุต ุฃุณูู ุงุณูู ูู ุงูุชุตููู ุงูุนุงููู</p>
                <button onclick="saveProfileBio()" class="btn-main bg-indigo-600">ุญูุธ ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ</button>
            </div>
        </div>

        <!-- SOLUTION ANSWER MODAL -->
        <div id="solution-answer-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('solution-answer-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-green-700 border-b pb-2">ุฅุฑุณุงู ุญู ุงูุณุคุงู</h3>
                <input type="hidden" id="solution-answer-id">
                
                <div class="mb-4">
                    <p class="text-sm font-bold text-gray-600 mb-2">ุงูุณุคุงู ุงููุฑุณู:</p>
                    <div id="solution-question-preview" class="bg-gray-50 p-3 rounded-lg border border-gray-200"></div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-500 mb-2">ุตูุฑุฉ ุงูุญู</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-green-400 transition" onclick="document.getElementById('solution-answer-image-input').click()">
                        <i class="fas fa-image text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500 text-sm">ุงููุฑ ูุฑูุน ุตูุฑุฉ ุงูุญู</p>
                        <input type="file" id="solution-answer-image-input" hidden accept="image/*" onchange="previewSolutionAnswerImage(this)">
                    </div>
                    <div id="solution-answer-image-preview" class="mt-3 hidden">
                        <img id="solution-answer-preview-img" class="solution-image-preview">
                        <button onclick="removeSolutionAnswerImage()" class="mt-2 text-red-500 text-sm font-bold">
                            <i class="fas fa-trash ml-1"></i> ุฅุฒุงูุฉ ุงูุตูุฑุฉ
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-500 mb-2">ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)</label>
                    <textarea id="solution-answer-notes" class="input-box h-24" placeholder="ุงูุชุจ ุฃู ููุงุญุธุงุช ุฃู ุชูุถูุญุงุช ุญูู ุงูุญู..."></textarea>
                </div>
                
                <button onclick="sendSolutionAnswer()" class="btn-main bg-green-600 hover:bg-green-700">
                    <i class="fas fa-paper-plane ml-2"></i> ุฅุฑุณุงู ุงูุญู
                </button>
            </div>
        </div>

        <!-- VIEW SOLUTION IMAGE MODAL -->
        <div id="view-solution-image-modal" class="modal-overlay hidden">
            <div class="modal-content relative bg-black">
                <button onclick="document.getElementById('view-solution-image-modal').classList.add('hidden')" class="absolute top-4 right-4 bg-white text-black w-10 h-10 rounded-full flex items-center justify-center z-50">
                    <i class="fas fa-times"></i>
                </button>
                <div class="h-full flex items-center justify-center">
                    <img id="full-solution-image" class="max-w-full max-h-full object-contain">
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, increment, getDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfLOjiPiSQW9opdiIgQif3pAp8zsezy58",
            authDomain: "ministerial-hacker.firebaseapp.com",
            databaseURL: "https://ministerial-hacker-default-rtdb.firebaseio.com",
            projectId: "ministerial-hacker",
            storageBucket: "ministerial-hacker.firebasestorage.app",
            messagingSenderId: "557133038084",
            appId: "1:557133038084:web:c8cb7df6ef0abef2beab51",
            measurementId: "G-WYMSX2LRTW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ******************************************************
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";
        // ******************************************************

        setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence Error", e));

        let currentUser = null;
        let userData = null;
        let selectedQType = null;
        let currentMatchId = null;
        let gameTimer = null;
        let hasAnsweredCurrentQ = false;
        let allAdminQuestions = []; 
        let adminListenerUnsubscribe = null;
        let matchListenerUnsubscribe = null; 
        let countdownInterval = null;
        let weeklyAutoDistributeInterval = null;
        
        // --- GAME LOGIC VARS ---
        let isExitingGame = false;
        let currentGameMode = 'online'; 
        let aiDifficulty = 'medium'; 
        let localMatchData = null; 
        let aiTimeoutId = null; 
        let currentQuestionCorrectAnswer = null; 
        let userAnsweredCorrectly = false; 

        // --- SYSTEM STATUS VARS ---
        let systemConfig = { enabled: true, msg: "ุงููุธุงู ูู ูุถุน ุงูุตูุงูุฉ ุญุงููุงู" };
        let systemStatusLock = false; // ูููุน ุงูุชุจุฏูู ุงูุชููุงุฆู

        // --- SUBJECT MANAGEMENT VARS ---
        let disabledSubjects = {}; 
        let subjectManagementListener = null;

        // --- PREMIUM DATA ---
        let premiumInterval = null;
        const BADGES_LIST = ["ุณุฌุงุฌ", "ุณุฌุงุฌุฉ", "ุฏูุชูุฑ", "ุฏูุชูุฑุฉ", "ูุณูุงู", "ูุณููุฉ", "ุดุทูุฑ", "ุดุทูุฑุฉ", "ูุงูู", "ูุงููุฉ", "ูุนุณุงู", "ูุนุณุงูุฉ", "ูุงูู ูุงูุณ", "ูููุฏุณ", "ูููุฏุณุฉ", "ูุงุญุฏ ุนุฑุงู", "ุตฺฏุงุฑูู", "ุตฺฏุงุฑุชูู", "ูุณุชูุฉ", "ุงููุญุงูู", "ุงููุญุงููุฉ"];
        const BACKGROUNDS_LIST = [
            { id: 'bg-medical', name: 'ุทุจู (ุณูุงุฆู)', class: 'bg-medical' },
            { id: 'bg-law', name: 'ูุงููู (ุฌูุฒู)', class: 'bg-law' },
            { id: 'bg-edu', name: 'ุชุนููู (ุฃุฎุถุฑ)', class: 'bg-edu' },
            { id: 'bg-eng', name: 'ููุฏุณุฉ (ุฃุตูุฑ)', class: 'bg-eng' },
            { id: 'bg-smart', name: 'ุฐูู (ุจุฑุชูุงูู)', class: 'bg-smart' },
            { id: 'bg-love', name: 'ุญุจ (ูุฑุฏู)', class: 'bg-love' }
        ];

        const subjects = {
            '6sci': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุงุญูุงุก', 'ุฑูุงุถูุงุช', 'ููููุงุก', 'ููุฒูุงุก'],
            '6lit': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุชุงุฑูุฎ', 'ุฑูุงุถูุงุช', 'ุฌุบุฑุงููุฉ', 'ุงูุชุตุงุฏ'],
            '3med': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุฑูุงุถูุงุช', 'ููููุงุก', 'ููุฒูุงุก', 'ุงุฌุชูุงุนูุงุช']
        };

        // --- SOLUTIONS DATA ---
        let solutionsListener = null;
        let adminSolutionsListener = null;
        let dailySolutionLimit = 1;
        let todaySolutionsSent = 0;

        // Initialize Firebase and Listeners
        onAuthStateChanged(auth, async (user) => {
            const intro = document.getElementById('intro-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const banScreen = document.getElementById('ban-screen');

            if (user) {
                currentUser = user;
                listenToSystemStatus();
                loadDisabledSubjects();
                startWeeklyAutoDistribution();

                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        userData = docSnap.data();

                        // BAN CHECK
                        if (userData.isBanned === true) {
                            banScreen.classList.remove('hidden');
                            await signOut(auth);
                            return;
                        }

                        updateDoc(doc(db, "users", user.uid), { lastActive: serverTimestamp() });
                        
                        setupProfileUI();
                        setupHeaderUI();
                        setupAdminUI();
                        checkDailyReward(); 
                        checkPremiumStatus();
                        loadSolutionsData();
                        
                        if(userData.email === ADMIN_EMAIL || userData.isModerator) {
                            setupSolutionsAdminUI();
                            listenToAdminSolutions();
                        }

                        if (userData.grade) {
                            document.getElementById('grade-selector-card').classList.add('hidden');
                            document.getElementById('challenge-active-card').classList.remove('hidden');
                            document.getElementById('header-grade-badge').innerText = getGradeName(userData.grade);
                            document.getElementById('header-grade-badge').classList.remove('hidden');
                            populateSubjects(userData.grade, 'challenge-subject');
                        } else {
                            document.getElementById('grade-selector-card').classList.remove('hidden');
                            document.getElementById('challenge-active-card').classList.add('hidden');
                            document.getElementById('header-grade-badge').classList.add('hidden');
                        }
                        
                        // Fake delay for intro animation
                        setTimeout(() => {
                            intro.classList.add('hidden');
                            authScreen.classList.add('hidden');
                            mainApp.classList.remove('hidden');
                            if(!document.querySelector('.screen.active')) switchTab('challenges');
                            startWeeklyCountdown();
                        }, 2500);
                        
                    } else {
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) { console.error("Auth Data Error:", e); }
            } else {
                setTimeout(() => {
                    intro.classList.add('hidden');
                    mainApp.classList.add('hidden');
                    banScreen.classList.add('hidden');
                    authScreen.classList.remove('hidden');
                    window.switchAuthTab('login');
                }, 2000);
            }
        });

        // --- WEEKLY COUNTDOWN & AUTO DISTRIBUTION ---
        function startWeeklyCountdown() {
            if(countdownInterval) clearInterval(countdownInterval);
            const timerEl = document.getElementById('weekly-timer');
            
            function updateTimer() {
                const now = new Date();
                const day = now.getDay(); // 0=Sun, 4=Thu, 5=Fri
                const daysUntilThu = (4 - day + 7) % 7; 
                
                const target = new Date(now);
                target.setDate(now.getDate() + daysUntilThu);
                target.setHours(23, 59, 59, 999);
                
                if (day === 5) {
                      target.setDate(now.getDate() + 6);
                }
                
                const diff = target - now;
                if (diff < 0) {
                      timerEl.innerText = "00:00:00:00";
                      return;
                }

                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);

                timerEl.innerText = `${d}:${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            }
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        function startWeeklyAutoDistribution() {
            if(weeklyAutoDistributeInterval) clearInterval(weeklyAutoDistributeInterval);
            
            weeklyAutoDistributeInterval = setInterval(async () => {
                const now = new Date();
                const day = now.getDay();
                const hour = now.getHours();
                const minute = now.getMinutes();
                
                // Check if it's Thursday 23:59 (Friday 00:00 in Iraq)
                if (day === 4 && hour === 23 && minute === 59) {
                    try {
                        await autoDistributeWeeklyPrizes();
                        console.log("โ ุชู ุงูุชูุฒูุน ุงูุชููุงุฆู ููุฌูุงุฆุฒ ุงูุฃุณุจูุนูุฉ");
                    } catch (error) {
                        console.error("โ ุฎุทุฃ ูู ุงูุชูุฒูุน ุงูุชููุงุฆู:", error);
                    }
                }
            }, 60000); // Check every minute
        }

        async function autoDistributeWeeklyPrizes() {
            try {
                // Get Top 5
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(5));
                const snap = await getDocs(q);
                const prizes = [10, 7, 5, 3, 2]; // $
                
                let batch = writeBatch(db);
                
                // Distribute Prizes
                snap.docs.forEach((d, index) => {
                    if(index < 5) {
                        const prize = prizes[index];
                        const newBalance = (d.data().balance || 0) + prize;
                        batch.update(doc(db, "users", d.id), { balance: newBalance });
                    }
                });

                // Reset Points for Top 150
                const qReset = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
                const snapReset = await getDocs(qReset);
                
                snapReset.docs.forEach(d => {
                    batch.update(doc(db, "users", d.id), { points: 0 });
                });
                
                await batch.commit();
                
                // Log the distribution
                await addDoc(collection(db, "system_logs"), {
                    type: "weekly_distribution",
                    timestamp: serverTimestamp(),
                    message: "ุชู ุงูุชูุฒูุน ุงูุชููุงุฆู ููุฌูุงุฆุฒ ุงูุฃุณุจูุนูุฉ"
                });
                
            } catch (e) {
                console.error("Auto distribution error:", e);
                throw e;
            }
        }

        // --- FORGOT PASSWORD ---
        window.openForgotPassword = function() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            document.getElementById('forgot-email').value = document.getElementById('login-email').value || '';
        };

        window.closeForgotPassword = function() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        };

        window.sendResetLink = async function() {
            const email = document.getElementById('forgot-email').value;
            if (!email || !email.includes('@')) { alert('ูุฑุฌู ุฅุฏุฎุงู ุจุฑูุฏ ุฅููุชุฑููู ุตุญูุญ'); return; }
            try {
                await sendPasswordResetEmail(auth, email);
                alert('โ ุชู ุฅุฑุณุงู ุฑุงุจุท ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ ุฅูู ุจุฑูุฏู ุงูุฅููุชุฑููู.');
                closeForgotPassword();
            } catch (error) { alert('โ ุญุฏุซ ุฎุทุฃ: ' + getArabicError(error.code)); } 
        };

        // --- ARABIC ERROR ---
        function getArabicError(code) {
            switch(code) {
                case 'auth/email-already-in-use': return 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ุจุงููุนู';
                case 'auth/invalid-email': return 'ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุบูุฑ ุตุงูุญ';
                case 'auth/weak-password': return 'ูููุฉ ุงููุฑูุฑ ุถุนููุฉ';
                case 'auth/user-disabled': return 'ุชู ุชุนุทูู ูุฐุง ุงูุญุณุงุจ';
                case 'auth/user-not-found': return 'ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ';
                case 'auth/wrong-password': return 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ';
                default: return 'ุญุฏุซ ุฎุทุฃ: ' + code;
            }
        }

        // --- SYSTEM STATUS (FIXED) ---
        function listenToSystemStatus() {
            onSnapshot(doc(db, "system_settings", "config"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Prevent automatic toggling
                    if (!systemStatusLock) {
                        systemConfig.enabled = data.challengesEnabled !== undefined ? data.challengesEnabled : true;
                        systemConfig.msg = data.maintenanceMessage || "ุงููุธุงู ูู ูุถุน ุงูุตูุงูุฉ ุญุงููุงู.";
                    }
                    
                    const toggle = document.getElementById('system-toggle');
                    const statusText = document.getElementById('system-status-text');
                    const msgInput = document.getElementById('maintenance-msg-input');
                    
                    if (toggle) {
                        toggle.checked = systemConfig.enabled;
                        if (!systemConfig.enabled) {
                            statusText.innerText = "ุงููุธุงู ูุชููู โ (ุงูุทูุงุจ ูุฑูู ุงูุฑุณุงูุฉ)";
                            statusText.className = "text-xs font-bold text-red-400 mb-2";
                        } else {
                            statusText.innerText = "ุงููุธุงู ูุนูู ุญุงููุงู โ";
                            statusText.className = "text-xs font-bold text-green-400 mb-2";
                        }
                        if (msgInput && document.activeElement !== msgInput) msgInput.value = systemConfig.msg;
                    }
                }
            });
        }

        async function loadDisabledSubjects() {
            try {
                const docSnap = await getDoc(doc(db, "system_settings", "disabled_subjects"));
                if (docSnap.exists()) {
                    disabledSubjects = docSnap.data();
                    // Ensure disabledSubjects is always an object
                    if (typeof disabledSubjects !== 'object') disabledSubjects = {};
                } else {
                    disabledSubjects = {};
                }
            } catch (e) { 
                console.error("Error loading disabled subjects:", e);
                disabledSubjects = {};
            }
        }

        function getEnabledSubjects(grade, type) {
            if (!subjects[grade]) return [];
            return subjects[grade].filter(subject => {
                 const key = `${grade}_${type}`;
                 return !disabledSubjects[key] || !disabledSubjects[key][subject];
            });
        }

        async function loadSubjectManagement() {
            const grade = document.getElementById('subject-grade').value;
            const type = document.getElementById('subject-type').value;
            const container = document.getElementById('subject-management-list');
            if (!grade || !type) return;
            const key = `${grade}_${type}`;
            const currentDisabled = disabledSubjects[key] || {};
            let html = '';
            subjects[grade].forEach(subject => {
                const isDisabled = currentDisabled[subject] === true;
                html += `<div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm flex justify-between items-center"><div><p class="font-bold text-gray-800">${subject}</p><p class="text-xs text-gray-400">${getGradeName(grade)} - ${type === 'mcq' ? 'ุงุฎุชูุงุฑุงุช' : 'ุตุญ ูุฎุทุฃ'}</p></div><label class="toggle-wrapper"><input type="checkbox" class="toggle-checkbox" ${isDisabled ? '' : 'checked'} onchange="toggleSubject('${grade}', '${type}', '${subject}', this.checked)"><span class="toggle-slider"></span></label></div>`;
            });
            container.innerHTML = html;
        }

        window.toggleSubject = async function(grade, type, subject, enabled) {
            const key = `${grade}_${type}`;
            if (!disabledSubjects[key]) disabledSubjects[key] = {};
            
            if (enabled) {
                delete disabledSubjects[key][subject];
            } else {
                disabledSubjects[key][subject] = true;
            }
            
            try {
                await setDoc(doc(db, "system_settings", "disabled_subjects"), disabledSubjects, { merge: true });
                alert(`โ ุชู ${enabled ? 'ุชูุนูู' : 'ุชุนุทูู'} ุงููุงุฏุฉ ${subject}`);
                updateUploadUIBasedOnSubjects();
            } catch (e) { 
                console.error("Error toggling subject:", e);
                alert('โ ุฎุทุฃ: ' + e.message); 
            }
        };

        function updateUploadUIBasedOnSubjects() {
            if (!userData || !userData.grade) return;
            const grade = userData.grade;
            const mcqEnabled = getEnabledSubjects(grade, 'mcq').length > 0;
            const tfEnabled = getEnabledSubjects(grade, 'tf').length > 0;
            const typeSelect = document.getElementById('up-type');
            
            let newHTML = '';
            if (mcqEnabled) newHTML += '<option value="mcq">ุงุฎุชูุงุฑุงุช</option>';
            if (tfEnabled) newHTML += '<option value="tf">ุตุญ ูุฎุทุฃ</option>';
            if (newHTML === '') newHTML = '<option value="" disabled>ูุง ุชูุฌุฏ ุฃููุงุน ูุชุงุญุฉ</option>';
            
            typeSelect.innerHTML = newHTML;
            
            if (mcqEnabled && !tfEnabled) typeSelect.value = 'mcq';
            if (!mcqEnabled && tfEnabled) typeSelect.value = 'tf';
            
            // Update subject list based on selected type
            const selectedType = typeSelect.value;
            if (selectedType) {
                populateSubjects(grade, 'up-subject', selectedType);
            }
        }

        function populateSubjects(grade, elementId, type = null) {
            const sel = document.getElementById(elementId);
            if(!sel) return;
            let filteredSubjects = type ? getEnabledSubjects(grade, type) : (subjects[grade] || []);
            sel.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>';
            filteredSubjects.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            if (filteredSubjects.length === 0) sel.innerHTML += '<option value="" disabled>ูุง ุชูุฌุฏ ููุงุฏ ูุชุงุญุฉ</option>';
        }

        window.switchAuthTab = (tab) => {
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('tab-login-btn').classList.add('active');
                document.getElementById('tab-signup-btn').classList.remove('active');
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
                document.getElementById('tab-login-btn').classList.remove('active');
                document.getElementById('tab-signup-btn').classList.add('active');
            }
        };

        window.handleLogin = async () => {
            try {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { alert(getArabicError(e.code)); }
        };

        window.handleSignup = async () => {
            try {
                // DEVICE CHECK (STRICT LIMIT 2)
                let deviceCount = parseInt(localStorage.getItem('device_acc_count') || "0");
                if (deviceCount >= 2) {
                    alert("โ ุนุฐุฑุงูุ ูุง ูููู ุฅูุดุงุก ุฃูุซุฑ ูู ุญุณุงุจูู ุนูู ููุณ ุงูุฌูุงุฒ.");
                    return;
                }

                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-pass').value;
                const imgFile = document.getElementById('signup-img').files[0];
                
                if(!name || !email || !pass) return alert("ูุฑุฌู ููุก ูุงูุฉ ุงูุญููู");
                if(!email.endsWith("@gmail.com")) return alert("ูุฌุจ ุงุณุชุฎุฏุงู ุงูููู Gmail");
                if(pass.length < 6) return alert("ูููุฉ ุงููุฑูุฑ ูุตูุฑุฉ ุฌุฏุงู");

                let photoURL = `https://ui-avatars.com/api/?name=${name}&background=random&size=128`;
                if(imgFile) photoURL = await compressImage(imgFile);

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                await setDoc(doc(db, "users", cred.user.uid), {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    photo: photoURL,
                    uniqueId: generateId(),
                    points: 0,
                    balance: 0,
                    role: 'user',
                    isBanned: false,
                    invitedCount: 0,
                    bio: "",
                    isPremium: false,
                    premiumExpiry: null,
                    selectedBadge: null,
                    selectedBadgeColor: null,
                    selectedBgTheme: 'bg-rank-default',
                    isModerator: false,
                    moderatorGrade: null,
                    dailyQuestionsSent: 0,
                    dailySolutionsSent: 0,
                    lastQuestionReset: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp()
                });

                localStorage.setItem('device_acc_count', (deviceCount + 1).toString());

            } catch (e) { alert(getArabicError(e.code)); }
        };

        window.logout = () => {
            if(adminListenerUnsubscribe) adminListenerUnsubscribe(); 
            if(matchListenerUnsubscribe) matchListenerUnsubscribe();
            if(subjectManagementListener) subjectManagementListener();
            if(premiumInterval) clearInterval(premiumInterval);
            if(solutionsListener) solutionsListener();
            if(adminSolutionsListener) adminSolutionsListener();
            if(weeklyAutoDistributeInterval) clearInterval(weeklyAutoDistributeInterval);
            signOut(auth);
        };

        // --- DAILY REWARD ---
        function getIraqDate() {
            const dateStr = new Date().toLocaleString("en-US", {timeZone: "Asia/Baghdad"});
            return new Date(dateStr);
        }

        window.checkDailyReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            if (userData.lastRewardDayKey === currentDayKey) return; 

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const nextDayToClaim = userDaysClaimed + 1;
            const grid = document.getElementById('reward-grid-container');
            grid.innerHTML = '';
            for(let i=1; i<=30; i++) {
                let pts = 5;
                if(i > 10 && i <= 20) pts = 10;
                if(i > 20) pts = 15;

                let cls = "day-box";
                if (i < nextDayToClaim) cls += " claimed"; 
                else if (i === nextDayToClaim) cls += " active"; 
                else cls += " locked"; 
                grid.innerHTML += `<div class="${cls}"><p>ููู ${i}</p><span>${pts} ููุงุท</span></div>`;
            }
            document.getElementById('daily-reward-screen').classList.remove('hidden');
        };

        window.claimReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const dayToClaim = userDaysClaimed + 1;
            let rewardAmount = 5;
            if(dayToClaim > 10 && dayToClaim <= 20) rewardAmount = 10;
            if(dayToClaim > 20) rewardAmount = 15;

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(rewardAmount),
                lastRewardDayKey: currentDayKey,
                rewardMonthKey: currentMonthKey,
                daysClaimedInMonth: increment(1) 
            });
            userData.points += rewardAmount;
            userData.lastRewardDayKey = currentDayKey;
            userData.rewardMonthKey = currentMonthKey;
            userData.daysClaimedInMonth = dayToClaim;
            setupHeaderUI();
            document.getElementById('daily-reward-screen').classList.add('hidden');
        };

        function setupProfileUI() {
    document.getElementById('profile-name-text').innerText = userData.name;
    document.getElementById('profile-id-text').innerText = "ID: " + userData.uniqueId;
    document.getElementById('profile-img').src = userData.photo;
    document.getElementById('profile-bio-text').innerText = userData.bio || "ูุง ุชูุฌุฏ ุณูุฑุฉ ุฐุงุชูุฉ";
    
    // Badge Logic in Profile
    const container = document.getElementById('profile-name-container');
    const existingBadge = container.querySelector('.premium-badge');
    if(existingBadge) existingBadge.remove();

    if (userData.isPremium && userData.selectedBadge && isPremiumValid(userData)) {
        const badgeSpan = document.createElement('span');
        badgeSpan.className = "premium-badge";
        badgeSpan.style.backgroundColor = userData.selectedBadgeColor || '#f59e0b';
        badgeSpan.innerText = userData.selectedBadge;
        container.insertBefore(badgeSpan, document.getElementById('profile-name-text').nextSibling);
    }

    // Wallet UI
    document.getElementById('wallet-balance').innerText = userData.balance || 0;
    if ((userData.balance || 0) >= 100) {
        document.getElementById('withdraw-section').classList.remove('hidden');
        document.getElementById('withdraw-locked-msg').classList.add('hidden');
    } else {
        document.getElementById('withdraw-section').classList.add('hidden');
        document.getElementById('withdraw-locked-msg').classList.remove('hidden');
    }
    
    // ุชุญุฏูุซ ุงูููุฏุฑ ุจูุงุกู ุนูู ุงูุชุจููุจ ุงูุญุงูู
    const activeTab = document.querySelector('.screen.active');
    if (activeTab && activeTab.id === 'tab-solutions') {
        manageHeaderForTab('solutions');
    }
}

        function setupHeaderUI() { 
            document.getElementById('header-points').innerText = userData.points; 
        }

        function setupAdminUI() { 
            if (userData.email === ADMIN_EMAIL) {
                document.getElementById('admin-hub-btn-container').classList.remove('hidden'); 
            }
        }

        // --- BIO FUNCTIONS ---
        window.editProfileBio = function() {
            document.getElementById('edit-bio-text').value = userData.bio || "";
            document.getElementById('edit-bio-modal').classList.remove('hidden');
        };

        window.saveProfileBio = async function() {
            const newBio = document.getElementById('edit-bio-text').value;
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { bio: newBio });
                userData.bio = newBio;
                document.getElementById('profile-bio-text').innerText = newBio || "ูุง ุชูุฌุฏ ุณูุฑุฉ ุฐุงุชูุฉ";
                document.getElementById('edit-bio-modal').classList.add('hidden');
                alert("โ ุชู ุญูุธ ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ ุจูุฌุงุญ!");
            } catch(e) {
                alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ");
            }
        };

        window.saveUserGrade = async () => {
            const g = document.getElementById('grade-select').value;
            if (!g) return alert("ุงุฎุชุฑ ุงููุฑุญูุฉ");
            await updateDoc(doc(db, "users", currentUser.uid), { grade: g });
            userData.grade = g;
            document.getElementById('grade-selector-card').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            document.getElementById('header-grade-badge').innerText = getGradeName(g);
            document.getElementById('header-grade-badge').classList.remove('hidden');
            populateSubjects(g, 'challenge-subject');
        };

        function getGradeName(code) { 
            return code==='6sci'?'ุงูุณุงุฏุณ ุงูุนููู':code==='6lit'?'ุงูุณุงุฏุณ ุงูุฃุฏุจู':'ุงูุซุงูุซ ูุชูุณุท'; 
        }

        // --- PREMIUM FEATURE LOGIC ---
        function isPremiumValid(user) {
            if(!user.isPremium || !user.premiumExpiry) return false;
            return user.premiumExpiry.toDate() > new Date();
        }

        function checkPremiumStatus() {
            const lockedView = document.getElementById('premium-locked-view');
            const activeView = document.getElementById('premium-active-view');
            
            if (isPremiumValid(userData)) {
                lockedView.classList.add('hidden');
                activeView.classList.remove('hidden');
                startPremiumTimer();
                
                // Set premium limits
                dailySolutionLimit = 3;
            } else {
                lockedView.classList.remove('hidden');
                activeView.classList.add('hidden');
                if(premiumInterval) clearInterval(premiumInterval);
                
                // Set normal limits
                dailySolutionLimit = 1;
            }
            
            // Update solutions UI
            updateSolutionsLimitUI();
        }

        function startPremiumTimer() {
            if(premiumInterval) clearInterval(premiumInterval);
            const display = document.getElementById('premium-countdown');
            const expiry = userData.premiumExpiry.toDate();

            function update() {
                const now = new Date();
                const diff = expiry - now;
                if(diff <= 0) {
                    display.innerText = "ุงูุชูู ุงูุงุดุชุฑุงู";
                    clearInterval(premiumInterval);
                    // Update UI to show premium expired
                    checkPremiumStatus();
                    return;
                }
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                display.innerText = `${d} ููู ${h}:${m}:${s}`;
            }
            update();
            premiumInterval = setInterval(update, 1000);
        }

        window.showPremiumDetails = () => { 
            document.getElementById('premium-details-modal').classList.remove('hidden'); 
        }
        
        window.activatePremiumCode = async () => {
            const codeInput = document.getElementById('premium-code-input').value.trim().toUpperCase();
            if(!codeInput) return alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูููุฏ");

            try {
                // ุงูุจุญุซ ุนู ุงูููุฏ
                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    alert("โ ุงูููุฏ ุบูุฑ ุตุญูุญ ุฃู ุบูุฑ ููุฌูุฏ");
                    return;
                }
                
                const codeDoc = snap.docs[0];
                const codeData = codeDoc.data();

                // ุงูุชุญูู ูู ุฃู ุงูููุฏ ูู ูุณุชุฎุฏู ูู ูุจู
                if(codeData.used) {
                    alert("โ ูุฐุง ุงูููุฏ ูุณุชุฎุฏู ูู ูุจู ููุง ูููู ุงุณุชุฎุฏุงูู ูุฑุฉ ุฃุฎุฑู");
                    return;
                }

                // ุงูุชุญูู ูู ุฃู ุงูููุฏ ููุนู
                if(codeData.isActive === false) {
                    alert("โ ูุฐุง ุงูููุฏ ูุนุทู ูู ูุจู ุงูุฅุฏุงุฑุฉ");
                    return;
                }

                // ุชูุนูู ุงูุงุดุชุฑุงู
                const durationDays = codeData.durationDays;
                let newExpiry = new Date();
                
                // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูููุฒ ุจุงููุนูุ ูุถูู ุงููุฏุฉ ุฅูู ุชุงุฑูุฎ ุงูุชูุงุฆู ุงูุญุงูู
                if (isPremiumValid(userData)) {
                    newExpiry = userData.premiumExpiry.toDate();
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                } else {
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                }

                const batch = writeBatch(db);
                
                // ุชุญุฏูุซ ุญุงูุฉ ุงูููุฏ ุฅูู ูุณุชุฎุฏู
                batch.update(doc(db, "premium_codes", codeDoc.id), { 
                    used: true, 
                    usedBy: currentUser.uid, 
                    usedAt: serverTimestamp() 
                });
                
                // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู
                batch.update(doc(db, "users", currentUser.uid), { 
                    isPremium: true,
                    premiumExpiry: Timestamp.fromDate(newExpiry)
                });
                
                await batch.commit();
                
                // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
                userData.isPremium = true;
                userData.premiumExpiry = Timestamp.fromDate(newExpiry);

                alert(`๐ ูุจุฑูู! ุชู ุชูุนูู ุงูุงุดุชุฑุงู ุงููููุฒ ููุฏุฉ ${durationDays} ููู.\n\nุงูููุฏ ุงุณุชุฎุฏู ููู ูุนูู ูุฑุฉ ุฃุฎุฑู.`);
                checkPremiumStatus();
                document.getElementById('premium-code-input').value = "";

            } catch(e) { 
                console.error("ุฎุทุฃ ูู ุชูุนูู ุงูููุฏ:", e);
                alert("โ ุญุฏุซ ุฎุทุฃ ูู ุชูุนูู ุงูููุฏ: " + e.message); 
            }
        };

        // Badge Selector
        window.openBadgeSelector = () => {
            const grid = document.getElementById('badge-grid');
            grid.innerHTML = '';
            BADGES_LIST.forEach(txt => {
                const btn = document.createElement('button');
                const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#818cf8', '#a78bfa', '#f472b6'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                btn.className = "p-3 rounded-lg border-2 border-gray-100 font-bold text-white shadow-sm hover:scale-105 transition";
                btn.style.backgroundColor = randomColor;
                btn.innerText = txt;
                btn.onclick = () => saveBadgeChoice(txt, randomColor);
                grid.appendChild(btn);
            });
            document.getElementById('badge-selector-modal').classList.remove('hidden');
        };

        async function saveBadgeChoice(txt, color) {
            await updateDoc(doc(db, "users", currentUser.uid), { selectedBadge: txt, selectedBadgeColor: color });
            userData.selectedBadge = txt;
            userData.selectedBadgeColor = color;
            document.getElementById('badge-selector-modal').classList.add('hidden');
            setupProfileUI();
            alert("ุชู ุชุญุฏูุซ ุนูุงูุฉ ุงูุชูุซูู โ");
        }

        // Bg Selector
        window.openBgSelector = () => {
            const list = document.getElementById('bg-grid');
            list.innerHTML = '';
            BACKGROUNDS_LIST.forEach(bg => {
                const btn = document.createElement('button');
                btn.className = `w-full h-20 rounded-xl shadow-md border-2 border-transparent hover:border-indigo-500 transition mb-2 ${bg.class} flex items-center justify-center`;
                btn.innerHTML = `<span class="bg-white/80 px-3 py-1 rounded-full font-bold text-gray-800 text-sm">${bg.name}</span>`;
                btn.onclick = () => saveBgChoice(bg.id, bg.class);
                list.appendChild(btn);
            });
            document.getElementById('bg-selector-modal').classList.remove('hidden');
        };

        async function saveBgChoice(id, cssClass) {
             await updateDoc(doc(db, "users", currentUser.uid), { selectedBgTheme: cssClass });
             userData.selectedBgTheme = cssClass;
             document.getElementById('bg-selector-modal').classList.add('hidden');
             alert("ุชู ุชุญุฏูุซ ุฎูููุฉ ุงูุชุตููู โ");
        }

        // --- MATCHMAKING & GAME (FIXED) ---
        window.setQType = (t) => {
            selectedQType = t;
            document.getElementById('btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
        };

        window.startMatchmaking = async (mode) => {
            if (!systemConfig.enabled) {
                const modal = document.getElementById('maintenance-popup');
                document.getElementById('maintenance-msg-display').innerText = systemConfig.msg;
                modal.classList.remove('hidden');
                return;
            }
            const sub = document.getElementById('challenge-subject').value;
            if(!sub || !selectedQType) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฏุฉ ูููุน ุงูุฃุณุฆูุฉ");

            currentGameMode = mode;
            if (mode === 'ai') aiDifficulty = document.getElementById('ai-difficulty').value;

            document.getElementById('challenge-active-card').classList.add('hidden');
            document.getElementById('searching-ui').classList.remove('hidden');
            document.getElementById('searching-ui').style.display = 'flex'; 
            document.getElementById('search-msg').innerText = mode === 'online' ? "ุฌุงุฑู ุงูุจุญุซ ุนู ุทุงูุจ..." : "ุฌุงุฑู ุชุญุถูุฑ ุงูุจูุช...";

            const grade = userData.grade;
            let group = `${grade}_${sub}`;
            if(['ุงุณูุงููุฉ','ุนุฑุจู','ุงููููุฒู'].includes(sub) && grade.startsWith('6')) group = `6shared_${sub}`;

            if (mode === 'online') startOnlineMatch(group, sub);
            else startAIMatch(sub);
        };

        async function startOnlineMatch(group, sub) {
            try {
                const qRef = collection(db, "match_queue");
                
                // ุงูุจุญุซ ุนู ูุจุงุฑุงุฉ ุจููุณ ุงููุฑุญูุฉ
                const qWait = query(
                    qRef, 
                    where("group", "==", group), 
                    where("status", "==", "waiting"), 
                    limit(10)
                );
                
                const snap = await getDocs(qWait);
                let foundMatchId = null;
                
                snap.forEach((doc) => { 
                    const matchData = doc.data();
                    // ุชุฃูุฏ ุฃู ุงููุงุนุจ ููุณ ููุณ ุงููุณุชุฎุฏู ูุฃู ุงููุจุงุฑุงุฉ ุจููุณ ุงููุฑุญูุฉ
                    if (matchData.player1.uid !== currentUser.uid && matchData.grade === userData.grade) {
                        foundMatchId = doc.id;
                    }
                });

                if(foundMatchId) {
                    currentMatchId = foundMatchId;
                    await updateDoc(doc(db, "match_queue", foundMatchId), {
                        player2: { 
                            uid: currentUser.uid, 
                            name: userData.name, 
                            score: 0, 
                            photo: userData.photo,
                            grade: userData.grade
                        },
                        status: 'active',
                        answersCount: 0,
                        lastUpdated: serverTimestamp()
                    });
                    listenToMatch(foundMatchId);
                } else {
                    // ุฌูุจ ุงูุฃุณุฆูุฉ ุจููุณ ุงููุฑุญูุฉ ููุท
                    const qDocs = await getQuestions(sub, selectedQType);
                    if(qDocs.length === 0) { 
                        alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ ูู ูุฐุง ุงููุณู ููุฐู ุงููุฑุญูุฉ"); 
                        cancelSearch(); 
                        return; 
                    }
                    
                    const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
                    const newMatch = await addDoc(qRef, {
                        group: group, 
                        status: 'waiting',
                        grade: userData.grade,
                        player1: { 
                            uid: currentUser.uid, 
                            name: userData.name, 
                            score: 0, 
                            photo: userData.photo,
                            grade: userData.grade
                        },
                        player2: null,
                        questions: shuffledQs, 
                        currentIdx: 0, 
                        answersCount: 0,
                        createdAt: serverTimestamp(),
                        lastUpdated: serverTimestamp(),
                        player1Ready: true,
                        player2Ready: false
                    });
                    currentMatchId = newMatch.id;
                    listenToMatch(newMatch.id);
                }
            } catch(e) { 
                console.error("ุฎุทุฃ ูู ุงูุจุญุซ ุนู ูุจุงุฑุงุฉ:", e); 
                cancelSearch(); 
            }
        }

        async function startAIMatch(sub) {
            // ุฌูุจ ุงูุฃุณุฆูุฉ ุจููุณ ุงููุฑุญูุฉ ููุท
            const qDocs = await getQuestions(sub, selectedQType);
            if(qDocs.length === 0) { 
                alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ ูู ูุฐุง ุงููุณู ููุฐู ุงููุฑุญูุฉ"); 
                cancelSearch(); 
                return; 
            }
            
            // PREMIUM LOGIC: 15 Questions if Premium
            let limit = 10;
            if (isPremiumValid(userData)) limit = 15;

            const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, limit);
            localMatchData = {
                status: 'active',
                grade: userData.grade,
                player1: { 
                    uid: currentUser.uid, 
                    name: userData.name, 
                    score: 0, 
                    photo: userData.photo,
                    grade: userData.grade
                },
                player2: { 
                    uid: 'AI_BOT', 
                    name: "ุงูุฐูุงุก ุงูุงุตุทูุงุนู", 
                    score: 0, 
                    photo: 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png',
                    grade: userData.grade
                },
                questions: shuffledQs, 
                currentIdx: 0, 
                answersCount: 0
            };
            
            await showVSAnimation(localMatchData.player1, localMatchData.player2);
            document.getElementById('game-overlay').classList.remove('hidden');
            renderGame(localMatchData);
        }

        async function getQuestions(sub, type) {
            if (!userData.grade) {
                console.error("ูุง ุชูุฌุฏ ูุฑุญูุฉ ูุญุฏุฏุฉ ูููุณุชุฎุฏู");
                return [];
            }
            
            const q = query(
                collection(db, "questions"), 
                where("grade", "==", userData.grade),
                where("subject", "==", sub), 
                where("type", "==", type), 
                limit(50)
            );
            
            const snap = await getDocs(q);
            const list = [];
            snap.forEach(d => {
                const data = d.data();
                if (data.grade === userData.grade) {
                    list.push(data);
                }
            });
            return list;
        }

        function listenToMatch(id) {
            if(matchListenerUnsubscribe) matchListenerUnsubscribe(); 
            matchListenerUnsubscribe = onSnapshot(doc(db, "match_queue", id), async (snap) => {
                if(isExitingGame) return;
                if(!snap.exists()) {
                    // Match was deleted (opponent left)
                    if (!isExitingGame) {
                        handleOpponentLeft();
                    }
                    return;
                }
                const d = snap.data();
                
                // Check if opponent left
                if (d.status === 'cancelled' || d.status === 'completed') {
                    if (!isExitingGame) {
                        handleOpponentLeft(d);
                    }
                    return;
                }
                
                if(d.status === 'active') {
                    if (document.getElementById('game-overlay').classList.contains('hidden') && !document.getElementById('vs-screen').classList.contains('flex')) {
                         await showVSAnimation(d.player1, d.player2);
                         document.getElementById('game-overlay').classList.remove('hidden');
                         renderGame(d);
                    } else {
                         renderGame(d);
                    }
                }
            });
        }
        
        function showVSAnimation(p1, p2) {
            return new Promise(resolve => {
                document.getElementById('searching-ui').classList.add('hidden');
                document.getElementById('searching-ui').style.display = 'none';
                
                const isP1 = p1.uid === currentUser.uid;
                const me = isP1 ? p1 : p2;
                const op = isP1 ? p2 : p1;

                document.getElementById('vs-p1-img').src = me.photo;
                document.getElementById('vs-p1-name').innerText = me.name;
                
                document.getElementById('vs-p2-img').src = op.photo;
                document.getElementById('vs-p2-name').innerText = op.name;

                const screen = document.getElementById('vs-screen');
                screen.classList.remove('hidden');
                
                setTimeout(() => {
                    screen.classList.add('hidden');
                    resolve();
                }, 2500); 
            });
        }

        function renderGame(data) {
            if (isExitingGame) return;
            
            // Validate player data
            if (!data.player1 || !data.player2) {
                console.error("Invalid player data");
                return;
            }
            
            const totalQs = data.questions.length;
            if(!data.questions || data.currentIdx >= totalQs) { 
                endGame(data); 
                return; 
            }
            
            if (currentGameMode === 'online' && data.answersCount >= 2) {
                 if(data.player1.uid === currentUser.uid) {
                     updateDoc(doc(db, "match_queue", currentMatchId), { 
                         currentIdx: increment(1), 
                         answersCount: 0,
                         lastUpdated: serverTimestamp()
                     });
                 }
                 return;
            }
            
            const q = data.questions[data.currentIdx];
            if (!q) { 
                endGame(data); 
                return; 
            }
            
            // Update player info with validation
            try {
                if (currentGameMode === 'online') {
                    const isP1 = data.player1.uid === currentUser.uid;
                    const p1Name = isP1 ? userData.name : (data.player1.name || "ุงููุงุนุจ 1");
                    const p2Name = isP1 ? (data.player2.name || "ุงููุงุนุจ 2") : userData.name;
                    const p1Photo = isP1 ? userData.photo : (data.player1.photo || "https://ui-avatars.com/api/?name=Player1");
                    const p2Photo = isP1 ? (data.player2.photo || "https://ui-avatars.com/api/?name=Player2") : userData.photo;
                    
                    document.getElementById('p1-name').innerText = p1Name.substring(0, 20);
                    document.getElementById('game-p1-img').src = p1Photo;
                    document.getElementById('p2-name').innerText = p2Name.substring(0, 20);
                    document.getElementById('game-p2-img').src = p2Photo;
                    document.getElementById('game-my-score').innerText = isP1 ? data.player1.score : data.player2.score;
                    document.getElementById('game-op-score').innerText = isP1 ? data.player2.score : data.player1.score;
                } else {
                    document.getElementById('p1-name').innerText = userData.name.substring(0, 20);
                    document.getElementById('game-p1-img').src = userData.photo;
                    document.getElementById('p2-name').innerText = data.player2.name.substring(0, 20);
                    document.getElementById('game-p2-img').src = data.player2.photo;
                    document.getElementById('game-my-score').innerText = data.player1.score;
                    document.getElementById('game-op-score').innerText = data.player2.score;
                }
            } catch (error) {
                console.error("Error updating player info:", error);
            }

            const qTextEl = document.getElementById('q-text');
            if(qTextEl.innerText !== q.question) {
                hasAnsweredCurrentQ = false;
                userAnsweredCorrectly = false;
                currentQuestionCorrectAnswer = null;
                clearTimeout(aiTimeoutId); 
                document.getElementById('answers-container').classList.remove('pointer-events-none', 'opacity-50');
                document.getElementById('waiting-msg').classList.add('hidden');
                document.getElementById('ai-thinking-msg').classList.add('hidden');
                
                clearInterval(gameTimer);
                let t = 15;
                document.getElementById('game-timer').innerText = t;
                gameTimer = setInterval(() => {
                    if (isExitingGame) { clearInterval(gameTimer); return; }
                    t--;
                    document.getElementById('game-timer').innerText = t;
                    if(t <= 0) { 
                        clearInterval(gameTimer); 
                        if(!hasAnsweredCurrentQ) submitGameAnswer(null, q, data); 
                        else if (currentGameMode === 'ai') handleAINextTurn();
                    }
                }, 1000);
            }
            
            document.getElementById('q-progress').innerText = `${data.currentIdx + 1} / ${totalQs}`;
            qTextEl.innerText = q.question;
            const div = document.getElementById('answers-container');
            if(div.children.length === 0 || div.getAttribute('data-curr-q') !== q.question) {
                div.setAttribute('data-curr-q', q.question);
                div.innerHTML = '';
                let ansList = [];
                if(q.type === 'mcq') ansList = q.answers.map((txt, idx) => ({ txt, isCorrect: idx === q.correct, value: idx }));
                else ansList = [{ txt: 'ุตุญ', isCorrect: q.correct === 'true' || q.correct === true, value: 'true' }, { txt: 'ุฎุทุฃ', isCorrect: q.correct === 'false' || q.correct === false, value: 'false' }];
                
                const correctAns = ansList.find(ans => ans.isCorrect);
                if (correctAns) currentQuestionCorrectAnswer = correctAns.value;

                ansList.sort(() => 0.5 - Math.random());
                ansList.forEach(ansObj => {
                    const btn = document.createElement('button');
                    btn.className = "answer-neutral w-full py-4 border-2 rounded-xl text-lg font-bold shadow-sm active:scale-95 transition";
                    btn.innerText = ansObj.txt;
                    btn.dataset.value = ansObj.value;
                    btn.onclick = () => { if(hasAnsweredCurrentQ) return; submitGameAnswer(ansObj, q, data); };
                    div.appendChild(btn);
                });
            }
        }

        async function submitGameAnswer(ansObj, q, matchData) {
            if(hasAnsweredCurrentQ || isExitingGame) return;
            hasAnsweredCurrentQ = true;
            userAnsweredCorrectly = ansObj && ansObj.isCorrect;
            
            const answerButtons = document.querySelectorAll('#answers-container button');
            answerButtons.forEach(btn => {
                btn.classList.remove('answer-correct', 'answer-wrong', 'answer-neutral');
                if (btn.dataset.value.toString() === currentQuestionCorrectAnswer.toString()) btn.classList.add('answer-correct');
                else if (ansObj && btn.dataset.value.toString() === (ansObj.value?.toString())) btn.classList.add('answer-wrong');
                else btn.classList.add('answer-neutral');
            });
            
            document.getElementById('answers-container').classList.add('pointer-events-none');

            if (currentGameMode === 'online') {
                document.getElementById('waiting-msg').classList.remove('hidden');
                const isP1 = matchData.player1.uid === currentUser.uid;
                if (!currentMatchId) return;
                const scoreIncrement = ansObj && ansObj.isCorrect ? 1 : 0;
                const updates = { 
                    answersCount: increment(1),
                    lastUpdated: serverTimestamp()
                };
                if(ansObj && ansObj.isCorrect) {
                    if (isP1) {
                        updates['player1.score'] = increment(scoreIncrement);
                    } else {
                        updates['player2.score'] = increment(scoreIncrement);
                    }
                }
                await updateDoc(doc(db, "match_queue", currentMatchId), updates);
            } else {
                document.getElementById('waiting-msg').classList.add('hidden'); 
                if(ansObj && ansObj.isCorrect) {
                    localMatchData.player1.score += 1;
                    document.getElementById('game-my-score').innerText = localMatchData.player1.score;
                }
                triggerAIResponse();
            }
        }

        function triggerAIResponse() {
            document.getElementById('waiting-msg').classList.add('hidden');
            document.getElementById('ai-thinking-msg').classList.remove('hidden');
            let delay = 2500; let accuracy = 0.25;
            if (aiDifficulty === 'medium') { delay = 3000; accuracy = 0.5; }
            if (aiDifficulty === 'hard') { delay = 3500; accuracy = 0.7; }
            aiTimeoutId = setTimeout(() => {
                const isCorrect = Math.random() < accuracy;
                if(isCorrect) {
                    localMatchData.player2.score += 1;
                    document.getElementById('game-op-score').innerText = localMatchData.player2.score;
                }
                handleAINextTurn();
            }, delay);
        }

        function handleAINextTurn() {
            if(isExitingGame) return;
            localMatchData.currentIdx += 1;
            localMatchData.answersCount = 0;
            renderGame(localMatchData);
        }

        // --- WITHDRAW FROM GAME ---
        window.withdrawFromGame = async function() {
            if(confirm("ูู ุชุฑูุฏ ุงูุงูุณุญุงุจ ูู ุงูุชุญุฏูุ ุณูุชู ุฎุตู 10 ููุงุท ููู ูุฅุนุทุงุฆูุง ููุฎุตู.")) {
                isExitingGame = true;
                
                if (currentGameMode === 'online' && currentMatchId) {
                    try {
                        // Get match data
                        const matchDoc = await getDoc(doc(db, "match_queue", currentMatchId));
                        if (matchDoc.exists()) {
                            const matchData = matchDoc.data();
                            const isP1 = matchData.player1.uid === currentUser.uid;
                            const opponentUid = isP1 ? matchData.player2?.uid : matchData.player1?.uid;
                            
                            if (opponentUid) {
                                // Give points to opponent
                                await updateDoc(doc(db, "users", opponentUid), {
                                    points: increment(10)
                                });
                                
                                // Deduct points from current user
                                await updateDoc(doc(db, "users", currentUser.uid), {
                                    points: increment(-10)
                                });
                                
                                // Update user data locally
                                userData.points = Math.max(0, userData.points - 10);
                                setupHeaderUI();
                                
                                // Mark match as completed with withdrawal reason
                                await updateDoc(doc(db, "match_queue", currentMatchId), {
                                    status: 'completed',
                                    winner: opponentUid,
                                    reason: 'withdrawal',
                                    completedAt: serverTimestamp()
                                });
                            }
                        }
                    } catch (error) {
                        console.error("Error processing withdrawal:", error);
                    }
                } else if (currentGameMode === 'ai') {
                    // For AI matches, just deduct points
                    await updateDoc(doc(db, "users", currentUser.uid), {
                        points: increment(-10)
                    });
                    userData.points = Math.max(0, userData.points - 10);
                    setupHeaderUI();
                }
                
                // Show withdrawal message
                document.getElementById('result-icon-container').innerText = "๐ข";
                document.getElementById('result-title').innerText = "ุงูุณุญุงุจ";
                document.getElementById('result-msg').innerText = "ุงูุณุญุจุช ูู ุงูุชุญุฏู ูุชู ุฎุตู 10 ููุงุท";
                document.getElementById('final-my-score').innerText = "0";
                document.getElementById('final-op-score').innerText = "0";
                document.getElementById('result-points-gained').innerText = "-10";
                document.getElementById('result-screen').classList.remove('hidden');
                
                // Clean up
                cleanUpGame();
            }
        };

        function handleOpponentLeft(matchData) {
            isExitingGame = true;
            
            // Show opponent left message
            document.getElementById('result-icon-container').innerText = "๐";
            document.getElementById('result-title').innerText = "ููุฒ!";
            document.getElementById('result-msg').innerText = "ุฎุตูู ุบุงุฏุฑ ุงูุชุญุฏู. ุญุตูุช ุนูู 10 ููุงุท!";
            document.getElementById('final-my-score').innerText = "10";
            document.getElementById('final-op-score').innerText = "0";
            document.getElementById('result-points-gained').innerText = "+10";
            document.getElementById('result-screen').classList.remove('hidden');
            
            // Give points to current user
            updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(10)
            }).then(() => {
                userData.points += 10;
                setupHeaderUI();
            });
            
            cleanUpGame();
        }

        async function endGame(d) {
            clearInterval(gameTimer);
            document.getElementById('game-overlay').classList.add('hidden');
            if (isExitingGame) return;
            
            let myScore, opScore;
            if (currentGameMode === 'online') {
                const isP1 = d.player1.uid === currentUser.uid;
                myScore = isP1 ? d.player1.score : d.player2.score;
                opScore = isP1 ? d.player2.score : d.player1.score;
                
                // Mark match as completed
                if (currentMatchId) {
                    await updateDoc(doc(db, "match_queue", currentMatchId), {
                        status: 'completed',
                        completedAt: serverTimestamp()
                    });
                }
            } else {
                myScore = localMatchData.player1.score;
                opScore = localMatchData.player2.score;
            }
            
            let pointsGained = 0; let msg = ""; let icon = "";
            if (myScore > opScore) { 
                msg = "ููุฒ ุณุงุญู!"; icon = "๐"; pointsGained = myScore * 2;
            } else if (myScore < opScore) { 
                msg = "ุญุธ ุฃููุฑ!"; icon = "๐ข"; pointsGained = 0;
            } else { 
                if(myScore > 0) { msg = "ุชุนุงุฏู ุฅูุฌุงุจู!"; icon = "๐ค"; pointsGained = myScore * 1; } 
                else { msg = "ุชุนุงุฏู ุณูุจู!"; icon = "๐"; pointsGained = 0; }
            }
            
            // PREMIUM LOGIC: Double Points
            if (isPremiumValid(userData) && pointsGained > 0) {
                 pointsGained = pointsGained * 2;
                 document.getElementById('result-points-gained').innerHTML += ' <span class="text-xs text-green-600">(x2 ูููุฒ)</span>';
            }

            if(pointsGained > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { points: increment(pointsGained) });
                userData.points += pointsGained;
                setupHeaderUI();
            }
            
            document.getElementById('result-icon-container').innerText = icon;
            document.getElementById('result-title').innerText = msg;
            document.getElementById('final-my-score').innerText = myScore;
            document.getElementById('final-op-score').innerText = opScore;
            document.getElementById('result-points-gained').innerText = `+${pointsGained}`;
            document.getElementById('result-screen').classList.remove('hidden');
        }

        window.closeResultScreen = async () => {
             isExitingGame = true;
             if (matchListenerUnsubscribe) { matchListenerUnsubscribe(); matchListenerUnsubscribe = null; }
             clearInterval(gameTimer); clearTimeout(aiTimeoutId);
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('game-overlay').classList.add('hidden');
             document.getElementById('searching-ui').classList.add('hidden');
             document.getElementById('searching-ui').style.display = 'none';

             currentMatchId = null; localMatchData = null; hasAnsweredCurrentQ = false;
             document.getElementById('challenge-active-card').classList.remove('hidden');
             if(currentUser) {
                 const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                 if(userDoc.exists()) { userData = userDoc.data(); setupHeaderUI(); setupProfileUI(); }
                 loadLeaderboard();
             }
             switchTab('challenges');
             setTimeout(() => { isExitingGame = false; }, 500);
        };

        function cleanUpGame() {
            if (matchListenerUnsubscribe) { matchListenerUnsubscribe(); matchListenerUnsubscribe = null; }
            clearInterval(gameTimer); clearTimeout(aiTimeoutId);
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('searching-ui').style.display = 'none';
            currentMatchId = null; localMatchData = null; hasAnsweredCurrentQ = false;
            
            setTimeout(() => {
                document.getElementById('challenge-active-card').classList.remove('hidden');
                switchTab('challenges');
                isExitingGame = false;
            }, 3000);
        }

        // --- CANCEL SEARCH (FIXED) ---
        window.cancelSearch = async function() {
            isExitingGame = true;
            
            if (currentMatchId && currentGameMode === 'online') {
                try {
                    // Get match data first
                    const matchDoc = await getDoc(doc(db, "match_queue", currentMatchId));
                    if (matchDoc.exists()) {
                        const matchData = matchDoc.data();
                        
                        // Only cancel if match is still waiting
                        if (matchData.status === 'waiting') {
                            await deleteDoc(doc(db, "match_queue", currentMatchId));
                        } else if (matchData.status === 'active') {
                            // If match is active, handle as withdrawal
                            await withdrawFromGame();
                            return;
                        }
                    }
                } catch (error) {
                    console.error("Error cancelling search:", error);
                }
            }
            
            // Clean up UI
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            currentMatchId = null;
            isExitingGame = false;
        };

        // --- UPLOAD ---
        window.nextUploadStep = () => {
            const sub = document.getElementById('up-subject').value;
            const type = document.getElementById('up-type').value;
            if (!sub) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฏุฉ");
            document.getElementById('up-step-1').classList.add('hidden');
            document.getElementById('up-step-2').classList.remove('hidden');
            if(type === 'mcq') {
                document.getElementById('up-mcq-container').classList.remove('hidden');
                document.getElementById('up-tf-container').classList.add('hidden');
            } else {
                document.getElementById('up-mcq-container').classList.add('hidden');
                document.getElementById('up-tf-container').classList.remove('hidden');
            }
        };

        window.submitUploadQuestion = async () => {
            // Check daily limit
            const today = new Date().toISOString().split('T')[0];
            if (userData.lastQuestionReset !== today) {
                userData.dailyQuestionsSent = 0;
                userData.lastQuestionReset = today;
            }
            
            const dailyLimit = isPremiumValid(userData) ? 5 : 1;
            if (userData.dailyQuestionsSent >= dailyLimit) {
                alert(`โ ููุฏ ูุตูุช ููุญุฏ ุงููููู ูุฑูุน ุงูุฃุณุฆูุฉ (${dailyLimit}).\n\nููููู ุงูุงุดุชุฑุงู ุงููููุฒ ูุฑูุน 5 ุฃุณุฆูุฉ ููููุงู.`);
                return;
            }
            
            const sub = document.getElementById('up-subject').value;
            const type = document.getElementById('up-type').value;
            const txt = document.getElementById('up-q-text').value;
            
            if(!txt) return alert("ูุฑุฌู ูุชุงุจุฉ ูุต ุงูุณุคุงู");
            
            let q = { 
                grade: userData.grade,
                subject: sub, 
                type, 
                question: txt, 
                authorId: currentUser.uid, 
                authorName: userData.name, 
                createdAt: serverTimestamp(), 
                status: 'pending' 
            };
            
            if(type==='mcq') {
                const a0 = document.getElementById('ans-0').value;
                const a1 = document.getElementById('ans-1').value;
                const a2 = document.getElementById('ans-2').value;
                if(!a0 || !a1 || !a2) return alert("ูุฑุฌู ููุก ุฌููุน ุงูุฎูุงุฑุงุช");
                q.answers = [a0, a1, a2];
                q.correct = parseInt(document.querySelector('input[name="correct"]:checked').value);
            } else { 
                q.correct = document.getElementById('up-tf-val').value; 
            }
            
            await addDoc(collection(db, "pending_questions"), q);
            
            // Update daily count
            await updateDoc(doc(db, "users", currentUser.uid), {
                dailyQuestionsSent: increment(1)
            });
            userData.dailyQuestionsSent = (userData.dailyQuestionsSent || 0) + 1;
            
            alert("ุชู ุงุฑุณุงู ุงูุณุคุงู ูููุฑุงุฌุนุฉ ุจูุฌุงุญ!");
            
            // ุชูุธูู ุงูุญููู
            document.getElementById('up-q-text').value = ""; 
            document.getElementById('ans-0').value = ""; 
            document.getElementById('ans-1').value = ""; 
            document.getElementById('ans-2').value = "";
            document.getElementById('up-step-2').classList.add('hidden'); 
            document.getElementById('up-step-1').classList.remove('hidden');
        };

        // --- NAVIGATION & SCREENS ---
        window.openPage = async (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'screen-admin-all') { populateAdminFilterSubjects(); loadAdminAllContent(); }
            else if (screenId === 'screen-stats') loadStatsContent();
            else if (screenId === 'screen-my-questions') loadMyQuestionsContent();
            else if (screenId === 'screen-admin-review') loadAdminReviewContent();
            else if (screenId === 'screen-admin-stats') resetStatsUI();
            else if (screenId === 'screen-admin-subjects') loadSubjectManagement();
            else if (screenId === 'screen-wallet') setupProfileUI(); 
            else if (screenId === 'screen-premium') checkPremiumStatus();
            else if (screenId === 'screen-admin-subscription') loadPremiumUsers();
            else if (screenId === 'screen-admin-moderators') loadModeratorsList();
        };

        window.backToProfile = () => { 
             document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
             switchTab('profile');
        };

        // --- EDIT PROFILE NAME ---
        window.editProfileName = async () => {
            const newName = prompt("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุงุณู ุงูุฌุฏูุฏ:", userData.name);
            if(newName && newName.trim() !== "") {
                const cleanName = newName.trim();
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { name: cleanName });
                    userData.name = cleanName;
                    setupProfileUI();
                    alert("ุชู ุชุบููุฑ ุงูุงุณู ุจูุฌุงุญ โ");
                } catch(e) { alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุบููุฑ ุงูุงุณู"); }
            }
        };

        // --- STUDY SCHEDULE FUNCTIONS ---
        let scheduleData = { subject: '', chapters: [], totalHours: 0, needSleep: true, breakDuration: 10 };

        // Initialize schedule
        function initSchedule() {
            const chaptersList = document.getElementById('chaptersList');
            chaptersList.innerHTML = '';
            addChapterRow();
            
            // Load saved data if exists
            const saved = localStorage.getItem('studySchedule');
            if (saved) {
                try {
                    scheduleData = JSON.parse(saved);
                    document.getElementById('subjectName').value = scheduleData.subject || '';
                    document.getElementById('totalHours').value = scheduleData.totalHours || '';
                    document.getElementById('needSleep').value = scheduleData.needSleep ? 'yes' : 'no';
                    document.getElementById('breakDuration').value = scheduleData.breakDuration || 10;
                    
                    // Load chapters
                    if (scheduleData.chapters && scheduleData.chapters.length > 0) {
                        chaptersList.innerHTML = '';
                        scheduleData.chapters.forEach(ch => {
                            addChapterRow(ch.name, ch.difficulty);
                        });
                    }
                } catch (e) {
                    console.error("Error loading schedule:", e);
                }
            }
        }

        window.addChapterRow = function(name = '', difficulty = 1.5) {
            const container = document.getElementById('chaptersList');
            const index = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center slide-in';
            div.innerHTML = `
                <span class="bg-indigo-50 text-indigo-600 font-bold py-2 px-3 rounded text-sm">${index}</span>
                <select class="diff-select w-24 p-2 rounded bg-white border text-xs font-bold focus:border-indigo-500 outline-none">
                    <option value="1" ${difficulty === 1 ? 'selected' : ''}>ุณูู</option>
                    <option value="1.5" ${difficulty === 1.5 ? 'selected' : ''}>ูุชูุณุท</option>
                    <option value="2.5" ${difficulty === 2.5 ? 'selected' : ''}>ุตุนุจ</option>
                </select>
                <input type="text" placeholder="ุงุณู ุงููุตู" class="name-input flex-1 p-2 rounded bg-white border text-sm focus:border-indigo-500 outline-none" value="${name}">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.appendChild(div);
        };

        window.handleScheduleFormSubmit = function(e) {
            e.preventDefault();
            
            scheduleData.subject = document.getElementById('subjectName').value;
            scheduleData.totalHours = parseFloat(document.getElementById('totalHours').value);
            scheduleData.needSleep = document.getElementById('needSleep').value === 'yes';
            scheduleData.breakDuration = parseInt(document.getElementById('breakDuration').value);
            
            scheduleData.chapters = [];
            document.querySelectorAll('#chaptersList > div').forEach((row, idx) => {
                const diff = parseFloat(row.querySelector('.diff-select').value);
                const nameVal = row.querySelector('.name-input').value;
                const name = nameVal ? nameVal : `ูุตู ${idx + 1}`;
                scheduleData.chapters.push({ name, difficulty: diff });
            });

            if (scheduleData.chapters.length === 0) {
                alert("ุงูุฑุฌุงุก ุฅุถุงูุฉ ูุตู ูุงุญุฏ ุนูู ุงูุฃูู");
                return;
            }

            // Save to localStorage
            localStorage.setItem('studySchedule', JSON.stringify(scheduleData));
            calculateAndRenderSchedule(false);
        };

        function calculateAndRenderSchedule(isShared) {
            let totalMins = scheduleData.totalHours * 60;
            let sleepMins = 0;

            // ุญุณุงุจ ุงูููู
            if (scheduleData.needSleep && scheduleData.totalHours > 16) {
                const days = scheduleData.totalHours / 24;
                sleepMins = Math.floor(days * 8 * 60);
                totalMins -= sleepMins;
            }

            // ูุณุจุฉ ุงูุฏุฑุงุณุฉ ููุฑุงุญุฉ
            const studyRatio = 60 / (60 + scheduleData.breakDuration);
            const netStudyMins = totalMins * studyRatio;
            const totalBreakMins = totalMins - netStudyMins;

            // ูุฌููุน ููุงุท ุงูุตุนูุจุฉ
            const totalPoints = scheduleData.chapters.reduce((acc, c) => acc + c.difficulty, 0);

            // ุนุฑุถ ุงูุตูุญุฉ
            document.getElementById('schedule-input-page').classList.add('hidden');
            document.getElementById('schedule-result-page').classList.remove('hidden');
            document.getElementById('displaySubject').innerText = scheduleData.subject;

            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            scheduleData.chapters.forEach(ch => {
                const share = ch.difficulty / totalPoints;
                const chapterMins = netStudyMins * share;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-sm">${ch.name}</td>
                    <td>
                        <div class="flex flex-col items-center">
                            <span class="text-lg font-black">${formatTime(chapterMins)}</span>
                            <div class="w-full bg-gray-100 h-1 mt-1 rounded overflow-hidden">
                                <div class="bg-indigo-500 h-full" style="width: ${Math.min(100, (chapterMins/180)*100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="text-xs text-gray-500 font-bold">${scheduleData.breakDuration}ุฏ</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('statStudy').innerText = formatTime(netStudyMins);
            document.getElementById('statBreak').innerText = formatTime(totalBreakMins);
            document.getElementById('statSleep').innerText = formatTime(sleepMins);

            // ุฅุฐุง ูุงู ุฑุงุจุท ูุดุงุฑูุฉุ ูุบูุฑ ุงูุฃุฒุฑุงุฑ
            if (isShared) {
                const btns = document.getElementById('schedule-action-buttons');
                const cleanLink = window.location.origin + window.location.pathname;
                btns.innerHTML = `
                    <div class="bg-blue-50 text-blue-800 p-3 rounded-lg text-center text-sm font-bold mb-2">
                        ุฃูุช ุชุดุงูุฏ ุฌุฏููุงู ูุดุชุฑูุงู
                    </div>
                    <button onclick="downloadScheduleAsImage()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700">
                        <i class="fa-solid fa-download"></i> ุญูุธ ุงูุฌุฏูู ูุตูุฑุฉ
                    </button>
                    <a href="${cleanLink}" class="block w-full text-center bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-50">
                        ุฅูุดุงุก ุฌุฏููู ุงูุฎุงุต
                    </a>
                `;
            }
        }

        window.shareSchedule = function() {
            // ุจูุงูุงุช ูุถุบูุทุฉ
            const data = {
                s: scheduleData.subject,
                c: scheduleData.chapters,
                h: scheduleData.totalHours,
                n: scheduleData.needSleep,
                b: scheduleData.breakDuration
            };
            const str = JSON.stringify(data);
            // ุชุดููุฑ
            const encoded = btoa(encodeURIComponent(str));
            const url = `${window.location.origin}${window.location.pathname}?d=${encoded}`;
            
            navigator.clipboard.writeText(url).then(() => {
                const t = document.getElementById('schedule-toast');
                t.style.opacity = '1'; t.style.bottom = '40px';
                setTimeout(() => { t.style.opacity = '0'; t.style.bottom = '10px'; }, 3000);
            }).catch(() => prompt("ุงูุณุฎ ุงูุฑุงุจุท ูุฏููุงู:", url));
        };

        window.downloadScheduleAsImage = function() {
            const el = document.getElementById('schedule-card');
            const btn = event.target.closest('button');
            const oldTxt = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ุฌุงุฑู ุงูุญูุธ...';
            
            // Load html2canvas dynamically
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            script.onload = function() {
                html2canvas(el, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ุฌุฏูู-${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    btn.innerHTML = oldTxt;
                });
            };
            document.head.appendChild(script);
        };

        window.resetSchedule = function() {
            if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุฌุฏูู ูุฅูุดุงุก ุฌุฏูุฏุ')) {
                localStorage.removeItem('studySchedule');
                location.reload();
            }
        };

        function formatTime(m) {
            if(m < 60) return Math.round(m) + ' ุฏ';
            const h = Math.floor(m/60);
            const rem = Math.round(m%60);
            return rem > 0 ? `${h}ุณ ${rem}ุฏ` : `${h}ุณ`;
        }

        window.switchTab = (tab) => {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    
    // ุฅุฏุงุฑุฉ ุงูููุฏุฑ ุจูุงุกู ุนูู ุงูุชุจููุจ
    manageHeaderForTab(tab);
    
    // Update navigation colors
    document.querySelectorAll('.nav-item').forEach(n => { 
        n.classList.remove('active'); 
    });
    const navs = document.querySelectorAll('.nav-item');
    if(tab==='challenges') navs[0].classList.add('active');
    if(tab==='leaderboard') { 
        navs[1].classList.add('active'); 
        loadLeaderboard(); 
    }
    if(tab==='schedule') { 
        navs[2].classList.add('active'); 
        initSchedule(); 
    }
    if(tab==='solutions') { 
        navs[3].classList.add('active'); 
        loadSolutionsData(); 
    }
    if(tab==='upload') { 
        navs[4].classList.add('active'); 
        updateUploadUI(); 
    }
    if(tab==='profile') navs[5].classList.add('active');
};

        // --- SOLUTIONS SYSTEM ---
        function loadSolutionsData() {
            // Update grade select options for solutions
            const gradeSelect = document.getElementById('solution-grade');
            gradeSelect.onchange = function() {
                const grade = this.value;
                const subjectSelect = document.getElementById('solution-subject');
                subjectSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>';
                if (grade && subjects[grade]) {
                    subjects[grade].forEach(s => {
                        subjectSelect.innerHTML += `<option value="${s}">${s}</option>`;
                    });
                }
            };
            
            // Set initial values if user has grade
            if (userData.grade) {
                gradeSelect.value = userData.grade;
                gradeSelect.dispatchEvent(new Event('change'));
            }
            
            // Load received solutions
            loadReceivedSolutions();
            
            // Check daily limit
            updateSolutionsLimitUI();
            
            // Listen for new answers
            listenForSolutions();
        }

        function updateSolutionsLimitUI() {
    const limitInfo = document.getElementById('solution-limit-info');
    const dailyCount = document.getElementById('solution-daily-count');
    const dailyLimit = document.getElementById('solution-daily-limit');
    const premiumInfo = document.getElementById('solution-premium-info');
    const sendBtn = document.getElementById('solution-send-btn');
    
    // ุงูุชุญูู ูู ุงูุชุงุฑูุฎ ุฃููุงู
    const today = new Date().toISOString().split('T')[0];
    if (userData.lastSolutionReset !== today) {
        userData.dailySolutionsSent = 0;
        userData.lastSolutionReset = today;
    }
    
    const limit = isPremiumValid(userData) ? 3 : 1;
    const sentToday = userData.dailySolutionsSent || 0;
    
    // ุชุญุฏูุซ ุงููุต
    dailyCount.textContent = sentToday;
    dailyLimit.textContent = limit;
    
    // ุชุญุฏูุซ ุฒุฑ ุงูุฅุฑุณุงู
    if (sendBtn) {
        if (sentToday >= limit) {
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-ban ml-2"></i> ูุตูุช ููุญุฏ ุงููููู';
            sendBtn.className = 'w-full bg-gray-400 text-white py-3 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 shadow-md cursor-not-allowed';
            sendBtn.title = `ููุฏ ุฃุฑุณูุช ${sentToday} ูู ${limit} ูุณููุญ ูู ุงูููู`;
        } else {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane ml-2"></i> ุฅุฑุณุงู ุงูุณุคุงู';
            sendBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 shadow-md cursor-pointer';
            sendBtn.title = `ููููู ุฅุฑุณุงู ${limit - sentToday} ุฃุณุฆูุฉ ุฃุฎุฑู ุงูููู`;
        }
    }
    
    // ูุนูููุงุช ุงููููุฒูู
    if (premiumInfo) {
        if (isPremiumValid(userData)) {
            premiumInfo.classList.remove('hidden');
            premiumInfo.innerHTML = '๐ ุญุณุงุจ ูููุฒ: 3 ุฃุณุฆูุฉ ููููุงู';
        } else {
            premiumInfo.classList.add('hidden');
        }
    }
    
    // ุชุญุฏูุซ ุงูุฑุณุงูุฉ ุงููุนูููุงุชูุฉ
    if (limitInfo) {
        limitInfo.innerHTML = `
            <span id="solution-daily-count">${sentToday}</span>/<span id="solution-daily-limit">${limit}</span>
            ${sentToday >= limit ? 
                '<span class="text-red-600 font-bold"> - ูุตูุช ููุญุฏ ุงูุฃูุตู!</span>' : 
                '<span class="text-green-600"> - ููููู ุฅุฑุณุงู ' + (limit - sentToday) + ' ุฃุณุฆูุฉ ุฃุฎุฑู</span>'
            }
        `;
    }
}

        window.switchSolutionsTab = (tab) => {
            if (tab === 'send') {
                document.getElementById('solutions-send-section').classList.remove('hidden');
                document.getElementById('solutions-receive-section').classList.add('hidden');
                document.getElementById('solutions-admin-panel').classList.add('hidden');
                document.getElementById('solutions-tab-send').classList.add('bg-white', 'text-indigo-600');
                document.getElementById('solutions-tab-send').classList.remove('text-gray-500');
                document.getElementById('solutions-tab-receive').classList.remove('bg-white', 'text-indigo-600');
                document.getElementById('solutions-tab-receive').classList.add('text-gray-500');
            } else if (tab === 'receive') {
                document.getElementById('solutions-send-section').classList.add('hidden');
                document.getElementById('solutions-receive-section').classList.remove('hidden');
                document.getElementById('solutions-admin-panel').classList.add('hidden');
                document.getElementById('solutions-tab-send').classList.remove('bg-white', 'text-indigo-600');
                document.getElementById('solutions-tab-send').classList.add('text-gray-500');
                document.getElementById('solutions-tab-receive').classList.add('bg-white', 'text-indigo-600');
                document.getElementById('solutions-tab-receive').classList.remove('text-gray-500');
                loadReceivedSolutions();
            }
        };

        window.openSolutionsAdmin = () => {
            document.getElementById('solutions-send-section').classList.add('hidden');
            document.getElementById('solutions-receive-section').classList.add('hidden');
            document.getElementById('solutions-admin-panel').classList.remove('hidden');
        };

        function setupSolutionsAdminUI() {
            const adminBtn = document.getElementById('solutions-admin-btn');
            if (userData.email === ADMIN_EMAIL || userData.isModerator) {
                adminBtn.classList.remove('hidden');
            }
        }

        window.previewSolutionImage = function(input) {
            if(input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert("ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏุงู. ุงูุญุฏ ุงูุฃูุตู 5MB");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('solution-preview-img').src = e.target.result;
                    document.getElementById('solution-image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeSolutionImage = function() {
            document.getElementById('solution-image-input').value = '';
            document.getElementById('solution-image-preview').classList.add('hidden');
        };

        window.sendSolutionQuestion = async function() {
    // 1. ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ุฃููุงู
    try {
        const userDocRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
            userData = { ...userData, ...userDoc.data() };
        }
        
        console.log("๐ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู");
    } catch (error) {
        console.error("โ ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏู:", error);
    }
    
    // 2. ุงูุชุญูู ูู ุงูุชุงุฑูุฎ ูุงูุญุฏ ุงููููู
    const today = new Date().toISOString().split('T')[0];
    console.log(`๐ ุงูููู: ${today} | ุขุฎุฑ ุชุญุฏูุซ: ${userData.lastSolutionReset || 'ูุง ููุฌุฏ'}`);
    
    // ุฅุฐุง ูุงู ุงูููู ูุฎุชููุ ูุนูุฏ ุงูุนุฏุงุฏ
    if (userData.lastSolutionReset !== today) {
        console.log("๐ ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฏุงุฏ ุงููููู");
        userData.dailySolutionsSent = 0;
        userData.lastSolutionReset = today;
        
        // ุชุญุฏูุซ ูู Firebase
        try {
            await updateDoc(doc(db, "users", currentUser.uid), {
                dailySolutionsSent: 0,
                lastSolutionReset: today
            });
        } catch (error) {
            console.error("โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูุนุฏุงุฏ:", error);
        }
    }
    
    // 3. ุญุณุงุจ ุงูุญุฏ ุงููุณููุญ
    const limit = isPremiumValid(userData) ? 3 : 1;
    const sentToday = userData.dailySolutionsSent || 0;
    
    console.log(`๐ ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุฑุณูุฉ ุงูููู: ${sentToday} / ${limit}`);
    
    // 4. ุงูุชุญูู ุงูุตุงุฑู ูู ุงูุญุฏ
    if (sentToday >= limit) {
        alert(`๐ซ **ุชู ุฑูุถ ุงูุฅุฑุณุงู!**
        
๐ ููุฏ ูุตูุช ููุญุฏ ุงูุฃูุตู ุงููููู!
๐ค ุนุฏุฏ ุฃุณุฆูุชู ุงููุฑุณูุฉ ุงูููู: ${sentToday}
๐ฏ ุงูุญุฏ ุงููุณููุญ ูู: ${limit} ุณุคุงู ููููุงู

${!isPremiumValid(userData) ? '๐ ุชุฑููุฉ ุฅูู ุญุณุงุจ ูููุฒ: 3 ุฃุณุฆูุฉ ููููุงู' : 'โ ุฃูุช ูุดุชุฑู ูููุฒ ุจุงููุนู'}`);
        
        // ุฅููุงู ุงูุนูููุฉ ุชูุงูุงู
        return false;
    }
    
    // 5. ุงูุชุญูู ูู ุงูุจูุงูุงุช ุงููุทููุจุฉ
    const grade = document.getElementById('solution-grade').value;
    const subject = document.getElementById('solution-subject').value;
    const notes = document.getElementById('solution-notes').value;
    const imageInput = document.getElementById('solution-image-input');
    
    if (!grade || !subject) {
        alert("โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุงููุฑุญูุฉ ูุงููุงุฏุฉ");
        return false;
    }
    
    if (!imageInput.files[0]) {
        alert("โ๏ธ ูุฌุจ ุฑูุน ุตูุฑุฉ ุงูุณุคุงู");
        return false;
    }
    
    // 6. ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุฃููุฏ
    const confirmSend = confirm(`๐ค ุชุฃููุฏ ุฅุฑุณุงู ุงูุณุคุงู:
    
๐ ุงููุฑุญูุฉ: ${getGradeName(grade)}
๐ ุงููุงุฏุฉ: ${subject}
๐ธ ููุฌุฏ ุตูุฑุฉ ูุฑููุฉ
๐ ูุฐุง ูู ุงูุณุคุงู ุฑูู ${sentToday + 1} ูู ${limit} ูุณููุญ ูู ุงูููู

ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`);
    
    if (!confirmSend) {
        return false;
    }
    
    // 7. ููุน ุฅุฑุณุงู ูุชุนุฏุฏ
    const sendBtn = document.getElementById('solution-send-btn');
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฅุฑุณุงู...';
    sendBtn.disabled = true;
    
    try {
        // ุฑูุน ุงูุตูุฑุฉ ุจุฌูุฏุฉ ูุงููุฉ
        const imageUrl = await compressImage(imageInput.files[0]);
        
        // ุฅุฑุณุงู ุงูุจูุงูุงุช
        const solutionData = {
            studentId: currentUser.uid,
            studentName: userData.name,
            grade: grade,
            subject: subject,
            imageUrl: imageUrl,
            notes: notes,
            status: 'pending',
            sentAt: serverTimestamp(),
            answered: false,
            answer: null,
            answerImage: null,
            answerNotes: null,
            answeredAt: null,
            answeredBy: null,
            answeredByName: null
        };
        
        await addDoc(collection(db, "solutions"), solutionData);
        
        // ุชุญุฏูุซ ุงูุนุฏุงุฏ ุงููููู ูู Firebase
        const newCount = (userData.dailySolutionsSent || 0) + 1;
        await updateDoc(doc(db, "users", currentUser.uid), {
            dailySolutionsSent: newCount,
            lastSolutionReset: today
        });
        
        // ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ
        userData.dailySolutionsSent = newCount;
        
        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
        document.getElementById('solution-notes').value = '';
        document.getElementById('solution-image-input').value = '';
        document.getElementById('solution-image-preview').classList.add('hidden');
        
        // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
        updateSolutionsLimitUI();
        
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
        alert(`โ **ุชู ุฅุฑุณุงู ุงูุณุคุงู ุจูุฌุงุญ!**
        
๐ ุฃุตุจุญ ูุฏูู ${newCount} ูู ${limit} ุฃุณุฆูุฉ ูุฑุณูุฉ ุงูููู
โณ ุณูุชู ุงูุฑุฏ ุนููู ูู ูุจู ุงููุดุฑููู ูุฑูุจุงู
๐ ููููู ูุชุงุจุนุฉ ุงูุฅุฌุงุจุงุช ูู ูุณู "ุงุณุชูุงู ุฅุฌุงุจุงุช"`);
        
    } catch (error) {
        console.error("โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุณุคุงู:", error);
        alert(`โ **ูุดู ุงูุฅุฑุณุงู!**
        
ุณุจุจ ุงูุฎุทุฃ: ${error.message || 'ุบูุฑ ูุนุฑูู'}
ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู`);
        
        // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        return false;
    }
    
    // ุฅุนุงุฏุฉ ุชูุนูู ุงูุฒุฑ ุจุนุฏ 2 ุซุงููุฉ
    setTimeout(() => {
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ุฅุฑุณุงู ุงูุณุคุงู';
        sendBtn.disabled = false;
    }, 2000);
    
    return true;
};

        function loadReceivedSolutions() {
            const listDiv = document.getElementById('solutions-received-list');
            listDiv.innerHTML = '<p class="text-center text-gray-400 py-8">ุฌุงุฑู ุชุญููู ุงูุฅุฌุงุจุงุช...</p>';
            
            const q = query(
                collection(db, "solutions"),
                where("studentId", "==", currentUser.uid),
                where("answered", "==", true),
                orderBy("answeredAt", "desc"),
                limit(20)
            );
            
            getDocs(q).then(snapshot => {
                if (snapshot.empty) {
                    listDiv.innerHTML = '<p class="text-center text-gray-400 py-8">ูู ุชุณุชูู ุฃู ุฅุฌุงุจุงุช ุจุนุฏ</p>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    html += `
                        <div class="solution-answer-box">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="font-bold text-gray-800">${data.subject} - ${getGradeName(data.grade)}</p>
                                    <p class="text-xs text-gray-500">ุชู ุงูุฅุฌุงุจุฉ: ${data.answeredAt?.toDate().toLocaleDateString('ar-EG') || ''}</p>
                                </div>
                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">ุชูุช ุงูุฅุฌุงุจุฉ</span>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm font-bold text-gray-600 mb-1">ุณุคุงูู:</p>
                                <p class="text-sm text-gray-700">${data.notes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}</p>
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm font-bold text-gray-600 mb-1">ุตูุฑุฉ ุงูุณุคุงู:</p>
                                <img src="${data.imageUrl}" class="solution-image-preview cursor-pointer" onclick="viewFullImage('${data.imageUrl}')">
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-sm font-bold text-green-600 mb-1">ุงูุฅุฌุงุจุฉ ูู ุงููุดุฑู:</p>
                                <p class="text-sm text-gray-700">${data.answerNotes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช ุฅุถุงููุฉ'}</p>
                            </div>
                            
                            ${data.answerImage ? `
                            <div>
                                <p class="text-sm font-bold text-green-600 mb-1">ุตูุฑุฉ ุงูุญู:</p>
                                <img src="${data.answerImage}" class="solution-image-preview cursor-pointer" onclick="viewFullImage('${data.answerImage}')">
                            </div>
                            ` : ''}
                            
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-gray-500">ุฃุฌุงุจ: ${data.answeredByName || 'ูุดุฑู'}</p>
                            </div>
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
            }).catch(error => {
                console.error("Error loading solutions:", error);
                listDiv.innerHTML = '<p class="text-center text-red-500 py-8">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฅุฌุงุจุงุช</p>';
            });
        }

        function listenForSolutions() {
            if (solutionsListener) solutionsListener();
            
            const q = query(
                collection(db, "solutions"),
                where("studentId", "==", currentUser.uid),
                where("answered", "==", true)
            );
            
            solutionsListener = onSnapshot(q, (snapshot) => {
                const unreadCount = snapshot.size;
                const badge = document.getElementById('solutions-badge');
                const navBadge = document.getElementById('solutions-nav-badge');
                
                if (unreadCount > 0) {
                    badge.classList.remove('hidden');
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    navBadge.classList.add('visible');
                } else {
                    badge.classList.add('hidden');
                    navBadge.classList.remove('visible');
                }
                
                // If we're on the receive tab, refresh the list
                if (document.getElementById('solutions-receive-section') && 
                    !document.getElementById('solutions-receive-section').classList.contains('hidden')) {
                    loadReceivedSolutions();
                }
            });
        }

        function listenToAdminSolutions() {
    if (adminSolutionsListener) adminSolutionsListener(); // ุฅูุบุงุก ุฃู ูุณุชูุน ุณุงุจู
    
    // ุงูุชุญูู ูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุฃููุงู
    if (!userData) {
        console.error("โ ุจูุงูุงุช ุงููุณุชุฎุฏู ุบูุฑ ูุชููุฑุฉ");
        document.getElementById('admin-solutions-list').innerHTML = 
            '<p class="text-center text-red-500 py-8">ุจูุงูุงุช ุงููุณุชุฎุฏู ุบูุฑ ูุชููุฑุฉ</p>';
        return;
    }
    
    let q;
    
    // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุดุฑู
    if (userData.isModerator && userData.email !== ADMIN_EMAIL) {
        // ุงููุดุฑู ุงูุนุงุฏู: ูุฑู ููุท ุงูุฃุณุฆูุฉ ูู ูุฑุญูุชู ุงููุฎุตุตุฉ
        console.log("โ ุงููุดุฑู ูุฑู ุฃุณุฆูุฉ ูุฑุญูุฉ:", userData.moderatorGrade);
        
        if (!userData.moderatorGrade) {
            console.error("โ ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ ูููุดุฑู ุบูุฑ ูุญุฏุฏุฉ");
            document.getElementById('admin-solutions-list').innerHTML = 
                '<p class="text-center text-red-500 py-8">ุงููุฑุญูุฉ ุงูุฏุฑุงุณูุฉ ุบูุฑ ูุญุฏุฏุฉ ูููุดุฑู</p>';
            return;
        }
        
        // ุงุณุชุนูุงู ุจุณูุท ูุณูู
        q = query(
            collection(db, "solutions"),
            where("grade", "==", userData.moderatorGrade),
            where("answered", "==", false)
            // ุชู ุฅุฒุงูุฉ orderBy ูุคูุชุงู ูุงุฎุชุจุงุฑ ุงููุดููุฉ
        );
    } else if (userData.email === ADMIN_EMAIL) {
        // ุงููุงูู: ูุฑู ุฌููุน ุงูุฃุณุฆูุฉ ุบูุฑ ุงููุฌุงุจุฉ
        console.log("โ ุงููุงูู ูุฑู ุฌููุน ุงูุฃุณุฆูุฉ");
        q = query(
            collection(db, "solutions"),
            where("answered", "==", false)
            // ุชู ุฅุฒุงูุฉ orderBy ูุคูุชุงู ูุงุฎุชุจุงุฑ ุงููุดููุฉ
        );
    } else {
        console.log("โ ุงููุณุชุฎุฏู ููุณ ูุดุฑูุงู");
        document.getElementById('admin-solutions-list').innerHTML = 
            '<p class="text-center text-gray-400 py-8">ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐุง ุงููุณู</p>';
        return;
    }
    
    console.log("๐ ุฌุงุฑู ุงูุงุณุชุนูุงู ุนู ุงูุฃุณุฆูุฉ...");
    
    // ุงุณุชุฎุฏุงู getDocs ุฃููุงู ูุงุฎุชุจุงุฑ ุงูุงุณุชุนูุงู
    getDocs(q).then(snapshot => {
        console.log(`โ ุชู ุฌูุจ ${snapshot.size} ุณุคุงู`);
        
        const listDiv = document.getElementById('admin-solutions-list');
        
        if (snapshot.empty) {
            listDiv.innerHTML = '<p class="text-center text-gray-400 py-8">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ุชุญุชุงุฌ ุฅูู ุญู</p>';
            return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            console.log("๐จ ุณุคุงู ูุงุฑุฏ:", data.subject, "ุงููุฑุญูุฉ:", data.grade, "ุงููุฌุงุจ:", data.answered);
            
            // ุงูุชุฃูุฏ ูู ุฃู ุงูุจูุงูุงุช ููุฌูุฏุฉ
            if (!data || !data.grade) {
                console.warn("โ๏ธ ุจูุงูุงุช ุงูุณุคุงู ุบูุฑ ููุชููุฉ:", doc.id);
                return;
            }
            
            // ุชุญููู ุงูุชุงุฑูุฎ ุฅูู ุชูุณูู ุนุฑุจู
            let timeAgo = 'ูุจู ูููู';
            try {
                if (data.sentAt && data.sentAt.toDate) {
                    const sentDate = data.sentAt.toDate();
                    timeAgo = getTimeAgo(sentDate);
                }
            } catch (e) {
                console.log("โ๏ธ ุฎุทุฃ ูู ุชุญููู ุงูุชุงุฑูุฎ:", e);
            }
            
            html += `
                <div class="bg-white border border-gray-200 rounded-xl p-4 mb-3 shadow-sm" id="admin-solution-${doc.id}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="font-bold text-gray-800">${data.studentName || "ูุฌููู"}</p>
                            <p class="text-xs text-gray-500">
                                ${getGradeName(data.grade)} - ${data.subject}
                                <span class="mr-2">โข</span>
                                <span class="text-blue-500">${timeAgo}</span>
                            </p>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded mb-1">ุจุงูุชุธุงุฑ ุงูุญู</span>
                            <span class="text-[10px] text-gray-400">ID: ${doc.id.substring(0,6)}</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p class="text-sm font-bold text-gray-600 mb-1">ููุงุญุธุงุช ุงูุทุงูุจ:</p>
                        <p class="text-sm text-gray-700 bg-gray-50 p-2 rounded border border-gray-100">
                            ${data.notes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <p class="text-sm font-bold text-gray-600 mb-1">ุตูุฑุฉ ุงูุณุคุงู:</p>
                        <img src="${data.imageUrl}" 
                             class="solution-image-preview cursor-pointer hover:opacity-90 transition" 
                             onclick="viewFullImage('${data.imageUrl}')"
                             onerror="this.src='https://cdn-icons-png.flaticon.com/512/3767/3767084.png'">
                    </div>
                    
    <div class="flex gap-2">
        <button onclick="answerSolution('${doc.id}')" 
                class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-green-700 transition flex items-center justify-center gap-1">
            <i class="fas fa-reply"></i> ุงูุฑุฏ ุนูู ุงูุณุคุงู
        </button>
        <button onclick="deleteSolution('${doc.id}', '${data.studentName || "ูุฌููู"}', '${data.subject}')" 
                class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold text-sm hover:bg-red-700 transition flex items-center justify-center gap-1">
            <i class="fas fa-trash-alt"></i> ุญุฐู ุงูุณุคุงู
        </button>
    </div>
                </div>
            `;
        });
        
        listDiv.innerHTML = html || '<p class="text-center text-gray-400 py-8">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ุชุญุชุงุฌ ุฅูู ุญู</p>';
        
        // ุงูุขู ูุถูู ูุณุชูุน Real-time
        adminSolutionsListener = onSnapshot(q, (snapshot) => {
            console.log(`๐ ุชุญุฏูุซ ูุจุงุดุฑ: ${snapshot.size} ุณุคุงู`);
            // ุฅุนุงุฏุฉ ุชุญุฏูุซ ุงููุงุฆูุฉ ุจููุณ ุงูููุทู ุฃุนูุงู
        }, (error) => {
            console.error("โ ุฎุทุฃ ูู ุงูุงุณุชูุงุน ููุฃุณุฆูุฉ:", error);
            // ุนุฏู ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ูุฏ ุชู ุชุญููููุง ุจุงููุนู
        });
        
    }).catch(error => {
        console.error("โ ุฎุทุฃ ูู ุฌูุจ ุงูุฃุณุฆูุฉ:", error.code, error.message);
        
        // ุฑุณุงูุฉ ุฎุทุฃ ุฃูุซุฑ ุชูุตููุงู
        let errorMsg = 'ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฃุณุฆูุฉ';
        if (error.code === 'failed-precondition') {
            errorMsg = 'ูุฌุจ ุฅูุดุงุก ููุงุฑุณ (indexes) ูู Firebase Console';
        } else if (error.code === 'permission-denied') {
            errorMsg = 'ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ููุฐู ุงูุจูุงูุงุช';
        }
        
        document.getElementById('admin-solutions-list').innerHTML = 
            `<p class="text-center text-red-500 py-8">${errorMsg}</p>
             <p class="text-center text-xs text-gray-400">${error.code}: ${error.message}</p>`;
    });
}

// ุฏุงูุฉ ุฌุฏูุฏุฉ: ุฅุธูุงุฑ ุฅุดุนุงุฑ ูููุดุฑููู
function showAdminNotification(count) {
    if (count > 0) {
        // ุฅุธูุงุฑ ุชูุจูู ูู ุงูุตูุญุฉ
        const notificationDiv = document.getElementById('admin-notification');
        if (notificationDiv) {
            notificationDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 animate-pulse">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-bell text-blue-500"></i>
                        <p class="text-sm font-bold text-blue-700">ูุฏูู ${count} ุณุคุงู ุชุญุชุงุฌ ุฅูู ุญู</p>
                    </div>
                </div>
            `;
            notificationDiv.classList.remove('hidden');
        }
        
        // ุฅุดุนุงุฑ ุตูุชู (ุงุฎุชูุงุฑู)
        if (count > 0 && localStorage.getItem('admin_sound') !== 'off') {
            playNotificationSound();
        }
    } else {
        const notificationDiv = document.getElementById('admin-notification');
        if (notificationDiv) {
            notificationDiv.classList.add('hidden');
        }
    }
}

// ุฏุงูุฉ ุฌุฏูุฏุฉ: ุชุญุฏูุซ ุจุงุฏุฌ ุงููุดุฑููู
function updateAdminBadge(count) {
    const adminBadge = document.getElementById('admin-btn-badge');
    const navBadge = document.getElementById('profile-tab-badge');
    
    if (count > 0) {
        adminBadge.classList.add('visible');
        navBadge.classList.add('visible');
        adminBadge.innerHTML = count > 9 ? '9+' : count;
    } else {
        adminBadge.classList.remove('visible');
        navBadge.classList.remove('visible');
    }
}

// ุฏุงูุฉ ุฌุฏูุฏุฉ: ุชุฎุทู ุงูุณุคุงู
window.skipSolution = async function(solutionId) {
    if (confirm("ูู ุชุฑูุฏ ุชุฎุทู ูุฐุง ุงูุณุคุงูุ ูููู ูููุดุฑููู ุงูุขุฎุฑูู ุฑุคูุชู.")) {
        try {
            // ูููู ุงูุณุคุงู ูููุงูุฉ ุงููุงุฆูุฉ ุจุชุญุฏูุซ ุงูููุช
            await updateDoc(doc(db, "solutions", solutionId), {
                sentAt: serverTimestamp() // ุชุญุฏูุซ ุงูููุช ููุธูุฑ ูู ุงูุฃุฎูุฑ
            });
            
            document.getElementById(`admin-solution-${solutionId}`).classList.add('opacity-50');
            alert("ุชู ุชุฎุทู ุงูุณุคุงู");
        } catch (error) {
            console.error("Error skipping solution:", error);
            alert("โ ุญุฏุซ ุฎุทุฃ ูู ุชุฎุทู ุงูุณุคุงู");
        }
    }
}

// ุฏุงูุฉ ุฌุฏูุฏุฉ: ุญุณุงุจ ุงูููุช ุงููููุถู
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffMins < 1) return 'ุงูุขู';
    if (diffMins < 60) return `ูุจู ${diffMins} ุฏูููุฉ`;
    if (diffHours < 24) return `ูุจู ${diffHours} ุณุงุนุฉ`;
    if (diffDays < 7) return `ูุจู ${diffDays} ููู`;
    return date.toLocaleDateString('ar-EG');
}

// ุฏุงูุฉ ุฌุฏูุฏุฉ: ุชุดุบูู ุตูุช ุงูุชูุจูู
function playNotificationSound() {
    try {
        const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
        audio.volume = 0.3;
        audio.play().catch(e => console.log("ูุง ูููู ุชุดุบูู ุงูุตูุช"));
    } catch (e) {
        console.log("ุฎุทุฃ ูู ุชุดุบูู ุงูุตูุช");
    }
}

        window.filterAdminSolutions = function() {
            const filter = document.getElementById('admin-solution-filter').value;
            const items = document.querySelectorAll('#admin-solutions-list > div');
            
            items.forEach(item => {
                const gradeText = item.querySelector('.text-xs.text-gray-500').textContent;
                const grade = gradeText.includes('ุงูุณุงุฏุณ ุงูุนููู') ? '6sci' : 
                             gradeText.includes('ุงูุณุงุฏุณ ุงูุฃุฏุจู') ? '6lit' : '3med';
                
                if (filter === 'all' || grade === filter) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        };

        window.answerSolution = function(solutionId) {
            document.getElementById('solution-answer-id').value = solutionId;
            
            // Load question data
            getDoc(doc(db, "solutions", solutionId)).then(docSnap => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const previewDiv = document.getElementById('solution-question-preview');
                    previewDiv.innerHTML = `
                        <p class="font-bold">${data.studentName} - ${getGradeName(data.grade)} - ${data.subject}</p>
                        <p class="text-sm text-gray-600 mt-1">${data.notes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}</p>
                    `;
                    
                    document.getElementById('solution-answer-modal').classList.remove('hidden');
                }
            });
        };

        window.previewSolutionAnswerImage = function(input) {
            if(input.files[0]) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert("ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏุงู. ุงูุญุฏ ุงูุฃูุตู 5MB");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('solution-answer-preview-img').src = e.target.result;
                    document.getElementById('solution-answer-image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeSolutionAnswerImage = function() {
            document.getElementById('solution-answer-image-input').value = '';
            document.getElementById('solution-answer-image-preview').classList.add('hidden');
        };

        window.sendSolutionAnswer = async function() {
    const solutionId = document.getElementById('solution-answer-id').value;
    const notes = document.getElementById('solution-answer-notes').value;
    const imageInput = document.getElementById('solution-answer-image-input');
    
    if (!notes && !imageInput.files[0]) {
        alert("ูุฑุฌู ุฅุฏุฎุงู ุฅุฌุงุจุฉ ุนูู ุงูุฃูู (ูุต ุฃู ุตูุฑุฉ)");
        return;
    }
    
    try {
        let answerImageUrl = null;
        if (imageInput.files[0]) {
            // ุงุณุชุฎุฏู ุฏุงูุฉ ุงูุฌูุฏุฉ ุงูุนุงููุฉ ูููุดุฑููู
            answerImageUrl = await compressAdminImage(imageInput.files[0]);
        }
        
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุญููู
        const sendBtn = document.querySelector('#solution-answer-modal button');
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ุฌุงุฑู ุงูุฅุฑุณุงู...';
        sendBtn.disabled = true;
        
        await updateDoc(doc(db, "solutions", solutionId), {
            answered: true,
            answerNotes: notes,
            answerImage: answerImageUrl,
            answeredAt: serverTimestamp(),
            answeredBy: currentUser.uid,
            answeredByName: userData.name
        });
        
        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฐุฌ
        document.getElementById('solution-answer-notes').value = '';
        document.getElementById('solution-answer-image-input').value = '';
        document.getElementById('solution-answer-image-preview').classList.add('hidden');
        
        // ุฅุนุงุฏุฉ ุฒุฑ ุงูุฅุฑุณุงู ูุญุงูุชู ุงูุฃุตููุฉ
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
        
        // ุฅุบูุงู ุงููุงูุฐุฉ
        setTimeout(() => {
            document.getElementById('solution-answer-modal').classList.add('hidden');
        }, 500);
        
        alert("โ ุชู ุฅุฑุณุงู ุงูุฅุฌุงุจุฉ ุจูุฌุงุญ ุจุฌูุฏุฉ ุนุงููุฉ!");
        
    } catch (error) {
        console.error("Error sending answer:", error);
        alert("โ ุญุฏุซ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฅุฌุงุจุฉ: " + error.message);
        
        // ุฅุนุงุฏุฉ ุชุนููู ุฒุฑ ุงูุฅุฑุณุงู ูู ุญุงูุฉ ุงูุฎุทุฃ
        const sendBtn = document.querySelector('#solution-answer-modal button');
        sendBtn.innerHTML = '<i class="fas fa-paper-plane ml-2"></i> ุฅุฑุณุงู ุงูุญู';
        sendBtn.disabled = false;
    }
};

        window.viewFullImage = function(imageUrl) {
            document.getElementById('full-solution-image').src = imageUrl;
            document.getElementById('view-solution-image-modal').classList.remove('hidden');
        };

        window.searchUserForModerator = async function() {
    const uidInput = document.getElementById('moderator-search-input').value.trim();
    const resultDiv = document.getElementById('moderator-search-result');
    
    if(!uidInput) {
        alert("ุฃุฏุฎู ุงููุนุฑู (ID)");
        return;
    }
    
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = 'ุฌุงุฑู ุงูุจุญุซ...';
    
    try {
        // ุงูุญู: ุงูุจุญุซ ุจู uniqueId ุฃู uid ูุนูุง
        let userDoc = null;
        
        // ุงููุญุงููุฉ ุงูุฃููู: ุงูุจุญุซ ุจุงูู uniqueId (ุงูุธุงูุฑ ูููุณุชุฎุฏู)
        let q1 = query(collection(db, "users"), where("uniqueId", "==", uidInput));
        let snap1 = await getDocs(q1);
        
        if(!snap1.empty) {
            userDoc = snap1.docs[0];
        } else {
            // ุงููุญุงููุฉ ุงูุซุงููุฉ: ุงูุจุญุซ ุจุงูู uid (ูุนุฑู ูุงูุฑุจูุฒ)
            // ูุชุญูู ุฃููุงู ุฅุฐุง ูุงู ุงูู uid ุตุญูุญูุง (ูุญุชูู ุนูู ุฃุญุฑู)
            if(uidInput.length >= 20 && uidInput.includes('_')) {
                try {
                    const docRef = doc(db, "users", uidInput);
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) {
                        userDoc = docSnap;
                    }
                } catch(e) {
                    console.log("ูุง ูููู ุงููุตูู ูููุณุชุฎุฏู ุจูุฐุง ุงููุนุฑู");
                }
            }
        }
        
        if(!userDoc) {
            resultDiv.innerHTML = '<p class="text-red-500">ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ</p>';
            return;
        }
        
        const uData = userDoc.data();
        const docId = userDoc.id;
        
        resultDiv.innerHTML = `
            <div class="text-center mb-4">
                <img src="${uData.photo}" class="w-16 h-16 rounded-full mx-auto mb-2" onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
                <h4 class="font-bold">${uData.name || 'ูุณุชุฎุฏู'}</h4>
                <p class="text-xs text-gray-500">ID: ${uData.uniqueId || 'ุบูุฑ ูุนุฑูู'}</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-500 mb-2">ุงููุฑุญูุฉ ุงููุณุคูู ุนููุง</label>
                <select id="moderator-grade" class="input-box">
                    <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                    <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                </select>
            </div>
            
            <button onclick="promoteToModerator()" class="btn-main bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-user-shield ml-2"></i> ุฑูุน ููุดุฑู
            </button>
        `;
        
        // ุชุฎุฒูู ุจูุงูุงุช ุงููุณุชุฎุฏู
        resultDiv.dataset.userId = docId;
        resultDiv.dataset.userData = JSON.stringify(uData);
        
    } catch(error) {
        console.error("ุฎุทุฃ ูู ุงูุจุญุซ:", error);
        resultDiv.innerHTML = '<p class="text-red-500">ุญุฏุซ ุฎุทุฃ ูู ุงูุจุญุซ ุนู ุงููุณุชุฎุฏู</p>';
    }
};

        window.promoteToModerator = async function() {
            const resultDiv = document.getElementById('moderator-search-result');
            const userId = resultDiv.dataset.userId;
            const grade = document.getElementById('moderator-grade').value;
            
            if(!userId || !grade) {
                alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุณุชุฎุฏู ูุงููุฑุญูุฉ");
                return;
            }
            
            if(confirm(`ูู ุชุฑูุฏ ุฑูุน ูุฐุง ุงููุณุชุฎุฏู ููุดุฑู ุนูู ${getGradeName(grade)}ุ`)) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        isModerator: true,
                        moderatorGrade: grade
                    });
                    
                    alert("โ ุชู ุฑูุน ุงููุณุชุฎุฏู ููุดุฑู ุจูุฌุงุญ!");
                    loadModeratorsList();
                    
                    // Clear search
                    document.getElementById('moderator-search-input').value = '';
                    resultDiv.classList.add('hidden');
                    
                } catch (error) {
                    console.error("Error promoting moderator:", error);
                    alert("โ ุญุฏุซ ุฎุทุฃ ูู ุฑูุน ุงููุดุฑู: " + error.message);
                }
            }
        };

        async function loadModeratorsList() {
            const listDiv = document.getElementById('current-moderators-list');
            listDiv.innerHTML = '<p class="text-center text-gray-400 py-4">ุฌุงุฑู ุชุญููู ุงููุงุฆูุฉ...</p>';
            
            const q = query(collection(db, "users"), where("isModerator", "==", true));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                listDiv.innerHTML = '<p class="text-center text-gray-400 py-4">ูุง ููุฌุฏ ูุดุฑููู ุญุงููุงู</p>';
                return;
            }
            
            let html = '';
            snap.forEach(doc => {
                const data = doc.data();
                html += `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img src="${data.photo}" class="w-10 h-10 rounded-full">
                            <div>
                                <p class="font-bold text-gray-800">${data.name}</p>
                                <p class="text-xs text-gray-500">${getGradeName(data.moderatorGrade)}</p>
                            </div>
                        </div>
                        <button onclick="demoteModerator('${doc.id}', '${data.name}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200">
                            <i class="fas fa-trash-alt ml-1"></i> ุฅุฒุงูุฉ
                        </button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        window.demoteModerator = async function(userId, userName) {
            if(confirm(`ูู ุชุฑูุฏ ุฅุฒุงูุฉ ${userName} ูู ุงููุดุฑูููุ`)) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        isModerator: false,
                        moderatorGrade: null
                    });
                    
                    alert("โ ุชู ุฅุฒุงูุฉ ุงููุดุฑู ุจูุฌุงุญ!");
                    loadModeratorsList();
                    
                } catch (error) {
                    console.error("Error demoting moderator:", error);
                    alert("โ ุญุฏุซ ุฎุทุฃ ูู ุฅุฒุงูุฉ ุงููุดุฑู: " + error.message);
                }
            }
        };

        // --- PREMIUM USERS MANAGEMENT ---
        async function loadPremiumUsers() {
            const listDiv = document.getElementById('premium-users-list');
            listDiv.innerHTML = '<p class="text-center text-gray-400 py-4">ุฌุงุฑู ุชุญููู ุงููุงุฆูุฉ...</p>';
            
            const q = query(collection(db, "users"), where("isPremium", "==", true));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                listDiv.innerHTML = '<p class="text-center text-gray-400 py-4">ูุง ููุฌุฏ ูุณุชุฎุฏููู ูููุฒูู</p>';
                return;
            }
            
            let html = '';
            const now = new Date();
            
            snap.forEach(doc => {
                const data = doc.data();
                const isActive = data.premiumExpiry && data.premiumExpiry.toDate() > now;
                const expiryDate = data.premiumExpiry ? data.premiumExpiry.toDate().toLocaleDateString('ar-EG') : 'ุบูุฑ ูุญุฏุฏ';
                
                html += `
                    <div class="bg-white border border-gray-200 rounded-xl p-4 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img src="${data.photo}" class="w-10 h-10 rounded-full">
                            <div>
                                <p class="font-bold text-gray-800">${data.name}</p>
                                <p class="text-xs ${isActive ? 'text-green-600' : 'text-red-600'}">
                                    ${isActive ? `ููุชูู: ${expiryDate}` : 'ููุชูู ุงูุตูุงุญูุฉ'}
                                </p>
                            </div>
                        </div>
                        <button onclick="removePremium('${doc.id}', '${data.name}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200">
                            <i class="fas fa-crown ml-1"></i> ุฅุฒุงูุฉ ุงููููุฒ
                        </button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        window.removePremium = async function(userId, userName) {
            if(confirm(`ูู ุชุฑูุฏ ุฅุฒุงูุฉ ${userName} ูู ุงููููุฒููุ`)) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        isPremium: false,
                        premiumExpiry: null
                    });
                    
                    alert("โ ุชู ุฅุฒุงูุฉ ุงูุนุถู ูู ุงููููุฒูู ุจูุฌุงุญ!");
                    loadPremiumUsers();
                    
                } catch (error) {
                    console.error("Error removing premium:", error);
                    alert("โ ุญุฏุซ ุฎุทุฃ ูู ุฅุฒุงูุฉ ุงูุนุถู: " + error.message);
                }
            }
        };

        // --- ADMIN FUNCTIONS ---
        async function loadStatsContent() {
             const div = document.getElementById('stats-content');
             const usersSnap = await getDocs(collection(db, "users"));
             const total = usersSnap.size;
             const today = new Date(); today.setHours(0,0,0,0);
             let newUsers = 0; let activeNow = 0; const now = new Date();
             usersSnap.forEach(d => {
                 const u = d.data();
                 if(!u) return;
                 if(u.createdAt && u.createdAt.toDate && u.createdAt.toDate() >= today) newUsers++;
                 if (u.lastActive && u.lastActive.toDate && (now - u.lastActive.toDate()) < 15 * 60 * 1000) activeNow++;
             });
             if(activeNow === 0) activeNow = 1; 
             div.innerHTML = `<div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ุงููุณุชุฎุฏููู ุงูููู</p><p class="text-2xl font-bold text-gray-800">${total}</p></div><div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users"></i></div></div><div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ูุดุทูู ุงูุขู</p><p class="text-2xl font-bold text-green-500">${activeNow}</p></div><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-wifi"></i></div></div><div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ุณุฌููุง ุงูููู</p><p class="text-2xl font-bold text-purple-500">${newUsers}</p></div><div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-user-plus"></i></div></div>`;
        }

        async function loadMyQuestionsContent() {
            const div = document.getElementById('my-questions-list');
            div.innerHTML = '<p class="text-center text-gray-400">ุชุญููู...</p>';
            const q1 = query(collection(db, "pending_questions"), where("authorId", "==", currentUser.uid));
            try {
                const s1 = await getDocs(q1);
                let html = ""; let qs = [];
                s1.forEach(d => qs.push(d.data()));
                qs.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                qs.forEach(q => { 
                    let statusBadge = "";
                    if(q.status === 'approved') statusBadge = `<span class="text-xs bg-green-100 text-green-600 px-2 rounded font-bold">ุชูุช ุงูููุงููุฉ (+10)</span>`;
                    else if (q.status === 'rejected') statusBadge = `<span class="text-xs bg-red-100 text-red-600 px-2 rounded font-bold">ูุฑููุถ</span>`;
                    else statusBadge = `<span class="text-xs bg-yellow-100 text-yellow-600 px-2 rounded font-bold">ููุฏ ุงููุฑุงุฌุนุฉ</span>`;
                    html += `<div class="bg-white p-4 rounded-xl border border-gray-100 mb-2 shadow-sm"><div class="flex justify-between mb-2"><span class="text-xs text-gray-400 font-bold">${q.subject}</span>${statusBadge}</div><p class="font-bold text-gray-800 text-sm">${q.question}</p></div>`; 
                });
                if(html === "") html = "<p class='text-center text-gray-400 mt-10'>ูู ุชูู ุจุฑูุน ุฃู ุฃุณุฆูุฉ ุญุชู ุงูุขู.</p>";
                div.innerHTML = html;
            } catch(e) { div.innerHTML = "<p class='text-red-500'>ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช.</p>"; }
        }

        // --- ADMIN FUNCTIONS CONTINUED ---
        async function loadAdminAllContent() {
             const div = document.getElementById('admin-all-list');
             if(allAdminQuestions.length === 0) {
                 div.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุฌูุจ ูู ุงูุฃุณุฆูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...</p>';
                 const q = await getDocs(collection(db, "questions"));
                 allAdminQuestions = [];
                 q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
             }
             filterAdminQuestions();
        }

        window.populateAdminFilterSubjects = () => {
            const grade = document.getElementById('admin-filter-grade').value;
            const subSel = document.getElementById('admin-filter-subject');
            subSel.innerHTML = '<option value="">ูู ุงูููุงุฏ</option>';
            if(grade && subjects[grade]) subjects[grade].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
        }

        window.renderAdminAllList = (list) => {
            const div = document.getElementById('admin-all-list');
            if(list.length === 0) { div.innerHTML = "<p class='text-center text-gray-400 mt-4'>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>"; return; }
            let html = `<p class="text-xs text-gray-400 mb-2">ุชู ุงูุนุซูุฑ ุนูู: ${list.length} ุณุคุงู</p>`;
            list.slice(0, 50).forEach(q => { 
                html += `<div class="bg-white rounded-xl p-3 mb-2 border border-gray-100 shadow-sm flex flex-col gap-2"><div class="flex justify-between items-start"><div><span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">${q.grade || 'ุบูุฑ ูุญุฏุฏ'} | ${q.subject}</span><span class="text-xs text-gray-400 ml-2">${q.type==='mcq'?'ุงุฎุชูุงุฑุงุช':'ุตุญ/ุฎุทุฃ'}</span></div><div class="flex gap-1"><button onclick="openEditModal('${q.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200 transition"><i class="fas fa-edit ml-1"></i>ุชุนุฏูู</button><button onclick="deleteApprovedQ('${q.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200 transition"><i class="fas fa-trash"></i></button></div></div><p class="font-bold text-gray-700 text-sm leading-6 border-r-2 border-indigo-200 pr-2">${q.question}</p></div>`;
            });
            div.innerHTML = html;
        };

        window.filterAdminQuestions = () => {
            const gr = document.getElementById('admin-filter-grade').value;
            const sub = document.getElementById('admin-filter-subject').value;
            const filtered = allAdminQuestions.filter(q => {
                const matchesGrade = gr ? (q.grade === gr) : true;
                const matchesSubject = sub ? (q.subject === sub) : true;
                return matchesGrade && matchesSubject;
            });
            renderAdminAllList(filtered);
        };

        window.resetStatsUI = () => { document.getElementById('stats-result-container').innerHTML = '<p class="text-center text-gray-400 text-sm mt-10">ุงุฎุชุฑ ุงูุจูุงูุงุช ูุงุถุบุท ุญุณุงุจ</p>'; }

        window.calculateQuestionStats = async () => {
            const grade = document.getElementById('stat-grade').value;
            const type = document.getElementById('stat-type').value;
            const resultDiv = document.getElementById('stats-result-container');
            resultDiv.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุงูุญุณุงุจ ุจุฏูุฉ...</p>';
            if(allAdminQuestions.length === 0) {
                 const q = await getDocs(collection(db, "questions"));
                 allAdminQuestions = [];
                 q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
            }
            const gradeSubjects = subjects[grade];
            let html = ""; let totalForGrade = 0;
            gradeSubjects.forEach(sub => {
                const count = allAdminQuestions.filter(q => q.grade === grade && q.type === type && q.subject === sub && (q.status === 'approved' || !q.status)).length;
                totalForGrade += count;
                html += `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100"><span class="font-bold text-gray-700">${sub}</span><span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg font-bold text-sm">${count}</span></div>`;
            });
            const summaryHtml = `<div class="bg-indigo-50 p-3 rounded-xl mb-3 border border-indigo-100 text-center"><p class="text-xs text-indigo-500 font-bold">ุงููุฌููุน ุงูููู ููุฐุง ุงููุณู</p><p class="text-2xl font-black text-indigo-800">${totalForGrade}</p></div>`;
            resultDiv.innerHTML = summaryHtml + html;
        };

        window.openEditModal = (id) => {
            const q = allAdminQuestions.find(i => i.id === id);
            if(!q) return;
            document.getElementById('edit-q-id').value = id;
            document.getElementById('edit-q-text').value = q.question;
            document.getElementById('edit-q-grade').value = q.grade || '6sci';
            const subSel = document.getElementById('edit-q-subject');
            subSel.innerHTML = "";
            subjects[q.grade || '6sci'].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            subSel.value = q.subject;
            document.getElementById('edit-q-grade').onchange = () => {
                const g = document.getElementById('edit-q-grade').value;
                subSel.innerHTML = "";
                subjects[g].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            };
            if(q.type === 'mcq') {
                document.getElementById('edit-mcq-fields').classList.remove('hidden');
                document.getElementById('edit-tf-fields').classList.add('hidden');
                document.getElementById('edit-ans-0').value = q.answers[0];
                document.getElementById('edit-ans-1').value = q.answers[1];
                document.getElementById('edit-ans-2').value = q.answers[2];
                document.getElementById('edit-correct-mcq').value = q.correct;
            } else {
                document.getElementById('edit-mcq-fields').classList.add('hidden');
                document.getElementById('edit-tf-fields').classList.remove('hidden');
                document.getElementById('edit-correct-tf').value = q.correct;
            }
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveFullEditQ = async () => {
            const id = document.getElementById('edit-q-id').value;
            const originalQ = allAdminQuestions.find(i => i.id === id);
            const type = originalQ.type;
            const updates = { question: document.getElementById('edit-q-text').value, grade: document.getElementById('edit-q-grade').value, subject: document.getElementById('edit-q-subject').value };
            if(type === 'mcq') {
                updates.answers = [document.getElementById('edit-ans-0').value, document.getElementById('edit-ans-1').value, document.getElementById('edit-ans-2').value];
                updates.correct = parseInt(document.getElementById('edit-correct-mcq').value);
            } else { updates.correct = document.getElementById('edit-correct-tf').value; }
            await updateDoc(doc(db, "questions", id), updates);
            const idx = allAdminQuestions.findIndex(i => i.id === id);
            if(idx !== -1) allAdminQuestions[idx] = { ...allAdminQuestions[idx], ...updates };
            const activeScreen = document.querySelector('.screen.active').id;
            if (activeScreen === 'screen-admin-all') filterAdminQuestions();
            if (activeScreen === 'screen-admin-stats') calculateQuestionStats();
            document.getElementById('edit-modal').classList.add('hidden');
            alert("ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ!");
        };

        window.deleteApprovedQ = async (id) => {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงู ููุงุฆูุงูุ")) {
                await deleteDoc(doc(db, "questions", id));
                allAdminQuestions = allAdminQuestions.filter(q => q.id !== id);
                filterAdminQuestions();
                calculateQuestionStats();
            }
        };

        async function loadAdminReviewContent() {
            const div = document.getElementById('admin-review-list');
            div.innerHTML = '<p class="text-center text-gray-400">ุชุญููู...</p>';
            const q = await getDocs(query(collection(db, "pending_questions"), where("status", "==", "pending")));
            if(q.empty) { div.innerHTML = "<p class='text-center py-10 text-gray-400'>ูุง ููุฌุฏ ุดูุก ูููุฑุงุฌุนุฉ</p>"; return; }
            let html = "";
            q.forEach(d => {
               const val = d.data(); const author = val.authorName || 'ูุฌููู';
               html += `<div class="bg-white rounded-xl p-4 mb-3 shadow-sm border border-gray-100" id="review-card-${d.id}"><div class="flex justify-between items-start mb-2"><span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg font-bold">${val.grade} | ${val.subject}</span><span class="text-xs text-gray-400">ุจูุงุณุทุฉ: ${author}</span></div><p class="font-bold mb-3 text-gray-800 text-sm leading-6">${val.question}</p><div class="bg-gray-50 p-3 rounded-lg mb-3 text-xs space-y-1 border border-gray-100"><p class="font-bold text-gray-500">ุงูุฎูุงุฑุงุช:</p>${val.type==='mcq' ? `<ul class="list-disc list-inside text-gray-600"><li>${val.answers[0]}</li><li>${val.answers[1]}</li><li>${val.answers[2]}</li></ul>` : `<p>ุตุญ / ุฎุทุฃ</p>`}<p class="mt-2 text-green-600 font-bold">ุงูุฌูุงุจ ุงูุตุญูุญ: ${val.type==='mcq' ? val.answers[val.correct] : (val.correct==='true'?'ุตุญ':'ุฎุทุฃ')}</p></div><div class="flex gap-2"><button onclick="approveQ('${d.id}')" class="flex-1 bg-green-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-green-600 transition">ูุจูู (+10)</button><button onclick="rejectQ('${d.id}')" class="flex-1 bg-red-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-red-600 transition">ุฑูุถ</button></div></div>`; 
            });
            div.innerHTML = html;
        }

        window.checkAdminNotifications = () => {
            const q = query(collection(db, "pending_questions"), where("status", "==", "pending"));
            adminListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                const badgeTab = document.getElementById('profile-tab-badge');
                const badgeBtn = document.getElementById('admin-btn-badge');
                if (count > 0) { badgeTab.classList.add('visible'); badgeBtn.classList.add('visible'); } 
                else { badgeTab.classList.remove('visible'); badgeBtn.classList.remove('visible'); }
            });
        };

        window.updateUploadUI = () => { 
            if(userData.grade) {
                updateUploadUIBasedOnSubjects();
                const type = document.getElementById('up-type').value;
                populateSubjects(userData.grade, 'up-subject', type);
                document.getElementById('up-type').onchange = function() {
                    populateSubjects(userData.grade, 'up-subject', this.value);
                };
            }
        };
        
        async function loadLeaderboard() {
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '<p class="text-center text-gray-400 mt-10">ุชุญููู...</p>';
            
            // ุฌูุจ ูู ุงููุณุชุฎุฏููู
            const q = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(d => { 
                users.push({ id: d.id, ...d.data() });
            });
            
            // ุชุฑุชูุจ ุญุณุจ ุงูููุงุท
            users.sort((a, b) => (b.points || 0) - (a.points || 0));

            const myIndex = users.findIndex(u => u.uid === currentUser.uid);
            if(myIndex !== -1) document.getElementById('my-rank-text').innerText = "#" + (myIndex + 1);
            else document.getElementById('my-rank-text').innerText = "ุบูุฑ ูุตูู";

            div.innerHTML = ''; 
            
            // Define prizes
            const prizes = [10, 7, 5, 3, 2, 1, 1, 1, 1, 1]; // $ for top 10
            
            users.forEach((u, index) => {
                let frameClass = "frame-rank-common";
                let crown = "";
                let rankBadge = `<div class="rank-badge-top">${index + 1}</div>`;
                let raysHtml = ""; 
                let backgroundClass = u.selectedBgTheme || 'bg-rank-default';
                
                // ุฅุถุงูุฉ ุฎูููุฉ ุงููููุฒูู
                if (u.isPremium && isPremiumValid(u)) {
                    backgroundClass = u.selectedBgTheme || 'bg-rank-default';
                }

                if (index === 0) { 
                    frameClass = "frame-rank-1"; 
                    crown = `<i class="fas fa-crown text-yellow-500 name-crown"></i>`; 
                    raysHtml = `<div class="rank-rays rays-gold"></div>`; 
                }
                else if (index === 1) { 
                    frameClass = "frame-rank-2"; 
                    raysHtml = `<div class="rank-rays rays-silver"></div>`; 
                }
                else if (index === 2) { 
                    frameClass = "frame-rank-3"; 
                    raysHtml = `<div class="rank-rays rays-bronze"></div>`; 
                }
                else if (index <= 9) { 
                    const colors = ['rays-blue', 'rays-red', 'rays-green', 'rays-purple', 'rays-blue', 'rays-red'];
                    frameClass = "frame-rank-other-top"; 
                    raysHtml = `<div class="rank-rays ${colors[index-3]}"></div>`; 
                }
                
                // ุฅุถุงูุฉ ุนูุงูุฉ ุงูุชูุซูู ูููููุฒูู
                let badgeHtml = "";
                if (u.isPremium && isPremiumValid(u) && u.selectedBadge) {
                    badgeHtml = `<span class="premium-badge" style="background-color: ${u.selectedBadgeColor || '#f59e0b'}">${u.selectedBadge}</span>`;
                }
                
                // Prize for top 10
                let prizeHtml = "";
                if (index < 10) {
                    prizeHtml = `<span class="text-xs font-bold text-green-600 ml-2">$${prizes[index]}</span>`;
                }
                
                let resetBtn = "";
                if (currentUser && userData && userData.email === ADMIN_EMAIL) {
                    resetBtn = `<button onclick="resetUserPoints('${u.id}', '${u.name}')" class="w-6 h-6 rounded bg-red-100 text-red-500 flex items-center justify-center mr-2"><i class="fas fa-trash-alt text-xs"></i></button>`;
                }
                
                div.innerHTML += `
                    <div class="flex items-center justify-between p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden ${backgroundClass}">
                        <div class="flex items-center gap-4 z-10">
                            <div class="rank-img-container">
                                ${rankBadge}
                                ${raysHtml}
                                <img src="${u.photo}" class="rank-img ${frameClass}">
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm flex items-center">
                                    ${crown} 
                                    ${u.name}
                                    ${badgeHtml}
                                    ${prizeHtml}
                                </p>
                                <p class="text-[10px] text-gray-600">ID: ${u.uniqueId}</p>
                                ${u.bio ? `<p class="bio-text mt-1">${u.bio}</p>` : ''}
                                ${u.isPremium && isPremiumValid(u) ? 
                                    `<p class="text-[10px] text-yellow-600 font-bold">๐ ูููุฒ</p>` : 
                                    ''}
                            </div>
                        </div>
                        <div class="flex items-center z-10">
                            ${resetBtn}
                            <span class="font-black text-indigo-600 text-lg">${u.points || 0} ๐</span>
                        </div>
                    </div>`;
            });
        }

        window.resetUserPoints = async (uid, name) => {
            if(confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ููุงุท ุงูุทุงูุจ: ${name}ุ`)) {
                await updateDoc(doc(db, "users", uid), { points: 0 });
                alert("ุชู ุชุตููุฑ ุงูููุงุท ุจูุฌุงุญ!");
                loadLeaderboard(); 
            }
        };

        // --- NEW ADMIN USER SEARCH & MANAGEMENT ---
        window.searchUserForAdmin = async () => {
             const uidInput = document.getElementById('admin-user-search').value.trim();
             const resDiv = document.getElementById('admin-user-result');
             if(!uidInput) return alert("ุฃุฏุฎู ุงููุนุฑู (ID)");
             
             resDiv.classList.remove('hidden');
             resDiv.innerHTML = 'ุฌุงุฑู ุงูุจุญุซ...';
             
             const q = query(collection(db, "users"), where("uniqueId", "==", uidInput));
             const snap = await getDocs(q);
             
             if(snap.empty) {
                 resDiv.innerHTML = '<p class="text-red-500">ุงููุณุชุฎุฏู ุบูุฑ ููุฌูุฏ</p>';
                 return;
             }
             
             const uData = snap.docs[0].data();
             const docId = snap.docs[0].id;
             const isBanned = uData.isBanned === true;
             const balance = uData.balance || 0;
             const deserves = balance >= 100;

             resDiv.innerHTML = `
                <div class="text-center mb-4">
                    <img src="${uData.photo}" class="w-16 h-16 rounded-full mx-auto mb-2">
                    <h3 class="font-bold">${uData.name}</h3>
                    <p class="text-xs text-gray-500">${uData.email}</p>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4 text-xs font-bold text-center">
                    <div class="bg-gray-50 p-2 rounded">ุงูููุงุท: ${uData.points}</div>
                    <div class="bg-gray-50 p-2 rounded">ุงูุฏููุงุฑุงุช: $${balance}</div>
                </div>
                <div class="mb-4 text-center">
                    <p class="text-sm font-bold ${deserves ? 'text-green-600' : 'text-red-500'}">
                        ${deserves ? 'โ ูุณุชุญู ุงูุณุญุจ' : 'โ ูุง ูุณุชุญู ุงูุณุญุจ'}
                    </p>
                    ${deserves ? `<button onclick="resetUserBalance('${docId}')" class="mt-2 bg-yellow-500 text-white px-4 py-2 rounded text-xs font-bold">ุชุตููุฑ ุงูุฏููุงุฑุงุช</button>` : ''}
                </div>
                <button onclick="toggleBan('${docId}', ${!isBanned})" class="w-full py-3 rounded-xl font-bold text-white ${isBanned ? 'bg-green-500' : 'bg-red-500'}">
                    ${isBanned ? 'ุฅูุบุงุก ุงูุญุธุฑ (ูู ุงูููุฏ)' : 'ุญุธุฑ ุงููุณุชุฎุฏู ููุงุฆูุงู'}
                </button>
             `;
        };

        window.toggleBan = async (docId, shouldBan) => {
            if(confirm(shouldBan ? "ูู ุฃูุช ูุชุฃูุฏ ูู ุญุธุฑ ูุฐุง ุงููุณุชุฎุฏู ููุงุฆูุงูุ ูู ูุชููู ูู ุงูุฏุฎูู ูุฌุฏุฏุงู." : "ูู ุชุฑูุฏ ุฅูุบุงุก ุงูุญุธุฑุ")) {
                await updateDoc(doc(db, "users", docId), { isBanned: shouldBan });
                alert(shouldBan ? "ุชู ุญุธุฑ ุงููุณุชุฎุฏู" : "ุชู ุฅูุบุงุก ุงูุญุธุฑ");
                searchUserForAdmin();
            }
        };

        window.resetUserBalance = async (docId) => {
             if(confirm("ูู ุชุฑูุฏ ุชุตููุฑ ุฏููุงุฑุงุช ูุฐุง ุงููุณุชุฎุฏูุ (ูุนูู ุฃูู ุฏูุนุช ูู)")) {
                 await updateDoc(doc(db, "users", docId), { balance: 0 });
                 alert("ุชู ุชุตููุฑ ุงูุฑุตูุฏ");
                 searchUserForAdmin();
             }
        };

        window.manualWeeklyDistribution = async () => {
             if(!confirm("โ๏ธ ุชุญุฐูุฑ: ูุฐุง ุงูุฅุฌุฑุงุก ุณูููู ุจุชูุฒูุน ุงูุฌูุงุฆุฒ ุนูู ุงููุฑุงูุฒ ุงูู 10 ุงูุฃููู ูุชุตููุฑ ููุงุท ุฌููุน ุงููุณุชุฎุฏููู (ุฃุนูู 150). ูู ุฃูุช ูุชุฃูุฏุ")) return;
             
             // Get Top 10
             const q = query(collection(db, "users"), orderBy("points", "desc"), limit(10));
             const snap = await getDocs(q);
             const prizes = [10, 7, 5, 3, 2, 1, 1, 1, 1, 1]; // $
             
             let batch = writeBatch(db);
             
             // Distribute Prizes
             snap.docs.forEach((d, index) => {
                 if(index < 10) {
                     const prize = prizes[index];
                     const newBalance = (d.data().balance || 0) + prize;
                     batch.update(doc(db, "users", d.id), { balance: newBalance });
                 }
             });
             await batch.commit();

             // Reset Points for Top 150
             const qReset = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
             const snapReset = await getDocs(qReset);
             
             let resetBatch = writeBatch(db);
             snapReset.docs.forEach(d => {
                 resetBatch.update(doc(db, "users", d.id), { points: 0 });
             });
             await resetBatch.commit();
             
             alert("โ ุชู ุชูุฒูุน ุงูุฌูุงุฆุฒ ูุชุตููุฑ ุงูููุงุท ุจูุฌุงุญ!");
             loadLeaderboard();
        };

        // --- SYSTEM SETTINGS (FIXED) ---
        window.toggleSystemUI = () => {
             const toggle = document.getElementById('system-toggle');
             const statusText = document.getElementById('system-status-text');
             
             // Prevent automatic changes
             systemStatusLock = true;
             
             if (!toggle.checked) {
                 statusText.innerText = "ุงููุธุงู ูุชููู โ (ุณูุชู ุงูุญูุธ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ)";
                 statusText.className = "text-xs font-bold text-red-400 mb-2";
             } else {
                 statusText.innerText = "ุงููุธุงู ูุนูู ุญุงููุงู โ (ุณูุชู ุงูุญูุธ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ)";
                 statusText.className = "text-xs font-bold text-green-400 mb-2";
             }
        };

        window.saveSystemSettings = async () => {
            const isEnabled = document.getElementById('system-toggle').checked;
            const msg = document.getElementById('maintenance-msg-input').value;
            
            if (!isEnabled && !msg.trim()) {
                alert("ูุฑุฌู ูุชุงุจุฉ ุฑุณุงูุฉ ุชูุถูุญูุฉ ูููุณุชุฎุฏููู ุนูุฏ ุงูุฅููุงู.");
                return;
            }
            
            try {
                systemConfig.enabled = isEnabled;
                systemConfig.msg = msg;
                
                await setDoc(doc(db, "system_settings", "config"), { 
                    challengesEnabled: isEnabled, 
                    maintenanceMessage: msg 
                }, { merge: true });
                
                // Release the lock
                systemStatusLock = false;
                
                alert("โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ุจูุฌุงุญ!");
            } catch (e) { 
                alert("ุฎุทุฃ ูู ุงูุญูุธ: " + e.message); 
            }
        };

        // --- SUBSCRIPTION CODE MANAGEMENT ---
        window.generateSubscriptionCode = async function() {
            try {
                // ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุฃุฏูู ููุท
                if (!currentUser || !userData || userData.email !== ADMIN_EMAIL) {
                    alert("โ ููุณ ูุฏูู ุตูุงุญูุฉ ููููุงู ุจูุฐุง ุงูุฅุฌุฑุงุก");
                    return;
                }

                const durationSelect = document.getElementById('admin-sub-duration');
                const durationDays = parseInt(durationSelect.value);
                
                if (!durationDays || durationDays <= 0) {
                    alert("โ ูุฑุฌู ุชุญุฏูุฏ ูุฏุฉ ุงูุงุดุชุฑุงู");
                    return;
                }

                // ุฅูุดุงุก ููุฏ ุนุดูุงุฆู ูุฑูุฏ
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code;
                let isUnique = false;
                let attempts = 0;
                
                // ุงูุชุฃูุฏ ูู ุฃู ุงูููุฏ ูุฑูุฏ ูุบูุฑ ูุณุชุฎุฏู
                while (!isUnique && attempts < 10) {
                    code = '';
                    for (let i = 0; i < 6; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    
                    // ุงูุชุญูู ูู ูุฌูุฏ ุงูููุฏ ูุณุจูุงู
                    const q = query(collection(db, "premium_codes"), where("code", "==", code));
                    const querySnapshot = await getDocs(q);
                    isUnique = querySnapshot.empty;
                    attempts++;
                }
                
                if (!isUnique) {
                    alert("โ ุชุนุฐุฑ ุฅูุดุงุก ููุฏ ูุฑูุฏุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู");
                    return;
                }

                // ุฅุถุงูุฉ ุงูููุฏ ุฅูู Firebase
                await addDoc(collection(db, "premium_codes"), {
                    code: code,
                    durationDays: durationDays,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    used: false,
                    usedBy: null,
                    usedAt: null,
                    isActive: true
                });

                // ุนุฑุถ ุงูููุฏ ูููุณุชุฎุฏู
                const displayDiv = document.getElementById('generated-code-display');
                const codeText = document.getElementById('gen-code-text');
                
                codeText.textContent = code;
                displayDiv.classList.remove('hidden');
                
                // ุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
                alert(`โ ุชู ุฅูุดุงุก ููุฏ ุงุดุชุฑุงู ุฌุฏูุฏ:\n\nุงูููุฏ: ${code}\nุงููุฏุฉ: ${durationDays} ููู\n\nุงูููุฏ ูุณุชุฎุฏู ูุฑุฉ ูุงุญุฏุฉ ููุท!`);

            } catch (error) {
                console.error("ุฎุทุฃ ูู ุชูููุฏ ุงูููุฏ:", error);
                alert(`โ ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงูููุฏ: ${error.message}`);
            }
        };

        window.copyGenCode = function() {
            const codeText = document.getElementById('gen-code-text').textContent;
            if (!codeText || codeText === '...') {
                alert("โ๏ธ ูุง ููุฌุฏ ููุฏ ูุนุฑุถู");
                return;
            }
            
            navigator.clipboard.writeText(codeText)
                .then(() => {
                    alert("โ ุชู ูุณุฎ ุงูููุฏ ุฅูู ุงูุญุงูุธุฉ!");
                })
                .catch(err => {
                    console.error("ุฎุทุฃ ูู ุงููุณุฎ:", err);
                    // ุทุฑููุฉ ุจุฏููุฉ ูููุณุฎ
                    const tempInput = document.createElement('input');
                    tempInput.value = codeText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert("โ ุชู ูุณุฎ ุงูููุฏ ุฅูู ุงูุญุงูุธุฉ!");
                });
        };

        window.deleteSubscriptionCode = async function() {
            try {
                const codeInput = document.getElementById('admin-delete-code-input').value.trim().toUpperCase();
                
                if (!codeInput) {
                    alert("โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ููุฏ ููุญุฐู");
                    return;
                }

                // ุชุฃููุฏ ุงูุญุฐู
                if (!confirm(`โ๏ธ ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููุฏ "${codeInput}"ุ\n\nูุฐุง ุงูุฅุฌุฑุงุก ููุงุฆู ููุง ูููู ุงูุชุฑุงุฌุน ุนูู.`)) {
                    return;
                }

                // ุงูุจุญุซ ุนู ุงูููุฏ ูู Firebase
                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    alert("โ ุงูููุฏ ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช");
                    return;
                }

                // ุญุฐู ุงูููุฏ
                const codeDoc = querySnapshot.docs[0];
                await deleteDoc(doc(db, "premium_codes", codeDoc.id));
                
                // ุชูุฑูุบ ุงูุญูู ูุฅุธูุงุฑ ุฑุณุงูุฉ ูุฌุงุญ
                document.getElementById('admin-delete-code-input').value = '';
                alert(`โ ุชู ุญุฐู ุงูููุฏ "${codeInput}" ุจูุฌุงุญ`);

            } catch (error) {
                console.error("ุฎุทุฃ ูู ุญุฐู ุงูููุฏ:", error);
                alert(`โ ุญุฏุซ ุฎุทุฃ ูู ุญุฐู ุงูููุฏ: ${error.message}`);
            }
        };

        // --- HELPERS ---
        window.handleImagePreview = (input) => {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById('preview-img').src = e.target.result;
                r.readAsDataURL(input.files[0]);
            }
        };

        function generateId() { 
            return Math.random().toString(36).substr(2, 6).toUpperCase(); 
        }

        function compressImage(file) {
    return new Promise((resolve, reject) => {
        if (!file || !file.type.startsWith('image/')) {
            reject(new Error("ุงูููู ููุณ ุตูุฑุฉ"));
            return;
        }

        console.log(`๐ธ ูุนุงูุฌุฉ ุงูุตูุฑุฉ: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
        
        // ูุฑุงุกุฉ ุงูููู ูู URL ูุจุงุดุฑุฉ ุจุฏูู ุถุบุท
        const reader = new FileReader();
        
        reader.onload = function(event) {
            // ุงุณุชุฎุฏู ุงูุตูุฑุฉ ุงูุฃุตููุฉ ูุจุงุดุฑุฉ ุจุฏูู ุถุบุท
            const imageUrl = event.target.result;
            
            console.log(`โ ุชู ุชุญููู ุงูุตูุฑุฉ: ${(imageUrl.length / 1024).toFixed(1)} KB`);
            console.log(`๐ฏ ุงูุฌูุฏุฉ: 100% (ุจุฏูู ุถุบุท)`);
            
            resolve(imageUrl); // ุฅุฑุฌุงุน ุงูุตูุฑุฉ ุงูุฃุตููุฉ
        };
        
        reader.onerror = function(error) {
            console.error("โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูุตูุฑุฉ:", error);
            reject(error);
        };
        
        // ูุฑุงุกุฉ ูู Data URL ุจุฏูู ุชุบููุฑ
        reader.readAsDataURL(file);
    });
}

        window.approveQ = async (id) => {
            const card = document.getElementById(`review-card-${id}`);
            if(card) card.remove();
            
            const ref = doc(db, "pending_questions", id);
            const d = (await getDoc(ref)).data();
            
            if (!d.grade) {
                const authorDoc = await getDoc(doc(db, "users", d.authorId));
                if (authorDoc.exists()) {
                    d.grade = authorDoc.data().grade || '6sci';
                } else {
                    d.grade = '6sci';
                }
            }
            
            await addDoc(collection(db, "questions"), {
                ...d, 
                status: 'approved',
                grade: d.grade
            });
            
            await updateDoc(doc(db, "users", d.authorId), { points: increment(10) });
            await updateDoc(ref, { status: 'approved' });
        };

        window.rejectQ = async (id) => {
            const card = document.getElementById(`review-card-${id}`);
            if(card) card.remove();
            await updateDoc(doc(db, "pending_questions", id), { status: 'rejected' });
        };

        window.updateProfilePic = async (input) => {
            if(input.files[0]) {
                const p = await compressImage(input.files[0]);
                await updateDoc(doc(db, "users", currentUser.uid), { photo: p });
                document.getElementById('profile-img').src = p;
            }
        };

        window.closeMaintenancePopup = function() {
            document.getElementById('maintenance-popup').classList.add('hidden');
            switchTab('challenges');
        };

function setupSolutionsHeader() {
    const headerPoints = document.getElementById('header-points');
    const headerContainer = document.querySelector('#main-app > div.absolute.top-0'); // ุงูููุฏุฑ ุงูุฑุฆูุณู
    
    if (!headerContainer) return;
    
    // ุงูุจุญุซ ุนู ุงูุนูุตุฑ ุงูุฐู ูุญุชูู ุนูู ุงูููุงุท
    const pointsContainer = headerContainer.querySelector('.bg-yellow-50');
    
    // ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุดุฑููุง ุฃู ูุงูููุง
    if (userData.email === ADMIN_EMAIL || userData.isModerator) {
        // ุฅุฎูุงุก ุงูููุงุท ูู ูุณู ุงูุญููู
        if (pointsContainer) {
            pointsContainer.style.display = 'none';
        }
        
        // ุฅุถุงูุฉ ุฒุฑ ุงูุฅุฏุงุฑุฉ ุจุฏูุงู ูู ุงูููุงุท
        const existingAdminBtn = headerContainer.querySelector('.solutions-header-admin-btn');
        if (!existingAdminBtn) {
            const adminBtn = document.createElement('button');
            adminBtn.className = 'solutions-header-admin-btn';
            adminBtn.innerHTML = '<i class="fas fa-user-shield"></i> ุงูุฅุฏุงุฑุฉ';
            adminBtn.onclick = openSolutionsAdmin;
            
            // ูุถุน ุงูุฒุฑ ูู ููุงู ุงูููุงุท
            if (pointsContainer) {
                pointsContainer.parentNode.insertBefore(adminBtn, pointsContainer.nextSibling);
            } else {
                // ุฅุฐุง ูู ูุฌุฏ ุญุงููุฉ ุงูููุงุทุ ูุถุน ุงูุฒุฑ ูู ููุงูุฉ ุงูููุฏุฑ
                headerContainer.appendChild(adminBtn);
            }
        }
    } else {
        // ูููุณุชุฎุฏููู ุงูุนุงุฏููู: ุฅุธูุงุฑ ุงูููุท ูุฅุฎูุงุก ุฒุฑ ุงูุฅุฏุงุฑุฉ ุฅุฐุง ูุงู ููุฌูุฏูุง
        if (pointsContainer) {
            pointsContainer.style.display = 'flex';
        }
        
        const adminBtn = headerContainer.querySelector('.solutions-header-admin-btn');
        if (adminBtn) {
            adminBtn.remove();
        }
    }
}

function manageHeaderForTab(tab) {
    const headerContainer = document.querySelector('#main-app > div.absolute.top-0');
    if (!headerContainer) return;
    
    const pointsContainer = headerContainer.querySelector('.bg-yellow-50');
    const adminBtn = headerContainer.querySelector('.solutions-header-admin-btn');
    
    if (tab === 'solutions') {
        // ูู ูุณู ุงูุญููู
        if (userData.email === ADMIN_EMAIL || userData.isModerator) {
            // ูููุดุฑููู: ุฅุฎูุงุก ุงูููุงุท ูุฅุธูุงุฑ ุฒุฑ ุงูุฅุฏุงุฑุฉ
            if (pointsContainer) pointsContainer.style.display = 'none';
            
            if (!adminBtn) {
                const newAdminBtn = document.createElement('button');
                newAdminBtn.className = 'solutions-header-admin-btn';
                newAdminBtn.innerHTML = '<i class="fas fa-user-shield"></i> ุงูุฅุฏุงุฑุฉ';
                newAdminBtn.onclick = openSolutionsAdmin;
                
                if (pointsContainer) {
                    pointsContainer.parentNode.insertBefore(newAdminBtn, pointsContainer.nextSibling);
                } else {
                    headerContainer.appendChild(newAdminBtn);
                }
            }
        } else {
            // ูููุณุชุฎุฏููู ุงูุนุงุฏููู: ุฅุธูุงุฑ ุงูููุงุท ููุท
            if (pointsContainer) pointsContainer.style.display = 'flex';
            if (adminBtn) adminBtn.remove();
        }
    } else {
        // ูู ุฌููุน ุงูุฃูุณุงู ุงูุฃุฎุฑู: ุฅุธูุงุฑ ุงูููุงุท ูุฅุฎูุงุก ุฒุฑ ุงูุฅุฏุงุฑุฉ
        if (pointsContainer) pointsContainer.style.display = 'flex';
        if (adminBtn) adminBtn.remove();
    }
}
// --- SOLUTIONS IMAGE HANDLING FUNCTIONS ---
window.previewSolutionImage = async function() {
    const input = document.getElementById('solution-image-input');
    const previewDiv = document.getElementById('solution-image-preview');
    
    if(input.files && input.files[0]) {
        const file = input.files[0];
        
        // ุงูุชุญูู ูู ุญุฌู ุงูููู (5MB ูุญุฏ ุฃูุตู)
        if (file.size > 5 * 1024 * 1024) {
            alert("ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏุงู. ุงูุญุฏ ุงูุฃูุตู 5MB");
            input.value = ''; // ุฅูุฑุงุบ ุงูุญูู
            return;
        }
        
        // ุงูุชุญูู ูู ููุน ุงูููู
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!validTypes.includes(file.type)) {
            alert("ููุน ุงูููู ุบูุฑ ูุฏุนูู. ูุฑุฌู ุฑูุน ุตูุฑุฉ (JPG, PNG, GIF)");
            input.value = '';
            return;
        }
        
        // ุนุฑุถ ุฑุณุงูุฉ ุงูุชุญููู
        previewDiv.innerHTML = `
            <div class="flex items-center justify-between bg-blue-50 p-2 rounded border border-blue-200">
                <div class="flex items-center gap-2">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-xs"></i>
                    <span class="text-xs font-medium text-gray-700">ุฌุงุฑู ูุนุงูุฌุฉ ุงูุตูุฑุฉ...</span>
                </div>
            </div>
        `;
        previewDiv.classList.remove('hidden');
        
        try {
            // ุถุบุท ุงูุตูุฑุฉ ูุชุญููููุง ุฅูู Base64
            const compressedImage = await compressImage(file);
            
            // ุนุฑุถ ุงูุตูุฑุฉ ุจุนุฏ ุงููุนุงูุฌุฉ
            previewDiv.innerHTML = `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500 text-xs"></i>
                        <span class="text-xs font-medium text-gray-700">ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ</span>
                    </div>
                    <button onclick="removeSolutionImage()" class="text-red-500 text-xs font-bold px-2 py-1 hover:bg-red-50 rounded">
                        <i class="fas fa-times ml-1"></i> ุฅุฒุงูุฉ
                    </button>
                </div>
                <div class="mt-2 bg-gray-100 rounded p-1">
                    <img src="${compressedImage}" class="w-full h-24 object-contain rounded">
                </div>
            `;
            
            // ุชูููู ุฒุฑ ุงูุฅุฑุณุงู ุฅุฐุง ูุงูุช ุฌููุน ุงูุญููู ููุชููุฉ
            validateSolutionForm();
            
        } catch (error) {
            console.error("Error processing image:", error);
            previewDiv.innerHTML = `
                <div class="flex items-center justify-between bg-red-50 p-2 rounded border border-red-200">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-exclamation-circle text-red-500 text-xs"></i>
                        <span class="text-xs font-medium text-gray-700">ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุตูุฑุฉ</span>
                    </div>
                    <button onclick="removeSolutionImage()" class="text-red-500 text-xs font-bold px-2 py-1 hover:bg-red-50 rounded">
                        <i class="fas fa-times ml-1"></i>
                    </button>
                </div>
            `;
            alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุตูุฑุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
        }
    }
};

window.removeSolutionImage = function() {
    const input = document.getElementById('solution-image-input');
    const previewDiv = document.getElementById('solution-image-preview');
    
    input.value = '';
    previewDiv.classList.add('hidden');
    previewDiv.innerHTML = '';
    
    // ุชุนุทูู ุฒุฑ ุงูุฅุฑุณุงู ุฅุฐุง ูุงูุช ุงูุตูุฑุฉ ูุทููุจุฉ
    validateSolutionForm();
};

// ุฏุงูุฉ ููุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ
function validateSolutionForm() {
    const grade = document.getElementById('solution-grade').value;
    const subject = document.getElementById('solution-subject').value;
    const imageInput = document.getElementById('solution-image-input');
    const sendBtn = document.getElementById('solution-send-btn');
    
    const isGradeValid = grade !== '';
    const isSubjectValid = subject !== '';
    const hasImage = imageInput.files && imageInput.files[0];
    
    // ุงูุชุญูู ูู ุงูุญุฏ ุงููููู
    const today = new Date().toISOString().split('T')[0];
    if (userData.lastSolutionReset !== today) {
        userData.dailySolutionsSent = 0;
        userData.lastSolutionReset = today;
    }
    
    const limit = isPremiumValid(userData) ? 3 : 1;
    const canSendMore = (userData.dailySolutionsSent || 0) < limit;
    
    if (isGradeValid && isSubjectValid && hasImage && canSendMore) {
        sendBtn.disabled = false;
        sendBtn.className = "w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-sm transition flex items-center justify-center gap-2 shadow-md cursor-pointer";
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> ุฅุฑุณุงู ุงูุณุคุงู';
    } else {
        sendBtn.disabled = true;
        sendBtn.className = "w-full bg-gray-400 text-white py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 cursor-not-allowed";
        
        if (!canSendMore) {
            sendBtn.innerHTML = '<i class="fas fa-ban"></i> ูุตูุช ููุญุฏ ุงููููู';
        } else if (!hasImage) {
            sendBtn.innerHTML = '<i class="fas fa-image"></i> ุงุฑูุน ุตูุฑุฉ ุงูุณุคุงู';
        } else if (!isSubjectValid) {
            sendBtn.innerHTML = '<i class="fas fa-book"></i> ุงุฎุชุฑ ุงููุงุฏุฉ';
        } else {
            sendBtn.innerHTML = '<i class="fas fa-school"></i> ุงุฎุชุฑ ุงููุฑุญูุฉ';
        }
    }
}

// ุฅุถุงูุฉ ูุณุชูุนุงุช ุงูุฃุญุฏุงุซ ููุญููู
document.addEventListener('DOMContentLoaded', function() {
    const gradeSelect = document.getElementById('solution-grade');
    const subjectSelect = document.getElementById('solution-subject');
    const imageInput = document.getElementById('solution-image-input');
    
    if (gradeSelect) {
        gradeSelect.addEventListener('change', function() {
            validateSolutionForm();
            // ุชุญุฏูุซ ูุงุฆูุฉ ุงูููุงุฏ ุนูุฏ ุชุบููุฑ ุงููุฑุญูุฉ
            if (this.value && subjects[this.value]) {
                subjectSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>';
                subjects[this.value].forEach(s => {
                    subjectSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            } else {
                subjectSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>';
            }
        });
    }
    
    if (subjectSelect) {
        subjectSelect.addEventListener('change', validateSolutionForm);
    }
    
    if (imageInput) {
        imageInput.addEventListener('change', validateSolutionForm);
    }
    
    // ุงูุชุญูู ุงูุฃููู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    setTimeout(validateSolutionForm, 500);
});

// ุฏุงูุฉ ุฎุงุตุฉ ูุฑูุน ุตูุฑ ุงููุดุฑููู ุจุฌูุฏุฉ ุนุงููุฉ ุฌุฏุงู
function compressAdminImage(file) {
    return new Promise((resolve, reject) => {
        if (!file || !file.type.startsWith('image/')) {
            reject(new Error("ุงูููู ููุณ ุตูุฑุฉ"));
            return;
        }

        console.log(`๐ [ูุดุฑู] ุฑูุน ุตูุฑุฉ ุจุฌูุฏุฉ ูุงููุฉ: ${file.name}`);
        
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const imageUrl = event.target.result;
            console.log(`๐ [ูุดุฑู] ุชู ุงูุฑูุน: ${(imageUrl.length / 1024).toFixed(1)} KB - ุฌูุฏุฉ 100%`);
            resolve(imageUrl);
        };
        
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

window.deleteSolution = async function(solutionId, studentName, subject) {
    if (!confirm(`โ๏ธ **ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงู ููุงุฆูุงูุ**
    
๐ค ุงูุทุงูุจ: ${studentName}
๐ ุงููุงุฏุฉ: ${subject}
โ ูุฐุง ุงูุณุคุงู ุณูุชู ุญุฐูู ููุงุฆูุงู ููู ูุชููู ุงูุทุงูุจ ูู ุฑุคูุชู

ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!`)) {
        return;
    }
    
    try {
        // ุฅุธูุงุฑ ุฑุณุงูุฉ ุชุญููู
        const card = document.getElementById(`admin-solution-${solutionId}`);
        if (card) {
            card.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-red-500 text-xl mb-2"></i>
                    <p class="text-sm text-gray-600">ุฌุงุฑู ุญุฐู ุงูุณุคุงู...</p>
                </div>
            `;
        }
        
        // ุญุฐู ุงูุณุคุงู ูู Firebase
        await deleteDoc(doc(db, "solutions", solutionId));
        
        console.log(`โ ุชู ุญุฐู ุณุคุงู ID: ${solutionId}`);
        
        // ุฅุฒุงูุฉ ุงูุนูุตุฑ ูู ุงููุงุฌูุฉ
        if (card) {
            card.style.opacity = '0.5';
            card.innerHTML = `
                <div class="text-center py-4 text-green-600">
                    <i class="fas fa-check-circle text-xl mb-2"></i>
                    <p class="text-sm font-bold">ุชู ุงูุญุฐู ุจูุฌุงุญ</p>
                </div>
            `;
            
            // ุฅุฒุงูุฉ ุงูุนูุตุฑ ุจุนุฏ ุซุงููุชูู
            setTimeout(() => {
                card.remove();
            }, 2000);
        }
        
        // ุฅุธูุงุฑ ุฅุดุนุงุฑ
        alert(`โ ุชู ุญุฐู ุณุคุงู ${subject} ููุทุงูุจ ${studentName} ุจูุฌุงุญ`);
        
    } catch (error) {
        console.error("โ ุฎุทุฃ ูู ุญุฐู ุงูุณุคุงู:", error);
        alert(`โ ูุดู ุญุฐู ุงูุณุคุงู: ${error.message}`);
        
        // ุฅุนุงุฏุฉ ุชุนููู ุงูุจุทุงูุฉ
        const card = document.getElementById(`admin-solution-${solutionId}`);
        if (card) {
            card.innerHTML = `
                <div class="text-center py-4 text-red-500">
                    <i class="fas fa-exclamation-triangle text-xl mb-2"></i>
                    <p class="text-sm font-bold">ุฎุทุฃ ูู ุงูุญุฐู</p>
                    <button onclick="deleteSolution('${solutionId}', '${studentName}', '${subject}')" 
                            class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-xs">
                        ุญุงูู ูุฑุฉ ุฃุฎุฑู
                    </button>
                </div>
            `;
        }
    }
};


    </script>
</body>
</html>
