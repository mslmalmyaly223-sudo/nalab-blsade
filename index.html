<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ููุฑ ุงููุฒุงุฑู</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Reset & Variables --- */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --bg-app: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-app);
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0; padding: 0;
        }

        /* --- Custom Scroll (UPDATED FOR BETTER SCROLLING) --- */
        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* ุฒูุฏุช ุงููุณุงูุฉ ุงูุฌููุฉ ุญุชู ุชูุฏุฑ ุชูุฒู ุจุฑุงุญุชู */
            padding-bottom: 200px; 
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Animations --- */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* --- Components --- */
        .screen {
            display: none; height: 100vh; width: 100vw;
            position: absolute; top: 0; left: 0; background: var(--bg-app); z-index: 10;
        }
        .screen.active { display: block; z-index: 20; }

        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .input-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 14px; width: 100%; outline: none; font-size: 1rem; transition: border-color 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn-main {
            background: var(--primary); color: white; padding: 14px;
            border-radius: 12px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); transition: transform 0.1s, background-color 0.2s;
            text-align: center; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:hover { background-color: var(--primary-dark); }

        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item { position: relative; transition: all 0.2s; } 
        
        .stat-btn {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative;
        }
        .stat-btn:active { transform: scale(0.98); background-color: #f9fafb; }

        /* Notification Dot */
        .red-dot {
            position: absolute; top: -2px; right: 25%;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .red-dot.visible { display: block; }
        
        .btn-dot {
            width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 10px; display: none;
        }
        .btn-dot.visible { display: inline-block; }

        /* Hacker Animation */
        .hacker-text {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: slideUp 1s ease-out;
        }

        /* Auth Tabs Styles */
        .auth-tabs {
            display: flex; background: #f1f5f9; padding: 4px;
            border-radius: 14px; margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1; text-align: center; padding: 10px;
            font-weight: bold; color: #64748b; cursor: pointer;
            border-radius: 10px; transition: all 0.3s; font-size: 0.95rem;
        }
        .auth-tab.active {
            background: white; color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Leaderboard Top Styles */
        .rank-item:nth-child(1) { border: 2px solid #FFD700; background: linear-gradient(to right, #fff, #fffde7); position: relative; }
        .rank-item:nth-child(1)::after { content: '๐'; position: absolute; top: -10px; left: 10px; font-size: 20px; animation: bounce 2s infinite; }
        .rank-item:nth-child(1) .rank-num { background: #FFD700; color: white; border: none; box-shadow: 0 0 10px #FFD700; }
        
        .rank-item:nth-child(2) { border: 2px solid #C0C0C0; background: linear-gradient(to right, #fff, #f3f3f3); }
        .rank-item:nth-child(2) .rank-num { background: #C0C0C0; color: white; border: none; }
        
        .rank-item:nth-child(3) { border: 2px solid #CD7F32; background: linear-gradient(to right, #fff, #fff5eb); }
        .rank-item:nth-child(3) .rank-num { background: #CD7F32; color: white; border: none; }

        .rank-item:nth-child(n+4):nth-child(-n+10) { border: 2px solid #a5b4fc; }
        .rank-item:nth-child(n+4):nth-child(-n+10) .rank-num { background: #a5b4fc; color: white; border: none; }

        /* Subway Surfers Style Daily Reward */
        .reward-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .reward-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px;
        }
        .day-box {
            background: #f1f5f9; border-radius: 8px; padding: 6px 2px;
            text-align: center; position: relative; border: 2px solid transparent;
            transition: all 0.2s; display: flex; flex-direction: column;
            align-items: center; justify-content: center; min-height: 50px;
        }
        .day-box p { font-size: 0.6rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }
        .day-box span { font-size: 0.7rem; font-weight: 900; display: block; line-height: 1.1; }
        
        .day-box.claimed { background: #10B981; border-color: #059669; }
        .day-box.claimed p, .day-box.claimed span { color: white; }
        .day-box.claimed::after { content: 'โ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.3); font-size: 20px; }

        .day-box.active { 
            background: #FFFBEB; border-color: #F59E0B; transform: scale(1.05); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); z-index: 10;
        }
        .day-box.active span { color: #D97706; }
        .day-box.active p { color: #D97706; }
        
        .day-box.locked { opacity: 0.6; }

        /* --- FIXED TOGGLE SWITCH STYLES --- */
        .toggle-wrapper {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #9CA3AF; /* Gray when off */
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        /* When Checked (Green) */
        .toggle-checkbox:checked + .toggle-slider {
            background-color: #10B981; 
        }
        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: 20px; padding: 20px; overflow-y: auto;
            animation: slideUp 0.3s ease-out; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        @media (min-width: 768px) {
            .input-box { font-size: 1.1rem; }
            .auth-overlay > div { max-width: 500px; }
        }

    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN -->
    <div id="intro-screen" class="auth-overlay flex-col" style="z-index: 10000;">
        <h1 class="hacker-text mb-4">ููุฑ ุงููุฒุงุฑู</h1>
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-medium animate-pulse">ุฌุงุฑู ุงูุชุญููู...</p>
    </div>

    <!-- 2. DAILY REWARD POPUP -->
    <div id="daily-reward-screen" class="fixed inset-0 reward-overlay z-[9000] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden animate-[slideUp_0.4s_ease-out]">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-indigo-800">ุณุฌู ุงูุญุถูุฑ ุงููููู ๐</h2>
                <p class="text-xs text-gray-500">ุงูุชูููุช ุญุณุจ ุจุบุฏุงุฏ (12:00 ุต)</p>
            </div>
            
            <div id="reward-grid-container" class="reward-grid"></div>

            <div class="text-center mt-6">
                <button onclick="claimReward()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                      <span>ุงุณุชูุงู ุงููุฏูุฉ</span>
                      <i class="fas fa-gift animate-bounce"></i>
                </button>
            </div>
            
            <button onclick="document.getElementById('daily-reward-screen').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 3. AUTH SCREEN -->
    <div id="auth-screen" class="auth-overlay hidden">
        <div class="w-full max-w-md p-8 h-full overflow-y-auto flex flex-col justify-center">
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-indigo-600 mb-2">ููุฑ ุงููุฒุงุฑู</h1>
                <p class="text-gray-500 text-sm">ุจูุงุจุชู ููุชููู ูู ุงูุงูุชุญุงูุงุช ุงููุฒุงุฑูุฉ</p>
            </div>

            <div class="auth-tabs">
                <div id="tab-login-btn" onclick="switchAuthTab('login')" class="auth-tab active">ุชุณุฌูู ุงูุฏุฎูู</div>
                <div id="tab-signup-btn" onclick="switchAuthTab('signup')" class="auth-tab">ุฅูุดุงุก ุญุณุงุจ</div>
            </div>

            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                        <input type="email" id="login-email" placeholder="example@gmail.com" class="input-box" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ูููุฉ ุงููุฑูุฑ</label>
                        <input type="password" id="login-pass" placeholder="โขโขโขโขโขโขโขโข" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-8">ุฏุฎูู</button>
            </form>

            <form id="signup-form" class="hidden" onsubmit="event.preventDefault(); handleSignup();">
                <div class="flex justify-center mb-6">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('signup-img').click()">
                        <img id="preview-img" src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100 shadow-md transition group-hover:border-indigo-200">
                        <div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm">
                            <i class="fas fa-camera text-xs"></i>
                        </div>
                    </div>
                    <input type="file" id="signup-img" hidden accept="image/*" onchange="handleImagePreview(this)">
                </div>
                <div class="space-y-3">
                    <div>
                        <input type="text" id="signup-name" placeholder="ุงูุงุณู ุงูุธุงูุฑ ูู ุงูุชุตููู" class="input-box" required>
                    </div>
                    <div>
                        <input type="email" id="signup-email" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (@gmail.com)" class="input-box" required>
                    </div>
                    <div>
                        <input type="password" id="signup-pass" placeholder="ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุน ุงูุฃูู)" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-6 bg-indigo-600">ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ</button>
                <p class="text-xs text-center text-gray-400 mt-4">ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ ุงุฎุชูุงุฑูุฉ</p>
            </form>
        </div>
    </div>

    <!-- 4. MAIN APP CONTAINER -->
    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- HEADER -->
        <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center justify-between px-5 pt-2">
            <div>
                <h1 class="font-bold text-lg text-gray-800">ููุฑ ุงููุฒุงุฑู</h1>
                <p id="header-grade-badge" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full hidden">...</p>
            </div>
            <div class="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2">
                <span id="header-points" class="font-bold text-yellow-700">0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>
        </div>

        <!-- === TABS === -->

        <!-- TAB 1: CHALLENGES -->
        <div id="tab-challenges" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                
                <!-- Select Grade First Time -->
                <div id="grade-selector-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-school text-xl"></i></div>
                        <h3 class="font-bold text-gray-800">ุญุฏุฏ ูุฑุญูุชู ุงูุฏุฑุงุณูุฉ</h3>
                        <p class="text-xs text-gray-400">ูุชู ุชุญุฏูุฏูุง ูุฑุฉ ูุงุญุฏุฉ ููุท</p>
                    </div>
                    <select id="grade-select" class="input-box mb-4 text-center">
                        <option value="">-- ุงุฎุชุฑ ุงููุฑุญูุฉ --</option>
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                        <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                        <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>
                    <button onclick="saveUserGrade()" class="btn-main py-3 text-sm">ุญูุธ ุงููุฑุญูุฉ</button>
                </div>

                <!-- Active Challenge Card -->
                <div id="challenge-active-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">ุจุฏุก ุชุญุฏู ุฌุฏูุฏ ๐ฅ</h3>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ุงููุงุฏุฉ</label>
                    <select id="challenge-subject" class="input-box mb-4 bg-gray-50"></select>

                    <label class="block text-sm font-bold text-gray-600 mb-2">ููุน ุงูุชุญุฏู</label>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setQType('mcq')" id="btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ุงุฎุชูุงุฑุงุช</button>
                        <button onclick="setQType('tf')" id="btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ุตุญ ูุฎุทุฃ</button>
                    </div>

                    <!-- PVP Button -->
                    <button onclick="startMatchmaking('online')" class="btn-main bg-gradient-to-r from-indigo-600 to-purple-600 mb-4">
                        <i class="fas fa-user-graduate ml-2"></i> ุงููุนุจ ุถุฏ ุทุงูุจ (ุญูููู)
                    </button>

                    <!-- AI Button Section -->
                    <div class="flex gap-2 items-center">
                        <button onclick="startMatchmaking('ai')" class="btn-main bg-gradient-to-r from-emerald-500 to-green-600 flex-1">
                            <i class="fas fa-robot ml-2"></i> ุถุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
                        </button>
                        <div class="w-1/3">
                            <select id="ai-difficulty" class="input-box text-xs font-bold text-center h-[52px] bg-green-50 border-green-200 text-green-800 focus:border-green-500">
                                <option value="easy">ุจุณูุท (25%)</option>
                                <option value="medium" selected>ูุชูุณุท (50%)</option>
                                <option value="hard">ุฐูู (70%)</option>
                            </select>
                        </div>
                    </div>

                </div>

                <!-- Searching UI -->
                <div id="searching-ui" class="hidden flex-col items-center justify-center py-10 min-h-[300px]">
                    <div class="w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center relative mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-indigo-500 opacity-20 animate-ping"></div>
                        <i class="fas fa-search text-3xl text-indigo-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="search-msg">ุฌุงุฑู ุงูุจุญุซ...</h3>
                    <button onclick="cancelSearch()" class="mt-8 text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full">ุฅูุบุงุก</button>
                </div>

                <!-- === ADMIN CONTROL PANEL (MOVED TO BOTTOM) === -->
                <div id="admin-challenge-controls" class="hidden mt-8 mb-6 bg-gray-900 rounded-2xl p-5 border-2 border-indigo-600 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-indigo-600 opacity-20 rounded-full -mr-10 -mt-10"></div>
                    
                    <div class="flex items-center justify-between mb-4 relative z-10">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-user-shield text-indigo-400 text-xl"></i>
                            <h3 class="font-bold text-white text-sm">ููุญุฉ ุงูุชุญูู ุจุงููุธุงู</h3>
                        </div>
                        
                        <!-- Toggle Switch -->
                        <label class="toggle-wrapper">
                            <input type="checkbox" id="system-toggle" class="toggle-checkbox" onchange="toggleSystemUI()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <p id="system-status-text" class="text-xs font-bold text-green-400 mb-2">ุงููุธุงู ูุนูู ุญุงููุงู โ</p>
                    
                    <!-- Always visible settings container -->
                    <div class="mt-4">
                        <label class="block text-xs font-bold text-gray-400 mb-2">ุฑุณุงูุฉ ุงูุชูุจูู ููุทูุงุจ (ุณุจุจ ุงูุฅููุงู):</label>
                        <textarea id="maintenance-msg-input" class="w-full bg-gray-800 border border-gray-600 text-white rounded-xl p-3 text-sm focus:border-indigo-500 outline-none h-20 mb-3" placeholder="ูุซูุงู: ุชููู ููุตูุงูุฉุ ูุนูุฏ ุจุนุฏ ุณุงุนุฉ..."></textarea>
                        
                        <button onclick="saveSystemSettings()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl text-sm transition shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> ุญูุธ ุงูุฅุนุฏุงุฏุงุช
                        </button>
                    </div>
                </div>
                <!-- ============================================== -->
            </div>
        </div>

        <!-- GAME OVERLAY -->
        <div id="game-overlay" class="fixed inset-0 bg-gray-50 z-[100] hidden flex-col">
            <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10">
                <div class="text-center w-1/3 overflow-hidden">
                    <p id="p1-name" class="text-xs text-gray-500 font-bold truncate">...</p>
                    <p id="game-my-score" class="text-2xl font-bold text-indigo-600">0</p>
                </div>
                <div class="w-1/3 flex justify-center">
                    <div id="game-timer" class="w-12 h-12 bg-gray-800 text-white rounded-full flex items-center justify-center font-bold text-lg">15</div>
                </div>
                <div class="text-center w-1/3 overflow-hidden">
                    <p id="p2-name" class="text-xs text-gray-500 font-bold truncate">...</p>
                    <p id="game-op-score" class="text-2xl font-bold text-red-500">0</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 text-center border-t-4 border-indigo-500 relative mt-4">
                    <span id="q-progress" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-3 py-1 rounded-full">1 / 10</span>
                    <p id="q-text" class="text-lg font-bold text-gray-800 leading-relaxed mt-2">...</p>
                </div>
                <div id="answers-container" class="space-y-3"></div>
                <p id="waiting-msg" class="text-center text-gray-400 text-sm hidden animate-pulse mt-4">ุจุงูุชุธุงุฑ ุฅุฌุงุจุฉ ุงูุฎุตู...</p>
                <p id="ai-thinking-msg" class="text-center text-green-600 text-sm hidden animate-pulse mt-4 font-bold">ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููุฑ...</p>
            </div>
        </div>

        <!-- POST MATCH RESULT SCREEN -->
        <div id="result-screen" class="fixed inset-0 bg-white z-[200] hidden flex-col items-center justify-center p-6 animate-[fadeIn_0.3s_ease-out]">
            <button onclick="closeResultScreen()" class="absolute top-6 right-6 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200">
                <i class="fas fa-times"></i>
            </button>

            <div id="result-icon-container" class="mb-6 text-6xl">๐</div>
            <h2 id="result-title" class="text-3xl font-extrabold text-gray-800 mb-2">ูุจุฑูู!</h2>
            <p id="result-msg" class="text-gray-500 mb-8 text-center">ููุฏ ููุช ุจุฃุฏุงุก ุฑุงุฆุน</p>
            
            <div class="flex items-center gap-8 mb-8 bg-gray-50 p-6 rounded-2xl w-full justify-center">
                <div class="text-center">
                    <p class="text-xs text-gray-400">ููุงุทู</p>
                    <p id="final-my-score" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="text-2xl text-gray-300">VS</div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ุงูุฎุตู</p>
                    <p id="final-op-score" class="text-3xl font-bold text-red-500">0</p>
                </div>
            </div>

            <div class="bg-yellow-50 px-6 py-3 rounded-full border border-yellow-200 mb-8 flex items-center gap-2">
                <span>ุญุตูุช ุนูู:</span>
                <span id="result-points-gained" class="font-bold text-yellow-700">+0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>

            <button onclick="closeResultScreen()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                <i class="fas fa-home"></i>
                <span>ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</span>
            </button>
        </div>

        <!-- TAB 2: LEADERBOARD -->
        <div id="tab-leaderboard" class="screen pt-20">
            <div class="scroll-container px-4">
                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-2xl mb-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm opacity-90">ุชุฑุชูุจู ุงูุญุงูู</p>
                        <h2 id="my-rank-text" class="text-2xl font-bold">#...</h2>
                    </div>
                    <i class="fas fa-trophy text-4xl opacity-50"></i>
                </div>
                <div id="leaderboard-list" class="space-y-2 pb-10 flex flex-col"></div>
            </div>
        </div>

        <!-- TAB 3: UPLOAD -->
        <div id="tab-upload" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- NOTES SECTION ADDED -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <h3 class="font-bold text-blue-800 text-sm mb-2"><i class="fas fa-info-circle ml-1"></i> ุชุนูููุงุช ุฑูุน ุงูุฃุณุฆูุฉ:</h3>
                    <ul class="text-xs text-blue-700 space-y-1 list-decimal list-inside font-medium">
                        <li>ูุฌุจ ุงู ุชููู ุงูุฃุณุฆูุฉ ุงููุถุงูุฉ ูู ุถูู ุงููููุฌ ููุชู ูุจูููุง.</li>
                        <li>ูุฌุจ ุงูุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุงูุฌูุงุจ ุงูุตุญูุญ ุจุฏูุฉ.</li>
                        <li>ูุฌุจ ุงูุชูุฑูู ุจูู ููุน ุงูุฃุณุฆูุฉ (ุงุฎุชูุงุฑุงุช) ู (ุตุญ ูุฎุทุฃ).</li>
                    </ul>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 flex-shrink-0">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-green-800">ุงุฑุจุญ 5 ููุงุท</p>
                        <p class="text-xs text-green-600">ุนู ูู ุณุคุงู ูุชู ูุจููู</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <!-- Step 1 -->
                    <div id="up-step-1">
                        <label class="block text-sm font-bold text-gray-500 mb-1">ุงููุงุฏุฉ</label>
                        <select id="up-subject" class="input-box mb-4 bg-gray-50"></select>
                        
                        <label class="block text-sm font-bold text-gray-500 mb-1">ุงูููุน</label>
                        <select id="up-type" class="input-box mb-6 bg-gray-50">
                            <option value="mcq">ุงุฎุชูุงุฑุงุช</option>
                            <option value="tf">ุตุญ ูุฎุทุฃ</option>
                        </select>
                        <button onclick="nextUploadStep()" class="btn-main">ุงูุชุงูู</button>
                    </div>

                    <!-- Step 2 -->
                    <div id="up-step-2" class="hidden">
                        <textarea id="up-q-text" class="input-box h-24 mb-4" placeholder="ุงูุชุจ ูุต ุงูุณุคุงู..."></textarea>
                        
                        <div id="up-mcq-container">
                            <p class="text-xs text-gray-400 mb-2">ุฃุฏุฎู ุงูุฎูุงุฑุงุช ูุญุฏุฏ ุงูุตุญูุญ</p>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="0" checked>
                                    <input type="text" id="ans-0" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุฃูู">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="1">
                                    <input type="text" id="ans-1" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูู">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="2">
                                    <input type="text" id="ans-2" class="input-box py-2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูุซ">
                                </div>
                            </div>
                        </div>

                        <div id="up-tf-container" class="hidden mb-4">
                            <label class="block text-xs text-gray-400 mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                            <select id="up-tf-val" class="input-box">
                                <option value="true">ุตุญ</option>
                                <option value="false">ุฎุทุฃ</option>
                            </select>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="document.getElementById('up-step-2').classList.add('hidden');document.getElementById('up-step-1').classList.remove('hidden')" class="bg-gray-100 text-gray-600 px-4 rounded-xl font-bold">ุฑุฌูุน</button>
                            <button onclick="submitUploadQuestion()" class="btn-main bg-green-600">ุฅุฑุณุงู</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: PROFILE -->
        <div id="tab-profile" class="screen pt-20">
            <div class="scroll-container px-5">
                <div class="bg-white p-6 rounded-3xl shadow-sm text-center mb-6 mt-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                    <div class="relative z-10">
                        <img id="profile-img" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-md mb-3 object-cover">
                        <h2 id="profile-name-text" class="text-xl font-bold text-gray-800">...</h2>
                        <p class="text-xs text-gray-400 mt-1" id="profile-id-text">ID: ...</p>
                        <button onclick="document.getElementById('edit-pic-input').click()" class="text-indigo-600 text-xs font-bold mt-2 hover:underline">ุชุบููุฑ ุงูุตูุฑุฉ</button>
                        <input type="file" id="edit-pic-input" hidden accept="image/*" onchange="updateProfilePic(this)">
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <button onclick="openPage('screen-stats')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-chart-pie"></i></div>
                            <span class="font-bold text-gray-700">ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-my-points')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i class="fas fa-star"></i></div>
                            <span class="font-bold text-gray-700">ููุงุทู ูุชุงุฑูุฎู</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-my-questions')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="fas fa-question"></i></div>
                            <span class="font-bold text-gray-700">ุฃุณุฆูุชู ุงููุฑููุนุฉ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>
                    
                    <div id="admin-buttons" class="hidden space-y-3 border-t pt-3 mt-3">
                        <p class="text-xs text-red-400 font-bold px-2">ููุญุฉ ุงูุชุญูู</p>
                        <button onclick="openPage('screen-admin-review')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600 relative">
                                    <i class="fas fa-gavel"></i>
                                    <div id="admin-btn-badge" class="btn-dot"></div>
                                </div>
                                <span class="font-bold text-red-700">ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ</span>
                            </div>
                        </button>
                        <button onclick="openPage('screen-admin-all')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-database"></i></div>
                                <span class="font-bold text-red-700">ูู ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</span>
                            </div>
                        </button>
                        <!-- NEW: Question Stats Button -->
                        <button onclick="openPage('screen-admin-counts')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-calculator"></i></div>
                                <span class="font-bold text-red-700">ุนุฏุฏ ุงูุฃุณุฆูุฉ ุงููุฑููุนุฉ</span>
                            </div>
                        </button>
                    </div>

                    <button onclick="logout()" class="stat-btn mt-6 border-red-100 text-red-500">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sign-out-alt px-3"></i>
                            <span class="font-bold">ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SUB SCREENS (FREE PAGES) === -->

        <!-- Screen: App Stats -->
        <div id="screen-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฅุญุตุงุฆูุงุช ุงูุชุทุจูู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="stats-content" class="space-y-4">
                    <p class="text-center text-gray-400">ุฌุงุฑู ุงูุชุญููู...</p>
                </div>
            </div>
        </div>

        <!-- Screen: My Points -->
        <div id="screen-my-points" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ููุงุทู ูุชุงุฑูุฎู</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="points-content" class="text-center">
                    <div class="bg-white p-8 rounded-3xl shadow-sm mb-6">
                        <i class="fas fa-gem text-5xl text-yellow-500 mb-4 animate-bounce"></i>
                        <h1 class="text-6xl font-black text-gray-800 mb-2" id="detail-points">0</h1>
                        <p class="text-gray-400">ูุฌููุน ุงูููุงุท</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm">
                            <p class="text-xs text-gray-400 mb-1">ุชุงุฑูุฎ ุงูุงูุถูุงู</p>
                            <p class="font-bold text-gray-700 text-sm" id="detail-join-date">...</p>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm">
                            <p class="text-xs text-gray-400 mb-1">ุนุฏุฏ ุงูุฃูุงู</p>
                            <p class="font-bold text-indigo-600 text-xl" id="detail-days">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: My Questions -->
        <div id="screen-my-questions" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุฃุณุฆูุชู ุงููุฑููุนุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="my-questions-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Screen: Admin Review -->
        <div id="screen-admin-review" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ูุฑุงุฌุนุฉ ุงูุฃุณุฆูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="admin-review-list" class="space-y-3"></div>
            </div>
        </div>

         <!-- Screen: Admin ALL Questions (IMPROVED) -->
         <div id="screen-admin-all" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ูู ุงูุฃุณุฆูุฉ (ุงููุญุฑุฑ ุงูุฐูู)</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- Filters -->
                <div class="flex gap-2 mb-4">
                    <select id="admin-filter-grade" class="input-box text-sm flex-1" onchange="filterAdminQuestions()">
                        <option value="">ูู ุงููุฑุงุญู</option>
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                        <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                        <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>
                    <input type="text" id="admin-search-all" onkeyup="filterAdminQuestions()" placeholder="ุจุญุซ..." class="input-box text-sm flex-[2]">
                </div>
                
                <div id="admin-all-list" class="space-y-3 pb-20"></div>
            </div>
        </div>
        
        <!-- Screen: Admin Question Counts (NEW) -->
        <div id="screen-admin-counts" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ุนุฏุงุฏ ุงูุฃุณุฆูุฉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                    <label class="block text-sm font-bold text-gray-500 mb-1">ุงูุตู</label>
                    <select id="count-grade-select" class="input-box mb-4">
                        <option value="6sci">ุงูุณุงุฏุณ ุงูุนููู</option>
                        <option value="6lit">ุงูุณุงุฏุณ ุงูุฃุฏุจู</option>
                        <option value="3med">ุงูุซุงูุซ ูุชูุณุท</option>
                    </select>
                    
                    <label class="block text-sm font-bold text-gray-500 mb-1">ููุน ุงูุณุคุงู</label>
                    <select id="count-type-select" class="input-box mb-4">
                        <option value="mcq">ุงุฎุชูุงุฑุงุช (MCQ)</option>
                        <option value="tf">ุตุญ ูุฎุทุฃ</option>
                    </select>
                    
                    <button onclick="calculateQuestionCounts()" class="btn-main">
                        <i class="fas fa-search"></i> ุจุญุซ
                    </button>
                </div>
                
                <div id="counts-result-container" class="space-y-3 pb-20">
                    <!-- Results go here -->
                </div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="switchTab('challenges')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-gamepad text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุชุญุฏูุงุช</span>
            </div>
            <div onclick="switchTab('leaderboard')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-trophy text-xl mb-1"></i><span class="text-[10px] font-bold">ุงูุชุตููู</span>
            </div>
            <div onclick="switchTab('upload')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg -mt-6 border-4 border-gray-50"><i class="fas fa-plus"></i></div>
                <span class="text-[10px] font-bold mt-1">ุฑูุน</span>
            </div>
            <div onclick="switchTab('profile')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">ุญุณุงุจู</span>
                <!-- Notification Badge -->
                <div id="profile-tab-badge" class="red-dot"></div>
            </div>
        </div>
        
        <!-- EDIT QUESTION MODAL (NEW) -->
        <div id="edit-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">ุชุนุฏูู ุงูุณุคุงู ุงูุดุงูู</h3>
                
                <input type="hidden" id="edit-q-id">
                
                <label class="block text-xs font-bold text-gray-500 mb-1">ูุต ุงูุณุคุงู</label>
                <textarea id="edit-q-text" class="input-box h-20 mb-3 text-sm"></textarea>
                
                <div class="flex gap-2 mb-3">
                     <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุตู</label>
                        <select id="edit-q-grade" class="input-box text-sm p-2">
                            <option value="6sci">6 ุนููู</option>
                            <option value="6lit">6 ุฃุฏุจู</option>
                            <option value="3med">3 ูุชูุณุท</option>
                        </select>
                     </div>
                     <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">ุงููุงุฏุฉ</label>
                        <select id="edit-q-subject" class="input-box text-sm p-2">
                             <!-- Populated by JS -->
                        </select>
                     </div>
                </div>

                <!-- MCQ Fields -->
                <div id="edit-mcq-fields" class="hidden">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 1</label>
                     <input type="text" id="edit-ans-0" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 2</label>
                     <input type="text" id="edit-ans-1" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ุงูุฎูุงุฑ 3</label>
                     <input type="text" id="edit-ans-2" class="input-box mb-3 p-2 text-sm">
                     
                     <label class="block text-xs font-bold text-green-600 mb-1">ุฑูู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (0, 1, 2)</label>
                     <select id="edit-correct-mcq" class="input-box p-2 text-sm">
                         <option value="0">ุงูุฎูุงุฑ 1</option>
                         <option value="1">ุงูุฎูุงุฑ 2</option>
                         <option value="2">ุงูุฎูุงุฑ 3</option>
                     </select>
                </div>

                <!-- TF Fields -->
                <div id="edit-tf-fields" class="hidden">
                    <label class="block text-xs font-bold text-green-600 mb-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
                    <select id="edit-correct-tf" class="input-box p-2 text-sm">
                        <option value="true">ุตุญ</option>
                        <option value="false">ุฎุทุฃ</option>
                    </select>
                </div>

                <button onclick="saveFullEditQ()" class="btn-main mt-6 bg-indigo-600 text-sm">ุญูุธ ุงูุชุนุฏููุงุช</button>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, increment, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfLOjiPiSQW9opdiIgQif3pAp8zsezy58",
            authDomain: "ministerial-hacker.firebaseapp.com",
            databaseURL: "https://ministerial-hacker-default-rtdb.firebaseio.com",
            projectId: "ministerial-hacker",
            storageBucket: "ministerial-hacker.firebasestorage.app",
            messagingSenderId: "557133038084",
            appId: "1:557133038084:web:c8cb7df6ef0abef2beab51",
            measurementId: "G-WYMSX2LRTW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // ******************************************************
        // โ๏ธโ๏ธโ๏ธ ุบูุฑ ูุฐุง ุงูุงูููู ุงูู ุงููููู ุงูุช (ุงูุงุฏูู) โ๏ธโ๏ธโ๏ธ
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";
        // ******************************************************

        setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence Error", e));

        let currentUser = null;
        let userData = null;
        let selectedQType = null;
        let currentMatchId = null;
        let gameTimer = null;
        let hasAnsweredCurrentQ = false;
        let allAdminQuestions = [];
        let adminListenerUnsubscribe = null;
        let matchListenerUnsubscribe = null; 
        
        // --- GAME LOGIC VARS ---
        let isExitingGame = false;
        let currentGameMode = 'online'; // 'online' or 'ai'
        let aiDifficulty = 'medium'; // easy, medium, hard
        let localMatchData = null; // For AI mode
        let aiTimeoutId = null; // To clear AI thinking

        // --- SYSTEM STATUS VARS (Global) ---
        let systemConfig = { enabled: true, msg: "ุงููุธุงู ูู ูุถุน ุงูุตูุงูุฉ ุญุงููุงู" };

        const subjects = {
            '6sci': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุงุญูุงุก', 'ุฑูุงุถูุงุช', 'ููููุงุก', 'ููุฒูุงุก'],
            '6lit': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุชุงุฑูุฎ', 'ุฑูุงุถูุงุช', 'ุฌุบุฑุงููุฉ', 'ุงูุชุตุงุฏ'],
            '3med': ['ุงุณูุงููุฉ', 'ุนุฑุจู', 'ุงููููุฒู', 'ุฑูุงุถูุงุช', 'ููููุงุก', 'ููุฒูุงุก', 'ุงุฌุชูุงุนูุงุช']
        };

        onAuthStateChanged(auth, async (user) => {
            const intro = document.getElementById('intro-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');

            if (user) {
                currentUser = user;
                // Start listening to system status immediately
                listenToSystemStatus();

                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        updateDoc(doc(db, "users", user.uid), { lastActive: serverTimestamp() });
                        
                        setupProfileUI();
                        setupHeaderUI();
                        setupAdminUI();
                        checkDailyReward(); 
                        if(userData.email === ADMIN_EMAIL) checkAdminNotifications(); 

                        if (userData.grade) {
                            document.getElementById('grade-selector-card').classList.add('hidden');
                            document.getElementById('challenge-active-card').classList.remove('hidden');
                            document.getElementById('header-grade-badge').innerText = getGradeName(userData.grade);
                            document.getElementById('header-grade-badge').classList.remove('hidden');
                            populateSubjects(userData.grade, 'challenge-subject');
                        } else {
                            document.getElementById('grade-selector-card').classList.remove('hidden');
                            document.getElementById('challenge-active-card').classList.add('hidden');
                            document.getElementById('header-grade-badge').classList.add('hidden');
                        }
                        
                        intro.classList.add('hidden');
                        authScreen.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        if(!document.querySelector('.screen.active')) switchTab('challenges');
                        
                    } else {
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) { console.error("Auth Data Error:", e); }
            } else {
                intro.classList.add('hidden');
                mainApp.classList.add('hidden');
                authScreen.classList.remove('hidden');
                window.switchAuthTab('login');
            }
        });

        // --- SYSTEM STATUS LISTENER ---
        function listenToSystemStatus() {
            onSnapshot(doc(db, "system_settings", "config"), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    systemConfig.enabled = data.challengesEnabled !== undefined ? data.challengesEnabled : true;
                    systemConfig.msg = data.maintenanceMessage || "ุงููุธุงู ูู ูุถุน ุงูุตูุงูุฉ ุญุงููุงูุ ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู.";
                    
                    const toggle = document.getElementById('system-toggle');
                    const statusText = document.getElementById('system-status-text');
                    const msgInput = document.getElementById('maintenance-msg-input');
                    
                    if (toggle) {
                        toggle.checked = systemConfig.enabled;
                        
                        if (!systemConfig.enabled) {
                            statusText.innerText = "ุงููุธุงู ูุชููู โ (ุงูุทูุงุจ ูุฑูู ุงูุฑุณุงูุฉ)";
                            statusText.className = "text-xs font-bold text-red-400 mb-2";
                        } else {
                            statusText.innerText = "ุงููุธุงู ูุนูู ุญุงููุงู โ";
                            statusText.className = "text-xs font-bold text-green-400 mb-2";
                        }
                        
                        // Don't overwrite if user is typing
                        if (msgInput && document.activeElement !== msgInput) {
                             msgInput.value = systemConfig.msg;
                        }
                    }
                }
            });
        }

        // Exposed Function for Toggle Switch Change (Visual Update Immediate)
        window.toggleSystemUI = () => {
             const toggle = document.getElementById('system-toggle');
             const statusText = document.getElementById('system-status-text');

             if (!toggle.checked) {
                 statusText.innerText = "ุงููุธุงู ูุชููู โ (ุณูุชู ุงูุญูุธ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ)";
                 statusText.className = "text-xs font-bold text-red-400 mb-2";
             } else {
                 statusText.innerText = "ุงููุธุงู ูุนูู ุญุงููุงู โ (ุณูุชู ุงูุญูุธ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ)";
                 statusText.className = "text-xs font-bold text-green-400 mb-2";
             }
        };

        window.saveSystemSettings = async () => {
            const isEnabled = document.getElementById('system-toggle').checked;
            const msg = document.getElementById('maintenance-msg-input').value;
            
            if (!isEnabled && !msg.trim()) return alert("ูุฑุฌู ูุชุงุจุฉ ุฑุณุงูุฉ ุชูุถูุญูุฉ ูููุณุชุฎุฏููู ุนูุฏ ุงูุฅููุงู.");

            try {
                await setDoc(doc(db, "system_settings", "config"), {
                    challengesEnabled: isEnabled,
                    maintenanceMessage: msg
                }, { merge: true });
                alert("โ ุชู ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ุจูุฌุงุญ!");
            } catch (e) {
                alert("ุฎุทุฃ ูู ุงูุญูุธ (ุชุฃูุฏ ูู ุงูููุงุนุฏ): " + e.message);
            }
        };

        window.switchAuthTab = (tab) => {
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('tab-login-btn').classList.add('active');
                document.getElementById('tab-signup-btn').classList.remove('active');
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
                document.getElementById('tab-login-btn').classList.remove('active');
                document.getElementById('tab-signup-btn').classList.add('active');
            }
        };

        window.handleLogin = async () => {
            try {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { alert("ุฎุทุฃ ูู ุงูุฏุฎูู: " + e.message); }
        };

        window.handleSignup = async () => {
            try {
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-pass').value;
                const imgFile = document.getElementById('signup-img').files[0];
                
                if(!name || !email || !pass) return alert("ูุฑุฌู ููุก ูุงูุฉ ุงูุญููู");
                if(!email.endsWith("@gmail.com")) return alert("ูุฌุจ ุงุณุชุฎุฏุงู ุงูููู Gmail");
                if(pass.length < 6) return alert("ูููุฉ ุงููุฑูุฑ ูุตูุฑุฉ ุฌุฏุงู");

                let photoURL = `https://ui-avatars.com/api/?name=${name}&background=random&size=128`;
                if(imgFile) photoURL = await compressImage(imgFile);

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                await setDoc(doc(db, "users", cred.user.uid), {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    photo: photoURL,
                    uniqueId: generateId(),
                    points: 0,
                    role: 'user',
                    createdAt: serverTimestamp(),
                    
                    // Daily Reward Fields
                    lastRewardDayKey: null, 
                    rewardMonthKey: null,   
                    daysClaimedInMonth: 0,  

                    hiddenFromLeaderboard: false 
                });
            } catch (e) { alert("ุฎุทุฃ: " + e.message); }
        };

        window.logout = () => {
            if(adminListenerUnsubscribe) adminListenerUnsubscribe(); 
            if(matchListenerUnsubscribe) matchListenerUnsubscribe();
            signOut(auth);
        };

        // --- DAILY REWARD LOGIC ---
        function getIraqDate() {
            const dateStr = new Date().toLocaleString("en-US", {timeZone: "Asia/Baghdad"});
            return new Date(dateStr);
        }

        window.checkDailyReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            if (userData.lastRewardDayKey === currentDayKey) return; 

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const nextDayToClaim = userDaysClaimed + 1;
            const grid = document.getElementById('reward-grid-container');
            grid.innerHTML = '';
            for(let i=1; i<=30; i++) {
                const pts = 10 + ((i - 1) * 5);
                let cls = "day-box";
                if (i < nextDayToClaim) cls += " claimed"; 
                else if (i === nextDayToClaim) cls += " active"; 
                else cls += " locked"; 
                grid.innerHTML += `<div class="${cls}"><p>ููู ${i}</p><span>${pts} ููุงุท</span></div>`;
            }
            document.getElementById('daily-reward-screen').classList.remove('hidden');
            document.getElementById('daily-reward-screen').style.display = 'flex';
        };

        window.claimReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const dayToClaim = userDaysClaimed + 1;
            const rewardAmount = 10 + ((dayToClaim - 1) * 5);

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(rewardAmount),
                lastRewardDayKey: currentDayKey,
                rewardMonthKey: currentMonthKey,
                daysClaimedInMonth: increment(1) 
            });
            userData.points += rewardAmount;
            userData.lastRewardDayKey = currentDayKey;
            userData.rewardMonthKey = currentMonthKey;
            userData.daysClaimedInMonth = dayToClaim;
            setupHeaderUI();
            document.getElementById('daily-reward-screen').classList.add('hidden');
            document.getElementById('daily-reward-screen').style.display = 'none';
        };

        // --- UI ---
        function setupProfileUI() {
            document.getElementById('profile-name-text').innerText = userData.name;
            document.getElementById('profile-id-text').innerText = "ID: " + userData.uniqueId;
            document.getElementById('profile-img').src = userData.photo;
        }
        function setupHeaderUI() { document.getElementById('header-points').innerText = userData.points; }
        function setupAdminUI() { 
            if (userData.email === ADMIN_EMAIL) {
                document.getElementById('admin-buttons').classList.remove('hidden'); 
                document.getElementById('admin-challenge-controls').classList.remove('hidden');
            }
        }

        window.saveUserGrade = async () => {
            const g = document.getElementById('grade-select').value;
            if (!g) return alert("ุงุฎุชุฑ ุงููุฑุญูุฉ");
            await updateDoc(doc(db, "users", currentUser.uid), { grade: g });
            userData.grade = g;
            document.getElementById('grade-selector-card').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            document.getElementById('header-grade-badge').innerText = getGradeName(g);
            document.getElementById('header-grade-badge').classList.remove('hidden');
            populateSubjects(g, 'challenge-subject');
        };

        function getGradeName(code) { return code==='6sci'?'ุงูุณุงุฏุณ ุงูุนููู':code==='6lit'?'ุงูุณุงุฏุณ ุงูุฃุฏุจู':'ุงูุซุงูุซ ูุชูุณุท'; }

        function populateSubjects(grade, elementId) {
            const sel = document.getElementById(elementId);
            sel.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุฏุฉ</option>';
            subjects[grade].forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        }

        // --- MATCHMAKING & GAME LOGIC ---
        window.setQType = (t) => {
            selectedQType = t;
            document.getElementById('btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
        };

        window.startMatchmaking = async (mode) => {
            if (!systemConfig.enabled) {
                alert("โ๏ธ ุชูุจูู ูู ุงูุฅุฏุงุฑุฉ:\n\n" + systemConfig.msg);
                return;
            }

            const sub = document.getElementById('challenge-subject').value;
            if(!sub || !selectedQType) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฏุฉ ูููุน ุงูุฃุณุฆูุฉ");

            currentGameMode = mode;
            if (mode === 'ai') aiDifficulty = document.getElementById('ai-difficulty').value;

            document.getElementById('challenge-active-card').classList.add('hidden');
            document.getElementById('searching-ui').classList.remove('hidden');
            document.getElementById('searching-ui').style.display = 'flex';
            document.getElementById('search-msg').innerText = mode === 'online' ? "ุฌุงุฑู ุงูุจุญุซ ุนู ุทุงูุจ..." : "ุฌุงุฑู ุชุญุถูุฑ ุงูุจูุช...";

            const grade = userData.grade;
            let group = `${grade}_${sub}`;
            if(['ุงุณูุงููุฉ','ุนุฑุจู','ุงููููุฒู'].includes(sub) && grade.startsWith('6')) group = `6shared_${sub}`;

            if (mode === 'online') {
                startOnlineMatch(group, sub);
            } else {
                startAIMatch(sub);
            }
        };

        // --- ONLINE LOGIC (FIXED: SELF-PLAY PREVENTION) ---
        async function startOnlineMatch(group, sub) {
            try {
                const qRef = collection(db, "match_queue");
                
                // 1. DELETE ANY OLD WAITING SESSIONS FOR THIS USER FIRST
                const oldSessionsQuery = query(qRef, where("player1.uid", "==", currentUser.uid), where("status", "==", "waiting"));
                const oldDocs = await getDocs(oldSessionsQuery);
                oldDocs.forEach(async (d) => { await deleteDoc(d.ref); });

                // 2. SEARCH FOR OPPONENT (NOT SELF)
                const qWait = query(qRef, where("group", "==", group), where("status", "==", "waiting"), limit(10));
                const snap = await getDocs(qWait);

                let foundMatchId = null;

                // Loop through waiting matches to find one that isn't me
                snap.forEach((doc) => {
                    const d = doc.data();
                    if (d.player1.uid !== currentUser.uid) {
                        foundMatchId = doc.id;
                    }
                });

                if(foundMatchId) {
                    // JOIN EXISTING MATCH
                    currentMatchId = foundMatchId;
                    await updateDoc(doc(db, "match_queue", foundMatchId), {
                        player2: { uid: currentUser.uid, name: userData.name, score: 0 },
                        status: 'active',
                        answersCount: 0 
                    });
                    listenToMatch(foundMatchId);
                } else {
                    // CREATE NEW MATCH
                    const qDocs = await getQuestions(sub, selectedQType);
                    if(qDocs.length === 0) { alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ ูู ูุฐุง ุงููุณู"); cancelSearch(); return; }
                    
                    const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
                    
                    const newMatch = await addDoc(qRef, {
                        group: group,
                        status: 'waiting',
                        player1: { uid: currentUser.uid, name: userData.name, score: 0 },
                        questions: shuffledQs,
                        currentIdx: 0,
                        answersCount: 0
                    });
                    currentMatchId = newMatch.id;
                    listenToMatch(newMatch.id);
                }
            } catch(e) { console.error(e); cancelSearch(); }
        }

        // --- AI LOGIC ---
        async function startAIMatch(sub) {
            const qDocs = await getQuestions(sub, selectedQType);
            if(qDocs.length === 0) { alert("ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุงููุฉ"); cancelSearch(); return; }
            const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);

            let botName = "ุงูุฐูุงุก ุงูุงุตุทูุงุนู ๐ค";
            localMatchData = {
                status: 'active',
                player1: { uid: currentUser.uid, name: userData.name, score: 0 },
                player2: { uid: 'AI_BOT', name: botName, score: 0 },
                questions: shuffledQs,
                currentIdx: 0,
                answersCount: 0
            };
            setTimeout(() => {
                document.getElementById('game-overlay').classList.remove('hidden');
                document.getElementById('game-overlay').style.display = 'flex';
                renderGame(localMatchData);
            }, 1000);
        }

        async function getQuestions(sub, type) {
            const q = query(collection(db, "questions"), where("subject", "==", sub), where("type", "==", type), limit(50));
            const snap = await getDocs(q);
            const list = [];
            snap.forEach(d => list.push(d.data()));
            return list;
        }

        window.cancelSearch = async () => {
            if(currentMatchId && currentGameMode === 'online') { try { await deleteDoc(doc(db, "match_queue", currentMatchId)); } catch(e){} }
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('searching-ui').style.removeProperty('display'); 
            document.getElementById('challenge-active-card').classList.remove('hidden');
        };

        function listenToMatch(id) {
            if(matchListenerUnsubscribe) matchListenerUnsubscribe(); 
            matchListenerUnsubscribe = onSnapshot(doc(db, "match_queue", id), (snap) => {
                if(isExitingGame) return;
                if(!snap.exists()) return;
                const d = snap.data();
                if(d.status === 'active') {
                    if(isExitingGame) return;
                    document.getElementById('game-overlay').classList.remove('hidden');
                    document.getElementById('game-overlay').style.display = 'flex';
                    renderGame(d);
                }
            });
        }

        function renderGame(data) {
            if (isExitingGame) return;
            if(!data.questions || data.currentIdx >= data.questions.length) { endGame(data); return; }

            if (currentGameMode === 'online' && data.answersCount >= 2) {
                 if(data.player1.uid === currentUser.uid) {
                       updateDoc(doc(db, "match_queue", currentMatchId), { currentIdx: increment(1), answersCount: 0 });
                 }
                 return;
            }

            const q = data.questions[data.currentIdx];
            if (!q) { endGame(data); return; }

            const qTextEl = document.getElementById('q-text');
            
            if(qTextEl.innerText !== q.question) {
                hasAnsweredCurrentQ = false;
                clearTimeout(aiTimeoutId); 
                document.getElementById('answers-container').classList.remove('pointer-events-none', 'opacity-50');
                document.getElementById('waiting-msg').classList.add('hidden');
                document.getElementById('ai-thinking-msg').classList.add('hidden');
                
                if (currentGameMode === 'online') {
                    const isP1 = data.player1.uid === currentUser.uid;
                    document.getElementById('p1-name').innerText = userData.name;
                    document.getElementById('p2-name').innerText = isP1 ? data.player2.name : data.player1.name;
                    document.getElementById('game-my-score').innerText = isP1 ? data.player1.score : data.player2.score;
                    document.getElementById('game-op-score').innerText = isP1 ? data.player2.score : data.player1.score;
                } else {
                    document.getElementById('p1-name').innerText = userData.name;
                    document.getElementById('p2-name').innerText = data.player2.name;
                    document.getElementById('game-my-score').innerText = data.player1.score;
                    document.getElementById('game-op-score').innerText = data.player2.score;
                }

                clearInterval(gameTimer);
                let t = 15;
                document.getElementById('game-timer').innerText = t;
                
                gameTimer = setInterval(() => {
                    if (isExitingGame) { clearInterval(gameTimer); return; }
                    t--;
                    document.getElementById('game-timer').innerText = t;
                    if(t <= 0) { 
                        clearInterval(gameTimer); 
                        if(!hasAnsweredCurrentQ) submitGameAnswer(null, q, data); 
                        else if (currentGameMode === 'ai') handleAINextTurn();
                    }
                }, 1000);
            }

            document.getElementById('q-progress').innerText = `${data.currentIdx + 1} / 10`;
            qTextEl.innerText = q.question;
            qTextEl.setAttribute('data-qid', q.question);

            const div = document.getElementById('answers-container');
            
            if(div.children.length === 0 || div.getAttribute('data-curr-q') !== q.question) {
                div.setAttribute('data-curr-q', q.question);
                div.innerHTML = '';
                
                let ansList = [];
                if(q.type === 'mcq') ansList = q.answers.map((txt, idx) => ({ txt, isCorrect: idx === q.correct }));
                else ansList = [{ txt: 'ุตุญ', isCorrect: q.correct === 'true' }, { txt: 'ุฎุทุฃ', isCorrect: q.correct === 'false' }];

                ansList.sort(() => 0.5 - Math.random());
                ansList.forEach(ansObj => {
                    const btn = document.createElement('button');
                    btn.className = "w-full py-4 bg-white border-2 border-gray-100 rounded-xl text-lg font-bold text-gray-700 shadow-sm active:scale-95 transition hover:border-indigo-300";
                    btn.innerText = ansObj.txt;
                    btn.onclick = () => { if(hasAnsweredCurrentQ) return; submitGameAnswer(ansObj, q, data); };
                    div.appendChild(btn);
                });
            }
        }

        async function submitGameAnswer(ansObj, q, matchData) {
            if(hasAnsweredCurrentQ || isExitingGame) return;
            hasAnsweredCurrentQ = true;
            document.getElementById('answers-container').classList.add('pointer-events-none', 'opacity-50');
            
            let correct = false;
            if(ansObj && ansObj.isCorrect) correct = true;

            if (currentGameMode === 'online') {
                document.getElementById('waiting-msg').classList.remove('hidden');
                const isP1 = matchData.player1.uid === currentUser.uid;
                if (!currentMatchId) return;
                const ref = doc(db, "match_queue", currentMatchId);
                const updates = { answersCount: increment(1) };
                if(correct) updates[isP1?'player1.score':'player2.score'] = increment(1);
                await updateDoc(ref, updates);
            } else {
                document.getElementById('waiting-msg').classList.remove('hidden'); 
                if(correct) {
                    localMatchData.player1.score += 1;
                    document.getElementById('game-my-score').innerText = localMatchData.player1.score;
                }
                triggerAIResponse();
            }
        }

        function triggerAIResponse() {
            document.getElementById('waiting-msg').classList.add('hidden');
            document.getElementById('ai-thinking-msg').classList.remove('hidden');
            let delay = 2000; let accuracy = 0.25;
            if (aiDifficulty === 'medium') { delay = 4000; accuracy = 0.5; }
            if (aiDifficulty === 'hard') { delay = 6000; accuracy = 0.7; }

            aiTimeoutId = setTimeout(() => {
                const isCorrect = Math.random() < accuracy;
                if(isCorrect) {
                    localMatchData.player2.score += 1;
                    document.getElementById('game-op-score').innerText = localMatchData.player2.score;
                }
                handleAINextTurn();
            }, delay);
        }

        function handleAINextTurn() {
            if(isExitingGame) return;
            localMatchData.currentIdx += 1;
            localMatchData.answersCount = 0;
            renderGame(localMatchData);
        }

        async function endGame(d) {
            clearInterval(gameTimer);
            document.getElementById('game-overlay').classList.add('hidden');
            if (isExitingGame) return;

            let myScore, opScore;
            if (currentGameMode === 'online') {
                const isP1 = d.player1.uid === currentUser.uid;
                myScore = isP1 ? d.player1.score : d.player2.score;
                opScore = isP1 ? d.player2.score : d.player1.score;
            } else {
                myScore = localMatchData.player1.score;
                opScore = localMatchData.player2.score;
            }
            
            let pts = 0; let msg = ""; let icon = "";
            if (myScore > opScore) { pts = myScore * 5; msg = "ููุฒ ุณุงุญู!"; icon = "๐"; } 
            else if (myScore < opScore) { pts = 0; msg = "ุญุธ ุฃููุฑ!"; icon = "๐ข"; } 
            else { pts = myScore > 0 ? myScore * 3 : 2; msg = "ุชุนุงุฏู!"; icon = "๐ค"; }

            if(pts > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { points: increment(pts) });
                userData.points += pts;
                setupHeaderUI();
            }
            document.getElementById('result-icon-container').innerText = icon;
            document.getElementById('result-title').innerText = msg;
            document.getElementById('final-my-score').innerText = myScore;
            document.getElementById('final-op-score').innerText = opScore;
            document.getElementById('result-points-gained').innerText = `+${pts}`;
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-screen').style.display = 'flex';
        }

        window.closeResultScreen = async () => {
             isExitingGame = true;
             if (matchListenerUnsubscribe) { matchListenerUnsubscribe(); matchListenerUnsubscribe = null; }
             clearInterval(gameTimer); clearTimeout(aiTimeoutId);
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('result-screen').style.display = 'none'; 
             document.getElementById('game-overlay').classList.add('hidden');
             document.getElementById('game-overlay').style.display = 'none';
             document.getElementById('searching-ui').classList.add('hidden');
             document.getElementById('searching-ui').style.removeProperty('display');

             currentMatchId = null; localMatchData = null; hasAnsweredCurrentQ = false;
             document.getElementById('challenge-active-card').classList.remove('hidden');
             if(currentUser) {
                 const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                 if(userDoc.exists()) { userData = userDoc.data(); setupHeaderUI(); setupProfileUI(); }
                 loadLeaderboard();
             }
             switchTab('challenges');
             setTimeout(() => { isExitingGame = false; document.getElementById('game-overlay').classList.add('hidden'); }, 500);
        };

        // --- UPLOAD ---
        window.nextUploadStep = () => {
            const sub = document.getElementById('up-subject').value;
            const type = document.getElementById('up-type').value;
            if (!sub) return alert("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฏุฉ");
            document.getElementById('up-step-1').classList.add('hidden');
            document.getElementById('up-step-2').classList.remove('hidden');
            if(type === 'mcq') {
                document.getElementById('up-mcq-container').classList.remove('hidden');
                document.getElementById('up-tf-container').classList.add('hidden');
            } else {
                document.getElementById('up-mcq-container').classList.add('hidden');
                document.getElementById('up-tf-container').classList.remove('hidden');
            }
        };

        window.submitUploadQuestion = async () => {
             const sub = document.getElementById('up-subject').value;
             const type = document.getElementById('up-type').value;
             const txt = document.getElementById('up-q-text').value;
             if(!txt) return alert("ูุฑุฌู ูุชุงุจุฉ ูุต ุงูุณุคุงู");
             
             let q = { grade: userData.grade, subject: sub, type, question: txt, authorId: currentUser.uid, authorName: userData.name, createdAt: serverTimestamp() };
             if(type==='mcq') {
                 const a0 = document.getElementById('ans-0').value;
                 const a1 = document.getElementById('ans-1').value;
                 const a2 = document.getElementById('ans-2').value;
                 if(!a0 || !a1 || !a2) return alert("ูุฑุฌู ููุก ุฌููุน ุงูุฎูุงุฑุงุช");
                 q.answers = [a0, a1, a2];
                 q.correct = parseInt(document.querySelector('input[name="correct"]:checked').value);
             } else { q.correct = document.getElementById('up-tf-val').value; }

             await addDoc(collection(db, "pending_questions"), q);
             alert("ุชู ุงุฑุณุงู ุงูุณุคุงู ูููุฑุงุฌุนุฉ ุจูุฌุงุญ!");
             document.getElementById('up-q-text').value = ""; document.getElementById('ans-0').value = ""; document.getElementById('ans-1').value = ""; document.getElementById('ans-2').value = "";
             document.getElementById('up-step-2').classList.add('hidden'); document.getElementById('up-step-1').classList.remove('hidden');
        };

        // --- FREE PAGES LOGIC ---
        window.openPage = async (screenId) => {
            document.querySelectorAll('.screen').forEach(s => { if(s.id.startsWith('screen-')) s.classList.remove('active'); });
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'screen-stats') loadStatsContent();
            else if (screenId === 'screen-my-points') loadMyPointsContent();
            else if (screenId === 'screen-my-questions') loadMyQuestionsContent();
            else if (screenId === 'screen-admin-review') loadAdminReviewContent();
            else if (screenId === 'screen-admin-all') loadAdminAllContent();
        };

        window.backToProfile = () => { document.querySelectorAll('.screen').forEach(s => { if(s.id.startsWith('screen-')) s.classList.remove('active'); }); };

        async function loadStatsContent() {
             const div = document.getElementById('stats-content');
             const usersSnap = await getDocs(collection(db, "users"));
             const total = usersSnap.size;
             const today = new Date(); today.setHours(0,0,0,0);
             let newUsers = 0; let activeNow = 0; const now = new Date();
             usersSnap.forEach(d => {
                 const u = d.data();
                 if(!u) return;
                 if(u.createdAt && u.createdAt.toDate && u.createdAt.toDate() >= today) newUsers++;
                 if (u.lastActive && u.lastActive.toDate && (now - u.lastActive.toDate()) < 15 * 60 * 1000) activeNow++;
             });
             if(activeNow === 0) activeNow = 1; 
             div.innerHTML = `
                <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ุงููุณุชุฎุฏููู ุงูููู</p><p class="text-2xl font-bold text-gray-800">${total}</p></div><div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users"></i></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ูุดุทูู ุงูุขู</p><p class="text-2xl font-bold text-green-500">${activeNow}</p></div><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-wifi"></i></div></div>
                <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ุณุฌููุง ุงูููู</p><p class="text-2xl font-bold text-purple-500">${newUsers}</p></div><div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-user-plus"></i></div></div>`;
        }
        async function loadMyPointsContent() {
             document.getElementById('detail-points').innerText = userData.points;
             const joinDate = userData.createdAt ? userData.createdAt.toDate() : new Date();
             document.getElementById('detail-join-date').innerText = joinDate.toLocaleDateString('ar-EG');
             const diffTime = Math.abs(new Date() - joinDate);
             const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
             document.getElementById('detail-days').innerText = diffDays + " ููู";
        }
        async function loadMyQuestionsContent() {
            const div = document.getElementById('my-questions-list');
            div.innerHTML = '<p class="text-center text-gray-400">ุชุญููู...</p>';
            const q1 = query(collection(db, "pending_questions"), where("authorId", "==", currentUser.uid));
            try {
                const s1 = await getDocs(q1);
                let html = "";
                s1.forEach(d => { const q = d.data(); html += `<div class="bg-white p-4 rounded-xl border border-yellow-100 mb-2"><div class="flex justify-between mb-1"><span class="text-xs text-gray-400">${q.subject}</span><span class="text-xs bg-yellow-100 text-yellow-600 px-2 rounded">ููุฏ ุงููุฑุงุฌุนุฉ</span></div><p class="font-bold text-gray-800 text-sm">${q.question}</p></div>`; });
                if(html === "") html = "<p class='text-center text-gray-400 mt-10'>ูู ุชูู ุจุฑูุน ุฃุณุฆูุฉ (ููุฏ ุงููุฑุงุฌุนุฉ) ุญุงููุงู.</p>";
                div.innerHTML = html;
            } catch(e) { div.innerHTML = "<p class='text-red-500'>ุญุฏุซ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช.</p>"; }
        }

        // --- NEW ADMIN FEATURES ---

        // 1. ADVANCED EDITOR (ALL QUESTIONS)
        async function loadAdminAllContent() {
             const div = document.getElementById('admin-all-list');
             div.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุฌูุจ ูู ุงูุฃุณุฆูุฉ...</p>';
             const q = await getDocs(collection(db, "questions"));
             allAdminQuestions = [];
             q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
             renderAdminAllList(allAdminQuestions);
        }

        window.renderAdminAllList = (list) => {
            const div = document.getElementById('admin-all-list');
            if(list.length === 0) { div.innerHTML = "<p>ูุง ุชูุฌุฏ ูุชุงุฆุฌ</p>"; return; }
            let html = "";
            list.slice(0, 50).forEach(q => { 
                html += `
                <div class="bg-white rounded-xl p-3 mb-2 border border-gray-100 shadow-sm flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">${q.grade || 'ุบูุฑ ูุญุฏุฏ'} | ${q.subject}</span>
                            <span class="text-xs text-gray-400 ml-2">${q.type==='mcq'?'ุงุฎุชูุงุฑุงุช':'ุตุญ/ุฎุทุฃ'}</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="openEditModal('${q.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200 transition"><i class="fas fa-edit ml-1"></i>ุชุนุฏูู</button>
                            <button onclick="deleteApprovedQ('${q.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p class="font-bold text-gray-700 text-sm leading-6 border-r-2 border-indigo-200 pr-2">${q.question}</p>
                </div>`;
            });
            div.innerHTML = html;
        };

        window.filterAdminQuestions = () => {
            const txt = document.getElementById('admin-search-all').value.toLowerCase();
            const gr = document.getElementById('admin-filter-grade').value;
            
            const filtered = allAdminQuestions.filter(q => {
                const matchesText = q.question.toLowerCase().includes(txt) || q.subject.includes(txt);
                const matchesGrade = gr ? (q.grade === gr) : true;
                return matchesText && matchesGrade;
            });
            renderAdminAllList(filtered);
        };

        window.openEditModal = (id) => {
            const q = allAdminQuestions.find(i => i.id === id);
            if(!q) return;

            document.getElementById('edit-q-id').value = id;
            document.getElementById('edit-q-text').value = q.question;
            document.getElementById('edit-q-grade').value = q.grade || '6sci';
            
            // Populate Subjects based on grade
            const subSel = document.getElementById('edit-q-subject');
            subSel.innerHTML = "";
            subjects[q.grade || '6sci'].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            subSel.value = q.subject;

            document.getElementById('edit-q-grade').onchange = () => {
                const g = document.getElementById('edit-q-grade').value;
                subSel.innerHTML = "";
                subjects[g].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            };

            if(q.type === 'mcq') {
                document.getElementById('edit-mcq-fields').classList.remove('hidden');
                document.getElementById('edit-tf-fields').classList.add('hidden');
                
                document.getElementById('edit-ans-0').value = q.answers[0];
                document.getElementById('edit-ans-1').value = q.answers[1];
                document.getElementById('edit-ans-2').value = q.answers[2];
                document.getElementById('edit-correct-mcq').value = q.correct;
            } else {
                document.getElementById('edit-mcq-fields').classList.add('hidden');
                document.getElementById('edit-tf-fields').classList.remove('hidden');
                document.getElementById('edit-correct-tf').value = q.correct;
            }

            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveFullEditQ = async () => {
            const id = document.getElementById('edit-q-id').value;
            const originalQ = allAdminQuestions.find(i => i.id === id);
            const type = originalQ.type;

            const updates = {
                question: document.getElementById('edit-q-text').value,
                grade: document.getElementById('edit-q-grade').value,
                subject: document.getElementById('edit-q-subject').value,
            };

            if(type === 'mcq') {
                updates.answers = [
                    document.getElementById('edit-ans-0').value,
                    document.getElementById('edit-ans-1').value,
                    document.getElementById('edit-ans-2').value
                ];
                updates.correct = parseInt(document.getElementById('edit-correct-mcq').value);
            } else {
                updates.correct = document.getElementById('edit-correct-tf').value;
            }

            await updateDoc(doc(db, "questions", id), updates);
            
            // Update local list
            const idx = allAdminQuestions.findIndex(i => i.id === id);
            if(idx !== -1) {
                allAdminQuestions[idx] = { ...allAdminQuestions[idx], ...updates };
            }
            
            filterAdminQuestions(); // Re-render
            document.getElementById('edit-modal').classList.add('hidden');
            alert("ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ!");
        };

        window.deleteApprovedQ = async (id) => {
            if(confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงู ููุงุฆูุงูุ")) {
                await deleteDoc(doc(db, "questions", id));
                allAdminQuestions = allAdminQuestions.filter(q => q.id !== id);
                filterAdminQuestions();
            }
        };

        // 2. QUESTION COUNTS (STATS) - FIXED LOGIC
        window.calculateQuestionCounts = async () => {
             const container = document.getElementById('counts-result-container');
             container.innerHTML = '<p class="text-center text-gray-400">ุฌุงุฑู ุงูุญุณุงุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...</p>';
             
             const grade = document.getElementById('count-grade-select').value;
             const type = document.getElementById('count-type-select').value;
             const allSubjs = subjects[grade];

             // Fetch REAL approved questions from DB
             const q = query(collection(db, "questions"), where("grade", "==", grade), where("type", "==", type));
             const snap = await getDocs(q);
             
             // Count logic (Dynamic)
             let counts = {};
             let totalCount = 0;

             // Initialize expected subjects with 0
             allSubjs.forEach(s => counts[s] = 0);
             
             snap.forEach(d => {
                 const data = d.data();
                 // Count accurately even if subject is new/different
                 counts[data.subject] = (counts[data.subject] || 0) + 1;
                 totalCount++;
             });

             let html = `<div class="bg-indigo-50 border-2 border-indigo-200 p-4 rounded-xl mb-4 text-center">
                <p class="text-sm font-bold text-gray-600">ุงููุฌููุน ุงูููู ููุฃุณุฆูุฉ ุงููุนุชูุฏุฉ</p>
                <p class="text-3xl font-black text-indigo-700">${totalCount}</p>
             </div>`;

             // Render Subjects List
             // Use Set to ensure we cover both expected subjects AND any extra found in DB
             const allFoundSubjects = new Set([...allSubjs, ...Object.keys(counts)]);

             allFoundSubjects.forEach(s => {
                 const c = counts[s] || 0;
                 html += `
                 <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-r-4 border-indigo-500 mb-2">
                      <span class="font-bold text-gray-700">${s}</span>
                      <span class="bg-indigo-100 text-indigo-700 font-black px-3 py-1 rounded-full text-sm">${c} ุณุคุงู</span>
                 </div>`;
             });
             
             container.innerHTML = html;
        };

        // ------------------------------------

        async function loadAdminReviewContent() {
            const div = document.getElementById('admin-review-list');
            div.innerHTML = '<p class="text-center text-gray-400">ุชุญููู...</p>';
            const q = await getDocs(query(collection(db, "pending_questions")));
            if(q.empty) { div.innerHTML = "<p class='text-center py-10 text-gray-400'>ูุง ููุฌุฏ ุดูุก ูููุฑุงุฌุนุฉ</p>"; return; }
            let html = "";
            q.forEach(d => {
               const val = d.data(); const author = val.authorName || 'ูุฌููู';
               html += `<div class="bg-white rounded-xl p-4 mb-3 shadow-sm border border-gray-100" id="review-card-${d.id}"><div class="flex justify-between items-start mb-2"><span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg font-bold">${val.grade} | ${val.subject}</span><span class="text-xs text-gray-400">ุจูุงุณุทุฉ: ${author}</span></div><p class="font-bold mb-3 text-gray-800 text-sm leading-6">${val.question}</p><div class="bg-gray-50 p-3 rounded-lg mb-3 text-xs space-y-1 border border-gray-100"><p class="font-bold text-gray-500">ุงูุฎูุงุฑุงุช:</p>${val.type==='mcq' ? `<ul class="list-disc list-inside text-gray-600"><li>${val.answers[0]}</li><li>${val.answers[1]}</li><li>${val.answers[2]}</li></ul>` : `<p>ุตุญ / ุฎุทุฃ</p>`}<p class="mt-2 text-green-600 font-bold">ุงูุฌูุงุจ ุงูุตุญูุญ: ${val.type==='mcq' ? val.answers[val.correct] : (val.correct==='true'?'ุตุญ':'ุฎุทุฃ')}</p></div><div class="flex gap-2"><button onclick="approveQ('${d.id}')" class="flex-1 bg-green-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-green-600 transition">ูุจูู (+5)</button><button onclick="rejectQ('${d.id}')" class="flex-1 bg-red-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-red-600 transition">ุฑูุถ</button></div></div>`; 
            });
            div.innerHTML = html;
        }

        window.checkAdminNotifications = () => {
            const q = query(collection(db, "pending_questions"));
            adminListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                const badgeTab = document.getElementById('profile-tab-badge');
                const badgeBtn = document.getElementById('admin-btn-badge');
                if (count > 0) { badgeTab.classList.add('visible'); badgeBtn.classList.add('visible'); } 
                else { badgeTab.classList.remove('visible'); badgeBtn.classList.remove('visible'); }
            });
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); n.classList.remove('text-indigo-600'); n.classList.add('text-gray-400'); });
            const navs = document.querySelectorAll('.nav-item');
            if(tab==='challenges') navs[0].classList.add('active', 'text-indigo-600');
            if(tab==='leaderboard') { navs[1].classList.add('active', 'text-indigo-600'); loadLeaderboard(); }
            if(tab==='upload') { navs[2].classList.add('active', 'text-indigo-600'); updateUploadUI(); }
            if(tab==='profile') navs[3].classList.add('active', 'text-indigo-600');
        };
        window.updateUploadUI = () => { if(userData.grade) populateSubjects(userData.grade, 'up-subject'); };
        
        async function loadLeaderboard() {
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '<p class="text-center text-gray-400 mt-10">ุชุญููู...</p>';
            const q = query(collection(db, "users"), limit(100));
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(d => { const u = d.data(); if (u.hiddenFromLeaderboard !== true) users.push(u); });
            users.sort((a, b) => {
                const pointsA = parseInt(a.points || 0); const pointsB = parseInt(b.points || 0);
                if (pointsB !== pointsA) return pointsB - pointsA;
                return (a.name || "").localeCompare((b.name || ""), 'ar');
            });

            const myIndex = users.findIndex(u => u.uid === currentUser.uid);
            if(myIndex !== -1) document.getElementById('my-rank-text').innerText = "#" + (myIndex + 1);
            else document.getElementById('my-rank-text').innerText = "ุบูุฑ ูุตูู";

            div.innerHTML = ''; let i = 1;
            users.forEach(u => {
                let medal = ""; 
                if(i===1) medal = "๐ฅ"; if(i===2) medal = "๐ฅ"; if(i===3) medal = "๐ฅ"; if(i>=4 && i<=10) medal = "๐๏ธ";
                let resetBtn = "";
                if (currentUser.email === ADMIN_EMAIL) resetBtn = `<button onclick="resetUserPoints('${u.uid}', '${u.name}')" class="w-6 h-6 rounded bg-red-100 text-red-500 flex items-center justify-center mr-2"><i class="fas fa-trash-alt text-xs"></i></button>`;
                div.innerHTML += `<div class="rank-item flex items-center justify-between bg-white p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden"><div class="flex items-center gap-4 z-10"><span class="rank-num font-black text-gray-300 w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 text-sm border">${i}</span><img src="${u.photo}" class="w-12 h-12 rounded-full border-2 border-white shadow-sm object-cover"><div><p class="font-bold text-gray-800 text-sm flex items-center">${u.name} ${medal}</p><p class="text-[10px] text-gray-400">ID: ${u.uniqueId}</p></div></div><div class="flex items-center z-10">${resetBtn}<span class="font-black text-indigo-600 text-lg">${u.points} ๐</span></div></div>`;
                i++;
            });
        }

        window.resetUserPoints = async (uid, name) => {
            if(confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ููุงุท ุงูุทุงูุจ: ${name}ุ\n(ุงูููุงุท ุณุชุนูุฏ ููุตูุฑ ููุท)`)) {
                await updateDoc(doc(db, "users", uid), { points: 0 });
                alert("ุชู ุชุตููุฑ ุงูููุงุท ุจูุฌุงุญ!");
                loadLeaderboard(); 
            }
        };

        window.handleImagePreview = (input) => {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById('preview-img').src = e.target.result;
                r.readAsDataURL(input.files[0]);
            }
        };
        function generateId() { return Math.random().toString(36).substr(2, 6).toUpperCase(); }
        function compressImage(file) {
            return new Promise((resolve) => {
                const r = new FileReader();
                r.readAsDataURL(file);
                r.onload = (e) => {
                    const i = new Image();
                    i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas');
                        c.width=200; c.height=200;
                        const ctx = c.getContext('2d');
                        ctx.drawImage(i,0,0,200,200);
                        resolve(c.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        }

        window.approveQ = async (id) => {
            const card = document.getElementById(`review-card-${id}`);
            if(card) card.remove();
            const ref = doc(db, "pending_questions", id);
            const d = (await getDoc(ref)).data();
            await addDoc(collection(db, "questions"), {...d, status:'approved'});
            await updateDoc(doc(db, "users", d.authorId), { points: increment(5) });
            await deleteDoc(ref);
        };

        window.rejectQ = async (id) => {
            const card = document.getElementById(`review-card-${id}`);
            if(card) card.remove();
            await deleteDoc(doc(db, "pending_questions", id));
        };

        window.updateProfilePic = async (input) => {
            if(input.files[0]) {
                const p = await compressImage(input.files[0]);
                await updateDoc(doc(db, "users", currentUser.uid), { photo: p });
                document.getElementById('profile-img').src = p;
            }
        };
    </script>
</body>
</html>
