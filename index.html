<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Reset & Variables --- */
        :root {
            --primary: #4F46E5;
            --secondary: #10B981;
            --bg-app: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-app);
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0; padding: 0;
        }

        /* --- Custom Scroll --- */
        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px; /* Space for bottom nav */
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Animations --- */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* --- Components --- */
        .screen {
            display: none; height: 100vh; width: 100vw;
            position: absolute; top: 0; left: 0; background: var(--bg-app); z-index: 10;
        }
        .screen.active { display: block; z-index: 20; }

        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .input-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 14px; width: 100%; outline: none; font-size: 1rem; transition: border-color 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn-main {
            background: var(--primary); color: white; padding: 14px;
            border-radius: 12px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); transition: transform 0.1s;
            text-align: center; border: none; cursor: pointer;
        }
        .btn-main:active { transform: scale(0.98); }

        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item { position: relative; } 
        
        .stat-btn {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative;
        }
        .stat-btn:active { transform: scale(0.98); background-color: #f9fafb; }

        /* Notification Dot */
        .red-dot {
            position: absolute;
            top: -2px;
            right: 20%;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            display: none; 
            z-index: 50;
        }
        .red-dot.visible { display: block; }
        
        /* Button inner dot */
        .btn-dot {
            width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 10px; display: none;
        }
        .btn-dot.visible { display: inline-block; }

        /* Hacker Animation */
        .hacker-text {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: slideUp 1s ease-out;
        }

        /* Auth Tabs Styles */
        .auth-tabs {
            display: flex;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 14px;
            margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: #64748b;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        .auth-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Leaderboard Top 5 Styles - FIXED: REMOVED 'order' PROPERTY */
        .rank-item:nth-child(1) { border: 2px solid #FFD700; background: linear-gradient(to right, #fff, #fffde7); }
        .rank-item:nth-child(1) .rank-num { background: #FFD700; color: white; }
        
        .rank-item:nth-child(2) { border: 2px solid #C0C0C0; }
        .rank-item:nth-child(2) .rank-num { background: #C0C0C0; color: white; }
        
        .rank-item:nth-child(3) { border: 2px solid #CD7F32; }
        .rank-item:nth-child(3) .rank-num { background: #CD7F32; color: white; }

        .rank-item:nth-child(4) { border: 2px solid #60A5FA; }
        .rank-item:nth-child(5) { border: 2px solid #A78BFA; }

        /* Daily Reward Popup */
        .reward-overlay {
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        }
        .reward-card {
            background: radial-gradient(circle at center, #ffffff, #f3f4f6);
        }
    </style>
</head>
<body>

    <!-- 1. LOADING SCREEN -->
    <div id="intro-screen" class="auth-overlay flex-col" style="z-index: 10000;">
        <h1 class="hacker-text mb-4">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 font-medium animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- 2. DAILY REWARD POPUP -->
    <div id="daily-reward-screen" class="fixed inset-0 reward-overlay z-[9000] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center reward-card shadow-2xl relative overflow-hidden animate-[slideUp_0.5s_ease-out]">
            <div class="absolute inset-0 bg-yellow-400 opacity-10 animate-pulse"></div>
            <h2 class="text-3xl font-extrabold text-yellow-500 mb-2 relative z-10">Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ©! ğŸ‰</h2>
            <p class="text-gray-500 mb-6 relative z-10">Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</p>
            
            <div class="w-24 h-24 mx-auto bg-yellow-100 rounded-full flex items-center justify-center mb-4 relative z-10 shadow-lg border-4 border-white">
                <i class="fas fa-gift text-5xl text-yellow-600 animate-[pulse-soft_2s_infinite]"></i>
            </div>
            
            <p class="text-4xl font-black text-gray-800 mb-2 relative z-10" id="reward-amount">+10</p>
            <p class="text-sm text-gray-400 mb-8 relative z-10">Ù†Ù‚Ø·Ø© ØªØ¶Ø§Ù Ù„Ø±ØµÙŠØ¯Ùƒ</p>
            
            <button onclick="claimReward()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-4 rounded-xl font-bold shadow-xl relative z-10 active:scale-95 transition">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</button>
        </div>
    </div>

    <!-- 3. AUTH SCREEN (NEW DESIGN) -->
    <div id="auth-screen" class="auth-overlay hidden">
        <div class="w-full max-w-md p-8 h-full overflow-y-auto flex flex-col justify-center">
            
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-indigo-600 mb-2">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
                <p class="text-gray-500 text-sm">Ø¨ÙˆØ§Ø¨ØªÙƒ Ù„Ù„ØªÙÙˆÙ‚ ÙÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ²Ø§Ø±ÙŠØ©</p>
            </div>

            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <div id="tab-login-btn" onclick="switchAuthTab('login')" class="auth-tab active">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
                <div id="tab-signup-btn" onclick="switchAuthTab('signup')" class="auth-tab">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
            </div>

            <!-- Login Form (Added onsubmit false to prevent reload) -->
            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="login-email" placeholder="example@gmail.com" class="input-box" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-8">Ø¯Ø®ÙˆÙ„</button>
            </form>

            <!-- Signup Form (Added onsubmit false to prevent reload) -->
            <form id="signup-form" class="hidden" onsubmit="event.preventDefault(); handleSignup();">
                <div class="flex justify-center mb-6">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('signup-img').click()">
                        <img id="preview-img" src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100 shadow-md transition group-hover:border-indigo-200">
                        <div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm">
                            <i class="fas fa-camera text-xs"></i>
                        </div>
                    </div>
                    <input type="file" id="signup-img" hidden accept="image/*" onchange="handleImagePreview(this)">
                </div>
                <div class="space-y-3">
                    <div>
                        <input type="text" id="signup-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± ÙÙŠ Ø§Ù„ØªØµÙ†ÙŠÙ" class="input-box" required>
                    </div>
                    <div>
                        <input type="email" id="signup-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (@gmail.com)" class="input-box" required>
                    </div>
                    <div>
                        <input type="password" id="signup-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹ Ø§Ù„Ø£Ù‚Ù„)" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-6 bg-indigo-600">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
                <p class="text-xs text-center text-gray-400 mt-4">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©</p>
            </form>

        </div>
    </div>

    <!-- 4. MAIN APP CONTAINER -->
    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- HEADER (FIXED) -->
        <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center justify-between px-5 pt-2">
            <div>
                <h1 class="font-bold text-lg text-gray-800">Ù‡ÙƒØ± Ø§Ù„ÙˆØ²Ø§Ø±ÙŠ</h1>
                <p id="header-grade-badge" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full hidden">...</p>
            </div>
            <div class="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2">
                <span id="header-points" class="font-bold text-yellow-700">0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>
        </div>

        <!-- === TABS === -->

        <!-- TAB 1: CHALLENGES -->
        <div id="tab-challenges" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- Select Grade First Time -->
                <div id="grade-selector-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-school text-xl"></i></div>
                        <h3 class="font-bold text-gray-800">Ø­Ø¯Ø¯ Ù…Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
                        <p class="text-xs text-gray-400">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·</p>
                    </div>
                    <select id="grade-select" class="input-box mb-4 text-center">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
                        <option value="6sci">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ</option>
                        <option value="6lit">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø£Ø¯Ø¨ÙŠ</option>
                        <option value="3med">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
                    </select>
                    <button onclick="saveUserGrade()" class="btn-main py-3 text-sm">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
                </div>

                <!-- Active Challenge Card -->
                <div id="challenge-active-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯ ğŸ”¥</h3>
                    <label class="block text-sm font-bold text-gray-600 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                    <select id="challenge-subject" class="input-box mb-4 bg-gray-50"></select>

                    <label class="block text-sm font-bold text-gray-600 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØªØ­Ø¯ÙŠ</label>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setQType('mcq')" id="btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
                        <button onclick="setQType('tf')" id="btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ØµØ­ ÙˆØ®Ø·Ø£</button>
                    </div>

                    <button onclick="startMatchmaking()" class="btn-main bg-gradient-to-r from-indigo-600 to-purple-600">
                        <i class="fas fa-bolt ml-2 animate-pulse"></i> Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø§ÙØ³
                    </button>
                </div>

                <!-- Searching UI -->
                <div id="searching-ui" class="hidden flex-col items-center justify-center py-10 min-h-[300px]">
                    <div class="w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center relative mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-indigo-500 opacity-20 animate-ping"></div>
                        <i class="fas fa-search text-3xl text-indigo-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</h3>
                    <button onclick="cancelSearch()" class="mt-8 text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>

        <!-- GAME OVERLAY -->
        <div id="game-overlay" class="fixed inset-0 bg-gray-50 z-[100] hidden flex-col">
            <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10">
                <div class="text-center w-1/3">
                    <p class="text-xs text-gray-500">Ø£Ù†Øª</p>
                    <p id="game-my-score" class="text-2xl font-bold text-indigo-600">0</p>
                </div>
                <div class="w-1/3 flex justify-center">
                    <div id="game-timer" class="w-12 h-12 bg-gray-800 text-white rounded-full flex items-center justify-center font-bold text-lg">15</div>
                </div>
                <div class="text-center w-1/3">
                    <p class="text-xs text-gray-500">Ø§Ù„Ø®ØµÙ…</p>
                    <p id="game-op-score" class="text-2xl font-bold text-red-500">0</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 text-center border-t-4 border-indigo-500 relative mt-4">
                    <span id="q-progress" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-3 py-1 rounded-full">1 / 10</span>
                    <p id="q-text" class="text-lg font-bold text-gray-800 leading-relaxed mt-2">...</p>
                </div>
                <div id="answers-container" class="space-y-3"></div>
                <p id="waiting-msg" class="text-center text-gray-400 text-sm hidden animate-pulse mt-4">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø®ØµÙ…...</p>
            </div>
        </div>

        <!-- POST MATCH RESULT SCREEN -->
        <div id="result-screen" class="fixed inset-0 bg-white z-[200] hidden flex-col items-center justify-center p-6 animate-[fadeIn_0.3s_ease-out]">
            <div id="result-icon-container" class="mb-6 text-6xl">ğŸ†</div>
            <h2 id="result-title" class="text-3xl font-extrabold text-gray-800 mb-2">Ù…Ø¨Ø±ÙˆÙƒ!</h2>
            <p id="result-msg" class="text-gray-500 mb-8 text-center">Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹</p>
            
            <div class="flex items-center gap-8 mb-8 bg-gray-50 p-6 rounded-2xl w-full justify-center">
                <div class="text-center">
                    <p class="text-xs text-gray-400">Ù†Ù‚Ø§Ø·Ùƒ</p>
                    <p id="final-my-score" class="text-3xl font-bold text-indigo-600">0</p>
                </div>
                <div class="text-2xl text-gray-300">VS</div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">Ø§Ù„Ø®ØµÙ…</p>
                    <p id="final-op-score" class="text-3xl font-bold text-red-500">0</p>
                </div>
            </div>

            <div class="bg-yellow-50 px-6 py-3 rounded-full border border-yellow-200 mb-8 flex items-center gap-2">
                <span>Ø­ØµÙ„Øª Ø¹Ù„Ù‰:</span>
                <span id="result-points-gained" class="font-bold text-yellow-700">+0</span>
                <i class="fas fa-gem text-yellow-500"></i>
            </div>

            <button onclick="closeResultScreen()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>

        <!-- TAB 2: LEADERBOARD -->
        <div id="tab-leaderboard" class="screen pt-20">
            <div class="scroll-container px-4">
                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-2xl mb-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm opacity-90">ØªØ±ØªÙŠØ¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                        <h2 id="my-rank-text" class="text-2xl font-bold">#...</h2>
                    </div>
                    <i class="fas fa-trophy text-4xl opacity-50"></i>
                </div>
                <div id="leaderboard-list" class="space-y-2 pb-10 flex flex-col"></div>
            </div>
        </div>

        <!-- TAB 3: UPLOAD -->
        <div id="tab-upload" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-600 flex-shrink-0">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div>
                        <p class="text-sm font-bold text-green-800">Ø§Ø±Ø¨Ø­ 5 Ù†Ù‚Ø§Ø·</p>
                        <p class="text-xs text-green-600">Ø¹Ù† ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„Ù‡</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm">
                    <!-- Step 1 -->
                    <div id="up-step-1">
                        <label class="block text-sm font-bold text-gray-500 mb-1">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
                        <select id="up-subject" class="input-box mb-4 bg-gray-50"></select>
                        
                        <label class="block text-sm font-bold text-gray-500 mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select id="up-type" class="input-box mb-6 bg-gray-50">
                            <option value="mcq">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</option>
                            <option value="tf">ØµØ­ ÙˆØ®Ø·Ø£</option>
                        </select>
                        <button onclick="nextUploadStep()" class="btn-main">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                    </div>

                    <!-- Step 2 -->
                    <div id="up-step-2" class="hidden">
                        <textarea id="up-q-text" class="input-box h-24 mb-4" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„..."></textarea>
                        
                        <div id="up-mcq-container">
                            <p class="text-xs text-gray-400 mb-2">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆØ­Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­</p>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="0" checked>
                                    <input type="text" id="ans-0" class="input-box py-2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="1">
                                    <input type="text" id="ans-1" class="input-box py-2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="correct" value="2">
                                    <input type="text" id="ans-2" class="input-box py-2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
                                </div>
                            </div>
                        </div>

                        <div id="up-tf-container" class="hidden mb-4">
                            <label class="block text-xs text-gray-400 mb-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
                            <select id="up-tf-val" class="input-box">
                                <option value="true">ØµØ­</option>
                                <option value="false">Ø®Ø·Ø£</option>
                            </select>
                        </div>

                        <div class="flex gap-2">
                            <button onclick="document.getElementById('up-step-2').classList.add('hidden');document.getElementById('up-step-1').classList.remove('hidden')" class="bg-gray-100 text-gray-600 px-4 rounded-xl font-bold">Ø±Ø¬ÙˆØ¹</button>
                            <button onclick="submitUploadQuestion()" class="btn-main bg-green-600">Ø¥Ø±Ø³Ø§Ù„</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: PROFILE -->
        <div id="tab-profile" class="screen pt-20">
            <div class="scroll-container px-5">
                <div class="bg-white p-6 rounded-3xl shadow-sm text-center mb-6 mt-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                    <div class="relative z-10">
                        <img id="profile-img" src="" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-md mb-3 object-cover">
                        <h2 id="profile-name-text" class="text-xl font-bold text-gray-800">...</h2>
                        <p class="text-xs text-gray-400 mt-1" id="profile-id-text">ID: ...</p>
                        <button onclick="document.getElementById('edit-pic-input').click()" class="text-indigo-600 text-xs font-bold mt-2 hover:underline">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</button>
                        <input type="file" id="edit-pic-input" hidden accept="image/*" onchange="updateProfilePic(this)">
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <button onclick="openPage('screen-stats')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-chart-pie"></i></div>
                            <span class="font-bold text-gray-700">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-my-points')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i class="fas fa-star"></i></div>
                            <span class="font-bold text-gray-700">Ù†Ù‚Ø§Ø·ÙŠ ÙˆØªØ§Ø±ÙŠØ®ÙŠ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-my-questions')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i class="fas fa-question"></i></div>
                            <span class="font-bold text-gray-700">Ø£Ø³Ø¦Ù„ØªÙŠ Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>
                    
                    <div id="admin-buttons" class="hidden space-y-3 border-t pt-3 mt-3">
                        <p class="text-xs text-red-400 font-bold px-2">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
                        <button onclick="openPage('screen-admin-review')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600 relative">
                                    <i class="fas fa-gavel"></i>
                                    <div id="admin-btn-badge" class="btn-dot"></div>
                                </div>
                                <span class="font-bold text-red-700">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span>
                            </div>
                        </button>
                        <button onclick="openPage('screen-admin-all')" class="stat-btn border-red-100 bg-red-50">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600"><i class="fas fa-database"></i></div>
                                <span class="font-bold text-red-700">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</span>
                            </div>
                        </button>
                    </div>

                    <button onclick="logout()" class="stat-btn mt-6 border-red-100 text-red-500">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sign-out-alt px-3"></i>
                            <span class="font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SUB SCREENS (FREE PAGES) === -->

        <!-- Screen: App Stats -->
        <div id="screen-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="stats-content" class="space-y-4">
                    <p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>

        <!-- Screen: My Points -->
        <div id="screen-my-points" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ù†Ù‚Ø§Ø·ÙŠ ÙˆØªØ§Ø±ÙŠØ®ÙŠ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="points-content" class="text-center">
                    <div class="bg-white p-8 rounded-3xl shadow-sm mb-6">
                        <i class="fas fa-gem text-5xl text-yellow-500 mb-4 animate-bounce"></i>
                        <h1 class="text-6xl font-black text-gray-800 mb-2" id="detail-points">0</h1>
                        <p class="text-gray-400">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-2xl shadow-sm">
                            <p class="text-xs text-gray-400 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</p>
                            <p class="font-bold text-gray-700 text-sm" id="detail-join-date">...</p>
                        </div>
                        <div class="bg-white p-5 rounded-2xl shadow-sm">
                            <p class="text-xs text-gray-400 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</p>
                            <p class="font-bold text-indigo-600 text-xl" id="detail-days">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: My Questions -->
        <div id="screen-my-questions" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ø£Ø³Ø¦Ù„ØªÙŠ Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="my-questions-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Screen: Admin Review -->
        <div id="screen-admin-review" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="admin-review-list" class="space-y-3"></div>
            </div>
        </div>

         <!-- Screen: Admin ALL Questions -->
         <div id="screen-admin-all" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <input type="text" id="admin-search-all" onkeyup="filterAdminQuestions()" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©..." class="input-box mb-4 text-sm">
                <div id="admin-all-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- BOTTOM NAV -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="switchTab('challenges')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-gamepad text-xl mb-1"></i><span class="text-[10px] font-bold">Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª</span>
            </div>
            <div onclick="switchTab('leaderboard')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-trophy text-xl mb-1"></i><span class="text-[10px] font-bold">Ø§Ù„ØªØµÙ†ÙŠÙ</span>
            </div>
            <div onclick="switchTab('upload')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full flex items-center justify-center text-white shadow-lg -mt-6 border-4 border-gray-50"><i class="fas fa-plus"></i></div>
                <span class="text-[10px] font-bold mt-1">Ø±ÙØ¹</span>
            </div>
            <div onclick="switchTab('profile')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">Ø­Ø³Ø§Ø¨ÙŠ</span>
                <!-- Notification Badge -->
                <div id="profile-tab-badge" class="red-dot"></div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, increment, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfLOjiPiSQW9opdiIgQif3pAp8zsezy58",
            authDomain: "ministerial-hacker.firebaseapp.com",
            databaseURL: "https://ministerial-hacker-default-rtdb.firebaseio.com",
            projectId: "ministerial-hacker",
            storageBucket: "ministerial-hacker.firebasestorage.app",
            messagingSenderId: "557133038084",
            appId: "1:557133038084:web:c8cb7df6ef0abef2beab51",
            measurementId: "G-WYMSX2LRTW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";

        // Force Persistence
        setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence Error", e));

        let currentUser = null;
        let userData = null;
        let selectedQType = null;
        let currentMatchId = null;
        let gameTimer = null;
        let hasAnsweredCurrentQ = false;
        let allAdminQuestions = [];
        let adminListenerUnsubscribe = null;

        const subjects = {
            '6sci': ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', 'Ø§Ø­ÙŠØ§Ø¡', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'ÙƒÙŠÙ…ÙŠØ§Ø¡', 'ÙÙŠØ²ÙŠØ§Ø¡'],
            '6lit': ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', 'ØªØ§Ø±ÙŠØ®', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø¬ØºØ±Ø§ÙÙŠØ©', 'Ø§Ù‚ØªØµØ§Ø¯'],
            '3med': ['Ø§Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø¹Ø±Ø¨ÙŠ', 'Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ', 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'ÙƒÙŠÙ…ÙŠØ§Ø¡', 'ÙÙŠØ²ÙŠØ§Ø¡', 'Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª']
        };

        // --- AUTH & STATE MANAGEMENT ---
        onAuthStateChanged(auth, async (user) => {
            const intro = document.getElementById('intro-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');

            if (user) {
                currentUser = user;
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        
                        // Update Last Active for Stats
                        updateDoc(doc(db, "users", user.uid), { lastActive: serverTimestamp() });
                        
                        setupProfileUI();
                        setupHeaderUI();
                        setupAdminUI();
                        checkDailyReward(); 
                        if(userData.email === ADMIN_EMAIL) checkAdminNotifications(); 

                        if (userData.grade) {
                            document.getElementById('grade-selector-card').classList.add('hidden');
                            document.getElementById('challenge-active-card').classList.remove('hidden');
                            document.getElementById('header-grade-badge').innerText = getGradeName(userData.grade);
                            document.getElementById('header-grade-badge').classList.remove('hidden');
                            populateSubjects(userData.grade, 'challenge-subject');
                        } else {
                            document.getElementById('grade-selector-card').classList.remove('hidden');
                            document.getElementById('challenge-active-card').classList.add('hidden');
                            document.getElementById('header-grade-badge').classList.add('hidden');
                        }
                        
                        intro.classList.add('hidden');
                        authScreen.classList.add('hidden');
                        mainApp.classList.remove('hidden');
                        // Ensure we are on challenges tab if first load or refresh
                        if(!document.querySelector('.screen.active')) switchTab('challenges');
                        
                    } else {
                        // User in Auth but not DB? Clean up
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) {
                      console.error("Auth Data Error:", e);
                      // If critical error, maybe reload or show error
                }
            } else {
                // No User
                intro.classList.add('hidden');
                mainApp.classList.add('hidden');
                authScreen.classList.remove('hidden');
                window.switchAuthTab('login');
            }
        });

        // --- AUTH TABS LOGIC ---
        window.switchAuthTab = (tab) => {
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('tab-login-btn').classList.add('active');
                document.getElementById('tab-signup-btn').classList.remove('active');
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
                document.getElementById('tab-login-btn').classList.remove('active');
                document.getElementById('tab-signup-btn').classList.add('active');
            }
        };

        window.handleLogin = async () => {
            try {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                await signInWithEmailAndPassword(auth, email, pass);
                // Auth listener will handle redirection
            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message); }
        };

        window.handleSignup = async () => {
            try {
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-pass').value;
                const imgFile = document.getElementById('signup-img').files[0];
                
                if(!name || !email || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„");
                if(!email.endsWith("@gmail.com")) return alert("ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§ÙŠÙ…ÙŠÙ„ Gmail");
                if(pass.length < 6) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹");

                let photoURL = `https://ui-avatars.com/api/?name=${name}&background=random&size=128`;
                if(imgFile) {
                    photoURL = await compressImage(imgFile);
                }

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                await setDoc(doc(db, "users", cred.user.uid), {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    photo: photoURL,
                    uniqueId: generateId(),
                    points: 0,
                    role: 'user',
                    createdAt: serverTimestamp(),
                    lastRewardDate: null,
                    rewardStreak: 0,
                    hiddenFromLeaderboard: false 
                });
                // Auth listener will handle redirection
            } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
        };

        window.logout = () => {
            if(adminListenerUnsubscribe) adminListenerUnsubscribe(); 
            signOut(auth);
            // Auth listener will handle UI switch
        };

        // --- DAILY REWARD LOGIC ---
        window.checkDailyReward = async () => {
            const now = new Date();
            if (now.getHours() < 9) return; 

            const todayStr = now.toDateString();
            if (userData.lastRewardDate === todayStr) return; 

            let streak = userData.rewardStreak || 0;
            const lastDate = userData.lastRewardDate ? new Date(userData.lastRewardDate) : null;
            
            if (lastDate) {
                const diffTime = Math.abs(now - lastDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                if (diffDays > 2) streak = 0; 
            }
            
            if (streak > 30) streak = 30; 
            
            const rewardAmount = 10 + (streak * 5);
            
            document.getElementById('reward-amount').innerText = `+${rewardAmount}`;
            document.getElementById('daily-reward-screen').classList.remove('hidden');
            document.getElementById('daily-reward-screen').style.display = 'flex';
        };

        window.claimReward = async () => {
            const now = new Date();
            const todayStr = now.toDateString();
            let streak = (userData.rewardStreak || 0) + 1;
            if (streak > 30) streak = 1;
            
            const rewardAmount = 10 + ((streak - 1) * 5);

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(rewardAmount),
                lastRewardDate: todayStr,
                rewardStreak: streak
            });
            
            userData.points += rewardAmount;
            userData.lastRewardDate = todayStr;
            userData.rewardStreak = streak;
            
            setupHeaderUI();
            
            document.getElementById('daily-reward-screen').classList.add('hidden');
            document.getElementById('daily-reward-screen').style.display = 'none';
            
            alert(`ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… ${rewardAmount} Ù†Ù‚Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
        };

        // --- UI ---
        function setupProfileUI() {
            document.getElementById('profile-name-text').innerText = userData.name;
            document.getElementById('profile-id-text').innerText = "ID: " + userData.uniqueId;
            document.getElementById('profile-img').src = userData.photo;
        }
        function setupHeaderUI() { document.getElementById('header-points').innerText = userData.points; }
        function setupAdminUI() { if (userData.email === ADMIN_EMAIL) document.getElementById('admin-buttons').classList.remove('hidden'); }

        window.saveUserGrade = async () => {
            const g = document.getElementById('grade-select').value;
            if (!g) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©");
            await updateDoc(doc(db, "users", currentUser.uid), { grade: g });
            userData.grade = g;
            document.getElementById('grade-selector-card').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            document.getElementById('header-grade-badge').innerText = getGradeName(g);
            document.getElementById('header-grade-badge').classList.remove('hidden');
            populateSubjects(g, 'challenge-subject');
        };

        function getGradeName(code) { return code==='6sci'?'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ':code==='6lit'?'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø£Ø¯Ø¨ÙŠ':'Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·'; }

        function populateSubjects(grade, elementId) {
            const sel = document.getElementById(elementId);
            sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            subjects[grade].forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        }

        // --- MATCHMAKING ---
        window.setQType = (t) => {
            selectedQType = t;
            document.getElementById('btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
        };

        window.startMatchmaking = async () => {
            const sub = document.getElementById('challenge-subject').value;
            if(!sub || !selectedQType) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©");

            document.getElementById('challenge-active-card').classList.add('hidden');
            document.getElementById('searching-ui').classList.remove('hidden');
            document.getElementById('searching-ui').style.display = 'flex';

            const grade = userData.grade;
            let group = `${grade}_${sub}`;
            if(['Ø§Ø³Ù„Ø§Ù…ÙŠØ©','Ø¹Ø±Ø¨ÙŠ','Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ'].includes(sub) && grade.startsWith('6')) group = `6shared_${sub}`;

            try {
                const qRef = collection(db, "match_queue");
                const qWait = query(qRef, where("group", "==", group), where("status", "==", "waiting"), limit(1));
                const snap = await getDocs(qWait);

                if(!snap.empty) {
                    const matchId = snap.docs[0].id;
                    currentMatchId = matchId;
                    await updateDoc(doc(db, "match_queue", matchId), {
                        player2: { uid: currentUser.uid, name: userData.name, score: 0 },
                        status: 'active',
                        answersCount: 0 
                    });
                    listenToMatch(matchId);
                } else {
                    const qDocs = await getQuestions(sub, selectedQType);
                    if(qDocs.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ©"); cancelSearch(); return; }
                    const newMatch = await addDoc(qRef, {
                        group: group,
                        status: 'waiting',
                        player1: { uid: currentUser.uid, name: userData.name, score: 0 },
                        questions: qDocs.sort(() => 0.5 - Math.random()).slice(0, 10),
                        currentIdx: 0,
                        answersCount: 0
                    });
                    currentMatchId = newMatch.id;
                    listenToMatch(newMatch.id);
                }
            } catch(e) { console.error(e); cancelSearch(); }
        };

        async function getQuestions(sub, type) {
            const q = query(collection(db, "questions"), where("subject", "==", sub), where("type", "==", type), limit(20));
            const snap = await getDocs(q);
            const list = [];
            snap.forEach(d => list.push(d.data()));
            return list;
        }

        window.cancelSearch = async () => {
            if(currentMatchId) { try { await deleteDoc(doc(db, "match_queue", currentMatchId)); } catch(e){} }
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('searching-ui').style.removeProperty('display'); 
            document.getElementById('challenge-active-card').classList.remove('hidden');
        };

        function listenToMatch(id) {
            onSnapshot(doc(db, "match_queue", id), (snap) => {
                if(!snap.exists()) return;
                const d = snap.data();
                if(d.status === 'active') {
                    document.getElementById('game-overlay').classList.remove('hidden');
                    document.getElementById('game-overlay').style.display = 'flex';
                    renderGame(d);
                }
            });
        }

        function renderGame(data) {
            if(!data.questions || data.currentIdx >= data.questions.length) { endGame(data); return; }

            if (data.answersCount >= 2) {
                 if(data.player1.uid === currentUser.uid) {
                     setTimeout(() => {
                         updateDoc(doc(db, "match_queue", currentMatchId), { 
                             currentIdx: increment(1),
                             answersCount: 0 
                         });
                     }, 1000);
                 }
                 return;
            }
            
            const q = data.questions[data.currentIdx];
            if (!q) { endGame(data); return; }

            const qTextEl = document.getElementById('q-text');
            
            if(qTextEl.innerText !== q.question) {
                hasAnsweredCurrentQ = false;
                document.getElementById('answers-container').classList.remove('pointer-events-none', 'opacity-50');
                document.getElementById('waiting-msg').classList.add('hidden');
            }

            document.getElementById('q-progress').innerText = `${data.currentIdx + 1} / 10`;
            qTextEl.innerText = q.question;
            
            const isP1 = data.player1.uid === currentUser.uid;
            document.getElementById('game-my-score').innerText = isP1 ? data.player1.score : data.player2.score;
            document.getElementById('game-op-score').innerText = isP1 ? data.player2.score : data.player1.score;

            const div = document.getElementById('answers-container');
            if(div.children.length === 0 || qTextEl.innerText !== q.question) {
                div.innerHTML = '';
                let ansList = q.type === 'mcq' ? q.answers : ['ØµØ­', 'Ø®Ø·Ø£'];
                ansList.forEach(ans => {
                    const btn = document.createElement('button');
                    btn.className = "w-full py-4 bg-white border-2 border-gray-100 rounded-xl text-lg font-bold text-gray-700 shadow-sm active:scale-95 transition hover:border-indigo-300";
                    btn.innerText = ans;
                    btn.onclick = () => submitGameAnswer(ans, q, data);
                    div.appendChild(btn);
                });
            }

            if(!hasAnsweredCurrentQ) {
                clearInterval(gameTimer);
                let t = 15;
                document.getElementById('game-timer').innerText = t;
                gameTimer = setInterval(() => {
                    t--;
                    document.getElementById('game-timer').innerText = t;
                    if(t<=0) { clearInterval(gameTimer); submitGameAnswer(null, q, data); }
                }, 1000);
            }
        }

        async function submitGameAnswer(ans, q, matchData) {
            if(hasAnsweredCurrentQ) return;
            hasAnsweredCurrentQ = true;
            clearInterval(gameTimer);
            
            document.getElementById('answers-container').classList.add('pointer-events-none', 'opacity-50');
            document.getElementById('waiting-msg').classList.remove('hidden');

            let correct = false;
            if(ans) {
                if(q.type==='mcq' && q.answers.indexOf(ans) === q.correct) correct = true;
                if(q.type==='tf' && ((ans==='ØµØ­' && q.correct==='true') || (ans==='Ø®Ø·Ø£' && q.correct==='false'))) correct = true;
            }

            const isP1 = matchData.player1.uid === currentUser.uid;
            const ref = doc(db, "match_queue", currentMatchId);

            const updates = { answersCount: increment(1) };
            if(correct) {
                updates[isP1?'player1.score':'player2.score'] = increment(1);
            }
            await updateDoc(ref, updates);
        }

        async function endGame(d) {
            document.getElementById('game-overlay').classList.add('hidden');
            
            const isP1 = d.player1.uid === currentUser.uid;
            const myS = isP1 ? d.player1.score : d.player2.score;
            const opS = isP1 ? d.player2.score : d.player1.score;
            
            let pts = 5; 
            let msg = "ØªØ¹Ø§Ø¯Ù„ Ù…Ø«ÙŠØ±!";
            let icon = "ğŸ¤";
            
            if(myS > opS) { pts = 20; msg = "ÙÙˆØ² Ø³Ø§Ø­Ù‚!"; icon = "ğŸ†"; }
            if(myS < opS) { pts = 0; msg = "Ø­Ø¸ Ø£ÙˆÙØ±!"; icon = "ğŸ˜¢"; }

            if(pts > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { points: increment(pts) });
                userData.points += pts;
                setupHeaderUI();
            }

            document.getElementById('result-icon-container').innerText = icon;
            document.getElementById('result-title').innerText = msg;
            document.getElementById('final-my-score').innerText = myS;
            document.getElementById('final-op-score').innerText = opS;
            document.getElementById('result-points-gained').innerText = `+${pts}`;
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('result-screen').style.display = 'flex';

            cancelSearch(); 
        }

        window.closeResultScreen = () => {
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('game-overlay').classList.add('hidden');
             document.getElementById('searching-ui').classList.add('hidden');
             document.getElementById('searching-ui').style.removeProperty('display');
             document.getElementById('challenge-active-card').classList.remove('hidden');
             switchTab('challenges');
        };

        // --- UPLOAD ---
        window.nextUploadStep = () => {
            const sub = document.getElementById('up-subject').value;
            const type = document.getElementById('up-type').value;
            if (!sub) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©");
            
            document.getElementById('up-step-1').classList.add('hidden');
            document.getElementById('up-step-2').classList.remove('hidden');

            if(type === 'mcq') {
                document.getElementById('up-mcq-container').classList.remove('hidden');
                document.getElementById('up-tf-container').classList.add('hidden');
            } else {
                document.getElementById('up-mcq-container').classList.add('hidden');
                document.getElementById('up-tf-container').classList.remove('hidden');
            }
        };

        window.submitUploadQuestion = async () => {
             const sub = document.getElementById('up-subject').value;
             const type = document.getElementById('up-type').value;
             const txt = document.getElementById('up-q-text').value;

             if(!txt) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„");
             
             let q = {
                 grade: userData.grade, subject: sub, type, question: txt,
                 authorId: currentUser.uid, authorName: userData.name, createdAt: serverTimestamp()
             };

             if(type==='mcq') {
                 const a0 = document.getElementById('ans-0').value;
                 const a1 = document.getElementById('ans-1').value;
                 const a2 = document.getElementById('ans-2').value;
                 if(!a0 || !a1 || !a2) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª");
                 q.answers = [a0, a1, a2];
                 q.correct = parseInt(document.querySelector('input[name="correct"]:checked').value);
             } else {
                 q.correct = document.getElementById('up-tf-val').value;
             }

             await addDoc(collection(db, "pending_questions"), q);
             alert("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!");
             
             document.getElementById('up-q-text').value = "";
             document.getElementById('ans-0').value = "";
             document.getElementById('ans-1').value = "";
             document.getElementById('ans-2').value = "";
             document.getElementById('up-step-2').classList.add('hidden');
             document.getElementById('up-step-1').classList.remove('hidden');
        };

        // --- FREE PAGES LOGIC (No Modals) ---
        window.openPage = async (screenId) => {
            document.querySelectorAll('.screen').forEach(s => {
                if(s.id.startsWith('screen-')) s.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'screen-stats') {
                loadStatsContent();
            } else if (screenId === 'screen-my-points') {
                loadMyPointsContent();
            } else if (screenId === 'screen-my-questions') {
                loadMyQuestionsContent();
            } else if (screenId === 'screen-admin-review') {
                loadAdminReviewContent();
            } else if (screenId === 'screen-admin-all') {
                loadAdminAllContent();
            }
        };

        window.backToProfile = () => {
             document.querySelectorAll('.screen').forEach(s => {
                if(s.id.startsWith('screen-')) s.classList.remove('active');
            });
        };

        async function loadStatsContent() {
             const div = document.getElementById('stats-content');
             const usersSnap = await getDocs(collection(db, "users"));
             const total = usersSnap.size;
             // Calc active today (roughly)
             const today = new Date(); today.setHours(0,0,0,0);
             let newUsers = 0;
             let activeNow = 0; 
             const now = new Date();

             usersSnap.forEach(d => {
                 const u = d.data();
                 if(u.createdAt && u.createdAt.toDate() >= today) newUsers++;
                 // Active in last 3 Minutes
                 if (u.lastActive && (now - u.lastActive.toDate()) < 3 * 60 * 1000) activeNow++;
             });
             // Always count current user if logic fails locally
             if(activeNow === 0) activeNow = 1; 

             div.innerHTML = `
                <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ</p>
                        <p class="text-2xl font-bold text-gray-800">${total}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Ù†Ø´Ø·ÙŠÙ† Ø§Ù„Ø¢Ù†</p>
                        <p class="text-2xl font-bold text-green-500">${activeNow}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-wifi"></i></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-500">Ø³Ø¬Ù„ÙˆØ§ Ø§Ù„ÙŠÙˆÙ…</p>
                        <p class="text-2xl font-bold text-purple-500">${newUsers}</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-user-plus"></i></div>
                </div>
             `;
        }

        async function loadMyPointsContent() {
             document.getElementById('detail-points').innerText = userData.points;
             const joinDate = userData.createdAt ? userData.createdAt.toDate() : new Date();
             document.getElementById('detail-join-date').innerText = joinDate.toLocaleDateString('ar-EG');
             const diffTime = Math.abs(new Date() - joinDate);
             const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
             document.getElementById('detail-days').innerText = diffDays + " ÙŠÙˆÙ…";
        }

        async function loadMyQuestionsContent() {
            const div = document.getElementById('my-questions-list');
            div.innerHTML = '<p class="text-center text-gray-400">ØªØ­Ù…ÙŠÙ„...</p>';
            
            const q1 = query(collection(db, "pending_questions"), where("authorId", "==", currentUser.uid));
            
            try {
                const s1 = await getDocs(q1);
                let html = "";
                s1.forEach(d => {
                    const q = d.data();
                    html += `<div class="bg-white p-4 rounded-xl border border-yellow-100 mb-2">
                        <div class="flex justify-between mb-1"><span class="text-xs text-gray-400">${q.subject}</span><span class="text-xs bg-yellow-100 text-yellow-600 px-2 rounded">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span></div>
                        <p class="font-bold text-gray-800 text-sm">${q.question}</p>
                    </div>`;
                });
                
                if(html === "") html = "<p class='text-center text-gray-400 mt-10'>Ù„Ù… ØªÙ‚Ù… Ø¨Ø±ÙØ¹ Ø£Ø³Ø¦Ù„Ø© (Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©) Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
                div.innerHTML = html;
            } catch(e) {
                div.innerHTML = "<p class='text-red-500'>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙÙ‡Ø§Ø±Ø³).</p>";
            }
        }

        async function loadAdminReviewContent() {
            const div = document.getElementById('admin-review-list');
            div.innerHTML = '<p class="text-center text-gray-400">ØªØ­Ù…ÙŠÙ„...</p>';
            const q = await getDocs(query(collection(db, "pending_questions")));
            if(q.empty) { div.innerHTML = "<p class='text-center py-10 text-gray-400'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>"; return; }
            let html = "";
            q.forEach(d => {
               const val = d.data();
               const author = val.authorName || 'Ù…Ø¬Ù‡ÙˆÙ„';
               html += `
                <div class="bg-white rounded-xl p-4 mb-3 shadow-sm border border-gray-100" id="review-card-${d.id}">
                    <div class="flex justify-between items-start mb-2">
                         <span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg font-bold">${val.grade} | ${val.subject}</span>
                         <span class="text-xs text-gray-400">Ø¨ÙˆØ§Ø³Ø·Ø©: ${author}</span>
                    </div>
                    <p class="font-bold mb-3 text-gray-800 text-sm leading-6">${val.question}</p>
                    
                    <div class="bg-gray-50 p-3 rounded-lg mb-3 text-xs space-y-1 border border-gray-100">
                         <p class="font-bold text-gray-500">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</p>
                         ${val.type==='mcq' ? 
                           `<ul class="list-disc list-inside text-gray-600">
                                <li>${val.answers[0]}</li>
                                <li>${val.answers[1]}</li>
                                <li>${val.answers[2]}</li>
                            </ul>` : 
                           `<p>ØµØ­ / Ø®Ø·Ø£</p>`
                         }
                         <p class="mt-2 text-green-600 font-bold">Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØµØ­ÙŠØ­: ${val.type==='mcq' ? val.answers[val.correct] : (val.correct==='true'?'ØµØ­':'Ø®Ø·Ø£')}</p>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="approveQ('${d.id}')" class="flex-1 bg-green-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-green-600 transition">Ù‚Ø¨ÙˆÙ„ (+5)</button>
                        <button onclick="rejectQ('${d.id}')" class="flex-1 bg-red-500 text-white text-xs py-3 rounded-lg font-bold shadow-md hover:bg-red-600 transition">Ø±ÙØ¶</button>
                    </div>
                </div>`; 
            });
            div.innerHTML = html;
        }

        async function loadAdminAllContent() {
             const div = document.getElementById('admin-all-list');
             div.innerHTML = '<p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...</p>';
             const q = await getDocs(collection(db, "questions"));
             allAdminQuestions = [];
             q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
             renderAdminAllList(allAdminQuestions);
        }

        window.renderAdminAllList = (list) => {
            const div = document.getElementById('admin-all-list');
            if(list.length === 0) { div.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>"; return; }
            let html = "";
            list.slice(0, 50).forEach(q => { 
                html += `
                <div class="bg-white rounded-xl p-3 mb-2 border border-gray-100 shadow-sm flex justify-between items-center">
                    <div class="overflow-hidden w-2/3">
                        <p class="text-xs text-indigo-400 font-bold">${q.subject}</p>
                        <input type="text" value="${q.question}" id="q-edit-${q.id}" class="w-full text-sm font-bold text-gray-700 border-b border-dashed border-gray-300 focus:border-indigo-500 outline-none bg-transparent">
                    </div>
                    <div class="flex gap-1">
                        <button onclick="saveEditQ('${q.id}')" class="bg-blue-100 text-blue-600 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-save"></i></button>
                        <button onclick="deleteApprovedQ('${q.id}')" class="bg-red-100 text-red-600 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
            div.innerHTML = html;
        };

        window.filterAdminQuestions = () => {
            const txt = document.getElementById('admin-search-all').value.toLowerCase();
            const filtered = allAdminQuestions.filter(q => q.question.toLowerCase().includes(txt) || q.subject.includes(txt));
            renderAdminAllList(filtered);
        };

        window.saveEditQ = async (id) => {
            const newTxt = document.getElementById(`q-edit-${id}`).value;
            await updateDoc(doc(db, "questions", id), { question: newTxt });
            alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
        };

        window.deleteApprovedQ = async (id) => {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) {
                await deleteDoc(doc(db, "questions", id));
                document.getElementById(`q-edit-${id}`).parentElement.parentElement.remove();
            }
        };

        // --- ADMIN DELETE USER (NEW LOGIC - SOFT DELETE / RESET) ---
        window.adminDeleteUser = async (uid) => {
            if(confirm("ØªØ­Ø°ÙŠØ±! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„ØªØµÙ†ÙŠÙ (Ø³ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù„Ø¹Ø¨ Ù…Ø¬Ø¯Ø¯Ø§Ù‹).")) {
                try {
                    // Update user to be hidden from leaderboard and reset points
                    await updateDoc(doc(db, "users", uid), {
                        points: 0,
                        hiddenFromLeaderboard: true
                    });
                    // Refresh leaderboard locally or reload
                    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØµÙ†ÙŠÙ ÙˆØªØµÙÙŠØ± Ù†Ù‚Ø§Ø·Ù‡.");
                    loadLeaderboard(); 
                } catch(e) {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
                }
            }
        };

        // --- ADMIN NOTIFICATION LISTENER ---
        window.checkAdminNotifications = () => {
            const q = query(collection(db, "pending_questions"));
            adminListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                const badgeTab = document.getElementById('profile-tab-badge');
                const badgeBtn = document.getElementById('admin-btn-badge');
                
                if (count > 0) {
                    badgeTab.classList.add('visible');
                    badgeBtn.classList.add('visible');
                } else {
                    badgeTab.classList.remove('visible');
                    badgeBtn.classList.remove('visible');
                }
            });
        };

        // --- COMMON UTILS ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); n.classList.remove('text-indigo-600'); n.classList.add('text-gray-400'); });
            const navs = document.querySelectorAll('.nav-item');
            if(tab==='challenges') navs[0].classList.add('active', 'text-indigo-600');
            if(tab==='leaderboard') { navs[1].classList.add('active', 'text-indigo-600'); loadLeaderboard(); }
            if(tab==='upload') { navs[2].classList.add('active', 'text-indigo-600'); updateUploadUI(); }
            if(tab==='profile') navs[3].classList.add('active', 'text-indigo-600');
        };
        window.updateUploadUI = () => { if(userData.grade) populateSubjects(userData.grade, 'up-subject'); };
        
        // --- IMPROVED LEADERBOARD SORTING & RENDERING ---
        async function loadLeaderboard() {
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '<p class="text-center text-gray-400 mt-10">ØªØ­Ù…ÙŠÙ„...</p>';
            
            // Fetch users (Fetched a large limit to sort on client correctly)
            // Note: Since we cannot use complex queries/indexes easily here, we fetch a chunk and sort client side.
            const q = query(collection(db, "users"), limit(500));
            const snap = await getDocs(q);
            
            let users = [];
            snap.forEach(d => {
                const u = d.data();
                // Filter out users who are "deleted/hidden" from leaderboard
                if (u.hiddenFromLeaderboard !== true) {
                    users.push(u);
                }
            });

            // Client-side Sort: Points Desc -> Name Asc (Arabic Aware)
            users.sort((a, b) => {
                // Parse int to ensure we are comparing numbers not strings
                const pointsA = parseInt(a.points || 0);
                const pointsB = parseInt(b.points || 0);

                // Primary: Points (High to Low)
                if (pointsB !== pointsA) {
                    return pointsB - pointsA;
                }
                // Secondary: Name (Arabic alphabetical)
                return (a.name || "").localeCompare((b.name || ""), 'ar');
            });

            div.innerHTML = '';
            let i = 1;
            // Only show top 50 after sorting
            users.slice(0, 50).forEach(u => {
                if(u.uid === currentUser.uid) document.getElementById('my-rank-text').innerText = "#" + i;
                
                let medal = "";
                if(i===1) medal = "ğŸ¥‡";
                if(i===2) medal = "ğŸ¥ˆ";
                if(i===3) medal = "ğŸ¥‰";

                // Admin Delete Button (Reset Points/Hide)
                let deleteBtn = "";
                if(userData.email === ADMIN_EMAIL) {
                    deleteBtn = `<button onclick="adminDeleteUser('${u.uid}')" class="text-red-400 bg-red-50 w-8 h-8 rounded-full ml-2 flex items-center justify-center hover:bg-red-100"><i class="fas fa-trash"></i></button>`;
                }

                div.innerHTML += `
                    <div class="rank-item flex items-center justify-between bg-white p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden">
                        <div class="flex items-center gap-4 z-10">
                            <span class="rank-num font-black text-gray-300 w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 text-sm border">${i}</span>
                            <img src="${u.photo}" class="w-12 h-12 rounded-full border-2 border-white shadow-sm object-cover">
                            <div>
                                <p class="font-bold text-gray-800 text-sm flex items-center">${u.name} ${medal} ${deleteBtn}</p>
                                <p class="text-[10px] text-gray-400">ID: ${u.uniqueId}</p>
                            </div>
                        </div>
                        <span class="font-black text-indigo-600 text-lg z-10">${u.points} ğŸ’</span>
                    </div>`;
                i++;
            });
        }

        window.handleImagePreview = (input) => {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById('preview-img').src = e.target.result;
                r.readAsDataURL(input.files[0]);
            }
        };
        function generateId() { return Math.random().toString(36).substr(2, 6).toUpperCase(); }
        function compressImage(file) {
            return new Promise((resolve) => {
                const r = new FileReader();
                r.readAsDataURL(file);
                r.onload = (e) => {
                    const i = new Image();
                    i.src = e.target.result;
                    i.onload = () => {
                        const c = document.createElement('canvas');
                        c.width=200; c.height=200;
                        const ctx = c.getContext('2d');
                        ctx.drawImage(i,0,0,200,200);
                        resolve(c.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        }

        // --- INSTANT REVIEW UI UPDATE ---
        window.approveQ = async (id) => {
            // Remove from UI immediately
            const card = document.getElementById(`review-card-${id}`);
            if(card) card.remove();
            
            // Backend processing
            const ref = doc(db, "pending_questions", id);
            const d = (await getDoc(ref)).data();
            await addDoc(collection(db, "questions"), {...d, status:'approved'});
            await updateDoc(doc(db, "users", d.authorId), { points: increment(5) });
            await deleteDoc(ref);
        };

        window.rejectQ = async (id) => {
             // Remove from UI immediately
            const card = document.getElementById(`review-card-${id}`);
            if(card) card.remove();
            
            // Backend processing
            await deleteDoc(doc(db, "pending_questions", id));
        };

        window.updateProfilePic = async (input) => {
            if(input.files[0]) {
                const p = await compressImage(input.files[0]);
                await updateDoc(doc(db, "users", currentUser.uid), { photo: p });
                document.getElementById('profile-img').src = p;
            }
        };
    </script>
</body>
</html>
