<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ŸáŸÉÿ± ÿßŸÑŸàÿ≤ÿßÿ±Ÿä</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Global Reset & Variables --- */
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --bg-app: #f8fafc;
            --gold: #FFD700;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-app);
            overflow: hidden; 
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
            margin: 0; padding: 0;
            overscroll-behavior: none;
        }

        /* --- Performance & Smooth Transitions --- */
        .screen {
            display: none; 
            height: 100vh; 
            width: 100vw;
            position: absolute; 
            top: 0; 
            left: 0; 
            background: var(--bg-app); 
            z-index: 10;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out;
            will-change: opacity, transform;
        }
        .screen.active { 
            display: block; 
            z-index: 20; 
            opacity: 1;
            transform: scale(1);
        }

        /* --- Custom Scroll --- */
        .scroll-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 250px; 
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Animations --- */
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Hacker Intro Animation */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes glitch { 0% { opacity: 1; transform: translate(0); } 20% { opacity: 0.8; transform: translate(-2px, 2px); } 40% { opacity: 1; transform: translate(2px, -2px); } 60% { opacity: 0.9; transform: translate(-1px, 1px); } 80% { opacity: 1; transform: translate(1px, -1px); } 100% { opacity: 1; transform: translate(0); } }

        /* VS Animation */
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes zoomInBounce { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }

        /* --- PREMIUM ANIMATIONS & STYLES --- */
        /* Medical Theme */
        .bg-medical { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); position: relative; overflow: hidden; }
        .bg-medical::before { content: '‚úö'; position: absolute; font-size: 40px; color: rgba(14, 165, 233, 0.2); animation: float 3s infinite; top: 10px; left: 10px; }
        .bg-medical::after { content: 'üíä'; position: absolute; font-size: 30px; opacity: 0.3; animation: spin-slow 10s infinite; bottom: 10px; right: 10px; }
        
        /* Law Theme */
        .bg-law { background: linear-gradient(135deg, #fef3c7 0%, #d97706 100%); position: relative; overflow: hidden; }
        .bg-law::before { content: '‚öñÔ∏è'; position: absolute; font-size: 40px; opacity: 0.3; animation: float 4s infinite; top: 5px; right: 20px; }
        .bg-law::after { content: 'üìú'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 5s infinite reverse; bottom: 5px; left: 20px; }

        /* Education Theme */
        .bg-edu { background: linear-gradient(135deg, #dcfce7 0%, #4ade80 100%); position: relative; overflow: hidden; }
        .bg-edu::before { content: 'üìö'; position: absolute; font-size: 35px; opacity: 0.3; animation: float 3s infinite; top: 10px; left: 20px; }
        .bg-edu::after { content: '‚úèÔ∏è'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 4s infinite reverse; bottom: 10px; right: 20px; }

        /* Engineering Theme */
        .bg-eng { background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); position: relative; overflow: hidden; }
        .bg-eng::before { content: 'üìê'; position: absolute; font-size: 35px; opacity: 0.3; animation: spin-slow 8s infinite; top: 5px; left: 10px; }
        .bg-eng::after { content: '‚öôÔ∏è'; position: absolute; font-size: 40px; opacity: 0.2; animation: spin-slow 4s infinite reverse; bottom: 5px; right: 10px; }

        /* Smart Theme */
        .bg-smart { background: linear-gradient(135deg, #ffedd5 0%, #fb923c 100%); position: relative; overflow: hidden; }
        .bg-smart::before { content: 'üí°'; position: absolute; font-size: 40px; opacity: 0.4; animation: pulse-border 2s infinite; top: 10px; right: 10px; }
        .bg-smart::after { content: 'üß†'; position: absolute; font-size: 30px; opacity: 0.3; animation: float 3s infinite; bottom: 10px; left: 10px; }

        /* Love Theme */
        .bg-love { background: linear-gradient(135deg, #fce7f3 0%, #f472b6 100%); position: relative; overflow: hidden; }
        .bg-love::before { content: '‚ù§'; position: absolute; font-size: 20px; color: rgba(255,255,255,0.6); animation: float 2s infinite; top: 20px; left: 20%; }
        .bg-love::after { content: 'üíñ'; position: absolute; font-size: 30px; opacity: 0.5; animation: float 3s infinite reverse; bottom: 10px; right: 20%; }

        /* Default Rank BG */
        .bg-rank-default { background: white; }

        /* Badge Styles */
        .premium-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.6rem;
            font-weight: bold;
            margin-right: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            vertical-align: middle;
        }

        /* --- Components --- */
        .auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex;
            align-items: center; justify-content: center;
        }

        .input-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px;
            padding: 14px; width: 100%; outline: none; font-size: 1rem; transition: border-color 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: white; }

        .btn-main {
            background: var(--primary); color: white; padding: 14px;
            border-radius: 12px; font-weight: bold; width: 100%;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); transition: transform 0.1s, background-color 0.2s;
            text-align: center; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:hover { background-color: var(--primary-dark); }

        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item { position: relative; transition: all 0.2s; } 
        
        .stat-btn {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.2s; position: relative; cursor: pointer;
        }
        .stat-btn:active { transform: scale(0.98); background-color: #f9fafb; }

        .red-dot {
            position: absolute; top: -2px; right: 25%;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .red-dot.visible { display: block; }
        .btn-dot {
            position: absolute; top: 0; right: 0;
            width: 10px; height: 10px; background-color: #ef4444;
            border-radius: 50%; border: 2px solid white;
            display: none; z-index: 50;
        }
        .btn-dot.visible { display: block; }

        /* Hacker Intro Styles */
        .hacker-avatar {
            font-size: 80px;
            color: #1e293b;
            position: relative;
            animation: float 3s ease-in-out infinite;
            margin-bottom: 20px;
        }
        .hacker-avatar .fa-user-secret {
            filter: drop-shadow(0 0 15px rgba(79, 70, 229, 0.5));
        }
        .hacker-text-intro {
            font-size: 2.5rem; font-weight: 900;
            background: linear-gradient(to right, #4F46E5, #9333EA);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            animation: glitch 3s infinite;
        }

        .auth-tabs {
            display: flex; background: #f1f5f9; padding: 4px;
            border-radius: 14px; margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1; text-align: center; padding: 10px;
            font-weight: bold; color: #64748b; cursor: pointer;
            border-radius: 10px; transition: all 0.3s; font-size: 0.95rem;
        }
        .auth-tab.active {
            background: white; color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- PREMIUM FRAMES STYLES --- */
        .profile-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 130%;
            height: 130%;
            pointer-events: none;
            z-index: 5;
            border-radius: 50%;
            overflow: hidden;
        }

        /* Frame 1: Royal Gold */
        .frame-royal-gold {
            border: 8px solid transparent;
            background: 
                radial-gradient(circle at 30% 30%, rgba(255, 215, 0, 0.8) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(218, 165, 32, 0.7) 0%, transparent 50%),
                linear-gradient(45deg, #FFD700, #DAA520, #B8860B, #FFD700);
            background-clip: padding-box, border-box;
            box-shadow: 
                0 0 50px rgba(255, 215, 0, 0.8),
                inset 0 0 40px rgba(255, 215, 0, 0.4),
                0 0 0 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .frame-royal-gold::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            bottom: -20px;
            background: 
                radial-gradient(circle at 50% 50%, transparent 30%, rgba(255, 215, 0, 0.3) 70%),
                repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 215, 0, 0.2) 10px, rgba(255, 215, 0, 0.2) 20px);
            border-radius: 50%;
            animation: spin-slow 20s linear infinite;
            z-index: -1;
        }

        .frame-royal-gold::after {
            content: 'üëë';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            animation: float 2s ease-in-out infinite;
        }

        /* Frame 2: Crystal Magic */
        .frame-crystal-magic {
            border: 8px solid transparent;
            background: 
                linear-gradient(135deg, 
                    rgba(0, 255, 255, 0.3) 0%,
                    rgba(138, 43, 226, 0.3) 25%,
                    rgba(75, 0, 130, 0.3) 50%,
                    rgba(0, 191, 255, 0.3) 75%,
                    rgba(0, 255, 255, 0.3) 100%);
            background-clip: border-box;
            box-shadow: 
                0 0 60px rgba(0, 255, 255, 0.6),
                inset 0 0 50px rgba(138, 43, 226, 0.4),
                0 0 0 6px rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .frame-crystal-magic::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            background: 
                radial-gradient(circle at 30% 30%, rgba(0, 255, 255, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(138, 43, 226, 0.4) 0%, transparent 50%);
            border-radius: 50%;
            animation: pulse-border 3s infinite;
            z-index: -1;
        }

        .frame-crystal-magic .crystal-sparkles {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 20%, white 2px, transparent 3px),
                radial-gradient(circle at 80% 30%, white 2px, transparent 3px),
                radial-gradient(circle at 40% 70%, white 2px, transparent 3px),
                radial-gradient(circle at 60% 80%, white 2px, transparent 3px);
            background-size: 100% 100%;
            animation: sparkle 4s linear infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Frame 3: Gemstone Sparkle */
        .frame-gemstone-sparkle {
            border: 8px solid transparent;
            background: 
                linear-gradient(45deg, 
                    #FF1493 0%, 
                    #00BFFF 25%, 
                    #32CD32 50%, 
                    #FFD700 75%, 
                    #FF1493 100%);
            background-clip: border-box;
            box-shadow: 
                0 0 70px rgba(255, 20, 147, 0.7),
                inset 0 0 60px rgba(0, 191, 255, 0.5),
                0 0 0 5px rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .frame-gemstone-sparkle::before {
            content: 'üíé';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 35px;
            filter: drop-shadow(0 0 15px rgba(255, 20, 147, 0.8));
            animation: bounce 2s infinite;
        }

        .frame-gemstone-sparkle .gem-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, #FF1493 3px, transparent 4px),
                radial-gradient(circle at 75% 25%, #00BFFF 3px, transparent 4px),
                radial-gradient(circle at 25% 75%, #32CD32 3px, transparent 4px),
                radial-gradient(circle at 75% 75%, #FFD700 3px, transparent 4px);
            animation: spin-slow 10s linear infinite;
        }

        /* Frame 4: Ice Glass */
        .frame-ice-glass {
            border: 10px solid rgba(173, 216, 230, 0.3);
            background: 
                linear-gradient(135deg, 
                    rgba(240, 248, 255, 0.8) 0%,
                    rgba(173, 216, 230, 0.6) 25%,
                    rgba(135, 206, 235, 0.8) 50%,
                    rgba(176, 224, 230, 0.6) 75%,
                    rgba(240, 248, 255, 0.8) 100%);
            background-clip: border-box;
            box-shadow: 
                0 0 80px rgba(135, 206, 235, 0.8),
                inset 0 0 70px rgba(255, 255, 255, 0.6),
                0 0 0 8px rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            position: relative;
        }

        .frame-ice-glass::before {
            content: '‚ùÑÔ∏è';
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            filter: drop-shadow(0 0 10px rgba(135, 206, 235, 0.8));
            animation: spin-slow 8s linear infinite;
        }

        /* Frame 5: Angel Wings */
        .frame-angel-wings {
            border: 8px solid rgba(255, 255, 255, 0.9);
            background: 
                radial-gradient(circle at center, 
                    rgba(255, 255, 255, 0.9) 0%,
                    rgba(230, 230, 250, 0.7) 50%,
                    rgba(216, 191, 216, 0.5) 100%);
            background-clip: border-box;
            box-shadow: 
                0 0 90px rgba(255, 255, 255, 0.9),
                inset 0 0 80px rgba(255, 255, 255, 0.7),
                0 0 0 10px rgba(255, 255, 255, 0.4);
            position: relative;
        }

        .frame-angel-wings::before {
            content: 'üëº';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 45px;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.9));
            animation: float 3s ease-in-out infinite;
        }

        .frame-angel-wings .wing-effect {
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
            background: 
                radial-gradient(circle at 30% 50%, rgba(255, 255, 255, 0.4) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(255, 255, 255, 0.4) 0%, transparent 50%);
            animation: pulse-border 4s infinite;
        }

        /* Frame 6: Imperial Crown */
        .frame-imperial-crown {
            border: 12px solid transparent;
            background: 
                linear-gradient(45deg, 
                    #C0C0C0 0%,
                    #FFD700 15%,
                    #D4AF37 30%,
                    #C0C0C0 45%,
                    #FFD700 60%,
                    #D4AF37 75%,
                    #C0C0C0 90%);
            background-clip: border-box;
            box-shadow: 
                0 0 100px rgba(212, 175, 55, 0.9),
                inset 0 0 90px rgba(255, 215, 0, 0.7),
                0 0 0 12px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .frame-imperial-crown::before {
            content: 'üëëüëë';
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 50px;
            filter: drop-shadow(0 0 25px rgba(212, 175, 55, 0.9));
            animation: bounce 3s infinite;
        }

        /* Frame 7: Magic Energy */
        .frame-magic-energy {
            border: 8px solid transparent;
            background: 
                linear-gradient(45deg, 
                    #00FF00 0%,
                    #00FFFF 25%,
                    #FF00FF 50%,
                    #FFFF00 75%,
                    #00FF00 100%);
            background-clip: border-box;
            box-shadow: 
                0 0 110px rgba(0, 255, 0, 0.7),
                inset 0 0 100px rgba(0, 255, 255, 0.6),
                0 0 0 8px rgba(255, 255, 255, 0.2);
            position: relative;
            animation: energy-pulse 2s infinite;
        }

        @keyframes energy-pulse {
            0%, 100% { 
                box-shadow: 
                    0 0 110px rgba(0, 255, 0, 0.7),
                    inset 0 0 100px rgba(0, 255, 255, 0.6),
                    0 0 0 8px rgba(255, 255, 255, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 130px rgba(0, 255, 0, 0.9),
                    inset 0 0 120px rgba(0, 255, 255, 0.8),
                    0 0 0 12px rgba(255, 255, 255, 0.4);
            }
        }

        .frame-magic-energy::before {
            content: '‚ö°';
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 55px;
            filter: drop-shadow(0 0 20px rgba(0, 255, 0, 0.9));
            animation: pulse-border 1s infinite;
        }

        /* Frame 8: Legendary Fire */
        .frame-legendary-fire {
            border: 10px solid transparent;
            background: 
                linear-gradient(45deg, 
                    #FF0000 0%,
                    #FF4500 25%,
                    #FF8C00 50%,
                    #FFD700 75%,
                    #FF0000 100%);
            background-clip: border-box;
            box-shadow: 
                0 0 120px rgba(255, 69, 0, 0.9),
                inset 0 0 110px rgba(255, 140, 0, 0.8),
                0 0 0 10px rgba(255, 0, 0, 0.3);
            position: relative;
        }

        .frame-legendary-fire::before {
            content: 'üî•';
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 60px;
            filter: drop-shadow(0 0 30px rgba(255, 69, 0, 0.9));
            animation: fire-burn 1.5s infinite;
        }

        @keyframes fire-burn {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); }
        }

        .frame-legendary-fire .fire-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 69, 0, 0.8) 4px, transparent 5px),
                radial-gradient(circle at 80% 30%, rgba(255, 140, 0, 0.8) 4px, transparent 5px),
                radial-gradient(circle at 40% 70%, rgba(255, 0, 0, 0.8) 4px, transparent 5px),
                radial-gradient(circle at 60% 80%, rgba(255, 215, 0, 0.8) 4px, transparent 5px);
            animation: spin-slow 15s linear infinite;
        }

        /* Image Container with Frame */
        .image-frame-container {
            position: relative;
            display: inline-block;
            border-radius: 50%;
            overflow: hidden;
        }

        .image-frame-container img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: relative;
            z-index: 2;
        }

        /* RANKING FRAMES & RAYS */
        .rank-img-container { 
            position: relative; display: flex; align-items: center; justify-content: center;
            width: 70px; height: 70px; margin-right: 5px;
        }
        .rank-img { 
            width: 56px; height: 56px; border-radius: 50%; object-fit: cover;
            position: relative; z-index: 5;
        }
        .rank-badge-top {
            position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; font-size: 10px; font-weight: 900;
            padding: 2px 6px; border-radius: 8px; border: 2px solid white; z-index: 20;
            min-width: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .rank-rays {
            position: absolute; inset: 0; border-radius: 50%; z-index: 1; 
            animation: spin-slow 10s linear infinite;
            mask-image: radial-gradient(transparent 58%, black 60%); 
            -webkit-mask-image: radial-gradient(transparent 58%, black 60%);
            opacity: 0.8;
        }
        .rays-gold { background: repeating-conic-gradient(from 0deg, #FFD700 0deg 10deg, transparent 10deg 20deg); }
        .rays-silver { background: repeating-conic-gradient(from 0deg, #C0C0C0 0deg 10deg, transparent 10deg 20deg); }
        .rays-bronze { background: repeating-conic-gradient(from 0deg, #CD7F32 0deg 10deg, transparent 10deg 20deg); }
        .rays-blue { background: repeating-conic-gradient(from 0deg, #3b82f6 0deg 10deg, transparent 10deg 20deg); }
        .rays-red { background: repeating-conic-gradient(from 0deg, #ef4444 0deg 10deg, transparent 10deg 20deg); }
        .rays-green { background: repeating-conic-gradient(from 0deg, #22c55e 0deg 10deg, transparent 10deg 20deg); }
        .rays-purple { background: repeating-conic-gradient(from 0deg, #a855f7 0deg 10deg, transparent 10deg 20deg); }
        
        .frame-rank-1 { border: 3px solid #FFD700; }
        .frame-rank-2 { border: 3px solid #C0C0C0; }
        .frame-rank-3 { border: 3px solid #CD7F32; }
        .frame-rank-common { border: 2px solid #e2e8f0; }
        .frame-rank-other-top { border: 2px solid #6366f1; }
        .name-crown { margin-right: 6px; font-size: 14px; animation: bounce 2s infinite; display: inline-block; }

        /* --- Daily Reward --- */
        .reward-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .reward-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px; }
        .day-box {
            background: #f1f5f9; border-radius: 8px; padding: 6px 2px;
            text-align: center; position: relative; border: 2px solid transparent;
            transition: all 0.2s; display: flex; flex-direction: column;
            align-items: center; justify-content: center; min-height: 50px;
        }
        .day-box p { font-size: 0.6rem; color: #94a3b8; font-weight: bold; margin-bottom: 2px; }
        .day-box span { font-size: 0.7rem; font-weight: 900; display: block; line-height: 1.1; }
        .day-box.claimed { background: #10B981; border-color: #059669; }
        .day-box.claimed p, .day-box.claimed span { color: white; }
        .day-box.claimed::after { content: '‚úî'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.3); font-size: 20px; }
        .day-box.active { background: #FFFBEB; border-color: #F59E0B; transform: scale(1.05); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); z-index: 10; }
        .day-box.active span { color: #D97706; }
        .day-box.active p { color: #D97706; }
        .day-box.locked { opacity: 0.6; }

        /* --- Maintenance Modal --- */
        .new-maintenance-overlay {
            position: fixed; inset: 0; z-index: 11000;
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(15px);
            display: flex; align-items: center; justify-content: center;
        }
        .new-maintenance-card {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 32px;
            padding: 40px 30px;
            width: 90%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.8);
            position: relative; overflow: hidden;
            animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .maint-icon-wrapper {
            position: relative; z-index: 1;
            width: 100px; height: 100px; margin: 0 auto 20px;
            background: linear-gradient(135deg, #EF4444 0%, #B91C1C 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.5);
            border: 4px solid white;
        }
        .maint-icon-wrapper i { font-size: 40px; color: white; animation: pulse-border 2s infinite; }
        .maint-title { 
            position: relative; z-index: 1; 
            font-size: 1.8rem; font-weight: 900; color: #1e293b; margin-bottom: 10px; 
            background: linear-gradient(to right, #EF4444, #B91C1C);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- Ban Overlay --- */
        .ban-overlay {
            position: fixed; inset: 0; z-index: 20000;
            background: #0f172a;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: white; padding: 20px;
        }
        .ban-icon { font-size: 80px; color: #ef4444; margin-bottom: 20px; }

        /* Toggle Switch */
        .toggle-wrapper { position: relative; width: 50px; height: 26px; }
        .toggle-checkbox { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #9CA3AF; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-checkbox:checked + .toggle-slider { background-color: #10B981; }
        .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(24px); }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            z-index: 12000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: 20px; padding: 20px; overflow-y: auto;
            animation: slideUp 0.3s ease-out; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* Answer Colors */
        .answer-correct { background: #DCFCE7 !important; border-color: #22C55E !important; color: #166534 !important; position: relative; }
        .answer-correct::after { content: '‚úì'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #22C55E; }
        .answer-wrong { background: #FEE2E2 !important; border-color: #EF4444 !important; color: #991B1B !important; position: relative; }
        .answer-wrong::after { content: '‚úó'; position: absolute; left: 15px; font-size: 1.2rem; font-weight: bold; color: #EF4444; }
        .answer-neutral { background: white !important; border-color: #E5E7EB !important; color: #374151 !important; }

        /* --- Countdown Timer --- */
        .countdown-container {
            background: linear-gradient(to right, #1e293b, #0f172a);
            color: white; padding: 10px; border-radius: 12px;
            margin-bottom: 15px; text-align: center;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }
        .timer-digits { font-family: monospace; font-size: 1.5rem; font-weight: bold; color: #ffd700; letter-spacing: 2px; }

        /* --- VS Screen & Avatar Styles --- */
        .vs-screen-overlay {
            position: fixed; inset: 0; z-index: 15000;
            background: radial-gradient(circle at center, #2e1065, #0f172a);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .vs-player-card {
            display: flex; flex-direction: column; align-items: center;
            z-index: 10;
        }
        .vs-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            border: 4px solid #fff; box-shadow: 0 0 20px rgba(79, 70, 229, 0.6);
            object-fit: cover; background: #fff;
        }
        .vs-text { font-size: 5rem; font-weight: 900; color: #ffd700; text-shadow: 0 0 30px #d97706; font-style: italic; z-index: 20; }
        .animate-slide-left { animation: slideInLeft 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide-right { animation: slideInRight 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-zoom-bounce { animation: zoomInBounce 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        
        .game-avatar-small {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;
            object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; vertical-align: middle;
        }

        /* --- Room System Styles --- */
        .room-code-display {
            font-family: monospace;
            font-size: 2rem;
            font-weight: 900;
            letter-spacing: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding: 10px 20px;
            border: 3px dashed #667eea;
            border-radius: 15px;
            text-align: center;
            margin: 20px auto;
            display: inline-block;
        }

        .ready-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .ready-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .ready-btn:active {
            transform: translateY(0);
        }

        .ready-btn.not-ready {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .room-user-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .room-user-card.ready {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .room-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #e5e7eb;
            object-fit: cover;
        }

        .room-user-card.ready .room-user-avatar {
            border-color: #10b981;
        }

        .room-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        /* --- Beautiful Modal Styles --- */
        .beautiful-modal {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 25px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
            overflow: hidden;
        }

        .beautiful-modal::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            border-radius: 0 25px 0 100px;
            opacity: 0.1;
        }

        .beautiful-modal h3 {
            color: #1e293b;
            font-weight: 900;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .beautiful-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }

        .beautiful-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }

        .beautiful-btn:active {
            transform: translateY(0);
        }

        .beautiful-btn.secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        /* --- Withdraw Button Styles --- */
        .withdraw-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .withdraw-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .withdraw-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        /* --- Premium Timer Styles --- */
        .premium-timer-container {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #f59e0b;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .premium-timer-digits {
            font-family: monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: #fbbf24;
            letter-spacing: 3px;
        }

        /* --- Beautiful Alert Styles --- */
        .beautiful-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            border: 2px solid #e5e7eb;
            z-index: 20000;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        .beautiful-alert-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .beautiful-alert.success .beautiful-alert-icon {
            color: #10b981;
        }

        .beautiful-alert.error .beautiful-alert-icon {
            color: #ef4444;
        }

        .beautiful-alert.warning .beautiful-alert-icon {
            color: #f59e0b;
        }

        .beautiful-alert-info .beautiful-alert-icon {
            color: #3b82f6;
        }

        .beautiful-alert h3 {
            color: #1e293b;
            font-weight: 900;
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .beautiful-alert p {
            color: #64748b;
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .beautiful-alert-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .beautiful-alert-btn:hover {
            opacity: 0.9;
        }

        /* --- Result Screen Styles --- */
        .result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
        }

        .result-emoji {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .result-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-subtitle {
            font-size: 1.2rem;
            color: #64748b;
            margin-bottom: 30px;
            font-weight: 500;
        }

        .result-score-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin: 30px 0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .result-player {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .result-player-name {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .result-player-score {
            font-size: 3rem;
            font-weight: 900;
            color: #4f46e5;
        }

        .result-player.op .result-player-score {
            color: #ef4444;
        }

        .result-vs {
            font-size: 1.5rem;
            font-weight: 900;
            color: #94a3b8;
            margin: 0 20px;
        }

        .result-points-gained {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1.5rem;
            color: #92400e;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- Banned Users List Styles --- */
        .banned-user-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid #fee2e2;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .banned-user-info {
            flex: 1;
        }

        .banned-user-name {
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .banned-user-id {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .unban-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .unban-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        /* --- Notifications Button Styles --- */
        .notifications-btn {
            position: absolute;
            top: 35px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 40;
            transition: all 0.3s;
        }

        .notifications-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .notifications-btn .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .notifications-btn.pulse {
            animation: pulse-border 1.5s infinite;
        }

        /* --- Friend Request Button --- */
        .friend-request-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            transition: all 0.3s;
        }

        .friend-request-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .friend-request-btn.sent {
            background: #10b981;
        }

        .friend-request-btn.sent:hover {
            background: #059669;
        }

        /* --- Bio Edit Styles --- */
        .bio-edit-btn {
            color: #4f46e5;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f1f5f9;
        }

        .bio-edit-btn:hover {
            background: #e0e7ff;
            transform: scale(1.1);
        }

        .bio-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            vertical-align: middle;
        }

        /* --- Game Connection Indicator --- */
        .connection-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .connection-indicator.good {
            background: rgba(34, 197, 94, 0.7);
        }

        .connection-indicator.poor {
            background: rgba(245, 158, 11, 0.7);
        }

        .connection-indicator.bad {
            background: rgba(239, 68, 68, 0.7);
            animation: pulse-border 1s infinite;
        }

        /* --- Game Resume Modal --- */
        .game-resume-modal {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
        }

        .game-resume-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #4f46e5;
            border-radius: 25px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            color: white;
        }

        /* --- Image Loading Styles --- */
        .image-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- Friends List Styles --- */
        .friend-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }

        .friend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }

        .friend-item.online {
            border-left: 4px solid #10b981;
        }

        .friend-item.offline {
            border-left: 4px solid #94a3b8;
        }

        .friend-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .friend-status.online {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .friend-status.offline {
            background: #94a3b8;
        }

        /* --- Invite Friends Modal --- */
        .invite-friends-modal {
            max-height: 70vh;
            overflow-y: auto;
        }

        .invite-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .invite-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .invite-btn.disabled {
            background: #94a3b8;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .invite-btn.disabled:hover {
            transform: none;
            background: #94a3b8;
        }

        @media (min-width: 768px) {
            .input-box { font-size: 1.1rem; }
            .auth-overlay > div { max-width: 500px; }
            .notifications-btn { top: 30px; left: 30px; }
        }
    </style>
</head>
<body>

    <!-- 0. BANNED SCREEN -->
    <div id="ban-screen" class="ban-overlay hidden">
        <i class="fas fa-ban ban-icon"></i>
        <h1 class="text-3xl font-black mb-4">ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿ≠ÿ≥ÿßÿ®ŸÉ</h1>
        <p class="text-gray-400 mb-6">ŸÑŸÇÿØ ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿ¨Ÿáÿßÿ≤ŸÉ Ÿàÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ÿ¥ŸÉŸÑ ŸÜŸáÿßÿ¶Ÿä ŸÑÿßŸÜÿ™ŸáÿßŸÉ ÿßŸÑÿ¥ÿ±Ÿàÿ∑.</p>
        <div class="bg-red-900 bg-opacity-50 p-4 rounded-xl border border-red-700">
            <p class="text-red-300 text-sm font-bold">ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°</p>
        </div>
    </div>

    <!-- 1. INTRO SCREEN -->
    <div id="intro-screen" class="auth-overlay flex-col bg-slate-50" style="z-index: 10000;">
        <div class="hacker-avatar">
            <i class="fas fa-user-secret"></i>
        </div>
        <h1 class="hacker-text-intro mb-6">ŸáŸÉÿ± ÿßŸÑŸàÿ≤ÿßÿ±Ÿä</h1>
        <div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden relative">
            <div class="absolute top-0 left-0 h-full bg-indigo-600 animate-[width_2s_ease-out_forwards]" style="width: 0%; animation-name: loadBar; animation-duration: 2s; animation-fill-mode: forwards;"></div>
        </div>
        <p class="mt-4 text-gray-500 font-bold text-sm tracking-widest animate-pulse">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±...</p>
        <style> @keyframes loadBar { 0% { width: 0%; } 100% { width: 100%; } } </style>
    </div>

    <!-- 1.5 VS SCREEN -->
    <div id="vs-screen" class="vs-screen-overlay hidden">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
        <div class="flex items-center justify-center gap-6 w-full max-w-lg relative">
            <div class="vs-player-card animate-slide-left">
                <div class="image-frame-container" style="width: 100px; height: 100px;">
                    <img id="vs-p1-img" src="" class="vs-avatar">
                </div>
                <p id="vs-p1-name" class="text-white font-bold text-lg text-center truncate w-32 mt-3"></p>
            </div>
            
            <div class="vs-text animate-zoom-bounce">VS</div>
            
            <div class="vs-player-card animate-slide-right">
                <div class="image-frame-container" style="width: 100px; height: 100px;">
                    <img id="vs-p2-img" src="" class="vs-avatar">
                </div>
                <p id="vs-p2-name" class="text-white font-bold text-lg text-center truncate w-32 mt-3"></p>
            </div>
        </div>
        <p class="text-indigo-300 font-bold mt-10 tracking-widest animate-pulse">ÿ¨ÿßÿ±Ÿä ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ÿØŸä...</p>
    </div>

    <!-- 2. DAILY REWARD POPUP -->
    <div id="daily-reward-screen" class="fixed inset-0 reward-overlay z-[9000] hidden flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative overflow-hidden animate-[slideUp_0.4s_ease-out]">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-indigo-800">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ÿßŸÑŸäŸàŸÖŸä üìÖ</h2>
                <p class="text-xs text-gray-500">ÿßŸÑÿ™ŸàŸÇŸäÿ™ ÿ≠ÿ≥ÿ® ÿ®ÿ∫ÿØÿßÿØ (12:00 ÿµ)</p>
            </div>
            <div id="reward-grid-container" class="reward-grid"></div>
            <div class="text-center mt-6">
                <button onclick="claimReward()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                      <span>ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑŸáÿØŸäÿ©</span>
                      <i class="fas fa-gift animate-bounce"></i>
                </button>
            </div>
            <button onclick="document.getElementById('daily-reward-screen').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 3. MAINTENANCE MODAL -->
    <div id="maintenance-popup" class="new-maintenance-overlay hidden">
        <div class="new-maintenance-card">
            <div class="maint-icon-wrapper"><i class="fas fa-tools"></i></div>
            <h2 class="maint-title">ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ™ÿ≠ÿ™ ÿßŸÑÿµŸäÿßŸÜÿ©</h2>
            <p class="text-sm text-red-500 font-bold mb-6 tracking-wide uppercase">System Maintenance</p>
            <div class="bg-white/90 border border-slate-200 rounded-2xl p-5 mb-6 text-slate-700 font-bold leading-relaxed">
                <p id="maintenance-msg-display">ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©...</p>
            </div>
            <button onclick="closeMaintenancePopup()" class="bg-slate-800 text-white px-8 py-4 rounded-full font-bold text-lg hover:scale-105 transition shadow-xl w-full flex items-center justify-center gap-2">
                <i class="fas fa-check-circle"></i> ÿ≠ÿ≥ŸÜÿß
            </button>
        </div>
    </div>

    <!-- 4. FORGOT PASSWORD MODAL -->
    <div id="forgot-password-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-3xl p-8 w-11/12 max-w-sm shadow-2xl animate-[slideUp_0.2s_ease-out]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-key text-2xl text-white"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800">ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</h3>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-2">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                <input type="email" id="forgot-email" placeholder="ÿ£ÿØÿÆŸÑ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿßŸÑŸÖÿ≥ÿ¨ŸÑ" class="input-box">
                <p class="text-xs bg-yellow-50 text-yellow-700 p-2 rounded mt-2 border border-yellow-200">ÿ™ŸÜÿ®ŸäŸá: ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÖŸÉŸÜ ÿ™ŸàÿµŸÑ "ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ±ÿ∫Ÿàÿ® ŸÅŸäŸáÿß"</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeForgotPassword()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button onclick="sendResetLink()" class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-3 rounded-xl font-bold shadow-md hover:opacity-90 transition">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
            </div>
        </div>
    </div>

    <!-- 5. AUTH SCREEN -->
    <div id="auth-screen" class="auth-overlay hidden">
        <div class="w-full max-w-md p-8 h-full overflow-y-auto flex flex-col justify-center">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-indigo-600 mb-2">ŸáŸÉÿ± ÿßŸÑŸàÿ≤ÿßÿ±Ÿä</h1>
                <p class="text-gray-500 text-sm">ÿ®Ÿàÿßÿ®ÿ™ŸÉ ŸÑŸÑÿ™ŸÅŸàŸÇ ŸÅŸä ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™ ÿßŸÑŸàÿ≤ÿßÿ±Ÿäÿ©</p>
            </div>
            <div class="auth-tabs">
                <div id="tab-login-btn" onclick="switchAuthTab('login')" class="auth-tab active">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</div>
                <div id="tab-signup-btn" onclick="switchAuthTab('signup')" class="auth-tab">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®</div>
            </div>

            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                        <input type="email" id="login-email" placeholder="example@gmail.com" class="input-box" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 mr-1">ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                        <input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input-box" required>
                    </div>
                </div>
                <button type="submit" class="btn-main mt-8">ÿØÿÆŸàŸÑ</button>
                <div class="text-center mt-4">
                    <button type="button" onclick="openForgotPassword()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium hover:underline">ŸáŸÑ ŸÜÿ≥Ÿäÿ™ ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±ÿü</button>
                </div>
            </form>

            <form id="signup-form" class="hidden" onsubmit="event.preventDefault(); handleSignup();">
                <div class="flex justify-center mb-6">
                    <div class="relative cursor-pointer group" onclick="document.getElementById('signup-img').click()">
                        <div class="image-frame-container" style="width: 96px; height: 96px;">
                            <img id="preview-img" src="https://ui-avatars.com/api/?name=User&background=random&size=128" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full flex items-center justify-center text-white border-2 border-white shadow-sm">
                            <i class="fas fa-camera text-xs"></i>
                        </div>
                    </div>
                    <input type="file" id="signup-img" hidden accept="image/*" onchange="handleImagePreview(this)">
                </div>
                <div class="space-y-3">
                    <div><input type="text" id="signup-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ∏ÿßŸáÿ±" class="input-box" required></div>
                    <div><input type="email" id="signup-email" placeholder="ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä (@gmail.com)" class="input-box" required></div>
                    <div><input type="password" id="signup-pass" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± (6+ ÿ£ÿ≠ÿ±ŸÅ)" class="input-box" required></div>
                </div>
                <button type="submit" class="btn-main mt-6 bg-indigo-600">ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ</button>
                <p class="text-xs text-center text-gray-400 mt-4">ÿ®ÿ•ŸÖŸÉÿßŸÜŸÉ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ ŸÑŸÑÿ¨Ÿáÿßÿ≤</p>
            </form>
        </div>
    </div>

    <!-- 6. MAIN APP CONTAINER -->
    <div id="main-app" class="hidden w-full h-full relative">
        
        <!-- HEADER -->
        <div class="absolute top-0 w-full h-20 bg-white/95 backdrop-blur-sm shadow-sm z-30 flex items-center justify-between px-5 pt-2">
            <div>
                <h1 class="font-black text-lg text-indigo-900">ŸáŸÉÿ± ÿßŸÑŸàÿ≤ÿßÿ±Ÿä</h1>
                <p id="header-grade-badge" class="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full hidden">...</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="add-subscription-btn" class="hidden bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm hover:shadow-md transition">+ ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ¥ÿ™ÿ±ÿßŸÉ</button>
                <div class="bg-yellow-50 px-3 py-1 rounded-full border border-yellow-100 flex items-center gap-2 shadow-sm">
                    <span id="header-points" class="font-bold text-yellow-700">0</span>
                    <i class="fas fa-gem text-yellow-500"></i>
                </div>
            </div>
        </div>

        <!-- Notifications Button -->
        <div id="notifications-btn" class="notifications-btn hidden" onclick="openNotifications()">
            <i class="fas fa-bell text-indigo-600"></i>
            <div id="notification-badge" class="notification-badge hidden">0</div>
        </div>

        <!-- === TABS === -->

        <!-- TAB 1: CHALLENGES -->
        <div id="tab-challenges" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <!-- Select Grade First Time -->
                <div id="grade-selector-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 border border-gray-100">
                    <div class="text-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-school text-xl"></i></div>
                        <h3 class="font-bold text-gray-800">ÿ≠ÿØÿØ ŸÖÿ±ÿ≠ŸÑÿ™ŸÉ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©</h3>
                        <p class="text-xs text-gray-400">Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØŸáÿß ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑</p>
                    </div>
                    <select id="grade-select" class="input-box mb-4 text-center">
                        <option value="">-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© --</option>
                        <option value="6sci">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä</option>
                        <option value="6lit">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿ£ÿØÿ®Ÿä</option>
                        <option value="3med">ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                    </select>
                    <button onclick="saveUserGrade()" class="btn-main py-3 text-sm">ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©</button>
                </div>

                <!-- Active Challenge Card -->
                <div id="challenge-active-card" class="bg-white p-6 rounded-2xl shadow-sm mb-6 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 border-r-4 border-indigo-500 pr-3">ÿ®ÿØÿ° ÿ™ÿ≠ÿØŸä ÿ¨ÿØŸäÿØ üî•</h3>
                    <label class="block text-sm font-bold text-gray-600 mb-2">ÿßŸÑŸÖÿßÿØÿ©</label>
                    <select id="challenge-subject" class="input-box mb-4 bg-gray-50"></select>

                    <label class="block text-sm font-bold text-gray-600 mb-2">ŸÜŸàÿπ ÿßŸÑÿ™ÿ≠ÿØŸä</label>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="setQType('mcq')" id="btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™</button>
                        <button onclick="setQType('tf')" id="btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ÿµÿ≠ ŸàÿÆÿ∑ÿ£</button>
                    </div>

                    <button onclick="startMatchmaking('online')" class="btn-main bg-gradient-to-r from-indigo-600 to-purple-600 mb-4 h-12">
                        <i class="fas fa-user-graduate ml-2"></i> ÿßŸÑŸÑÿπÿ® ÿ∂ÿØ ÿ∑ÿßŸÑÿ® (ÿ≠ŸÇŸäŸÇŸä)
                    </button>

                    <button onclick="startMatchmaking('ai')" class="btn-main bg-gradient-to-r from-emerald-500 to-green-600 mb-3 h-12">
                        <i class="fas fa-robot ml-2"></i> ÿ∂ÿØ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
                    </button>

                    <!-- ÿ≤ÿ± ÿ™ÿ≠ÿØŸëŸä ÿßŸÑÿ£ÿµÿØŸÇÿßÿ° -->
                    <button onclick="openFriendChallenge()" class="btn-main bg-gradient-to-r from-pink-500 to-rose-600 h-12">
                        <i class="fas fa-users ml-2"></i> ÿ™ÿ≠ÿØŸëŸä ÿßŸÑÿ£ÿµÿØŸÇÿßÿ° (ÿ∫ÿ±ŸÅ)
                    </button>
                </div>

                <!-- Searching UI -->
                <div id="searching-ui" class="hidden flex-col items-center justify-center py-10 min-h-[300px]">
                    <div class="w-24 h-24 rounded-full bg-indigo-50 flex items-center justify-center relative mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-indigo-500 opacity-20 animate-ping"></div>
                        <i class="fas fa-search text-3xl text-indigo-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800" id="search-msg">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...</h3>
                    <button onclick="cancelSearch()" class="mt-8 text-red-500 font-bold text-sm bg-red-50 px-4 py-2 rounded-full">ÿ•ŸÑÿ∫ÿßÿ°</button>
                </div>
            </div>
        </div>

        <!-- GAME OVERLAY -->
        <div id="game-overlay" class="fixed inset-0 bg-gray-50 z-[100] hidden flex-col">
            <!-- Connection Indicator -->
            <div id="connection-indicator" class="connection-indicator hidden">
                <i class="fas fa-wifi"></i>
                <span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ...</span>
            </div>

            <div class="bg-white p-3 shadow-sm flex justify-between items-center z-10 border-b border-gray-100 h-20">
                <!-- Player 1 -->
                <div class="flex items-center gap-2 w-1/3 overflow-hidden">
                    <div class="image-frame-container" style="width: 32px; height: 32px;">
                        <img id="game-p1-img" src="" class="game-avatar-small">
                    </div>
                    <div class="overflow-hidden">
                        <p id="p1-name" class="text-[10px] text-gray-500 font-bold truncate">...</p>
                        <p id="game-my-score" class="text-xl font-black text-indigo-600">0</p>
                    </div>
                    <!-- Friend Request Button for Opponent -->
                    <button id="game-friend-request-btn" class="friend-request-btn hidden" onclick="sendFriendRequestFromGame()">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
                
                <!-- Timer -->
                <div class="w-1/3 flex justify-center">
                    <div id="game-timer" class="w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center font-bold text-md shadow-md">15</div>
                </div>

                <!-- Player 2 -->
                <div class="flex items-center gap-2 w-1/3 overflow-hidden justify-end">
                    <div class="overflow-hidden text-left">
                        <p id="p2-name" class="text-[10px] text-gray-500 font-bold truncate">...</p>
                        <p id="game-op-score" class="text-xl font-black text-red-500">0</p>
                    </div>
                    <div class="image-frame-container" style="width: 32px; height: 32px;">
                        <img id="game-p2-img" src="" class="game-avatar-small">
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 pb-20">
                <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 text-center border-t-4 border-indigo-500 relative mt-4">
                    <span id="q-progress" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-3 py-1 rounded-full">1 / 10</span>
                    <p id="q-text" class="text-lg font-bold text-gray-800 leading-relaxed mt-2">...</p>
                </div>
                <div id="answers-container" class="space-y-3"></div>
                <p id="waiting-msg" class="text-center text-gray-400 text-sm hidden animate-pulse mt-4">ÿ®ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿÆÿµŸÖ...</p>
                <p id="ai-thinking-msg" class="text-center text-green-600 text-sm hidden animate-pulse mt-4 font-bold">ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸäŸÅŸÉÿ±...</p>
            </div>

            <!-- ÿ≤ÿ± ÿßŸÑÿßŸÜÿ≥ÿ≠ÿßÿ® -->
            <button id="withdraw-game-btn" onclick="withdrawFromGame()" class="withdraw-btn hidden">
                <i class="fas fa-sign-out-alt"></i> ÿßŸÜÿ≥ÿ≠ÿßÿ®
            </button>
        </div>

        <!-- POST MATCH RESULT SCREEN -->
        <div id="result-screen" class="fixed inset-0 bg-white z-[200] hidden">
            <div class="result-container">
                <button onclick="closeResultScreen()" class="absolute top-6 right-6 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-gray-200">
                    <i class="fas fa-times"></i>
                </button>
                <div id="result-icon-container" class="result-emoji">üèÜ</div>
                <h2 id="result-title" class="result-title">ŸÖÿ®ÿ±ŸàŸÉ!</h2>
                <p id="result-msg" class="result-subtitle">ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ£ÿØÿßÿ° ÿ±ÿßÿ¶ÿπ</p>
                
                <div class="result-score-container">
                    <div class="result-player">
                        <p class="result-player-name">ÿ£ŸÜÿ™</p>
                        <p id="final-my-score" class="result-player-score">0</p>
                    </div>
                    <div class="result-vs">VS</div>
                    <div class="result-player op">
                        <p id="final-op-name" class="result-player-name">ÿßŸÑÿÆÿµŸÖ</p>
                        <p id="final-op-score" class="result-player-score">0</p>
                    </div>
                </div>
                
                <div class="result-points-gained">
                    <span id="result-points-gained-text">+0</span>
                    <i class="fas fa-gem"></i>
                </div>
                
                <button onclick="closeResultScreen()" class="beautiful-btn">
                    <i class="fas fa-home"></i>
                    <span>ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                </button>
            </div>
        </div>

        <!-- TAB 2: LEADERBOARD -->
        <div id="tab-leaderboard" class="screen pt-20">
            <div class="scroll-container px-4">
                <!-- Weekly Countdown -->
                <div class="countdown-container">
                    <p class="text-xs text-gray-300 mb-1">ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿßÿ≥ÿ®ŸàÿπŸäÿ© üéÅ (ÿßŸÑÿÆŸÖŸäÿ≥ 12:00 ÿµ)</p>
                    <div id="weekly-timer" class="timer-digits">00:00:00:00</div>
                </div>

                <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-4 rounded-2xl mb-4 shadow-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm opacity-90">ÿ™ÿ±ÿ™Ÿäÿ®ŸÉ ÿßŸÑÿ≠ÿßŸÑŸä</p>
                        <h2 id="my-rank-text" class="text-2xl font-bold">#...</h2>
                    </div>
                    <i class="fas fa-trophy text-4xl opacity-50"></i>
                </div>
                <div id="leaderboard-list" class="space-y-4 pb-10 flex flex-col"></div>
            </div>
        </div>

        <!-- TAB 3: STUDY SCHEDULE -->
        <div id="tab-schedule" class="screen pt-20">
            <div class="scroll-container px-5 py-6">
                <section id="schedule-input-page">
                    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6">
                        <header class="text-center mb-4">
                            <div class="inline-block p-2 rounded-full bg-indigo-100 text-primary mb-2">
                                <i class="fa-solid fa-layer-group text-2xl text-indigo-600"></i>
                            </div>
                            <h1 class="text-xl font-bold text-gray-800">ÿ¨ÿØŸàŸÑ ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ÿßŸÑŸäŸàŸÖŸä</h1>
                            <p class="text-xs text-gray-500 mt-1">ÿÆÿ∑ÿ∑ ŸÑÿØÿ±ÿßÿ≥ÿ™ŸÉ ÿ®ÿ∞ŸÉÿßÿ° Ÿàÿ≠ŸÇŸÇ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨!</p>
                        </header>

                        <form onsubmit="handleScheduleFormSubmit(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">ÿßŸÑŸÖÿßÿØÿ©</label>
                                <input type="text" id="subjectName" required placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©..." class="input-box">
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">ÿßŸÑŸÅÿµŸàŸÑ (ÿßŸÑÿ£ÿµÿπÿ® Ÿäÿ£ÿÆÿ∞ ŸàŸÇÿ™ÿßŸã ÿ£ŸÉÿ´ÿ±)</label>
                                <div id="chaptersList" class="space-y-2 max-h-40 overflow-y-auto mb-2"></div>
                                <button type="button" onclick="addChapterRow()" class="w-full py-2 border-2 border-dashed border-indigo-300 text-indigo-500 rounded-xl hover:bg-indigo-50 text-sm font-bold">+ ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿµŸÑ</button>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä (ÿ≥ÿßÿπÿßÿ™)</label>
                                <input type="number" id="totalHours" required min="1" max="999" placeholder="ŸÖÿ´ÿßŸÑ: 10" class="input-box text-center font-bold text-lg">
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label class="block text-gray-700 text-xs font-bold mb-2">ŸàŸÇÿ™ ÿßŸÑŸÜŸàŸÖÿü</label>
                                    <select id="needSleep" class="input-box text-sm font-bold">
                                        <option value="yes">ÿßÿ≠ÿ≥ÿ® ŸàŸÇÿ™ ÿßŸÑŸÜŸàŸÖ</option>
                                        <option value="no">ŸÑÿß ÿ™ÿ≠ÿ≥ÿ®Ÿá</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-xs font-bold mb-2">ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©</label>
                                    <select id="breakDuration" class="input-box text-sm font-bold">
                                        <option value="10">10 ÿØŸÇÿßÿ¶ŸÇ</option>
                                        <option value="15">15 ÿØŸÇŸäŸÇÿ©</option>
                                        <option value="20">20 ÿØŸÇŸäŸÇÿ©</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition-all text-lg">ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ¢ŸÜ</button>
                        </form>
                    </div>
                </section>

                <section id="schedule-result-page" class="hidden">
                    <div id="schedule-card" class="bg-white rounded-2xl overflow-hidden shadow-xl border border-gray-200 mb-6">
                        <div class="h-3 bg-indigo-600 w-full"></div>
                        <div class="p-5">
                            <div class="text-center mb-6">
                                <h2 class="text-3xl font-black text-gray-800" id="displaySubject"></h2>
                                <p class="text-xs text-gray-500 mt-1">ÿÆÿ∑ÿ© ÿØÿ±ÿßÿ≥Ÿäÿ© ÿ∞ŸÉŸäÿ©</p>
                            </div>

                            <div class="mb-6 overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="text-sm font-bold text-gray-600 p-3" width="35%">ÿßŸÑŸÅÿµŸÑ</th>
                                            <th class="text-sm font-bold text-gray-600 p-3" width="40%">ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿÆÿµÿµ</th>
                                            <th class="text-sm font-bold text-gray-600 p-3" width="25%">ÿßŸÑÿ±ÿßÿ≠ÿ©</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody"></tbody>
                                </table>
                            </div>

                            <div class="flex justify-between bg-gray-100 p-3 rounded-lg text-center text-xs font-bold text-gray-600">
                                <div><span class="block text-indigo-600 text-lg" id="statStudy"></span>ÿµÿßŸÅŸä ÿßŸÑÿØÿ±ÿßÿ≥ÿ©</div>
                                <div><span class="block text-pink-600 text-lg" id="statBreak"></span>ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ±ÿßÿ≠ÿ©</div>
                                <div><span class="block text-blue-600 text-lg" id="statSleep"></span>ŸàŸÇÿ™ ÿßŸÑŸÜŸàŸÖ</div>
                            </div>
                        </div>
                    </div>

                    <div id="schedule-action-buttons" class="space-y-3">
                        <button onclick="downloadScheduleAsImage()" class="w-full bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl hover:bg-indigo-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-download"></i> ÿ≠ŸÅÿ∏ ŸÉÿµŸàÿ±ÿ©
                        </button>
                        <button onclick="resetSchedule()" class="w-full bg-white text-red-500 border border-red-200 font-bold py-3 rounded-xl hover:bg-red-50 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash-can"></i> ÿ≠ÿ∞ŸÅ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸäÿØ
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- TAB 4: PROFILE -->
        <div id="tab-profile" class="screen pt-20">
            <div class="scroll-container px-5">
                <div class="bg-white p-6 rounded-3xl shadow-sm text-center mb-6 mt-4 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-indigo-500 to-purple-500 opacity-10"></div>
                    <div class="relative z-10">
                        <div class="image-frame-container mx-auto mb-3" style="width: 96px; height: 96px;">
                            <img id="profile-img" src="" class="w-full h-full rounded-full object-cover">
                        </div>
                        <div class="flex items-center justify-center gap-2 flex-wrap" id="profile-name-container">
                            <h2 id="profile-name-text" class="text-xl font-bold text-gray-800">...</h2>
                            <!-- Badge will be inserted here -->
                            <button onclick="editProfileName()" class="w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-100 transition">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-1" id="profile-id-text">ID: ...</p>
                        <p class="text-xs text-gray-600 mt-2 max-w-xs mx-auto flex items-center justify-center gap-1">
                            <span id="profile-bio-text" class="bio-text">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥Ÿäÿ±ÿ© ÿ∞ÿßÿ™Ÿäÿ©</span>
                            <button onclick="editProfileBio()" class="bio-edit-btn">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </p>
                        <button onclick="document.getElementById('edit-pic-input').click()" class="text-indigo-600 text-xs font-bold mt-2 hover:underline block mx-auto">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ©</button>
                        <input type="file" id="edit-pic-input" hidden accept="image/*" onchange="updateProfilePic(this)">
                    </div>
                </div>

                <div class="space-y-3 pb-20">
                    <button onclick="openPage('screen-wallet')" class="stat-btn border-green-100 bg-green-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-600"><i class="fas fa-wallet"></i></div>
                            <span class="font-bold text-green-700">ÿ£ŸÖŸàÿßŸÑŸä</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <!-- ÿ≤ÿ± ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ ŸÅŸä ÿ≠ÿ≥ÿßÿ®Ÿä -->
                    <button onclick="openPage('screen-premium-in-profile')" class="stat-btn border-yellow-100 bg-yellow-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-yellow-600"><i class="fas fa-crown"></i></div>
                            <span class="font-bold text-yellow-700">ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <button onclick="openPage('screen-stats')" class="stat-btn">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600"><i class="fas fa-chart-pie"></i></div>
                            <span class="font-bold text-gray-700">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</span>
                        </div>
                        <i class="fas fa-chevron-left text-gray-300"></i>
                    </button>

                    <!-- Unified Admin Button -->
                    <div id="admin-hub-btn-container" class="hidden mt-4">
                        <button onclick="openPage('screen-admin-hub')" class="stat-btn border-red-200 bg-red-50 shadow-md">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-600 relative">
                                    <i class="fas fa-user-shield"></i>
                                    <div id="admin-btn-badge" class="btn-dot"></div>
                                </div>
                                <span class="font-bold text-red-800">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                            </div>
                            <i class="fas fa-chevron-left text-red-300"></i>
                        </button>
                    </div>

                    <button onclick="logout()" class="stat-btn mt-6 border-red-100 text-red-500">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-sign-out-alt px-3"></i>
                            <span class="font-bold">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- === SUB SCREENS === -->

        <!-- Screen: Wallet -->
        <div id="screen-wallet" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ŸÖÿ≠ŸÅÿ∏ÿ™Ÿä üíµ</h1>
            </div>
            <div class="scroll-container px-5 py-6 text-center">
                <div class="bg-gradient-to-br from-green-500 to-emerald-700 text-white p-8 rounded-3xl shadow-lg mb-6">
                    <p class="text-green-100 text-sm mb-2 font-bold">ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä</p>
                    <h1 class="text-5xl font-black mb-1">$<span id="wallet-balance">0</span></h1>
                    <p class="text-xs text-green-200 mt-4 border-t border-green-400 pt-2 leading-relaxed">
                        (ŸäŸÖŸÉŸÜ ÿ≥ÿ≠ÿ® ÿßŸÇŸÑ ÿ¥Ÿä 100$ ŸàŸÉŸÑ 100$ ÿ™ÿ≥ÿßŸàŸä 10 ÿßŸÑŸÅ ÿØŸäŸÜÿßÿ± ÿπÿ±ÿßŸÇŸä)
                    </p>
                </div>
                <div id="withdraw-section" class="hidden">
                     <a href="https://t.me/mslmh19" target="_blank" class="w-full bg-blue-500 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-600 transition flex items-center justify-center gap-2 animate-pulse">
                        <i class="fab fa-telegram-plane"></i>
                        <span>ÿßŸÑŸÖÿ∑ÿßŸÑÿ®ÿ© ÿ®ÿßŸÑÿ£ŸÖŸàÿßŸÑ ÿßŸÑÿ¢ŸÜ</span>
                    </a>
                </div>
                <p id="withdraw-locked-msg" class="text-gray-400 text-sm mt-4">ÿπÿ∞ÿ±ÿßŸãÿå Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿµŸÑ ÿ•ŸÑŸâ 100$ ŸÑÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿ®.</p>
            </div>
        </div>

        <!-- Screen: ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ ÿØÿßÿÆŸÑ ÿ≠ÿ≥ÿßÿ®Ÿä -->
        <div id="screen-premium-in-profile" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ŸÇÿ≥ŸÖ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- NON-PREMIUM VIEW -->
                <div id="premium-locked-view">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4 text-center">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÖŸÖŸäÿ≤ üîë</h3>
                        <input type="text" id="premium-code-input" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ŸáŸÜÿß" class="input-box mb-3 text-center font-mono font-bold text-lg tracking-widest text-indigo-700 uppercase">
                        <button onclick="activatePremiumCode()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition mb-4">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÉŸàÿØ</button>
                        
                        <div class="flex flex-col gap-2">
                            <button onclick="window.open('https://t.me/mslmh19', '_blank')" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-600 transition flex items-center justify-center gap-2">
                                <i class="fab fa-telegram-plane"></i> ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÉŸàÿØ ÿßŸÑÿ™ÿ≠ŸÇŸÇ
                            </button>
                            <button onclick="showPremiumDetails()" class="w-full bg-yellow-50 text-yellow-700 py-3 rounded-xl font-bold border border-yellow-200 hover:bg-yellow-100 transition">
                                <i class="fas fa-info-circle ml-1"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸÖŸäÿ≤
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PREMIUM ACTIVE VIEW -->
                <div id="premium-active-view" class="hidden">
                    <!-- Timer Card -->
                    <div class="premium-timer-container">
                        <p class="text-xs text-gray-300 mb-1">ÿßŸÑŸÖÿØÿ© ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉŸÉ</p>
                        <div id="premium-countdown" class="premium-timer-digits">ÿ™ÿ≠ŸÖŸäŸÑ...</div>
                    </div>

                    <!-- Customization Buttons -->
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <button onclick="openBadgeSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-indigo-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ</h3>
                                <p class="text-xs text-gray-500">ÿßÿÆÿ™ÿ± ÿßŸÑŸÑŸÇÿ® ŸàÿßŸÑŸÑŸàŸÜ ÿ®ÿ¨ÿßŸÜÿ® ÿßÿ≥ŸÖŸÉ</p>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>

                        <button onclick="openBgSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-purple-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-image text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ</h3>
                                <p class="text-xs text-gray-500">ÿßÿÆÿ™ÿ± ÿÆŸÑŸÅŸäÿ© ŸÖŸÖŸäÿ≤ÿ© ŸÑÿ®ÿ∑ÿßŸÇÿ™ŸÉ</p>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>

                        <button onclick="openFrameSelector()" class="bg-white p-4 rounded-2xl shadow-sm border border-yellow-100 flex items-center gap-4 hover:shadow-md transition group">
                            <div class="w-12 h-12 rounded-full bg-yellow-50 flex items-center justify-center text-yellow-600 group-hover:bg-yellow-600 group-hover:text-white transition"><i class="fas fa-gem text-xl"></i></div>
                            <div class="text-right">
                                <h3 class="font-bold text-gray-800">ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
                                <p class="text-xs text-gray-500">ÿßÿÆÿ™ÿ± ÿ•ÿ∑ÿßÿ±ÿßŸã ŸÅÿßÿÆÿ±ÿßŸã ŸÑÿµŸàÿ±ÿ™ŸÉ</p>
                            </div>
                            <i class="fas fa-chevron-left mr-auto text-gray-300"></i>
                        </button>
                    </div>

                    <!-- Active Perks Status -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-green-50 p-3 rounded-xl border border-green-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-bolt text-green-600"></i>
                                <span class="font-bold text-sm text-green-800">ŸÖÿ∂ÿßÿπŸÅÿ© ÿßŸÑŸÜŸÇÿßÿ∑ (2x)</span>
                            </div>
                            <span class="bg-green-200 text-green-800 text-[10px] px-2 py-1 rounded font-bold">ŸÜÿ¥ÿ∑ ‚úÖ</span>
                        </div>
                        <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-xl border border-emerald-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-dollar-sign text-emerald-600"></i>
                                <span class="font-bold text-sm text-emerald-800">ŸÖÿ∂ÿßÿπŸÅÿ© ÿßŸÑÿ£ŸÖŸàÿßŸÑ (2x)</span>
                            </div>
                            <span class="bg-emerald-200 text-emerald-800 text-[10px] px-2 py-1 rounded font-bold">ŸÜÿ¥ÿ∑ ‚úÖ</span>
                        </div>
                        <div class="flex items-center justify-between bg-blue-50 p-3 rounded-xl border border-blue-200">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-robot text-blue-600"></i>
                                <span class="font-bold text-sm text-blue-800">15 ÿ≥ÿ§ÿßŸÑ (ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä)</span>
                            </div>
                            <span class="bg-blue-200 text-blue-800 text-[10px] px-2 py-1 rounded font-bold">ŸÜÿ¥ÿ∑ ‚úÖ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: ADMIN HUB -->
        <div id="screen-admin-hub" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openPage('screen-admin-panel')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-cogs text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ÿßŸÑŸÜÿ∏ÿßŸÖ</span>
                    </button>
                    <button onclick="openPage('screen-admin-users')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users-cog text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</span>
                    </button>
                    <button onclick="openPage('screen-admin-all')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-edit text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ÿ™ÿπÿØŸäŸÑ</span>
                    </button>
                    <button onclick="openPage('screen-admin-subscription')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-2 hover:bg-gray-50">
                        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600"><i class="fas fa-ticket-alt text-xl"></i></div>
                        <span class="font-bold text-sm text-gray-700">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Subscription -->
        <div id="screen-admin-subscription" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="flex flex-col gap-4">
                    <button onclick="openPage('screen-admin-generate-code')" class="bg-white p-6 rounded-2xl shadow-sm border border-green-100 flex flex-col items-center justify-center gap-3 hover:bg-green-50 transition">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-key text-2xl"></i></div>
                        <h3 class="font-bold text-gray-800">ÿ™ŸÉŸàŸäŸÜ ŸÉŸàÿØ</h3>
                        <p class="text-xs text-gray-500 text-center">ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸàÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ¨ÿØŸäÿØ</p>
                    </button>

                    <button onclick="openPage('screen-admin-delete-code')" class="bg-white p-6 rounded-2xl shadow-sm border border-red-100 flex flex-col items-center justify-center gap-3 hover:bg-red-50 transition">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center text-red-600"><i class="fas fa-trash-alt text-2xl"></i></div>
                        <h3 class="font-bold text-gray-800">ÿ≠ÿ∞ŸÅ ŸÉŸàÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</h3>
                        <p class="text-xs text-gray-500 text-center">ÿ≠ÿ∞ŸÅ ŸÉŸàÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸàÿ¨ŸàÿØ</p>
                    </button>

                    <button onclick="openPage('screen-admin-premium-users')" class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 flex flex-col items-center justify-center gap-3 hover:bg-blue-50 transition">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-crown text-2xl"></i></div>
                        <h3 class="font-bold text-gray-800">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</h3>
                        <p class="text-xs text-gray-500 text-center">ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Generate Code -->
        <div id="screen-admin-generate-code" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-subscription')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ™ŸÉŸàŸäŸÜ ŸÉŸàÿØ ÿ¨ÿØŸäÿØ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-3">ÿ™ŸÉŸàŸäŸÜ ŸÉŸàÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÖŸäÿ≤</h3>
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-2">ŸÖÿØÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</label>
                        <select id="admin-sub-duration" class="input-box mb-3">
                            <option value="7">ÿ£ÿ≥ÿ®Ÿàÿπ (7 ÿ£ŸäÿßŸÖ)</option>
                            <option value="30">ÿ¥Ÿáÿ± (30 ŸäŸàŸÖ)</option>
                            <option value="90">3 ÿ£ÿ¥Ÿáÿ± (90 ŸäŸàŸÖ)</option>
                            <option value="180">6 ÿ£ÿ¥Ÿáÿ± (180 ŸäŸàŸÖ)</option>
                            <option value="365">ÿ≥ŸÜÿ© (365 ŸäŸàŸÖ)</option>
                        </select>
                        <button onclick="generateSubscriptionCode()" class="btn-main bg-green-600 mb-4">
                            <i class="fas fa-key ml-2"></i> ÿ™ŸÉŸàŸäŸÜ Ÿàÿ™ŸàŸÑŸäÿØ ŸÉŸàÿØ
                        </button>
                        
                        <div id="generated-code-display" class="hidden bg-green-50 border border-green-200 p-4 rounded-xl text-center mt-4">
                            <p class="text-xs text-green-500 mb-1">ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ¨ÿØŸäÿØ:</p>
                            <h2 class="text-2xl font-mono font-bold text-green-800 select-all" id="gen-code-text">...</h2>
                            <div class="flex justify-center gap-2 mt-3">
                                <button onclick="copyGenCode()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition flex items-center gap-1">
                                    <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ
                                </button>
                                <button onclick="document.getElementById('generated-code-display').classList.add('hidden')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-300 transition">
                                    ÿ•ÿÆŸÅÿßÿ°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Delete Code -->
        <div id="screen-admin-delete-code" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-subscription')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ≠ÿ∞ŸÅ ŸÉŸàÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-red-100">
                    <h3 class="font-bold text-red-800 mb-3">ÿ≠ÿ∞ŸÅ ŸÉŸàÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ</h3>
                    <input type="text" id="admin-delete-code-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ ŸÑÿ≠ÿ∞ŸÅŸá" class="input-box mb-4 uppercase">
                    <button onclick="deleteSubscriptionCode()" class="btn-main bg-red-600 hover:bg-red-700">
                        <i class="fas fa-trash-alt ml-2"></i> ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿØ
                    </button>
                    <p class="text-xs text-gray-500 mt-3">ŸÖŸÑÿßÿ≠ÿ∏ÿ©: Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ∞ŸÅ ŸÜŸáÿßÿ¶Ÿä ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá</p>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Premium Users -->
        <div id="screen-admin-premium-users" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-subscription')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="premium-users-list" class="space-y-3">
                    <p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
                </div>
            </div>
        </div>

        <!-- Screen: Admin System Panel -->
        <div id="screen-admin-panel" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-2xl p-5 shadow-sm">
                    <h3 class="font-bold text-yellow-800 mb-2">üéÅ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</h3>
                    <p class="text-xs text-yellow-600 mb-4">ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ÿå ÿ≥Ÿäÿ™ŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÄ 10 ÿßŸÑÿ£ŸàŸÑŸâ Ÿàÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ.</p>
                    <button onclick="manualWeeklyDistribution()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-yellow-600">ÿ™Ÿàÿ≤Ÿäÿπ Ÿàÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ¢ŸÜ</button>
                </div>
            </div>
        </div>

        <!-- Screen: Admin Users -->
        <div id="screen-admin-users" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="flex gap-2 mb-6">
                    <input type="text" id="admin-user-search" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ID)" class="input-box">
                    <button onclick="searchUserForAdmin()" class="btn-main w-auto px-6"><i class="fas fa-search"></i></button>
                </div>
                <div id="admin-user-result" class="hidden bg-white p-5 rounded-2xl shadow-md border border-gray-100"></div>
                
                <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ŸäŸÜ -->
                <div id="banned-users-section" class="mt-8 hidden">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ≠ÿ∏Ÿàÿ±ŸäŸÜ</h3>
                    <div id="banned-users-list" class="space-y-3">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿáÿß ÿπÿ®ÿ± JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen: App Stats -->
        <div id="screen-stats" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToProfile()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div id="stats-content" class="space-y-4"><p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p></div>
            </div>
        </div>

        <!-- Screen: Admin ALL Questions -->
        <div id="screen-admin-all" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="openPage('screen-admin-hub')" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿ±ŸÅŸàÿπÿ©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-3 rounded-xl mb-4 shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 mb-2">ÿ™ÿµŸÅŸäÿ© ÿ≠ÿ≥ÿ®:</p>
                    <div class="flex gap-2">
                        <select id="admin-filter-grade" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ŸÉŸÑ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ</option>
                            <option value="6sci">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä</option>
                            <option value="6lit">ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿ£ÿØÿ®Ÿä</option>
                            <option value="3med">ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                        </select>
                        <select id="admin-filter-subject" class="input-box text-sm p-2" onchange="filterAdminQuestions()"><option value="">ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ</option></select>
                        <select id="admin-filter-type" class="input-box text-sm p-2" onchange="filterAdminQuestions()">
                            <option value="">ŸÉŸÑ ÿßŸÑÿ£ŸÜŸàÿßÿπ</option>
                            <option value="mcq">ÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™</option>
                            <option value="tf">ÿµÿ≠/ÿÆÿ∑ÿ£</option>
                        </select>
                    </div>
                </div>
                <div id="admin-all-list" class="space-y-3 pb-20"></div>
            </div>
        </div>

        <!-- Screen: Friend Challenge Room -->
        <div id="screen-friend-challenge" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToChallenges()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿá ÿπÿ®ÿ± JavaScript -->
                <div id="room-content" class="text-center">
                    <p class="text-gray-400 mt-10">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∫ÿ±ŸÅÿ©...</p>
                </div>
            </div>
        </div>

        <!-- Screen: Create Room -->
        <div id="screen-create-room" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToFriendChallenge()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ŸÑÿ™ÿ≠ÿØŸä ÿµÿØŸäŸÇ</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-600 mb-2">ÿßŸÑŸÖÿßÿØÿ©</label>
                        <select id="room-subject" class="input-box"></select>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-600 mb-2">ŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="setRoomQType('mcq')" id="room-btn-mcq" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™</button>
                            <button onclick="setRoomQType('tf')" id="room-btn-tf" class="py-3 rounded-xl border-2 border-indigo-100 text-gray-500 font-bold active:scale-95 transition">ÿµÿ≠ ŸàÿÆÿ∑ÿ£</button>
                        </div>
                    </div>

                    <button onclick="createRoom()" class="beautiful-btn">
                        <i class="fas fa-plus-circle"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Join Room -->
        <div id="screen-join-room" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToFriendChallenge()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿßŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ÿ∫ÿ±ŸÅÿ©</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 text-center">ÿßŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ÿ∫ÿ±ŸÅÿ© ÿµÿØŸäŸÇ</h3>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-600 mb-2">ÿ±ŸÇŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ© (8 ÿ£ÿ±ŸÇÿßŸÖ)</label>
                        <input type="text" id="room-code-input" placeholder="ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ©" class="input-box text-center font-mono text-xl tracking-widest" maxlength="8">
                    </div>

                    <button onclick="joinRoom()" class="beautiful-btn">
                        <i class="fas fa-sign-in-alt"></i> ÿßŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Notifications -->
        <div id="screen-notifications" class="screen pt-20">
            <div class="absolute top-0 w-full h-20 bg-white shadow-sm z-30 flex items-center px-5 gap-4">
                <button onclick="backToChallenges()" class="text-gray-500"><i class="fas fa-arrow-right text-xl"></i></button>
                <h1 class="font-bold text-lg text-gray-800">ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™</h1>
            </div>
            <div class="scroll-container px-5 py-6">
                <!-- Tabs -->
                <div class="flex mb-6 border-b border-gray-100">
                    <button id="notif-tab-alerts" onclick="switchNotifTab('alerts')" class="flex-1 py-3 font-bold text-sm border-b-2 border-indigo-600 text-indigo-600">ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™</button>
                    <button id="notif-tab-friends" onclick="switchNotifTab('friends')" class="flex-1 py-3 font-bold text-sm text-gray-500">ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</button>
                    <button id="notif-tab-requests" onclick="switchNotifTab('requests')" class="flex-1 py-3 font-bold text-sm text-gray-500">ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ©</button>
                    <button id="notif-tab-pending" onclick="switchNotifTab('pending')" class="flex-1 py-3 font-bold text-sm text-gray-500">ÿßŸÑŸÖÿπŸÑŸÇÿ©</button>
                </div>

                <!-- Alerts Content -->
                <div id="notif-alerts-content" class="space-y-4">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿáÿß ÿπÿ®ÿ± JavaScript -->
                </div>

                <!-- Friends Content -->
                <div id="notif-friends-content" class="space-y-4 hidden">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿáÿß ÿπÿ®ÿ± JavaScript -->
                </div>

                <!-- Friend Requests Content -->
                <div id="notif-requests-content" class="space-y-4 hidden">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿáÿß ÿπÿ®ÿ± JavaScript -->
                </div>

                <!-- Pending Requests Content -->
                <div id="notif-pending-content" class="space-y-4 hidden">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿáÿß ÿπÿ®ÿ± JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- BOTTOM NAV -->
        <div class="fixed bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center h-20 pb-2 z-40 shadow-[0_-5px_20px_rgba(0,0,0,0.03)]">
            <div onclick="switchTab('challenges')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full cursor-pointer">
                <i class="fas fa-gamepad text-xl mb-1"></i><span class="text-[10px] font-bold">ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™</span>
            </div>
            <div onclick="switchTab('leaderboard')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-trophy text-xl mb-1"></i><span class="text-[10px] font-bold">ÿßŸÑÿ™ÿµŸÜŸäŸÅ</span>
            </div>
            <div onclick="switchTab('schedule')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-calendar-alt text-xl mb-1"></i><span class="text-[10px] font-bold">ÿ¨ÿØŸàŸÑ ŸäŸàŸÖŸä</span>
            </div>
            <div onclick="switchTab('profile')" class="nav-item flex-1 flex flex-col items-center justify-center h-full cursor-pointer text-gray-400">
                <i class="fas fa-user text-xl mb-1"></i><span class="text-[10px] font-bold">ÿ≠ÿ≥ÿßÿ®Ÿä</span>
                <div id="profile-tab-badge" class="red-dot"></div>
            </div>
        </div>
        
        <!-- POPUP: Premium Details -->
        <div id="premium-details-modal" class="modal-overlay hidden">
            <div class="modal-content relative bg-gradient-to-br from-indigo-900 to-indigo-800 text-white border-2 border-yellow-500">
                <button onclick="document.getElementById('premium-details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <div class="text-center mb-6">
                    <i class="fas fa-crown text-5xl text-yellow-400 mb-3 animate-bounce"></i>
                    <h2 class="text-2xl font-black text-yellow-400">ŸÖŸÖŸäÿ≤ÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖŸÖŸäÿ≤</h2>
                </div>
                <div class="space-y-4 text-right">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-check"></i></div>
                        <p class="font-bold">ÿ™Ÿàÿ´ŸäŸÇ ŸÖŸÖŸäÿ≤ ŸÑŸÑÿ≠ÿ≥ÿßÿ® (ÿπŸÑÿßŸÖÿ© ÿ®ÿ¨ÿßŸÜÿ® ÿßŸÑÿßÿ≥ŸÖ).</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold"><i class="fas fa-check"></i></div>
                        <p class="font-bold">ÿÆŸÑŸÅŸäÿ© ŸÖŸÖŸäÿ≤ÿ© ŸÖÿ™ÿ≠ÿ±ŸÉÿ© ŸÅŸä ÿßŸÑÿ™ÿµŸÜŸäŸÅ.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">2x</div>
                        <p class="font-bold">ŸÜŸÇÿßÿ∑ ŸÖÿ∂ÿßÿπŸÅÿ© ŸÖŸÜ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">$$</div>
                        <p class="font-bold">ÿ£ŸÖŸàÿßŸÑ ŸÖÿ∂ÿßÿπŸÅÿ© ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿßÿ≥ÿ®Ÿàÿπ.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-yellow-500 text-indigo-900 flex items-center justify-center font-bold">15</div>
                        <p class="font-bold">15 ÿ≥ÿ§ÿßŸÑ ÿ®ÿØŸÑ 10 ŸÅŸä ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä.</p>
                    </div>
                </div>
                <button onclick="document.getElementById('premium-details-modal').classList.add('hidden')" class="mt-8 w-full bg-yellow-500 text-indigo-900 font-bold py-3 rounded-xl hover:bg-yellow-400 transition">ŸÅŸáŸÖÿ™ÿå ÿ¥ŸÉÿ±ÿßŸã</button>
            </div>
        </div>

        <!-- POPUP: Badge Selector -->
        <div id="badge-selector-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                 <button onclick="document.getElementById('badge-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                 <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ÿßÿÆÿ™ÿ± ŸÑŸÇÿ® ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ</h3>
                 <p class="text-xs text-gray-500 text-center mb-4">ÿ≥Ÿäÿ∏Ÿáÿ± Ÿáÿ∞ÿß ÿßŸÑŸÑŸÇÿ® ÿ®ŸÑŸàŸÜ ÿπÿ¥Ÿàÿßÿ¶Ÿä ÿ®ÿ¨ÿßŸÜÿ® ÿßÿ≥ŸÖŸÉ</p>
                 <div class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto p-2" id="badge-grid"></div>
            </div>
        </div>

        <!-- POPUP: Background Selector -->
        <div id="bg-selector-modal" class="modal-overlay hidden">
             <div class="modal-content relative">
                 <button onclick="document.getElementById('bg-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                 <h3 class="font-bold text-lg mb-4 text-purple-700 text-center">ÿßÿÆÿ™ÿ± ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ</h3>
                 <div class="space-y-3" id="bg-grid"></div>
            </div>
        </div>

        <!-- POPUP: Frame Selector -->
        <div id="frame-selector-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('frame-selector-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-yellow-700 text-center">ÿßÿÆÿ™ÿ± ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä</h3>
                <p class="text-xs text-gray-500 text-center mb-4">ÿßÿÆÿ™ÿ± ÿ•ÿ∑ÿßÿ±ÿßŸã ŸÅÿßÿÆÿ±ÿßŸã ŸÑÿµŸàÿ±ÿ™ŸÉ (ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ ŸÅŸÇÿ∑)</p>
                <div class="grid grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto p-2" id="frame-grid"></div>
            </div>
        </div>
        
        <!-- EDIT QUESTION MODAL -->
        <div id="edit-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 border-b pb-2">ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ¥ÿßŸÖŸÑ</h3>
                <input type="hidden" id="edit-q-id">
                <label class="block text-xs font-bold text-gray-500 mb-1">ŸÜÿµ ÿßŸÑÿ≥ÿ§ÿßŸÑ</label>
                <textarea id="edit-q-text" class="input-box h-20 mb-3 text-sm"></textarea>
                <div class="flex gap-2 mb-3">
                     <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">ÿßŸÑÿµŸÅ</label><select id="edit-q-grade" class="input-box text-sm p-2"><option value="6sci">6 ÿπŸÑŸÖŸä</option><option value="6lit">6 ÿ£ÿØÿ®Ÿä</option><option value="3med">3 ŸÖÿ™Ÿàÿ≥ÿ∑</option></select></div>
                     <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">ÿßŸÑŸÖÿßÿØÿ©</label><select id="edit-q-subject" class="input-box text-sm p-2"></select></div>
                </div>
                <div id="edit-mcq-fields" class="hidden">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ÿßŸÑÿÆŸäÿßÿ± 1</label><input type="text" id="edit-ans-0" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ÿßŸÑÿÆŸäÿßÿ± 2</label><input type="text" id="edit-ans-1" class="input-box mb-2 p-2 text-sm">
                     <label class="block text-xs font-bold text-gray-500 mb-1">ÿßŸÑÿÆŸäÿßÿ± 3</label><input type="text" id="edit-ans-2" class="input-box mb-3 p-2 text-sm">
                     <label class="block text-xs font-bold text-green-600 mb-1">ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© (0, 1, 2)</label>
                     <select id="edit-correct-mcq" class="input-box p-2 text-sm"><option value="0">ÿßŸÑÿÆŸäÿßÿ± 1</option><option value="1">ÿßŸÑÿÆŸäÿßÿ± 2</option><option value="2">ÿßŸÑÿÆŸäÿßÿ± 3</option></select>
                </div>
                <div id="edit-tf-fields" class="hidden">
                    <label class="block text-xs font-bold text-green-600 mb-1">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©</label>
                    <select id="edit-correct-tf" class="input-box p-2 text-sm"><option value="true">ÿµÿ≠</option><option value="false">ÿÆÿ∑ÿ£</option></select>
                </div>
                <button onclick="saveFullEditQ()" class="btn-main mt-6 bg-indigo-600 text-sm">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
            </div>
        </div>

        <!-- POPUP: Add Subscription -->
        <div id="add-subscription-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('add-subscription-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ÿ•ÿ∂ÿßŸÅÿ© ÿßÿ¥ÿ™ÿ±ÿßŸÉ</h3>
                <p class="text-xs text-gray-500 text-center mb-4">ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÑÿ™ÿ≤ŸäÿØ ÿßŸÑŸÖÿØÿ©</p>
                <input type="text" id="add-subscription-code" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ" class="input-box mb-4 text-center font-mono text-lg uppercase">
                <button onclick="addSubscriptionTime()" class="btn-main bg-green-600 hover:bg-green-700">
                    <i class="fas fa-plus-circle ml-2"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿØÿ©
                </button>
            </div>
        </div>

        <!-- POPUP: Edit Bio -->
        <div id="edit-bio-modal" class="modal-overlay hidden">
            <div class="modal-content relative">
                <button onclick="document.getElementById('edit-bio-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ©</h3>
                <div class="mb-2 flex justify-between items-center">
                    <span class="text-xs text-gray-500">ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ: 25 ÿ≠ÿ±ŸÅ</span>
                    <span id="bio-char-count" class="text-xs font-bold text-indigo-600">0/25</span>
                </div>
                <textarea id="edit-bio-input" class="input-box h-32 mb-4" placeholder="ÿßŸÉÿ™ÿ® ŸÜÿ®ÿ∞ÿ© ÿπŸÜŸÉ..." maxlength="25" oninput="updateBioCharCount()"></textarea>
                <button onclick="saveProfileBio()" class="btn-main bg-indigo-600 hover:bg-indigo-700">ÿ≠ŸÅÿ∏</button>
            </div>
        </div>

        <!-- Beautiful Alert Popup -->
        <div id="beautiful-alert" class="beautiful-alert hidden">
            <div id="beautiful-alert-icon" class="beautiful-alert-icon">!</div>
            <h3 id="beautiful-alert-title" class="beautiful-alert-title">ÿ™ŸÜÿ®ŸäŸá</h3>
            <p id="beautiful-alert-message" class="beautiful-alert-message">...</p>
            <button id="beautiful-alert-ok-btn" class="beautiful-alert-btn">ÿ≠ÿ≥ŸÜÿßŸã</button>
        </div>

        <!-- Friend Challenge Modal -->
        <div id="friend-challenge-modal" class="modal-overlay hidden">
            <div class="beautiful-modal">
                <button onclick="closeFriendChallengeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
                <h3 class="font-bold text-lg mb-6 text-center text-indigo-700">ÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</h3>
                
                <div class="space-y-4">
                    <button onclick="openCreateRoomScreen()" class="beautiful-btn">
                        <i class="fas fa-plus-circle"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ©
                    </button>
                    
                    <button onclick="openJoinRoomScreen()" class="beautiful-btn secondary">
                        <i class="fas fa-sign-in-alt"></i> ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ∫ÿ±ŸÅÿ©
                    </button>
                </div>
            </div>
        </div>

        <!-- Invite Friends Modal -->
        <div id="invite-friends-modal" class="modal-overlay hidden">
            <div class="modal-content invite-friends-modal">
                <button onclick="document.getElementById('invite-friends-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
                <h3 class="font-bold text-lg mb-4 text-indigo-700 text-center">ÿØÿπŸàÿ© ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</h3>
                <p class="text-xs text-gray-500 text-center mb-6">ÿßÿÆÿ™ÿ± ÿµÿØŸäŸÇÿßŸã ŸÑÿØÿπŸàÿ™Ÿá ŸÑŸÑÿ∫ÿ±ŸÅÿ©</p>
                <div id="friends-list" class="space-y-3">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ™Ÿáÿß ÿπÿ®ÿ± JavaScript -->
                </div>
            </div>
        </div>

        <!-- Game Resume Modal -->
        <div id="game-resume-modal" class="modal-overlay game-resume-modal hidden">
            <div class="game-resume-card">
                <div class="text-center mb-6">
                    <i class="fas fa-redo text-5xl text-indigo-400 mb-3 animate-spin"></i>
                    <h2 class="text-2xl font-black text-white">ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ©</h2>
                </div>
                <p class="text-gray-300 text-center mb-6">Ÿäÿ®ÿØŸà ÿ£ŸÜ ŸÑÿØŸäŸÉ ŸÖÿ®ÿßÿ±ÿßÿ© ŸÇŸäÿØ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅŸáÿßÿü</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="resumeGame()" class="bg-green-500 text-white py-3 rounded-xl font-bold hover:bg-green-600 transition">
                        <i class="fas fa-play mr-2"></i> ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ
                    </button>
                    <button onclick="cancelGameResume()" class="bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition">
                        <i class="fas fa-times mr-2"></i> ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, serverTimestamp, increment, getDoc, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfLOjiPiSQW9opdiIgQif3pAp8zsezy58",
            authDomain: "ministerial-hacker.firebaseapp.com",
            databaseURL: "https://ministerial-hacker-default-rtdb.firebaseio.com",
            projectId: "ministerial-hacker",
            storageBucket: "ministerial-hacker.firebasestorage.app",
            messagingSenderId: "557133038084",
            appId: "1:557133038084:web:c8cb7df6ef0abef2beab51",
            measurementId: "G-WYMSX2LRTW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        const ADMIN_EMAIL = "mslmalmyaly223@gmail.com";

        setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence Error", e));

        let currentUser = null;
        let userData = null;
        let selectedQType = null;
        let currentMatchId = null;
        let gameTimer = null;
        let hasAnsweredCurrentQ = false;
        let allAdminQuestions = []; 
        let adminListenerUnsubscribe = null;
        let matchListenerUnsubscribe = null; 
        let countdownInterval = null;
        let roomListenerUnsubscribe = null;
        let currentRoomId = null;
        let isRoomHost = false;
        let roomReadyState = false;
        
        let isExitingGame = false;
        let currentGameMode = 'online'; 
        let aiDifficulty = 'medium'; 
        let localMatchData = null; 
        let aiTimeoutId = null; 
        let currentQuestionCorrectAnswer = null; 
        let userAnsweredCorrectly = false; 
        let connectionMonitorInterval = null;
        let opponentLastSeen = Date.now();
        let isMonitoringConnection = false;
        let playerDisconnected = false;
        let matchConnectionChecked = false;

        let systemConfig = { enabled: true, msg: "ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿµŸäÿßŸÜÿ© ÿ≠ÿßŸÑŸäÿßŸã" };

        let premiumInterval = null;
        const BADGES_LIST = ["ÿ≥ÿ¨ÿßÿ¨", "ÿ≥ÿ¨ÿßÿ¨ÿ©", "ÿØŸÉÿ™Ÿàÿ±", "ÿØŸÉÿ™Ÿàÿ±ÿ©", "ŸÉÿ≥ŸÑÿßŸÜ", "ŸÉÿ≥ŸàŸÑÿ©", "ÿ¥ÿ∑Ÿàÿ±", "ÿ¥ÿ∑Ÿàÿ±ÿ©", "ŸÜÿßŸäŸÖ", "ŸÜÿßŸäŸÖÿ©", "ŸÜÿπÿ≥ÿßŸÜ", "ŸÜÿπÿ≥ÿßŸÜÿ©", "ŸÖÿßŸÉŸà ŸàÿßŸáÿ≥", "ŸÖŸáŸÜÿØÿ≥", "ŸÖŸáŸÜÿØÿ≥ÿ©", "Ÿàÿßÿ≠ÿØ ÿπÿ±ÿßŸÇ", "ÿµ⁄Øÿßÿ±ŸÉŸÖ", "ÿµ⁄Øÿßÿ±ÿ™ŸÉŸÖ", "ŸÅÿ≥ÿ™ŸÇÿ©", "ÿßŸÑŸÖÿ≠ÿßŸÖŸä", "ÿßŸÑŸÖÿ≠ÿßŸÖŸäÿ©"];
        const BACKGROUNDS_LIST = [
            { id: 'bg-medical', name: 'ÿ∑ÿ®Ÿä (ÿ≥ŸÖÿßÿ¶Ÿä)', class: 'bg-medical' },
            { id: 'bg-law', name: 'ŸÇÿßŸÜŸàŸÜ (ÿ¨Ÿàÿ≤Ÿä)', class: 'bg-law' },
            { id: 'bg-edu', name: 'ÿ™ÿπŸÑŸäŸÖ (ÿ£ÿÆÿ∂ÿ±)', class: 'bg-edu' },
            { id: 'bg-eng', name: 'ŸáŸÜÿØÿ≥ÿ© (ÿ£ÿµŸÅÿ±)', class: 'bg-eng' },
            { id: 'bg-smart', name: 'ÿ∞ŸÉŸä (ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä)', class: 'bg-smart' },
            { id: 'bg-love', name: 'ÿ≠ÿ® (Ÿàÿ±ÿØŸä)', class: 'bg-love' }
        ];

        const FRAMES_LIST = [
            { id: 'frame-royal-gold', name: 'ÿ∞Ÿáÿ® ŸÖŸÑŸÉŸä', class: 'frame-royal-gold', description: 'ÿ•ÿ∑ÿßÿ± ÿ∞Ÿáÿ®Ÿä ŸÖŸÑŸÉŸä ŸÖÿπ ÿ™ÿßÿ¨' },
            { id: 'frame-crystal-magic', name: 'ŸÉÿ±Ÿäÿ≥ÿ™ÿßŸÑ ÿ≥ÿßÿ≠ÿ±', class: 'frame-crystal-magic', description: 'ÿ•ÿ∑ÿßÿ± ŸÉÿ±Ÿäÿ≥ÿ™ÿßŸÑ ÿ≥ÿßÿ≠ÿ± ŸÖÿ™ŸÑÿ£ŸÑÿ¶' },
            { id: 'frame-gemstone-sparkle', name: 'ÿ¨ŸàŸáÿ±ÿ© ŸÖÿ™ŸÑÿ£ŸÑÿ¶ÿ©', class: 'frame-gemstone-sparkle', description: 'ÿ•ÿ∑ÿßÿ± ÿ¨ŸàŸáÿ±ÿ© ÿ®ÿ£ŸÑŸàÿßŸÜ ŸÇŸàÿ≥ ŸÇÿ≤ÿ≠' },
            { id: 'frame-ice-glass', name: 'ÿ≤ÿ¨ÿßÿ¨ ÿ´ŸÑÿ¨Ÿä', class: 'frame-ice-glass', description: 'ÿ•ÿ∑ÿßÿ± ÿ≤ÿ¨ÿßÿ¨Ÿä ÿ´ŸÑÿ¨Ÿä ŸÜŸÇŸä' },
            { id: 'frame-angel-wings', name: 'ÿ£ÿ¨ŸÜÿ≠ÿ© ŸÖŸÑÿßŸÉ', class: 'frame-angel-wings', description: 'ÿ•ÿ∑ÿßÿ± ÿ®ÿ£ÿ¨ŸÜÿ≠ÿ© ŸÖŸÑÿßŸÉ ÿ®Ÿäÿ∂ÿßÿ°' },
            { id: 'frame-imperial-crown', name: 'ÿ™ÿßÿ¨ ÿ•ŸÖÿ®ÿ±ÿßÿ∑Ÿàÿ±Ÿä', class: 'frame-imperial-crown', description: 'ÿ•ÿ∑ÿßÿ± ÿ™ÿßÿ¨ ÿ•ŸÖÿ®ÿ±ÿßÿ∑Ÿàÿ±Ÿä ŸÅÿßÿÆÿ±' },
            { id: 'frame-magic-energy', name: 'ÿ∑ÿßŸÇÿ© ÿ≥ÿ≠ÿ±Ÿäÿ©', class: 'frame-magic-energy', description: 'ÿ•ÿ∑ÿßÿ± ÿ∑ÿßŸÇÿ© ÿ≥ÿ≠ÿ±Ÿäÿ© ŸÖÿ™ŸàŸáÿ¨ÿ©' },
            { id: 'frame-legendary-fire', name: 'ŸÜÿßÿ± ÿ£ÿ≥ÿ∑Ÿàÿ±Ÿäÿ©', class: 'frame-legendary-fire', description: 'ÿ•ÿ∑ÿßÿ± ŸÜÿßÿ± ÿ£ÿ≥ÿ∑Ÿàÿ±Ÿäÿ© ŸÖÿ™ŸÇÿØÿ©' }
        ];

        const subjects = {
            '6sci': ['ÿßÿ≥ŸÑÿßŸÖŸäÿ©', 'ÿπÿ±ÿ®Ÿä', 'ÿßŸÜŸÉŸÑŸäÿ≤Ÿä', 'ÿßÿ≠Ÿäÿßÿ°', 'ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™', 'ŸÉŸäŸÖŸäÿßÿ°', 'ŸÅŸäÿ≤Ÿäÿßÿ°'],
            '6lit': ['ÿßÿ≥ŸÑÿßŸÖŸäÿ©', 'ÿπÿ±ÿ®Ÿä', 'ÿßŸÜŸÉŸÑŸäÿ≤Ÿä', 'ÿ™ÿßÿ±ŸäÿÆ', 'ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™', 'ÿ¨ÿ∫ÿ±ÿßŸÅŸäÿ©', 'ÿßŸÇÿ™ÿµÿßÿØ'],
            '3med': ['ÿßÿ≥ŸÑÿßŸÖŸäÿ©', 'ÿπÿ±ÿ®Ÿä', 'ÿßŸÜŸÉŸÑŸäÿ≤Ÿä', 'ÿ±Ÿäÿßÿ∂Ÿäÿßÿ™', 'ŸÉŸäŸÖŸäÿßÿ°', 'ŸÅŸäÿ≤Ÿäÿßÿ°', 'ÿßÿ¨ÿ™ŸÖÿßÿπŸäÿßÿ™', 'ÿßÿ≠Ÿäÿßÿ°']
        };

        const sharedSubjects = ['ÿßÿ≥ŸÑÿßŸÖŸäÿ©', 'ÿπÿ±ÿ®Ÿä', 'ÿßŸÜŸÉŸÑŸäÿ≤Ÿä'];

        // Image Cache System
        const imageCache = new Map();
        const MAX_CACHE_SIZE = 50;

        async function getCachedImage(url) {
            if (!url) return null;
            
            if (imageCache.has(url)) {
                return imageCache.get(url);
            }

            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                
                if (imageCache.size >= MAX_CACHE_SIZE) {
                    const firstKey = imageCache.keys().next().value;
                    const firstUrl = imageCache.get(firstKey);
                    URL.revokeObjectURL(firstUrl);
                    imageCache.delete(firstKey);
                }
                
                imageCache.set(url, objectUrl);
                return objectUrl;
            } catch (error) {
                console.error("Error caching image:", error);
                return url;
            }
        }

        function clearImageCache() {
            for (const url of imageCache.values()) {
                URL.revokeObjectURL(url);
            }
            imageCache.clear();
        }

        async function loadImageWithCache(imgElement, url, fallbackUrl = null) {
            if (!imgElement) return;
            
            try {
                const cachedUrl = await getCachedImage(url);
                imgElement.src = cachedUrl || url;
                
                imgElement.onload = () => {
                    imgElement.classList.remove('image-loading');
                };
                
                imgElement.onerror = () => {
                    if (fallbackUrl) {
                        imgElement.src = fallbackUrl;
                    }
                    imgElement.classList.remove('image-loading');
                };
                
            } catch (error) {
                console.error("Error loading image:", error);
                if (fallbackUrl) {
                    imgElement.src = fallbackUrl;
                }
                imgElement.classList.remove('image-loading');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            const intro = document.getElementById('intro-screen');
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const banScreen = document.getElementById('ban-screen');

            if (user) {
                currentUser = user;
                loadDisabledSubjects();

                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        userData = docSnap.data();

                        if (userData.isBanned === true) {
                            banScreen.classList.remove('hidden');
                            await signOut(auth);
                            localStorage.setItem('device_banned', 'true');
                            return;
                        }

                        if (localStorage.getItem('device_banned') === 'true') {
                            banScreen.classList.remove('hidden');
                            await signOut(auth);
                            return;
                        }

                        updateDoc(doc(db, "users", user.uid), { lastActive: serverTimestamp() });
                        
                        setupProfileUI();
                        setupHeaderUI();
                        setupAdminUI();
                        checkDailyReward(); 
                        checkPremiumStatus();
                        if(userData.email === ADMIN_EMAIL) checkAdminNotifications(); 
                        checkForPendingGame();
                        loadNotifications();

                        if (userData.grade) {
                            document.getElementById('grade-selector-card').classList.add('hidden');
                            document.getElementById('challenge-active-card').classList.remove('hidden');
                            document.getElementById('header-grade-badge').innerText = getGradeName(userData.grade);
                            document.getElementById('header-grade-badge').classList.remove('hidden');
                            populateSubjects(userData.grade, 'challenge-subject');
                        } else {
                            document.getElementById('grade-selector-card').classList.remove('hidden');
                            document.getElementById('challenge-active-card').classList.add('hidden');
                            document.getElementById('header-grade-badge').classList.add('hidden');
                        }
                        
                        setTimeout(() => {
                            intro.classList.add('hidden');
                            authScreen.classList.add('hidden');
                            mainApp.classList.remove('hidden');
                            document.getElementById('notifications-btn').classList.remove('hidden');
                            if(!document.querySelector('.screen.active')) switchTab('challenges');
                            startWeeklyCountdown();
                        }, 2500);
                        
                    } else {
                        await signOut(auth);
                        location.reload();
                    }
                } catch(e) { 
                    console.error("Auth Data Error:", e); 
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                    await signOut(auth);
                    location.reload();
                }
            } else {
                setTimeout(() => {
                    intro.classList.add('hidden');
                    mainApp.classList.add('hidden');
                    banScreen.classList.add('hidden');
                    document.getElementById('notifications-btn').classList.add('hidden');
                    authScreen.classList.remove('hidden');
                    window.switchAuthTab('login');
                }, 2000);
            }
        });

        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let width = img.width;
                        let height = img.height;
                        const maxSize = 200;
                        
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedDataUrl);
                    };
                };
            });
        }

        async function uploadImageToStorage(file, userId) {
            try {
                const compressedImage = await compressImage(file);
                const blob = await fetch(compressedImage).then(r => r.blob());
                
                const storageRef = ref(storage, `profile_images/${userId}_${Date.now()}.jpg`);
                const snapshot = await uploadBytes(storageRef, blob);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                await updateDoc(doc(db, "users", userId), { photo: downloadURL });
                
                return downloadURL;
            } catch (error) {
                console.error("Error uploading image:", error);
                throw error;
            }
        }

        async function uploadToStorage(file, path) {
            try {
                const storageRef = ref(storage, path);
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (error) {
                console.error("Error uploading to storage:", error);
                throw error;
            }
        }

        function startWeeklyCountdown() {
            if(countdownInterval) clearInterval(countdownInterval);
            const timerEl = document.getElementById('weekly-timer');
            
            function updateTimer() {
                const now = new Date();
                const day = now.getDay();
                const daysUntilThu = (4 - day + 7) % 7; 
                
                const target = new Date(now);
                target.setDate(now.getDate() + daysUntilThu);
                target.setHours(23, 59, 59, 999);
                
                if (day === 5) {
                      target.setDate(now.getDate() + 6);
                }
                
                const diff = target - now;
                
                if (diff < 0) {
                    timerEl.innerText = "00:00:00:00";
                    if (!window.weeklyRewardDistributed) {
                        window.weeklyRewardDistributed = true;
                        setTimeout(() => autoDistributeWeeklyPrizes(), 1000);
                    }
                    return;
                }

                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);

                timerEl.innerText = `${d}:${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
                
                if (d === 0 && h === 0 && m === 0 && s < 60) {
                    window.weeklyRewardDistributed = false;
                }
            }
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        async function autoDistributeWeeklyPrizes() {
            try {
                console.log("ÿ®ÿØÿ° ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©...");
                
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(10));
                const snap = await getDocs(q);
                const prizes = [10, 7, 5, 3, 2, 1, 1, 1, 1, 1];
                
                let batch = writeBatch(db);
                
                snap.docs.forEach((d, index) => {
                    if(index < 10) {
                        const prize = prizes[index];
                        const newBalance = (d.data().balance || 0) + prize;
                        batch.update(doc(db, "users", d.id), { 
                            balance: newBalance,
                            lastWeeklyPrize: prize,
                            lastWeeklyRank: index + 1
                        });
                    }
                });
                await batch.commit();

                const qReset = query(collection(db, "users"), orderBy("points", "desc"), limit(100));
                const snapReset = await getDocs(qReset);
                
                let resetBatch = writeBatch(db);
                snapReset.docs.forEach(d => {
                    resetBatch.update(doc(db, "users", d.id), { 
                        points: 0,
                        previousPoints: d.data().points || 0
                    });
                });
                await resetBatch.commit();
                
                await setDoc(doc(db, "system_settings", "last_weekly_distribution"), {
                    timestamp: serverTimestamp(),
                    distributedBy: 'auto-system'
                }, { merge: true });
                
                console.log("‚úÖ ÿ™ŸÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ¨Ÿàÿßÿ¶ÿ≤ Ÿàÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑ ÿ®ŸÜÿ¨ÿßÿ≠!");
                
                if (document.getElementById('tab-leaderboard').classList.contains('active')) {
                    loadLeaderboard();
                }
                
                if (userData && userData.email === ADMIN_EMAIL) {
                    showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ', '‚úÖ ÿ™ŸÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© Ÿàÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑!');
                }
                
            } catch (error) {
                console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:", error);
                setTimeout(() => {
                    if (!window.retryWeeklyDistribution) {
                        window.retryWeeklyDistribution = true;
                        autoDistributeWeeklyPrizes();
                    }
                }, 5 * 60 * 1000);
            }
        }

        function showBeautifulAlert(type, title, message) {
            const alert = document.getElementById('beautiful-alert');
            const icon = document.getElementById('beautiful-alert-icon');
            const alertTitle = document.getElementById('beautiful-alert-title');
            const alertMessage = document.getElementById('beautiful-alert-message');
            
            alert.classList.remove('success', 'error', 'warning', 'info');
            alert.classList.add(type);
            
            if (type === 'success') {
                icon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                icon.innerHTML = '<i class="fas fa-times-circle"></i>';
            } else if (type === 'warning') {
                icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            } else {
                icon.innerHTML = '<i class="fas fa-info-circle"></i>';
            }
            
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            
            alert.classList.remove('hidden');
        }

        function closeBeautifulAlert() {
            document.getElementById('beautiful-alert').classList.add('hidden');
        }
        
        document.getElementById('beautiful-alert-ok-btn').addEventListener('click', closeBeautifulAlert);

        window.openForgotPassword = function() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            document.getElementById('forgot-email').value = document.getElementById('login-email').value || '';
        };

        window.closeForgotPassword = function() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        };

        window.sendResetLink = async function() {
            const email = document.getElementById('forgot-email').value;
            if (!email || !email.includes('@')) { 
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿµÿ≠Ÿäÿ≠');
                return; 
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ', '‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿßÿ®ÿ∑ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ•ŸÑŸâ ÿ®ÿ±ŸäÿØŸÉ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä.');
                closeForgotPassword();
            } catch (error) { 
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + getArabicError(error.code)); 
            } 
        };

        function getArabicError(code) {
            switch(code) {
                case 'auth/email-already-in-use': return 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ';
                case 'auth/invalid-email': return 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠';
                case 'auth/weak-password': return 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∂ÿπŸäŸÅÿ©';
                case 'auth/user-disabled': return 'ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ®';
                case 'auth/user-not-found': return 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ';
                case 'auth/wrong-password': return 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©';
                case 'storage/unauthorized': return 'ÿ∫Ÿäÿ± ŸÖÿµÿ±ÿ≠ ÿ®ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿµŸàÿ±';
                case 'storage/canceled': return 'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©';
                case 'storage/unknown': return 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ ŸÅŸä ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ';
                default: return 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + code;
            }
        }

        async function loadDisabledSubjects() {
            try {
                const docSnap = await getDoc(doc(db, "system_settings", "disabled_subjects"));
                if (docSnap.exists()) disabledSubjects = docSnap.data();
                else disabledSubjects = {};
            } catch (e) { disabledSubjects = {}; }
        }

        function populateSubjects(grade, elementId, type = null) {
            const sel = document.getElementById(elementId);
            if(!sel) return;
            let filteredSubjects = subjects[grade] || [];
            sel.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©</option>';
            filteredSubjects.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
            if (filteredSubjects.length === 0) sel.innerHTML += '<option value="" disabled>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßÿØ ŸÖÿ™ÿßÿ≠ÿ©</option>';
        }

        window.switchAuthTab = (tab) => {
            if(tab === 'login') {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('tab-login-btn').classList.add('active');
                document.getElementById('tab-signup-btn').classList.remove('active');
            } else {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
                document.getElementById('tab-login-btn').classList.remove('active');
                document.getElementById('tab-signup-btn').classList.add('active');
            }
        };

        window.handleLogin = async () => {
            try {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                
                if (!email || !pass) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
                    return;
                }
                
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) { 
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ', getArabicError(e.code)); 
            }
        };

        window.handleSignup = async () => {
            try {
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const pass = document.getElementById('signup-pass').value;
                
                if(!name || !email || !pass) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ŸÉÿßŸÅÿ© ÿßŸÑÿ≠ŸÇŸàŸÑ');
                    return;
                }
                
                if(!email.endsWith("@gmail.com")) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ¨ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸäŸÖŸäŸÑ Gmail');
                    return;
                }
                
                if(pass.length < 6) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÇÿµŸäÿ±ÿ© ÿ¨ÿØÿßŸã');
                    return;
                }

                let photoURL = `https://ui-avatars.com/api/?name=${name}&background=random&size=128`;
                const imgFile = document.getElementById('signup-img').files[0];
                if(imgFile) {
                    try {
                        photoURL = await uploadImageToStorage(imgFile, "new_user_" + Date.now());
                    } catch (error) {
                        console.error("Error uploading profile image:", error);
                        showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿµŸàÿ±ÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ®ÿ≥ÿ®ÿ® ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©');
                    }
                }

                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                
                await setDoc(doc(db, "users", cred.user.uid), {
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    photo: photoURL,
                    uniqueId: generateId(),
                    points: 0,
                    balance: 0,
                    role: 'user',
                    isBanned: false,
                    bio: "",
                    invitedCount: 0,
                    createdAt: serverTimestamp(),
                    lastRewardDayKey: null, 
                    rewardMonthKey: null,    
                    daysClaimedInMonth: 0,
                    isPremium: false,
                    premiumExpiry: null,
                    selectedBadge: null,
                    selectedBadgeColor: null,
                    selectedBgTheme: 'bg-rank-default',
                    selectedFrame: null,
                    notifications: [],
                    friends: [],
                    friendRequests: [],
                    pendingRequests: []
                });

                showBeautifulAlert('success', 'ŸÖÿ®ÿ±ŸàŸÉ!', 'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®ŸÉ ÿ®ŸÜÿ¨ÿßÿ≠');

            } catch (e) { 
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', getArabicError(e.code)); 
            }
        };

        window.logout = () => {
            if(adminListenerUnsubscribe) adminListenerUnsubscribe(); 
            if(matchListenerUnsubscribe) matchListenerUnsubscribe();
            if(roomListenerUnsubscribe) roomListenerUnsubscribe();
            if(premiumInterval) clearInterval(premiumInterval);
            if(connectionMonitorInterval) clearInterval(connectionMonitorInterval);
            clearImageCache();
            signOut(auth);
        };

        function getIraqDate() {
            const dateStr = new Date().toLocaleString("en-US", {timeZone: "Asia/Baghdad"});
            return new Date(dateStr);
        }

        window.checkDailyReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            if (userData.lastRewardDayKey === currentDayKey) return; 

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const nextDayToClaim = userDaysClaimed + 1;
            const grid = document.getElementById('reward-grid-container');
            grid.innerHTML = '';
            for(let i=1; i<=30; i++) {
                let pts = 5;
                if(i > 10 && i <= 20) pts = 10;
                if(i > 20) pts = 15;

                let cls = "day-box";
                if (i < nextDayToClaim) cls += " claimed"; 
                else if (i === nextDayToClaim) cls += " active"; 
                else cls += " locked"; 
                grid.innerHTML += `<div class="${cls}"><p>ŸäŸàŸÖ ${i}</p><span>${pts} ŸÜŸÇÿßÿ∑</span></div>`;
            }
            document.getElementById('daily-reward-screen').classList.remove('hidden');
        };

        window.claimReward = async () => {
            const iraqDate = getIraqDate();
            const currentDayKey = `${iraqDate.getDate()}-${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;
            const currentMonthKey = `${iraqDate.getMonth()}-${iraqDate.getFullYear()}`;

            let userDaysClaimed = userData.daysClaimedInMonth || 0;
            if (userData.rewardMonthKey !== currentMonthKey) userDaysClaimed = 0;

            const dayToClaim = userDaysClaimed + 1;
            let rewardAmount = 5;
            if(dayToClaim > 10 && dayToClaim <= 20) rewardAmount = 10;
            if(dayToClaim > 20) rewardAmount = 15;

            await updateDoc(doc(db, "users", currentUser.uid), {
                points: increment(rewardAmount),
                lastRewardDayKey: currentDayKey,
                rewardMonthKey: currentMonthKey,
                daysClaimedInMonth: increment(1) 
            });
            userData.points += rewardAmount;
            userData.lastRewardDayKey = currentDayKey;
            userData.rewardMonthKey = currentMonthKey;
            userData.daysClaimedInMonth = dayToClaim;
            setupHeaderUI();
            document.getElementById('daily-reward-screen').classList.add('hidden');
        };

        function setupProfileUI() {
            document.getElementById('profile-name-text').innerText = userData.name;
            document.getElementById('profile-id-text').innerText = "ID: " + userData.uniqueId;
            
            const profileImg = document.getElementById('profile-img');
            profileImg.classList.add('image-loading');
            loadImageWithCache(profileImg, userData.photo, 'https://ui-avatars.com/api/?name=' + userData.name + '&background=random');
            
            const bioText = document.getElementById('profile-bio-text');
            if (userData.bio && userData.bio.length > 25) {
                bioText.innerText = userData.bio.substring(0, 22) + '...';
            } else {
                bioText.innerText = userData.bio || "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥Ÿäÿ±ÿ© ÿ∞ÿßÿ™Ÿäÿ©";
            }
            
            const container = document.getElementById('profile-name-container');
            const existingBadge = container.querySelector('.premium-badge');
            if(existingBadge) existingBadge.remove();

            if (userData.isPremium && userData.selectedBadge && isPremiumValid(userData)) {
                const badgeSpan = document.createElement('span');
                badgeSpan.className = "premium-badge";
                badgeSpan.style.backgroundColor = userData.selectedBadgeColor || '#f59e0b';
                badgeSpan.innerText = userData.selectedBadge;
                container.insertBefore(badgeSpan, document.getElementById('profile-name-text').nextSibling);
            }

            document.getElementById('wallet-balance').innerText = userData.balance || 0;
            if ((userData.balance || 0) >= 100) {
                document.getElementById('withdraw-section').classList.remove('hidden');
                document.getElementById('withdraw-locked-msg').classList.add('hidden');
            } else {
                document.getElementById('withdraw-section').classList.add('hidden');
                document.getElementById('withdraw-locked-msg').classList.remove('hidden');
            }

            applyProfileFrame();
        }

        function applyProfileFrame() {
            const profileImgContainer = document.querySelector('#profile-img').parentElement;
            
            // Remove existing frame
            const existingFrame = profileImgContainer.querySelector('.profile-frame');
            if (existingFrame) {
                existingFrame.remove();
            }

            // Apply new frame if premium and has selected frame
            if (userData.isPremium && userData.selectedFrame && isPremiumValid(userData)) {
                const frameDiv = document.createElement('div');
                frameDiv.className = `profile-frame ${userData.selectedFrame}`;
                profileImgContainer.appendChild(frameDiv);
            }
        }
        
        function setupHeaderUI() { 
            document.getElementById('header-points').innerText = userData.points; 
            const addSubscriptionBtn = document.getElementById('add-subscription-btn');
            if (isPremiumValid(userData) && document.getElementById('screen-premium-in-profile').classList.contains('active')) {
                addSubscriptionBtn.classList.remove('hidden');
            } else {
                addSubscriptionBtn.classList.add('hidden');
            }
        }
        
        function setupAdminUI() { 
            if (userData.email === ADMIN_EMAIL) {
                document.getElementById('admin-hub-btn-container').classList.remove('hidden'); 
                loadBannedUsers();
            }
        }

        window.saveUserGrade = async () => {
            const g = document.getElementById('grade-select').value;
            if (!g) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©');
                return;
            }
            await updateDoc(doc(db, "users", currentUser.uid), { grade: g });
            userData.grade = g;
            document.getElementById('grade-selector-card').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            document.getElementById('header-grade-badge').innerText = getGradeName(g);
            document.getElementById('header-grade-badge').classList.remove('hidden');
            populateSubjects(g, 'challenge-subject');
        };

        function getGradeName(code) { 
            return code==='6sci'?'ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿπŸÑŸÖŸä':code==='6lit'?'ÿßŸÑÿ≥ÿßÿØÿ≥ ÿßŸÑÿ£ÿØÿ®Ÿä':'ÿßŸÑÿ´ÿßŸÑÿ´ ŸÖÿ™Ÿàÿ≥ÿ∑'; 
        }

        function isPremiumValid(user) {
            if(!user.isPremium || !user.premiumExpiry) return false;
            const now = new Date();
            const expiry = user.premiumExpiry.toDate();
            const isValid = expiry > now;
            
            if (!isValid && user.isPremium) {
                deactivatePremiumFeatures(user.uid);
            }
            
            return isValid;
        }

        async function deactivatePremiumFeatures(uid) {
            try {
                await updateDoc(doc(db, "users", uid), {
                    isPremium: false,
                    selectedBadge: null,
                    selectedBadgeColor: null,
                    selectedBgTheme: 'bg-rank-default',
                    selectedFrame: null
                });
                
                if (uid === currentUser?.uid) {
                    userData.isPremium = false;
                    userData.selectedBadge = null;
                    userData.selectedBadgeColor = null;
                    userData.selectedBgTheme = 'bg-rank-default';
                    userData.selectedFrame = null;
                    checkPremiumStatus();
                    setupProfileUI();
                }
            } catch (error) {
                console.error("Error deactivating premium:", error);
            }
        }

        function checkPremiumStatus() {
            const lockedView = document.getElementById('premium-locked-view');
            const activeView = document.getElementById('premium-active-view');
            
            if (isPremiumValid(userData)) {
                lockedView.classList.add('hidden');
                activeView.classList.remove('hidden');
                startPremiumTimer();
            } else {
                lockedView.classList.remove('hidden');
                activeView.classList.add('hidden');
                if(premiumInterval) clearInterval(premiumInterval);
            }
        }

        function startPremiumTimer() {
            if(premiumInterval) clearInterval(premiumInterval);
            const display = document.getElementById('premium-countdown');
            const expiry = userData.premiumExpiry.toDate();

            function update() {
                const now = new Date();
                const diff = expiry - now;
                if(diff <= 0) {
                    display.innerText = "00:00:00:00";
                    clearInterval(premiumInterval);
                    deactivatePremiumFeatures(currentUser.uid);
                    return;
                }
                
                const months = Math.floor(diff / (1000 * 60 * 60 * 24 * 30));
                const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                display.innerText = `${months}:${days<10?'0'+days:days}:${hours<10?'0'+hours:hours}:${minutes<10?'0'+minutes:minutes}:${seconds<10?'0'+seconds:seconds}`;
            }
            update();
            premiumInterval = setInterval(update, 1000);
        }

        window.showPremiumDetails = () => { 
            document.getElementById('premium-details-modal').classList.remove('hidden'); 
        }
        
        window.activatePremiumCode = async () => {
            const codeInput = document.getElementById('premium-code-input').value.trim().toUpperCase();
            if(!codeInput) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ');
                return;
            }

            try {
                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }
                
                const codeDoc = snap.docs[0];
                const codeData = codeDoc.data();

                if(codeData.used) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ŸÇÿ®ŸÑ ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
                    return;
                }

                if(codeData.isActive === false) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿπÿ∑ŸÑ ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ©');
                    return;
                }

                const durationDays = codeData.durationDays;
                let newExpiry = new Date();
                
                if (isPremiumValid(userData)) {
                    newExpiry = userData.premiumExpiry.toDate();
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                } else {
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                }

                const batch = writeBatch(db);
                
                batch.update(doc(db, "premium_codes", codeDoc.id), { 
                    used: true, 
                    usedBy: currentUser.uid, 
                    usedAt: serverTimestamp() 
                });
                
                batch.update(doc(db, "users", currentUser.uid), { 
                    isPremium: true,
                    premiumExpiry: Timestamp.fromDate(newExpiry)
                });
                
                await batch.commit();
                
                userData.isPremium = true;
                userData.premiumExpiry = Timestamp.fromDate(newExpiry);

                showBeautifulAlert('success', 'ŸÖÿ®ÿ±ŸàŸÉ!', `üéâ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿßŸÑŸÖŸÖŸäÿ≤ ŸÑŸÖÿØÿ© ${durationDays} ŸäŸàŸÖ.\n\nÿßŸÑŸÉŸàÿØ ÿßÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÑŸÜ ŸäÿπŸÖŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.`);
                checkPremiumStatus();
                setupHeaderUI();
                document.getElementById('premium-code-input').value = "";

            } catch(e) { 
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÉŸàÿØ:", e);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÉŸàÿØ: ' + e.message); 
            }
        };

        document.getElementById('add-subscription-btn').addEventListener('click', function() {
            if (!isPremiumValid(userData)) {
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿ¥ÿ™ÿ±ŸÉÿßŸã ŸÖŸÖŸäÿ≤ÿßŸã ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ©');
                return;
            }
            document.getElementById('add-subscription-modal').classList.remove('hidden');
        });

        window.addSubscriptionTime = async function() {
            const codeInput = document.getElementById('add-subscription-code').value.trim().toUpperCase();
            if(!codeInput) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ');
                return;
            }

            try {
                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ ÿ£Ÿà ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }
                
                const codeDoc = snap.docs[0];
                const codeData = codeDoc.data();

                if(codeData.used) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ŸÇÿ®ŸÑ ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖŸá ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
                    return;
                }

                if(codeData.isActive === false) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿπÿ∑ŸÑ ŸÖŸÜ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿØÿßÿ±ÿ©');
                    return;
                }

                const durationDays = codeData.durationDays;
                let newExpiry = new Date();
                
                if (isPremiumValid(userData)) {
                    newExpiry = userData.premiumExpiry.toDate();
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                } else {
                    newExpiry.setDate(newExpiry.getDate() + durationDays);
                }

                const batch = writeBatch(db);
                
                batch.update(doc(db, "premium_codes", codeDoc.id), { 
                    used: true, 
                    usedBy: currentUser.uid, 
                    usedAt: serverTimestamp() 
                });
                
                batch.update(doc(db, "users", currentUser.uid), { 
                    premiumExpiry: Timestamp.fromDate(newExpiry)
                });
                
                await batch.commit();
                
                userData.premiumExpiry = Timestamp.fromDate(newExpiry);

                showBeautifulAlert('success', 'ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©', `üéâ ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${durationDays} ŸäŸàŸÖ ŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉŸÉ!\n\nÿßŸÑŸÖÿØÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©: ${newExpiry.toLocaleDateString('ar-EG')}`);
                checkPremiumStatus();
                document.getElementById('add-subscription-code').value = "";
                document.getElementById('add-subscription-modal').classList.add('hidden');

            } catch(e) { 
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿØÿ©:", e);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿØÿ©: ' + e.message); 
            }
        };

        window.openBadgeSelector = () => {
            const grid = document.getElementById('badge-grid');
            grid.innerHTML = '';
            BADGES_LIST.forEach(txt => {
                const btn = document.createElement('button');
                const colors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#818cf8', '#a78bfa', '#f472b6'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                btn.className = "p-3 rounded-lg border-2 border-gray-100 font-bold text-white shadow-sm hover:scale-105 transition";
                btn.style.backgroundColor = randomColor;
                btn.innerText = txt;
                btn.onclick = () => saveBadgeChoice(txt, randomColor);
                grid.appendChild(btn);
            });
            document.getElementById('badge-selector-modal').classList.remove('hidden');
        };

        async function saveBadgeChoice(txt, color) {
            await updateDoc(doc(db, "users", currentUser.uid), { selectedBadge: txt, selectedBadgeColor: color });
            userData.selectedBadge = txt;
            userData.selectedBadgeColor = color;
            document.getElementById('badge-selector-modal').classList.add('hidden');
            setupProfileUI();
            showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´', 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™Ÿàÿ´ŸäŸÇ ‚úÖ');
        }

        window.openBgSelector = () => {
            const list = document.getElementById('bg-grid');
            list.innerHTML = '';
            BACKGROUNDS_LIST.forEach(bg => {
                const btn = document.createElement('button');
                btn.className = `w-full h-20 rounded-xl shadow-md border-2 border-transparent hover:border-indigo-500 transition mb-2 ${bg.class} flex items-center justify-center`;
                btn.innerHTML = `<span class="bg-white/80 px-3 py-1 rounded-full font-bold text-gray-800 text-sm">${bg.name}</span>`;
                btn.onclick = () => saveBgChoice(bg.id, bg.class);
                list.appendChild(btn);
            });
            document.getElementById('bg-selector-modal').classList.remove('hidden');
        };

        async function saveBgChoice(id, cssClass) {
             await updateDoc(doc(db, "users", currentUser.uid), { selectedBgTheme: cssClass });
             userData.selectedBgTheme = cssClass;
             document.getElementById('bg-selector-modal').classList.add('hidden');
             showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´', 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ™ÿµŸÜŸäŸÅ ‚úÖ');
        }

        window.openFrameSelector = () => {
            if (!isPremiumValid(userData)) {
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿ¥ÿ™ÿ±ŸÉÿßŸã ŸÖŸÖŸäÿ≤ÿßŸã ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ©');
                return;
            }

            const grid = document.getElementById('frame-grid');
            grid.innerHTML = '';
            FRAMES_LIST.forEach(frame => {
                const btn = document.createElement('button');
                btn.className = `relative h-32 rounded-xl shadow-lg border-2 border-transparent hover:border-yellow-500 transition overflow-hidden group`;
                
                // Create preview frame
                const previewDiv = document.createElement('div');
                previewDiv.className = `absolute inset-0 ${frame.class} flex items-center justify-center`;
                
                // Add avatar inside frame
                const avatar = document.createElement('div');
                avatar.className = "w-16 h-16 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center";
                avatar.innerHTML = '<i class="fas fa-user text-white text-2xl"></i>';
                previewDiv.appendChild(avatar);
                
                // Add frame name
                const nameDiv = document.createElement('div');
                nameDiv.className = "absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs font-bold py-1 text-center";
                nameDiv.innerText = frame.name;
                previewDiv.appendChild(nameDiv);
                
                btn.appendChild(previewDiv);
                btn.onclick = () => saveFrameChoice(frame.id, frame.class);
                grid.appendChild(btn);
            });
            document.getElementById('frame-selector-modal').classList.remove('hidden');
        };

        async function saveFrameChoice(frameId, frameClass) {
            await updateDoc(doc(db, "users", currentUser.uid), { selectedFrame: frameClass });
            userData.selectedFrame = frameClass;
            document.getElementById('frame-selector-modal').classList.add('hidden');
            setupProfileUI();
            showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´', 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ‚úÖ');
        }

        window.setQType = (t) => {
            selectedQType = t;
            document.getElementById('btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
        };

        window.startMatchmaking = async (mode) => {
            const sub = document.getElementById('challenge-subject').value;
            if(!sub || !selectedQType) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿßÿØÿ© ŸàŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©');
                return;
            }

            currentGameMode = mode;
            matchConnectionChecked = false;

            document.getElementById('challenge-active-card').classList.add('hidden');
            document.getElementById('searching-ui').classList.remove('hidden');
            document.getElementById('searching-ui').style.display = 'flex'; 
            document.getElementById('search-msg').innerText = mode === 'online' ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ∑ÿßŸÑÿ®..." : "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿ®Ÿàÿ™...";

            const grade = userData.grade;
            let group = `${grade}_${sub}`;
            
            if(sharedSubjects.includes(sub) && (grade === '6sci' || grade === '6lit')) {
                group = `6shared_${sub}`;
            }

            if (mode === 'online') startOnlineMatch(group, sub);
            else startAIMatch(sub);
        };

        async function startOnlineMatch(group, sub) {
            try {
                const qRef = collection(db, "match_queue");
                
                const qWait = query(
                    qRef, 
                    where("group", "==", group), 
                    where("status", "==", "waiting"), 
                    limit(10)
                );
                
                const snap = await getDocs(qWait);
                let foundMatchId = null;
                let foundMatchData = null;
                
                snap.forEach((doc) => { 
                    const matchData = doc.data();
                    if (matchData.player1.uid !== currentUser.uid && matchData.grade === userData.grade) {
                        const lastActiveTime = matchData.player1LastActive || 0;
                        const currentTime = Date.now();
                        
                        if (currentTime - lastActiveTime < 30000) {
                            foundMatchId = doc.id;
                            foundMatchData = matchData;
                        }
                    }
                });

                if(foundMatchId && foundMatchData) {
                    currentMatchId = foundMatchId;
                    await updateDoc(doc(db, "match_queue", foundMatchId), {
                        player2: { 
                            uid: currentUser.uid, 
                            name: userData.name, 
                            score: 0, 
                            photo: userData.photo,
                            grade: userData.grade
                        },
                        status: 'active',
                        answersCount: 0,
                        player2LastActive: Date.now(),
                        lastActivity: Date.now()
                    });
                    
                    // Save match info for resume
                    localStorage.setItem('pending_match', JSON.stringify({
                        matchId: foundMatchId,
                        mode: 'online',
                        timestamp: Date.now()
                    }));
                    
                    listenToMatch(foundMatchId);
                    startConnectionMonitoring(foundMatchId, false);
                } else {
                    const qDocs = await getQuestions(sub, selectedQType);
                    if(qDocs.length === 0) { 
                        showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÉÿßŸÅŸäÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©'); 
                        cancelSearch(); 
                        return; 
                    }
                    
                    const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
                    const newMatch = await addDoc(qRef, {
                        group: group, 
                        status: 'waiting',
                        grade: userData.grade,
                        player1: { 
                            uid: currentUser.uid, 
                            name: userData.name, 
                            score: 0, 
                            photo: userData.photo,
                            grade: userData.grade
                        },
                        questions: shuffledQs, 
                        currentIdx: 0, 
                        answersCount: 0,
                        player1LastActive: Date.now(),
                        lastActivity: Date.now(),
                        createdAt: serverTimestamp()
                    });
                    currentMatchId = newMatch.id;
                    
                    // Save match info for resume
                    localStorage.setItem('pending_match', JSON.stringify({
                        matchId: newMatch.id,
                        mode: 'online',
                        timestamp: Date.now()
                    }));
                    
                    listenToMatch(newMatch.id);
                }
            } catch(e) { 
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ®ÿßÿ±ÿßÿ©:", e); 
                cancelSearch(); 
            }
        }

        async function startAIMatch(sub) {
            const qDocs = await getQuestions(sub, selectedQType);
            if(qDocs.length === 0) { 
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÉÿßŸÅŸäÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ ŸÑŸáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©'); 
                cancelSearch(); 
                return; 
            }
            
            let limit = 10;
            if (isPremiumValid(userData)) limit = 15;

            const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, limit);
            localMatchData = {
                status: 'active',
                grade: userData.grade,
                player1: { 
                    uid: currentUser.uid, 
                    name: userData.name, 
                    score: 0, 
                    photo: userData.photo,
                    grade: userData.grade
                },
                player2: { 
                    uid: 'AI_BOT', 
                    name: "ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä", 
                    score: 0, 
                    photo: 'https://cdn-icons-png.flaticon.com/512/4712/4712027.png',
                    grade: userData.grade
                },
                questions: shuffledQs, 
                currentIdx: 0, 
                answersCount: 0
            };
            
            // Save match info for resume
            localStorage.setItem('pending_match', JSON.stringify({
                matchId: 'ai_match_' + Date.now(),
                mode: 'ai',
                data: localMatchData,
                timestamp: Date.now()
            }));
            
            await showVSAnimation(localMatchData.player1, localMatchData.player2);
            document.getElementById('game-overlay').classList.remove('hidden');
            document.getElementById('withdraw-game-btn').classList.add('hidden');
            renderGame(localMatchData);
        }

        async function getQuestions(sub, type) {
            if (!userData.grade) {
                console.error("ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿ≠ŸÑÿ© ŸÖÿ≠ÿØÿØÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ");
                return [];
            }
            
            let gradeCondition = userData.grade;
            if(sharedSubjects.includes(sub) && (userData.grade === '6sci' || userData.grade === '6lit')) {
                gradeCondition = ['6sci', '6lit'];
            }
            
            let q;
            if (Array.isArray(gradeCondition)) {
                q = query(
                    collection(db, "questions"), 
                    where("grade", "in", gradeCondition),  
                    where("subject", "==", sub), 
                    where("type", "==", type), 
                    limit(30)
                );
            } else {
                q = query(
                    collection(db, "questions"), 
                    where("grade", "==", gradeCondition),  
                    where("subject", "==", sub), 
                    where("type", "==", type), 
                    limit(30)
                );
            }
            
            const snap = await getDocs(q);
            const list = [];
            snap.forEach(d => {
                const data = d.data();
                list.push(data);
            });
            return list;
        }

        function startConnectionMonitoring(matchId, isPlayer1) {
            if(connectionMonitorInterval) clearInterval(connectionMonitorInterval);
            isMonitoringConnection = true;
            opponentLastSeen = Date.now();
            
            // Show connection indicator
            const indicator = document.getElementById('connection-indicator');
            indicator.classList.remove('hidden', 'good', 'poor', 'bad');
            indicator.classList.add('good');
            indicator.innerHTML = '<i class="fas fa-wifi"></i><span>ÿßÿ™ÿµÿßŸÑ ŸÖŸÖÿ™ÿßÿ≤</span>';
            
            connectionMonitorInterval = setInterval(async () => {
                if(!isMonitoringConnection || !currentMatchId) return;
                
                const now = Date.now();
                const timeSinceLastSeen = now - opponentLastSeen;
                
                // Update connection indicator status
                if (timeSinceLastSeen > 3000) {
                    indicator.classList.remove('good');
                    indicator.classList.add('poor');
                    indicator.innerHTML = '<i class="fas fa-wifi"></i><span>ÿßÿ™ÿµÿßŸÑ ÿ∂ÿπŸäŸÅ</span>';
                }
                
                if (timeSinceLastSeen > 6000) {
                    indicator.classList.remove('poor');
                    indicator.classList.add('bad');
                    indicator.innerHTML = '<i class="fas fa-wifi-slash"></i><span>ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ...</span>';
                }
                
                if(timeSinceLastSeen > 10000 && !matchConnectionChecked) {
                    matchConnectionChecked = true;
                    await checkOpponentConnection(matchId, isPlayer1);
                }
            }, 3000); // Check every 3 seconds
            
            updateLastActive(matchId, isPlayer1);
        }

        async function updateLastActive(matchId, isPlayer1) {
            try {
                const updateField = isPlayer1 ? 'player1LastActive' : 'player2LastActive';
                await updateDoc(doc(db, "match_queue", matchId), {
                    [updateField]: Date.now(),
                    lastActivity: Date.now()
                });
            } catch (error) {
                console.error("Error updating last active:", error);
            }
        }

        async function checkOpponentConnection(matchId, isPlayer1) {
            try {
                const matchDoc = await getDoc(doc(db, "match_queue", matchId));
                if(!matchDoc.exists()) return;
                
                const matchData = matchDoc.data();
                const opponentLastActive = isPlayer1 ? matchData.player2LastActive : matchData.player1LastActive;
                const now = Date.now();
                
                if(opponentLastActive && (now - opponentLastActive) > 15000) {
                    await handlePlayerDisconnection(matchId, isPlayer1);
                } else {
                    matchConnectionChecked = false;
                }
            } catch (error) {
                console.error("Error checking connection:", error);
            }
        }

        async function handlePlayerDisconnection(matchId, isPlayer1) {
            if(playerDisconnected) return;
            playerDisconnected = true;
            
            try {
                const matchDoc = await getDoc(doc(db, "match_queue", matchId));
                if(!matchDoc.exists()) return;
                
                const matchData = matchDoc.data();
                const winnerId = isPlayer1 ? matchData.player2.uid : matchData.player1.uid;
                const loserId = isPlayer1 ? matchData.player1.uid : matchData.player2.uid;
                
                if(winnerId && winnerId !== 'AI_BOT') {
                    await updateDoc(doc(db, "users", winnerId), {
                        points: increment(10)
                    });
                }
                
                if(loserId && loserId !== 'AI_BOT') {
                    await updateDoc(doc(db, "users", loserId), {
                        points: increment(-10)
                    });
                }
                
                await deleteDoc(doc(db, "match_queue", matchId));
                
                if(connectionMonitorInterval) {
                    clearInterval(connectionMonitorInterval);
                    isMonitoringConnection = false;
                }
                
                // Clear pending match from localStorage
                localStorage.removeItem('pending_match');
                
                if(winnerId === currentUser.uid) {
                    showDisconnectionResult(true, "ŸÅÿ≤ÿ™ ÿ®ÿ≥ÿ®ÿ® ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßŸÜÿ™ÿ±ŸÜÿ™ ÿπŸÜÿØ ÿÆÿµŸÖŸÉ");
                } else if(loserId === currentUser.uid) {
                    showDisconnectionResult(false, "ÿÆÿ≥ÿ±ÿ™ ÿ®ÿ≥ÿ®ÿ® ÿßŸÜŸÇÿ∑ÿßÿπ ÿßŸÑÿßŸÜÿ™ÿ±ŸÜÿ™");
                }
                
            } catch (error) {
                console.error("Error handling disconnection:", error);
            }
        }

        function showDisconnectionResult(isWinner, message) {
            clearInterval(gameTimer);
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('connection-indicator').classList.add('hidden');
            
            const resultScreen = document.getElementById('result-screen');
            const iconContainer = document.getElementById('result-icon-container');
            const title = document.getElementById('result-title');
            const msg = document.getElementById('result-msg');
            const myScore = document.getElementById('final-my-score');
            const opScore = document.getElementById('final-op-score');
            const opName = document.getElementById('final-op-name');
            const pointsGained = document.getElementById('result-points-gained-text');
            
            if(isWinner) {
                iconContainer.innerText = "üèÜ";
                title.innerText = "ŸÅŸàÿ≤!";
                msg.innerText = message;
                myScore.innerText = "10";
                opScore.innerText = "0";
                opName.innerText = "ÿßŸÑÿÆÿµŸÖ";
                pointsGained.innerText = "+10";
            } else {
                iconContainer.innerText = "üò¢";
                title.innerText = "ÿÆÿ≥ÿßÿ±ÿ©!";
                msg.innerText = message;
                myScore.innerText = "0";
                opScore.innerText = "10";
                opName.innerText = "ÿßŸÑÿÆÿµŸÖ";
                pointsGained.innerText = "-10";
            }
            
            resultScreen.classList.remove('hidden');
        }

        function listenToMatch(id) {
            if(matchListenerUnsubscribe) matchListenerUnsubscribe(); 
            matchListenerUnsubscribe = onSnapshot(doc(db, "match_queue", id), async (snap) => {
                if(isExitingGame) return;
                if(!snap.exists()) {
                    if (currentGameMode === 'online') {
                        console.log("ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ© ÿ≠ÿ∞ŸÅÿ™ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±");
                        localStorage.removeItem('pending_match');
                        return;
                    }
                    return;
                }
                const d = snap.data();
                
                const isP1 = d.player1.uid === currentUser.uid;
                opponentLastSeen = isP1 ? (d.player2LastActive || Date.now()) : (d.player1LastActive || Date.now());
                
                if(d.status === 'active') {
                    if (document.getElementById('game-overlay').classList.contains('hidden') && !document.getElementById('vs-screen').classList.contains('flex')) {
                         await showVSAnimation(d.player1, d.player2);
                         document.getElementById('game-overlay').classList.remove('hidden');
                         document.getElementById('withdraw-game-btn').classList.remove('hidden');
                         startConnectionMonitoring(id, isP1);
                         renderGame(d);
                    } else {
                         renderGame(d);
                    }
                }
            });
        }
        
        async function showVSAnimation(p1, p2) {
            return new Promise(resolve => {
                document.getElementById('searching-ui').classList.add('hidden');
                document.getElementById('searching-ui').style.display = 'none';
                
                const isP1 = p1.uid === currentUser.uid;
                const me = isP1 ? p1 : p2;
                const op = isP1 ? p2 : p1;

                const vsP1Img = document.getElementById('vs-p1-img');
                vsP1Img.classList.add('image-loading');
                loadImageWithCache(vsP1Img, me.photo, 'https://ui-avatars.com/api/?name=' + me.name + '&background=random');
                
                const vsP2Img = document.getElementById('vs-p2-img');
                vsP2Img.classList.add('image-loading');
                loadImageWithCache(vsP2Img, op.photo, 'https://ui-avatars.com/api/?name=' + op.name + '&background=random');
                
                document.getElementById('vs-p1-name').innerText = me.name;
                document.getElementById('vs-p2-name').innerText = op.name;

                const screen = document.getElementById('vs-screen');
                screen.classList.remove('hidden');
                
                setTimeout(() => {
                    screen.classList.add('hidden');
                    resolve();
                }, 2500); 
            });
        }

        function renderGame(data) {
            if (isExitingGame) return;
            const totalQs = data.questions.length;
            if(!data.questions || data.currentIdx >= totalQs) { 
                endGame(data); 
                return; 
            }
            
            if (currentGameMode === 'online' && data.answersCount >= 2) {
                 if(data.player1.uid === currentUser.uid) {
                     updateDoc(doc(db, "match_queue", currentMatchId), { 
                         currentIdx: increment(1), 
                         answersCount: 0 
                     });
                 }
                 return;
            }
            
            const q = data.questions[data.currentIdx];
            if (!q) { 
                endGame(data); 
                return; 
            }
            
            if (currentGameMode === 'online') {
                const isP1 = data.player1.uid === currentUser.uid;
                document.getElementById('p1-name').innerText = userData.name;
                
                const gameP1Img = document.getElementById('game-p1-img');
                gameP1Img.classList.add('image-loading');
                loadImageWithCache(gameP1Img, userData.photo, 'https://ui-avatars.com/api/?name=' + userData.name + '&background=random');
                
                document.getElementById('p2-name').innerText = isP1 ? data.player2.name : data.player1.name;
                
                const gameP2Img = document.getElementById('game-p2-img');
                const opPhoto = isP1 ? data.player2.photo : data.player1.photo;
                const opName = isP1 ? data.player2.name : data.player1.name;
                gameP2Img.classList.add('image-loading');
                loadImageWithCache(gameP2Img, opPhoto, 'https://ui-avatars.com/api/?name=' + opName + '&background=random');
                
                document.getElementById('game-my-score').innerText = isP1 ? data.player1.score : data.player2.score;
                document.getElementById('game-op-score').innerText = isP1 ? data.player2.score : data.player1.score;
                
                // Show friend request button for opponent
                const friendBtn = document.getElementById('game-friend-request-btn');
                if (!isP1 && data.player1.uid && data.player1.uid !== currentUser.uid) {
                    friendBtn.classList.remove('hidden');
                    friendBtn.dataset.opponentId = data.player1.uid;
                    friendBtn.dataset.opponentName = data.player1.name;
                } else if (isP1 && data.player2.uid && data.player2.uid !== currentUser.uid) {
                    friendBtn.classList.remove('hidden');
                    friendBtn.dataset.opponentId = data.player2.uid;
                    friendBtn.dataset.opponentName = data.player2.name;
                } else {
                    friendBtn.classList.add('hidden');
                }
            } else {
                document.getElementById('p1-name').innerText = userData.name;
                
                const gameP1Img = document.getElementById('game-p1-img');
                gameP1Img.classList.add('image-loading');
                loadImageWithCache(gameP1Img, userData.photo, 'https://ui-avatars.com/api/?name=' + userData.name + '&background=random');
                
                document.getElementById('p2-name').innerText = data.player2.name;
                
                const gameP2Img = document.getElementById('game-p2-img');
                gameP2Img.classList.add('image-loading');
                loadImageWithCache(gameP2Img, data.player2.photo);
                
                document.getElementById('game-my-score').innerText = data.player1.score;
                document.getElementById('game-op-score').innerText = data.player2.score;
                
                // Hide friend request button for AI
                document.getElementById('game-friend-request-btn').classList.add('hidden');
            }

            const qTextEl = document.getElementById('q-text');
            if(qTextEl.innerText !== q.question) {
                hasAnsweredCurrentQ = false;
                userAnsweredCorrectly = false;
                currentQuestionCorrectAnswer = null;
                clearTimeout(aiTimeoutId); 
                document.getElementById('answers-container').classList.remove('pointer-events-none', 'opacity-50');
                document.getElementById('waiting-msg').classList.add('hidden');
                document.getElementById('ai-thinking-msg').classList.add('hidden');
                
                clearInterval(gameTimer);
                let t = 15;
                document.getElementById('game-timer').innerText = t;
                gameTimer = setInterval(() => {
                    if (isExitingGame) { clearInterval(gameTimer); return; }
                    t--;
                    document.getElementById('game-timer').innerText = t;
                    if(t <= 0) { 
                        clearInterval(gameTimer); 
                        if(!hasAnsweredCurrentQ) {
                            submitGameAnswer(null, q, data);
                        } else if (currentGameMode === 'ai') {
                            handleAINextTurn();
                        }
                    }
                }, 1000);
            }
            
            document.getElementById('q-progress').innerText = `${data.currentIdx + 1} / ${totalQs}`;
            qTextEl.innerText = q.question;
            const div = document.getElementById('answers-container');
            if(div.children.length === 0 || div.getAttribute('data-curr-q') !== q.question) {
                div.setAttribute('data-curr-q', q.question);
                div.innerHTML = '';
                let ansList = [];
                if(q.type === 'mcq') ansList = q.answers.map((txt, idx) => ({ txt, isCorrect: idx === q.correct, value: idx }));
                else ansList = [{ txt: 'ÿµÿ≠', isCorrect: q.correct === 'true' || q.correct === true, value: 'true' }, { txt: 'ÿÆÿ∑ÿ£', isCorrect: q.correct === 'false' || q.correct === false, value: 'false' }];
                
                const correctAns = ansList.find(ans => ans.isCorrect);
                if (correctAns) currentQuestionCorrectAnswer = correctAns.value;

                ansList.sort(() => 0.5 - Math.random());
                ansList.forEach(ansObj => {
                    const btn = document.createElement('button');
                    btn.className = "answer-neutral w-full py-4 border-2 rounded-xl text-lg font-bold shadow-sm active:scale-95 transition";
                    btn.innerText = ansObj.txt;
                    btn.dataset.value = ansObj.value;
                    btn.onclick = () => { if(hasAnsweredCurrentQ) return; submitGameAnswer(ansObj, q, data); };
                    div.appendChild(btn);
                });
            }
        }

        async function submitGameAnswer(ansObj, q, matchData) {
            if(hasAnsweredCurrentQ || isExitingGame) return;
            hasAnsweredCurrentQ = true;
            userAnsweredCorrectly = ansObj && ansObj.isCorrect;
            
            const answerButtons = document.querySelectorAll('#answers-container button');
            answerButtons.forEach(btn => {
                btn.classList.remove('answer-correct', 'answer-wrong', 'answer-neutral');
                if (btn.dataset.value.toString() === currentQuestionCorrectAnswer.toString()) btn.classList.add('answer-correct');
                else if (ansObj && btn.dataset.value.toString() === (ansObj.value?.toString())) btn.classList.add('answer-wrong');
                else btn.classList.add('answer-neutral');
            });
            
            document.getElementById('answers-container').classList.add('pointer-events-none');

            if (currentGameMode === 'online') {
                document.getElementById('waiting-msg').classList.remove('hidden');
                const isP1 = matchData.player1.uid === currentUser.uid;
                if (!currentMatchId) return;
                const scoreIncrement = ansObj && ansObj.isCorrect ? 1 : 0;
                const updates = { 
                    answersCount: increment(1),
                    lastActivity: Date.now()
                };
                if(ansObj && ansObj.isCorrect) updates[isP1?'player1.score':'player2.score'] = increment(scoreIncrement);
                await updateDoc(doc(db, "match_queue", currentMatchId), updates);
            } else {
                document.getElementById('waiting-msg').classList.add('hidden'); 
                if(ansObj && ansObj.isCorrect) {
                    localMatchData.player1.score += 1;
                    document.getElementById('game-my-score').innerText = localMatchData.player1.score;
                }
                triggerAIResponse();
            }
        }

        function triggerAIResponse() {
            document.getElementById('waiting-msg').classList.add('hidden');
            document.getElementById('ai-thinking-msg').classList.remove('hidden');
            let delay = Math.random() * 4000;
            let accuracy = 0.6;
            
            aiTimeoutId = setTimeout(() => {
                const isCorrect = Math.random() < accuracy;
                if(isCorrect) {
                    localMatchData.player2.score += 1;
                    document.getElementById('game-op-score').innerText = localMatchData.player2.score;
                }
                handleAINextTurn();
            }, delay);
        }

        function handleAINextTurn() {
            if(isExitingGame) return;
            localMatchData.currentIdx += 1;
            localMatchData.answersCount = 0;
            renderGame(localMatchData);
        }

        window.withdrawFromGame = async function() {
            if(!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿßŸÜÿ≥ÿ≠ÿßÿ® ŸÖŸÜ ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ©ÿü ÿ≥Ÿäÿ™ŸÖ ÿÆÿµŸÖ 10 ŸÜŸÇÿßÿ∑ ŸÖŸÜŸÉ ŸàŸÖŸÜÿ≠Ÿáÿß ŸÑŸÑÿÆÿµŸÖ.')) return;
            
            try {
                if(currentMatchId && currentGameMode === 'online') {
                    const matchDoc = await getDoc(doc(db, "match_queue", currentMatchId));
                    if(matchDoc.exists()) {
                        const matchData = matchDoc.data();
                        const isP1 = matchData.player1.uid === currentUser.uid;
                        const opponentId = isP1 ? matchData.player2.uid : matchData.player1.uid;
                        
                        await updateDoc(doc(db, "users", currentUser.uid), {
                            points: increment(-10)
                        });
                        
                        if(opponentId !== 'AI_BOT') {
                            await updateDoc(doc(db, "users", opponentId), {
                                points: increment(10)
                            });
                        }
                        
                        await deleteDoc(doc(db, "match_queue", currentMatchId));
                    }
                }
                
                // Clear pending match
                localStorage.removeItem('pending_match');
                
                showWithdrawalResult();
                
            } catch (error) {
                console.error("Error withdrawing:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßŸÜÿ≥ÿ≠ÿßÿ®');
            }
        };

        function showWithdrawalResult() {
            clearInterval(gameTimer);
            if(connectionMonitorInterval) clearInterval(connectionMonitorInterval);
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('connection-indicator').classList.add('hidden');
            
            const resultScreen = document.getElementById('result-screen');
            const iconContainer = document.getElementById('result-icon-container');
            const title = document.getElementById('result-title');
            const msg = document.getElementById('result-msg');
            const myScore = document.getElementById('final-my-score');
            const opScore = document.getElementById('final-op-score');
            const opName = document.getElementById('final-op-name');
            const pointsGained = document.getElementById('result-points-gained-text');
            
            iconContainer.innerText = "üò¢";
            title.innerText = "ÿßŸÜÿ≥ÿ≠ÿßÿ®";
            msg.innerText = "ŸÑŸÇÿØ ÿßŸÜÿ≥ÿ≠ÿ®ÿ™ ŸÖŸÜ ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ©";
            myScore.innerText = "0";
            opScore.innerText = "10";
            opName.innerText = "ÿßŸÑÿÆÿµŸÖ";
            pointsGained.innerText = "-10";
            
            resultScreen.classList.remove('hidden');
            
            userData.points -= 10;
            setupHeaderUI();
        }

        async function endGame(d) {
            clearInterval(gameTimer);
            if(connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
                isMonitoringConnection = false;
            }
            document.getElementById('game-overlay').classList.add('hidden');
            document.getElementById('connection-indicator').classList.add('hidden');
            document.getElementById('withdraw-game-btn').classList.add('hidden');
            if (isExitingGame) return;
            
            let myScore, opScore, opName;
            if (currentGameMode === 'online') {
                const isP1 = d.player1.uid === currentUser.uid;
                myScore = isP1 ? d.player1.score : d.player2.score;
                opScore = isP1 ? d.player2.score : d.player1.score;
                opName = isP1 ? d.player2.name : d.player1.name;
            } else {
                myScore = localMatchData.player1.score;
                opScore = localMatchData.player2.score;
                opName = localMatchData.player2.name;
            }
            
            let pointsGained = 0; 
            let msg = ""; 
            let icon = "";
            if (myScore > opScore) { 
                msg = "ŸÅŸàÿ≤ ÿ≥ÿßÿ≠ŸÇ!"; 
                icon = "üèÜ"; 
                pointsGained = myScore * 2;
            } else if (myScore < opScore) { 
                msg = "ÿ≠ÿ∏ ÿ£ŸàŸÅÿ±!"; 
                icon = "üò¢"; 
                pointsGained = 0;
            } else { 
                if(myScore > 0) { 
                    msg = "ÿ™ÿπÿßÿØŸÑ ÿ•Ÿäÿ¨ÿßÿ®Ÿä!"; 
                    icon = "ü§ù"; 
                    pointsGained = myScore * 1; 
                } else { 
                    msg = "ÿ™ÿπÿßÿØŸÑ ÿ≥ŸÑÿ®Ÿä!"; 
                    icon = "üòê"; 
                    pointsGained = 0; 
                }
            }
            
            if (isPremiumValid(userData) && pointsGained > 0) {
                 pointsGained = pointsGained * 2;
            }

            if(pointsGained > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { points: increment(pointsGained) });
                userData.points += pointsGained;
                setupHeaderUI();
            }
            
            if(currentMatchId && currentGameMode === 'online') {
                await deleteDoc(doc(db, "match_queue", currentMatchId));
            }
            
            // Clear pending match
            localStorage.removeItem('pending_match');
            
            const resultScreen = document.getElementById('result-screen');
            const iconContainer = document.getElementById('result-icon-container');
            const title = document.getElementById('result-title');
            const resultMsg = document.getElementById('result-msg');
            const finalMyScore = document.getElementById('final-my-score');
            const finalOpScore = document.getElementById('final-op-score');
            const finalOpName = document.getElementById('final-op-name');
            const pointsGainedText = document.getElementById('result-points-gained-text');
            
            iconContainer.innerText = icon;
            title.innerText = msg;
            resultMsg.innerText = "ŸÑŸÇÿØ ŸÇŸÖÿ™ ÿ®ÿ£ÿØÿßÿ° ÿ±ÿßÿ¶ÿπ";
            finalMyScore.innerText = myScore;
            finalOpScore.innerText = opScore;
            finalOpName.innerText = opName;
            pointsGainedText.innerText = `+${pointsGained}`;
            
            if (isPremiumValid(userData) && pointsGained > 0) {
                pointsGainedText.innerHTML += ' <span class="text-xs text-green-600">(x2 ŸÖŸÖŸäÿ≤)</span>';
            }
            
            resultScreen.classList.remove('hidden');
        }

        window.closeResultScreen = async () => {
             isExitingGame = true;
             if (matchListenerUnsubscribe) { 
                 matchListenerUnsubscribe(); 
                 matchListenerUnsubscribe = null; 
             }
             if(roomListenerUnsubscribe) {
                 roomListenerUnsubscribe();
                 roomListenerUnsubscribe = null;
             }
             clearInterval(gameTimer); 
             clearTimeout(aiTimeoutId);
             if(connectionMonitorInterval) {
                 clearInterval(connectionMonitorInterval);
                 isMonitoringConnection = false;
             }
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('game-overlay').classList.add('hidden');
             document.getElementById('connection-indicator').classList.add('hidden');
             document.getElementById('searching-ui').classList.add('hidden');
             document.getElementById('searching-ui').style.display = 'none';

             currentMatchId = null; 
             localMatchData = null; 
             hasAnsweredCurrentQ = false;
             playerDisconnected = false;
             matchConnectionChecked = false;
             document.getElementById('challenge-active-card').classList.remove('hidden');
             if(currentUser) {
                 const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                 if(userDoc.exists()) { 
                     userData = userDoc.data(); 
                     setupHeaderUI(); 
                     setupProfileUI(); 
                 }
                 loadLeaderboard();
             }
             switchTab('challenges');
             setTimeout(() => { isExitingGame = false; }, 500);
        };

        async function checkForPendingGame() {
            const pendingMatch = localStorage.getItem('pending_match');
            if (pendingMatch) {
                const matchData = JSON.parse(pendingMatch);
                const now = Date.now();
                
                // If match was created less than 5 minutes ago, show resume option
                if (now - matchData.timestamp < 5 * 60 * 1000) {
                    setTimeout(() => {
                        document.getElementById('game-resume-modal').classList.remove('hidden');
                    }, 1000);
                } else {
                    // Clear expired match
                    localStorage.removeItem('pending_match');
                }
            }
        }

        window.resumeGame = async function() {
            const pendingMatch = localStorage.getItem('pending_match');
            if (!pendingMatch) {
                document.getElementById('game-resume-modal').classList.add('hidden');
                return;
            }

            const matchData = JSON.parse(pendingMatch);
            
            if (matchData.mode === 'online' && matchData.matchId) {
                currentMatchId = matchData.matchId;
                currentGameMode = 'online';
                listenToMatch(matchData.matchId);
                
                try {
                    const matchDoc = await getDoc(doc(db, "match_queue", matchData.matchId));
                    if (matchDoc.exists()) {
                        const matchData = matchDoc.data();
                        startConnectionMonitoring(matchData.matchId, matchData.player1.uid === currentUser.uid);
                    }
                } catch (error) {
                    console.error("Error resuming game:", error);
                }
            } else if (matchData.mode === 'ai' && matchData.data) {
                localMatchData = matchData.data;
                currentGameMode = 'ai';
                
                document.getElementById('game-overlay').classList.remove('hidden');
                document.getElementById('withdraw-game-btn').classList.add('hidden');
                renderGame(localMatchData);
            }
            
            document.getElementById('game-resume-modal').classList.add('hidden');
        };

        window.cancelGameResume = function() {
            localStorage.removeItem('pending_match');
            document.getElementById('game-resume-modal').classList.add('hidden');
        };

        window.openPage = async (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'screen-admin-all') { 
                populateAdminFilterSubjects(); 
                loadAdminAllContent(); 
            }
            else if (screenId === 'screen-stats') loadStatsContent();
            else if (screenId === 'screen-admin-premium-users') loadPremiumUsers();
            else if (screenId === 'screen-wallet') setupProfileUI(); 
            else if (screenId === 'screen-premium-in-profile') {
                checkPremiumStatus();
                setupHeaderUI();
            }
            else if (screenId === 'screen-admin-users') {
                loadBannedUsers();
            }
            else if (screenId === 'screen-notifications') {
                loadNotifications();
            }
        };

        window.backToProfile = () => { 
             document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
             switchTab('profile');
        };

        window.backToChallenges = () => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            switchTab('challenges');
        };

        window.backToFriendChallenge = () => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-friend-challenge').classList.add('active');
        };

        window.editProfileBio = () => {
            document.getElementById('edit-bio-input').value = userData.bio || "";
            updateBioCharCount();
            document.getElementById('edit-bio-modal').classList.remove('hidden');
        };

        window.updateBioCharCount = function() {
            const bioInput = document.getElementById('edit-bio-input');
            const charCount = document.getElementById('bio-char-count');
            const count = bioInput.value.length;
            charCount.textContent = `${count}/25`;
            
            if (count > 25) {
                bioInput.value = bioInput.value.substring(0, 25);
                charCount.textContent = "25/25";
            }
        };

        window.saveProfileBio = async () => {
            const newBio = document.getElementById('edit-bio-input').value.trim();
            if (newBio.length > 25) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© ŸáŸà 25 ÿ≠ÿ±ŸÅ');
                return;
            }
            
            await updateDoc(doc(db, "users", currentUser.uid), { bio: newBio });
            userData.bio = newBio;
            
            const bioText = document.getElementById('profile-bio-text');
            if (newBio.length > 25) {
                bioText.innerText = newBio.substring(0, 22) + '...';
            } else {
                bioText.innerText = newBio || "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥Ÿäÿ±ÿ© ÿ∞ÿßÿ™Ÿäÿ©";
            }
            
            document.getElementById('edit-bio-modal').classList.add('hidden');
            showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´', 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© ‚úÖ');
        };

        async function loadStatsContent() {
             const div = document.getElementById('stats-content');
             try {
                 const usersSnap = await getDocs(collection(db, "users"));
                 const total = usersSnap.size;
                 const today = new Date(); today.setHours(0,0,0,0);
                 let newUsers = 0; let activeNow = 0; const now = new Date();
                 usersSnap.forEach(d => {
                     const u = d.data();
                     if(!u) return;
                     if(u.createdAt && u.createdAt.toDate && u.createdAt.toDate() >= today) newUsers++;
                     if (u.lastActive && u.lastActive.toDate && (now - u.lastActive.toDate()) < 15 * 60 * 1000) activeNow++;
                 });
                 if(activeNow === 0) activeNow = 1; 
                 div.innerHTML = `<div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÉŸÑŸä</p><p class="text-2xl font-bold text-gray-800">${total}</p></div><div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"><i class="fas fa-users"></i></div></div><div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ŸÜÿ¥ÿ∑ŸäŸÜ ÿßŸÑÿ¢ŸÜ</p><p class="text-2xl font-bold text-green-500">${activeNow}</p></div><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600"><i class="fas fa-wifi"></i></div></div><div class="bg-white p-5 rounded-2xl shadow-sm flex justify-between items-center"><div><p class="text-sm text-gray-500">ÿ≥ÿ¨ŸÑŸàÿß ÿßŸÑŸäŸàŸÖ</p><p class="text-2xl font-bold text-purple-500">${newUsers}</p></div><div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><i class="fas fa-user-plus"></i></div></div>`;
             } catch (error) {
                 div.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</p>';
             }
        }

        async function loadAdminAllContent() {
             const div = document.getElementById('admin-all-list');
             if(allAdminQuestions.length === 0) {
                 div.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿ¨ŸÑÿ® ŸÉŸÑ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</p>';
                 try {
                     const q = await getDocs(query(collection(db, "questions"), orderBy("createdAt", "desc"), limit(100)));
                     allAdminQuestions = [];
                     q.forEach(d => allAdminQuestions.push({id: d.id, ...d.data()}));
                 } catch (error) {
                     div.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©</p>';
                     return;
                 }
             }
             filterAdminQuestions();
        }

        window.populateAdminFilterSubjects = () => {
            const grade = document.getElementById('admin-filter-grade').value;
            const subSel = document.getElementById('admin-filter-subject');
            subSel.innerHTML = '<option value="">ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ</option>';
            if(grade && subjects[grade]) subjects[grade].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
        }

        window.renderAdminAllList = (list) => {
            const div = document.getElementById('admin-all-list');
            if(list.length === 0) { 
                div.innerHTML = "<p class='text-center text-gray-400 mt-4'>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</p>"; 
                return; 
            }
            let html = `<p class="text-xs text-gray-400 mb-2">ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ: ${list.length} ÿ≥ÿ§ÿßŸÑ</p>`;
            list.slice(0, 50).forEach(q => { 
                html += `<div class="bg-white rounded-xl p-3 mb-2 border border-gray-100 shadow-sm flex flex-col gap-2"><div class="flex justify-between items-start"><div><span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold">${q.grade || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} | ${q.subject}</span><span class="text-xs text-gray-400 ml-2">${q.type==='mcq'?'ÿßÿÆÿ™Ÿäÿßÿ±ÿßÿ™':'ÿµÿ≠/ÿÆÿ∑ÿ£'}</span></div><div class="flex gap-1"><button onclick="openEditModal('${q.id}')" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200 transition"><i class="fas fa-edit ml-1"></i>ÿ™ÿπÿØŸäŸÑ</button><button onclick="deleteApprovedQ('${q.id}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200 transition"><i class="fas fa-trash"></i></button></div></div><p class="font-bold text-gray-700 text-sm leading-6 border-r-2 border-indigo-200 pr-2">${q.question}</p></div>`;
            });
            div.innerHTML = html;
        };

        window.filterAdminQuestions = () => {
            if(event && event.target && event.target.id === 'admin-filter-grade') populateAdminFilterSubjects();
            const gr = document.getElementById('admin-filter-grade').value;
            const sub = document.getElementById('admin-filter-subject').value;
            const type = document.getElementById('admin-filter-type').value;
            const filtered = allAdminQuestions.filter(q => {
                const matchesGrade = gr ? (q.grade === gr) : true;
                const matchesSubject = sub ? (q.subject === sub) : true;
                const matchesType = type ? (q.type === type) : true;
                return matchesGrade && matchesSubject && matchesType;
            });
            renderAdminAllList(filtered);
        };

        window.openEditModal = (id) => {
            const q = allAdminQuestions.find(i => i.id === id);
            if(!q) return;
            document.getElementById('edit-q-id').value = id;
            document.getElementById('edit-q-text').value = q.question;
            document.getElementById('edit-q-grade').value = q.grade || '6sci';
            const subSel = document.getElementById('edit-q-subject');
            subSel.innerHTML = "";
            subjects[q.grade || '6sci'].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            subSel.value = q.subject;
            document.getElementById('edit-q-grade').onchange = () => {
                const g = document.getElementById('edit-q-grade').value;
                subSel.innerHTML = "";
                subjects[g].forEach(s => subSel.innerHTML += `<option value="${s}">${s}</option>`);
            };
            if(q.type === 'mcq') {
                document.getElementById('edit-mcq-fields').classList.remove('hidden');
                document.getElementById('edit-tf-fields').classList.add('hidden');
                document.getElementById('edit-ans-0').value = q.answers[0];
                document.getElementById('edit-ans-1').value = q.answers[1];
                document.getElementById('edit-ans-2').value = q.answers[2];
                document.getElementById('edit-correct-mcq').value = q.correct;
            } else {
                document.getElementById('edit-mcq-fields').classList.add('hidden');
                document.getElementById('edit-tf-fields').classList.remove('hidden');
                document.getElementById('edit-correct-tf').value = q.correct;
            }
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.saveFullEditQ = async () => {
            const id = document.getElementById('edit-q-id').value;
            const originalQ = allAdminQuestions.find(i => i.id === id);
            const type = originalQ.type;
            const updates = { question: document.getElementById('edit-q-text').value, grade: document.getElementById('edit-q-grade').value, subject: document.getElementById('edit-q-subject').value };
            if(type === 'mcq') {
                updates.answers = [document.getElementById('edit-ans-0').value, document.getElementById('edit-ans-1').value, document.getElementById('edit-ans-2').value];
                updates.correct = parseInt(document.getElementById('edit-correct-mcq').value);
            } else { updates.correct = document.getElementById('edit-correct-tf').value; }
            await updateDoc(doc(db, "questions", id), updates);
            const idx = allAdminQuestions.findIndex(i => i.id === id);
            if(idx !== -1) allAdminQuestions[idx] = { ...allAdminQuestions[idx], ...updates };
            const activeScreen = document.querySelector('.screen.active').id;
            if (activeScreen === 'screen-admin-all') filterAdminQuestions();
            document.getElementById('edit-modal').classList.add('hidden');
            showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏', 'ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠!');
        };

        window.deleteApprovedQ = async (id) => {
            if(confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ§ÿßŸÑ ŸÜŸáÿßÿ¶ŸäÿßŸãÿü")) {
                await deleteDoc(doc(db, "questions", id));
                allAdminQuestions = allAdminQuestions.filter(q => q.id !== id);
                filterAdminQuestions();
                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        };

        window.checkAdminNotifications = () => {
            const badgeTab = document.getElementById('profile-tab-badge');
            const badgeBtn = document.getElementById('admin-btn-badge');
            badgeTab.classList.remove('visible'); 
            badgeBtn.classList.remove('visible');
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); n.classList.remove('text-indigo-600'); n.classList.add('text-gray-400'); });
            const navs = document.querySelectorAll('.nav-item');
            if(tab==='challenges') navs[0].classList.add('active', 'text-indigo-600');
            if(tab==='leaderboard') { 
                navs[1].classList.add('active', 'text-indigo-600'); 
                loadLeaderboard(); 
            }
            if(tab==='schedule') { 
                navs[2].classList.add('active', 'text-indigo-600'); 
                initSchedule(); 
            }
            if(tab==='profile') navs[3].classList.add('active', 'text-indigo-600');
        };
        
        async function loadLeaderboard() {
            const div = document.getElementById('leaderboard-list');
            div.innerHTML = '<p class="text-center text-gray-400 mt-10">ÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                const q = query(collection(db, "users"), orderBy("points", "desc"), limit(100));
                const snap = await getDocs(q);
                let users = [];
                snap.forEach(d => { 
                    users.push({ id: d.id, ...d.data() });
                });
                
                users.sort((a, b) => (b.points || 0) - (a.points || 0));

                const myIndex = users.findIndex(u => u.uid === currentUser.uid);
                if(myIndex !== -1) document.getElementById('my-rank-text').innerText = "#" + (myIndex + 1);
                else document.getElementById('my-rank-text').innerText = "ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ";

                div.innerHTML = ''; 
                
                users.forEach((u, index) => {
                    let frameClass = "frame-rank-common";
                    let crown = "";
                    let rankBadge = `<div class="rank-badge-top">${index + 1}</div>`;
                    let raysHtml = ""; 
                    let backgroundClass = 'bg-rank-default';
                    
                    if (u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date()) {
                        backgroundClass = u.selectedBgTheme || 'bg-rank-default';
                    }

                    if (index === 0) { 
                        frameClass = "frame-rank-1"; 
                        crown = `<i class="fas fa-crown text-yellow-500 name-crown"></i>`; 
                        raysHtml = `<div class="rank-rays rays-gold"></div>`; 
                    }
                    else if (index === 1) { 
                        frameClass = "frame-rank-2"; 
                        raysHtml = `<div class="rank-rays rays-silver"></div>`; 
                    }
                    else if (index === 2) { 
                        frameClass = "frame-rank-3"; 
                        raysHtml = `<div class="rank-rays rays-bronze"></div>`; 
                    }
                    else if (index <= 9) { 
                        const colors = ['rays-blue', 'rays-red', 'rays-green', 'rays-purple', 'rays-blue', 'rays-red'];
                        frameClass = "frame-rank-other-top"; 
                        raysHtml = `<div class="rank-rays ${colors[index-3]}"></div>`; 
                    }
                    
                    let badgeHtml = "";
                    if (u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date() && u.selectedBadge) {
                        badgeHtml = `<span class="premium-badge" style="background-color: ${u.selectedBadgeColor || '#f59e0b'}">${u.selectedBadge}</span>`;
                    }
                    
                    let prizeMoney = "";
                    if (index === 0) prizeMoney = " <span class='text-xs text-green-300'>10$</span>";
                    else if (index === 1) prizeMoney = " <span class='text-xs text-green-300'>7$</span>";
                    else if (index === 2) prizeMoney = " <span class='text-xs text-green-300'>5$</span>";
                    else if (index === 3) prizeMoney = " <span class='text-xs text-green-300'>3$</span>";
                    else if (index === 4) prizeMoney = " <span class='text-xs text-green-300'>2$</span>";
                    else if (index >= 5 && index <= 9) prizeMoney = " <span class='text-xs text-green-300'>1$</span>";
                    
                    let resetBtn = "";
                    if (currentUser && userData && userData.email === ADMIN_EMAIL) {
                        resetBtn = `<button onclick="resetUserPoints('${u.id}', '${u.name}')" class="w-6 h-6 rounded bg-red-100 text-red-500 flex items-center justify-center mr-2"><i class="fas fa-trash-alt text-xs"></i></button>`;
                    }
                    
                    // Create image with frame
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'rank-img-container';
                    imgContainer.innerHTML = `
                        ${rankBadge}
                        ${raysHtml}
                        <div class="image-frame-container" style="width: 56px; height: 56px;">
                            <img src="${u.photo}" class="rank-img ${frameClass}">
                            ${u.isPremium && u.selectedFrame ? `<div class="profile-frame ${u.selectedFrame}"></div>` : ''}
                        </div>
                    `;
                    
                    div.innerHTML += `
                        <div class="flex items-center justify-between p-4 rounded-xl shadow-sm mb-3 relative overflow-hidden ${backgroundClass}">
                            <div class="flex items-center gap-4 z-10">
                                ${imgContainer.outerHTML}
                                <div>
                                    <p class="font-bold text-gray-800 text-sm flex items-center">
                                        ${crown} 
                                        ${u.name}
                                        ${badgeHtml}
                                    </p>
                                    <p class="text-[10px] text-gray-600">ID: ${u.uniqueId}</p>
                                    <p class="text-[10px] text-gray-500 mt-1">${u.bio || ""}</p>
                                    ${u.isPremium && u.premiumExpiry && u.premiumExpiry.toDate() > new Date() ? 
                                        `<p class="text-[10px] text-yellow-600 font-bold">üëë ŸÖŸÖŸäÿ≤</p>` : 
                                        ''}
                                </div>
                            </div>
                            <div class="flex items-center z-10">
                                ${resetBtn}
                                <div class="text-right">
                                    <span class="font-black text-indigo-600 text-lg">${u.points || 0} üíé${prizeMoney}</span>
                                </div>
                            </div>
                        </div>`;
                });
            } catch (error) {
                div.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿµŸÜŸäŸÅ</p>';
            }
        }

        window.resetUserPoints = async (uid, name) => {
            if(confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿßŸÑÿ∑ÿßŸÑÿ®: ${name}ÿü`)) {
                await updateDoc(doc(db, "users", uid), { points: 0 });
                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿµŸÅŸäÿ±', 'ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑ ÿ®ŸÜÿ¨ÿßÿ≠!');
                loadLeaderboard(); 
            }
        };

        async function loadBannedUsers() {
            try {
                const q = query(collection(db, "users"), where("isBanned", "==", true));
                const snap = await getDocs(q);
                
                const section = document.getElementById('banned-users-section');
                const list = document.getElementById('banned-users-list');
                
                if(snap.empty) {
                    section.classList.add('hidden');
                    return;
                }
                
                section.classList.remove('hidden');
                list.innerHTML = '';
                
                snap.forEach(doc => {
                    const u = doc.data();
                    list.innerHTML += `
                        <div class="banned-user-item">
                            <div class="banned-user-info">
                                <p class="banned-user-name">${u.name}</p>
                                <p class="banned-user-id">ID: ${u.uniqueId}</p>
                            </div>
                            <button onclick="unbanUser('${doc.id}', '${u.name}')" class="unban-btn">
                                <i class="fas fa-unlock"></i> ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±
                            </button>
                        </div>
                    `;
                });
                
            } catch (error) {
                console.error("Error loading banned users:", error);
            }
        }

        window.unbanUser = async (uid, name) => {
            if(confirm(`ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ± ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${name}ÿü`)) {
                try {
                    await updateDoc(doc(db, "users", uid), { isBanned: false });
                    showBeautifulAlert('success', 'ÿ™ŸÖ ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±', `ÿ™ŸÖ ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ± ÿπŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${name}`);
                    loadBannedUsers();
                } catch (error) {
                    console.error("Error unbanning user:", error);
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÅŸÉ ÿßŸÑÿ≠ÿ∏ÿ±');
                }
            }
        };

        window.searchUserForAdmin = async () => {
             const uidInput = document.getElementById('admin-user-search').value.trim();
             const resDiv = document.getElementById('admin-user-result');
             if(!uidInput) {
                 showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿ£ÿØÿÆŸÑ ÿßŸÑŸÖÿπÿ±ŸÅ (ID)');
                 return;
             }
             
             resDiv.classList.remove('hidden');
             resDiv.innerHTML = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´...';
             
             try {
                 const q = query(collection(db, "users"), where("uniqueId", "==", uidInput));
                 const snap = await getDocs(q);
                 
                 if(snap.empty) {
                     resDiv.innerHTML = '<p class="text-red-500">ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ</p>';
                     return;
                 }
                 
                 const uData = snap.docs[0].data();
                 const docId = snap.docs[0].id;
                 const isBanned = uData.isBanned === true;
                 const balance = uData.balance || 0;
                 const deserves = balance >= 100;

                 resDiv.innerHTML = `
                    <div class="text-center mb-4">
                        <img src="${uData.photo}" class="w-16 h-16 rounded-full mx-auto mb-2">
                        <h3 class="font-bold">${uData.name}</h3>
                        <p class="text-xs text-gray-500">${uData.email}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4 text-xs font-bold text-center">
                        <div class="bg-gray-50 p-2 rounded">ÿßŸÑŸÜŸÇÿßÿ∑: ${uData.points}</div>
                        <div class="bg-gray-50 p-2 rounded">ÿßŸÑÿØŸàŸÑÿßÿ±ÿßÿ™: $${balance}</div>
                    </div>
                    <div class="mb-4 text-center">
                        <p class="text-sm font-bold ${deserves ? 'text-green-600' : 'text-red-500'}">
                            ${deserves ? '‚úÖ Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑÿ≥ÿ≠ÿ®' : '‚ùå ŸÑÿß Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑÿ≥ÿ≠ÿ®'}
                        </p>
                        ${deserves ? `<button onclick="resetUserBalance('${docId}')" class="mt-2 bg-yellow-500 text-white px-4 py-2 rounded text-xs font-bold">ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿØŸàŸÑÿßÿ±ÿßÿ™</button>` : ''}
                    </div>
                    <button onclick="toggleBan('${docId}', ${!isBanned})" class="w-full py-3 rounded-xl font-bold text-white ${isBanned ? 'bg-green-500' : 'bg-red-500'}">
                        ${isBanned ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∏ÿ± (ŸÅŸÉ ÿßŸÑŸÇŸäÿØ)' : 'ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸáÿßÿ¶ŸäÿßŸã'}
                    </button>
                 `;
             } catch (error) {
                 resDiv.innerHTML = '<p class="text-red-500">ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´</p>';
             }
        };

        window.toggleBan = async (docId, shouldBan) => {
            if(confirm(shouldBan ? "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∏ÿ± Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸáÿßÿ¶ŸäÿßŸãÿü ŸÑŸÜ Ÿäÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ¨ÿØÿØÿßŸã." : "ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∏ÿ±ÿü")) {
                await updateDoc(doc(db, "users", docId), { isBanned: shouldBan });
                if(shouldBan) {
                    localStorage.setItem('device_banned', 'true');
                }
                showBeautifulAlert('success', 'ÿ™ŸÖ', shouldBan ? "ÿ™ŸÖ ÿ≠ÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" : "ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ≠ÿ∏ÿ±");
                searchUserForAdmin();
                loadBannedUsers();
            }
        };

        window.resetUserBalance = async (docId) => {
             if(confirm("ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿµŸÅŸäÿ± ÿØŸàŸÑÿßÿ±ÿßÿ™ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü (ŸäÿπŸÜŸä ÿ£ŸÜŸÉ ÿØŸÅÿπÿ™ ŸÑŸá)")) {
                 await updateDoc(doc(db, "users", docId), { balance: 0 });
                 showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿµŸÅŸäÿ±', 'ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ±ÿµŸäÿØ');
                 searchUserForAdmin();
             }
        };

        window.manualWeeklyDistribution = async () => {
             if(!confirm("‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±: Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿ≥ŸäŸÇŸàŸÖ ÿ®ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿπŸÑŸâ ÿßŸÑŸÄ 10 ÿßŸÑÿ£Ÿàÿßÿ¶ŸÑ Ÿàÿ™ÿµŸÅŸäÿ± ŸÜŸÇÿßÿ∑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ (ÿ£ÿπŸÑŸâ 150). ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü")) return;
             
             const q = query(collection(db, "users"), orderBy("points", "desc"), limit(10));
             const snap = await getDocs(q);
             const prizes = [10, 7, 5, 3, 2, 1, 1, 1, 1, 1];
             
             let batch = writeBatch(db);
             
             snap.docs.forEach((d, index) => {
                 if(index < 10) {
                     const prize = prizes[index];
                     const newBalance = (d.data().balance || 0) + prize;
                     batch.update(doc(db, "users", d.id), { balance: newBalance });
                 }
             });
             await batch.commit();

             const qReset = query(collection(db, "users"), orderBy("points", "desc"), limit(150));
             const snapReset = await getDocs(qReset);
             
             let resetBatch = writeBatch(db);
             snapReset.docs.forEach(d => {
                 resetBatch.update(doc(db, "users", d.id), { points: 0 });
             });
             await resetBatch.commit();
             
             showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ', '‚úÖ ÿ™ŸÖ ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ Ÿàÿ™ÿµŸÅŸäÿ± ÿßŸÑŸÜŸÇÿßÿ∑ ÿ®ŸÜÿ¨ÿßÿ≠!');
        };

        window.generateSubscriptionCode = async function() {
            try {
                if (!currentUser || !userData || userData.email !== ADMIN_EMAIL) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚õî ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑŸÇŸäÿßŸÖ ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°');
                    return;
                }

                const durationSelect = document.getElementById('admin-sub-duration');
                const durationDays = parseInt(durationSelect.value);
                
                if (!durationDays || durationDays <= 0) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', '‚õî Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿØÿ© ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ');
                    return;
                }

                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let code;
                let isUnique = false;
                let attempts = 0;
                
                while (!isUnique && attempts < 10) {
                    code = '';
                    for (let i = 0; i < 8; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    
                    const q = query(collection(db, "premium_codes"), where("code", "==", code));
                    const querySnapshot = await getDocs(q);
                    isUnique = querySnapshot.empty;
                    attempts++;
                }
                
                if (!isUnique) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿ™ÿπÿ∞ÿ± ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸàÿØ ŸÅÿ±ŸäÿØÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ');
                    return;
                }

                await addDoc(collection(db, "premium_codes"), {
                    code: code,
                    durationDays: durationDays,
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    used: false,
                    usedBy: null,
                    usedAt: null,
                    isActive: true
                });

                const displayDiv = document.getElementById('generated-code-display');
                const codeText = document.getElementById('gen-code-text');
                
                codeText.textContent = code;
                displayDiv.classList.remove('hidden');
                
                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°', `‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÉŸàÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ ÿ¨ÿØŸäÿØ:\n\nÿßŸÑŸÉŸàÿØ: ${code}\nÿßŸÑŸÖÿØÿ©: ${durationDays} ŸäŸàŸÖ\n\nÿßŸÑŸÉŸàÿØ Ÿäÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑!`);

            } catch (error) {
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÉŸàÿØ:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', `‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÉŸàÿØ: ${error.message}`);
            }
        };

        window.copyGenCode = function() {
            const codeText = document.getElementById('gen-code-text').textContent;
            if (!codeText || codeText === '...') {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', '‚ö†Ô∏è ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉŸàÿØ ŸÑÿπÿ±ÿ∂Ÿá');
                return;
            }
            
            navigator.clipboard.writeText(codeText)
                .then(() => {
                    showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ', '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©!');
                })
                .catch(err => {
                    console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ:", err);
                    const tempInput = document.createElement('input');
                    tempInput.value = codeText;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ', '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©!');
                });
        };

        window.deleteSubscriptionCode = async function() {
            try {
                const codeInput = document.getElementById('admin-delete-code-input').value.trim().toUpperCase();
                
                if (!codeInput) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', '‚ö†Ô∏è Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸàÿØ ŸÑŸÑÿ≠ÿ∞ŸÅ');
                    return;
                }

                if (!confirm(`‚ö†Ô∏è ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿØ "${codeInput}"ÿü\n\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÜŸáÿßÿ¶Ÿä ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá.`)) {
                    return;
                }

                const q = query(collection(db, "premium_codes"), where("code", "==", codeInput));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                    return;
                }

                const codeDoc = querySnapshot.docs[0];
                await deleteDoc(doc(db, "premium_codes", codeDoc.id));
                
                document.getElementById('admin-delete-code-input').value = '';
                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ', `‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿØ "${codeInput}" ÿ®ŸÜÿ¨ÿßÿ≠`);

            } catch (error) {
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿØ:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', `‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÉŸàÿØ: ${error.message}`);
            }
        };

        async function loadPremiumUsers() {
            const listDiv = document.getElementById('premium-users-list');
            listDiv.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                const q = query(collection(db, "users"), where("isPremium", "==", true));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    listDiv.innerHTML = '<p class="text-center text-gray-400 py-10">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ŸÖŸÖŸäÿ≤ŸäŸÜ</p>';
                    return;
                }
                
                let html = '';
                const now = new Date();
                
                snap.docs.forEach(doc => {
                    const u = doc.data();
                    let remainingDays = "ŸÖŸÜÿ™ŸáŸä";
                    if (u.premiumExpiry) {
                        const expiry = u.premiumExpiry.toDate();
                        const diff = expiry - now;
                        if(diff > 0) {
                            remainingDays = Math.ceil(diff / (1000 * 60 * 60 * 24)) + " ŸäŸàŸÖ";
                        }
                    }
                    
                    html += `
                        <div class="bg-white rounded-xl p-4 border border-yellow-100 shadow-sm">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-gray-800">${u.name}</p>
                                    <p class="text-xs text-gray-500">ID: ${u.uniqueId}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-bold">${remainingDays}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                listDiv.innerHTML = html;
            } catch (error) {
                listDiv.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖŸÖŸäÿ≤ŸäŸÜ</p>';
            }
        }

        window.handleImagePreview = (input) => {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById('preview-img').src = e.target.result;
                r.readAsDataURL(input.files[0]);
            }
        };
        
        function generateId() { 
            return Math.random().toString(36).substr(2, 8).toUpperCase(); 
        }

        window.updateProfilePic = async (input) => {
            if(input.files[0]) {
                try {
                    showBeautifulAlert('info', 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ±ŸÅÿπ', 'ÿ¨ÿßÿ±Ÿä ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©...');
                    const photoURL = await uploadImageToStorage(input.files[0], currentUser.uid);
                    
                    await updateDoc(doc(db, "users", currentUser.uid), { photo: photoURL });
                    userData.photo = photoURL;
                    document.getElementById('profile-img').src = photoURL;
                    
                    showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´', 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ‚úÖ');
                } catch (error) {
                    console.error("Error updating profile picture:", error);
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', '‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ±ÿ©: ' + getArabicError(error.code));
                }
            }
        };

        window.cancelSearch = function() {
            document.getElementById('searching-ui').classList.add('hidden');
            document.getElementById('challenge-active-card').classList.remove('hidden');
            if(currentMatchId) {
                deleteDoc(doc(db, "match_queue", currentMatchId));
                currentMatchId = null;
            }
            if(connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
                isMonitoringConnection = false;
            }
            localStorage.removeItem('pending_match');
        };

        window.closeMaintenancePopup = function() {
            document.getElementById('maintenance-popup').classList.add('hidden');
            switchTab('challenges');
        };

        let scheduleData = { subject: '', chapters: [], totalHours: 0, needSleep: true, breakDuration: 10 };
        
        function initSchedule() {
            const chaptersList = document.getElementById('chaptersList');
            chaptersList.innerHTML = '';
            addChapterRow();
            
            const saved = localStorage.getItem('studySchedule');
            if (saved) {
                try {
                    scheduleData = JSON.parse(saved);
                    document.getElementById('subjectName').value = scheduleData.subject || '';
                    document.getElementById('totalHours').value = scheduleData.totalHours || '';
                    document.getElementById('needSleep').value = scheduleData.needSleep ? 'yes' : 'no';
                    document.getElementById('breakDuration').value = scheduleData.breakDuration || 10;
                    
                    if (scheduleData.chapters && scheduleData.chapters.length > 0) {
                        chaptersList.innerHTML = '';
                        scheduleData.chapters.forEach(ch => {
                            addChapterRow(ch.name, ch.difficulty);
                        });
                    }
                } catch (e) {
                    console.error("Error loading schedule:", e);
                }
            }
        }
        
        window.handleScheduleFormSubmit = function(e) {
            e.preventDefault();
            
            scheduleData.subject = document.getElementById('subjectName').value;
            scheduleData.totalHours = parseFloat(document.getElementById('totalHours').value);
            scheduleData.needSleep = document.getElementById('needSleep').value === 'yes';
            scheduleData.breakDuration = parseInt(document.getElementById('breakDuration').value);
            
            scheduleData.chapters = [];
            document.querySelectorAll('#chaptersList > div').forEach((row, idx) => {
                const diff = parseFloat(row.querySelector('.diff-select').value);
                const nameVal = row.querySelector('.name-input').value;
                const name = nameVal ? nameVal : `ŸÅÿµŸÑ ${idx + 1}`;
                scheduleData.chapters.push({ name, difficulty: diff });
            });

            if (scheduleData.chapters.length === 0) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿµŸÑ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }

            localStorage.setItem('studySchedule', JSON.stringify(scheduleData));
            calculateAndRenderSchedule(false);
        };

        function calculateAndRenderSchedule(isShared) {
            let totalMins = scheduleData.totalHours * 60;
            let sleepMins = 0;

            if (scheduleData.needSleep && scheduleData.totalHours > 16) {
                const days = scheduleData.totalHours / 24;
                sleepMins = Math.floor(days * 8 * 60);
                totalMins -= sleepMins;
            }

            const studyRatio = 60 / (60 + scheduleData.breakDuration);
            const netStudyMins = totalMins * studyRatio;
            const totalBreakMins = totalMins - netStudyMins;

            const totalPoints = scheduleData.chapters.reduce((acc, c) => acc + c.difficulty, 0);

            document.getElementById('schedule-input-page').classList.add('hidden');
            document.getElementById('schedule-result-page').classList.remove('hidden');
            document.getElementById('displaySubject').innerText = scheduleData.subject;

            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            scheduleData.chapters.forEach(ch => {
                const share = ch.difficulty / totalPoints;
                const chapterMins = netStudyMins * share;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-sm p-3">${ch.name}</td>
                    <td class="p-3">
                        <div class="flex flex-col items-center">
                            <span class="text-lg font-black">${formatTime(chapterMins)}</span>
                            <div class="w-full bg-gray-100 h-1 mt-1 rounded overflow-hidden">
                                <div class="bg-indigo-500 h-full" style="width: ${Math.min(100, (chapterMins/180)*100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="text-xs text-gray-500 font-bold p-3">${scheduleData.breakDuration}ÿØ</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('statStudy').innerText = formatTime(netStudyMins);
            document.getElementById('statBreak').innerText = formatTime(totalBreakMins);
            document.getElementById('statSleep').innerText = formatTime(sleepMins);
        }

        function formatTime(m) {
            if(m < 60) return Math.round(m) + ' ÿØ';
            const h = Math.floor(m/60);
            const rem = Math.round(m%60);
            return rem > 0 ? `${h}ÿ≥ ${rem}ÿØ` : `${h}ÿ≥`;
        }

        window.addChapterRow = function(name = '', difficulty = 1.5) {
            const container = document.getElementById('chaptersList');
            const index = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <span class="bg-indigo-50 text-indigo-600 font-bold py-2 px-3 rounded text-sm">${index}</span>
                <select class="diff-select w-24 p-2 rounded bg-white border text-xs font-bold focus:border-indigo-500 outline-none">
                    <option value="1" ${difficulty === 1 ? 'selected' : ''}>ÿ≥ŸáŸÑ</option>
                    <option value="1.5" ${difficulty === 1.5 ? 'selected' : ''}>ŸÖÿ™Ÿàÿ≥ÿ∑</option>
                    <option value="2.5" ${difficulty === 2.5 ? 'selected' : ''}>ÿµÿπÿ®</option>
                </select>
                <input type="text" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÅÿµŸÑ" class="name-input flex-1 p-2 rounded bg-white border text-sm focus:border-indigo-500 outline-none" value="${name}">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 px-2"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.appendChild(div);
        };

        window.downloadScheduleAsImage = function() {
            const el = document.getElementById('schedule-card');
            const btn = event.target.closest('button');
            const oldTxt = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
            
            const script = document.createElement('script');
            script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
            script.onload = function() {
                html2canvas(el, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ÿ¨ÿØŸàŸÑ-${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    btn.innerHTML = oldTxt;
                });
            };
            document.head.appendChild(script);
        };

        window.resetSchedule = function() {
            if(confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¨ÿØŸàŸÑ Ÿàÿ•ŸÜÿ¥ÿßÿ° ÿ¨ÿØŸäÿØÿü')) {
                localStorage.removeItem('studySchedule');
                location.reload();
            }
        };

        window.openFriendChallenge = function() {
            document.getElementById('friend-challenge-modal').classList.remove('hidden');
        };

        window.closeFriendChallengeModal = function() {
            document.getElementById('friend-challenge-modal').classList.add('hidden');
        };

        window.openCreateRoomScreen = function() {
            closeFriendChallengeModal();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-create-room').classList.add('active');
            
            const grade = userData.grade;
            if(grade) {
                populateSubjects(grade, 'room-subject');
            }
        };

        window.openJoinRoomScreen = function() {
            closeFriendChallengeModal();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-join-room').classList.add('active');
        };

        let roomQType = 'mcq';
        window.setRoomQType = (t) => {
            roomQType = t;
            document.getElementById('room-btn-mcq').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='mcq'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
            document.getElementById('room-btn-tf').className = `py-3 rounded-xl border-2 font-bold transition flex-1 ${t==='tf'?'border-indigo-600 bg-indigo-50 text-indigo-600':'border-indigo-100 text-gray-500'}`;
        };

        window.createRoom = async function() {
            const subject = document.getElementById('room-subject').value;
            if(!subject || !roomQType) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿßÿØÿ© ŸàŸÜŸàÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©');
                return;
            }

            const roomCode = generateRoomCode();
            currentRoomId = roomCode;
            isRoomHost = true;
            roomReadyState = false;

            await setDoc(doc(db, "rooms", roomCode), {
                code: roomCode,
                host: {
                    uid: currentUser.uid,
                    name: userData.name,
                    photo: userData.photo,
                    grade: userData.grade,
                    ready: false
                },
                guest: null,
                subject: subject,
                questionType: roomQType,
                status: 'waiting',
                createdAt: serverTimestamp(),
                lastUpdated: serverTimestamp()
            });

            openRoomScreen(roomCode);
        };

        function generateRoomCode() {
            const chars = '0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        window.joinRoom = async function() {
            const roomCode = document.getElementById('room-code-input').value.trim();
            if(!roomCode || roomCode.length !== 8) {
                showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ ÿ∫ÿ±ŸÅÿ© ÿµÿ≠Ÿäÿ≠ (8 ÿ£ÿ±ŸÇÿßŸÖ)');
                return;
            }

            try {
                const roomDoc = await getDoc(doc(db, "rooms", roomCode));
                if(!roomDoc.exists()) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ±ŸÇŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠');
                    return;
                }

                const roomData = roomDoc.data();
                if(roomData.status !== 'waiting') {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿØÿÆŸàŸÑ');
                    return;
                }

                if(roomData.host.grade !== userData.grade) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', `Ÿáÿ∞Ÿá ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÖÿÆÿµÿµÿ© ŸÑÿ∑ŸÑÿßÿ® ${getGradeName(roomData.host.grade)} ŸÅŸÇÿ∑`);
                    return;
                }

                currentRoomId = roomCode;
                isRoomHost = false;
                roomReadyState = false;

                await updateDoc(doc(db, "rooms", roomCode), {
                    guest: {
                        uid: currentUser.uid,
                        name: userData.name,
                        photo: userData.photo,
                        grade: userData.grade,
                        ready: false
                    },
                    lastUpdated: serverTimestamp()
                });

                openRoomScreen(roomCode);

            } catch (error) {
                console.error("Error joining room:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ∫ÿ±ŸÅÿ©');
            }
        };

        function openRoomScreen(roomCode) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-friend-challenge').classList.add('active');
            
            listenToRoom(roomCode);
        }

        function listenToRoom(roomCode) {
            if(roomListenerUnsubscribe) roomListenerUnsubscribe();
            
            roomListenerUnsubscribe = onSnapshot(doc(db, "rooms", roomCode), async (snap) => {
                if(!snap.exists()) {
                    showBeautifulAlert('warning', 'ÿ™ŸÖ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ', 'ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ∫ÿ±ŸÅÿ©');
                    backToChallenges();
                    return;
                }

                const roomData = snap.data();
                renderRoom(roomData);

                if(roomData.status === 'starting' && roomData.matchId) {
                    startRoomMatch(roomData.matchId);
                }
            });
        }

        function renderRoom(roomData) {
            const content = document.getElementById('room-content');
            const host = roomData.host;
            const guest = roomData.guest;
            const totalPlayers = guest ? 2 : 1;
            const readyCount = (host.ready ? 1 : 0) + (guest?.ready ? 1 : 0);

            content.innerHTML = `
                <div class="room-counter">${totalPlayers}/2</div>
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">ÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ™ÿ≠ÿØŸä</h2>
                    <div class="room-code-display">${roomData.code}</div>
                    <button onclick="copyRoomCode('${roomData.code}')" class="text-indigo-600 text-sm font-bold flex items-center justify-center gap-2 mx-auto">
                        <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ ÿ±ŸÇŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                    </button>
                </div>

                <div class="mb-6">
                    <div class="room-user-card ${host.ready ? 'ready' : ''}">
                        <img src="${host.photo}" class="room-user-avatar">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${host.name} (ŸÖÿ∂ŸäŸÅ)</p>
                            <p class="text-xs text-gray-500">${getGradeName(host.grade)}</p>
                        </div>
                        <div class="text-right">
                            ${host.ready ? '<span class="text-green-600 font-bold">ŸÖÿ≥ÿ™ÿπÿØ ‚úì</span>' : '<span class="text-gray-400">ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ±...</span>'}
                        </div>
                    </div>

                    ${guest ? `
                    <div class="room-user-card ${guest.ready ? 'ready' : ''}">
                        <img src="${guest.photo}" class="room-user-avatar">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${guest.name}</p>
                            <p class="text-xs text-gray-500">${getGradeName(guest.grade)}</p>
                        </div>
                        <div class="text-right">
                            ${guest.ready ? '<span class="text-green-600 font-bold">ŸÖÿ≥ÿ™ÿπÿØ ‚úì</span>' : '<span class="text-gray-400">ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ±...</span>'}
                        </div>
                    </div>
                    ` : `
                    <div class="room-user-card">
                        <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-user-plus text-gray-400"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-400">ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÑÿßÿπÿ® ÿ¢ÿÆÿ±...</p>
                        </div>
                        ${isRoomHost ? `
                        <button onclick="openInviteFriendsModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-600 transition">
                            <i class="fas fa-user-plus ml-1"></i> ÿØÿπŸàÿ©
                        </button>
                        ` : ''}
                    </div>
                    `}
                </div>

                <div class="fixed bottom-20 left-0 right-0 p-4 bg-white border-t">
                    <div class="flex gap-3">
                        ${isRoomHost ? `
                        <button onclick="deleteRoom()" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold">
                            <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©
                        </button>
                        ` : `
                        <button onclick="leaveRoom()" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-bold">
                            <i class="fas fa-sign-out-alt"></i> ŸÖÿ∫ÿßÿØÿ±ÿ©
                        </button>
                        `}
                        
                        <button onclick="toggleReady()" class="flex-1 ${roomReadyState ? 'bg-gray-500' : 'bg-green-500'} text-white py-3 rounded-xl font-bold">
                            ${roomReadyState ? 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿßÿ≥ÿ™ÿπÿØÿßÿØ' : 'ŸÖÿ≥ÿ™ÿπÿØ'}
                        </button>
                    </div>
                </div>
            `;
        }

        window.copyRoomCode = function(code) {
            navigator.clipboard.writeText(code)
                .then(() => {
                    showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ', 'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ŸÇŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©');
                })
                .catch(err => {
                    const tempInput = document.createElement('input');
                    tempInput.value = code;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ', 'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ŸÇŸÖ ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©');
                });
        };

        window.toggleReady = async function() {
            try {
                roomReadyState = !roomReadyState;
                const field = isRoomHost ? 'host.ready' : 'guest.ready';
                
                await updateDoc(doc(db, "rooms", currentRoomId), {
                    [field]: roomReadyState,
                    lastUpdated: serverTimestamp()
                });

                const roomDoc = await getDoc(doc(db, "rooms", currentRoomId));
                const roomData = roomDoc.data();
                
                const hostReady = roomData.host.ready;
                const guestReady = roomData.guest?.ready || false;
                
                if(hostReady && guestReady && roomData.guest) {
                    await startRoomGame(roomData);
                }

            } catch (error) {
                console.error("Error toggling ready:", error);
            }
        };

        async function startRoomGame(roomData) {
            try {
                const qDocs = await getQuestions(roomData.subject, roomData.questionType);
                if(qDocs.length === 0) {
                    showBeautifulAlert('warning', 'ÿ™ŸÜÿ®ŸäŸá', 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≥ÿ¶ŸÑÿ© ŸÉÿßŸÅŸäÿ©');
                    return;
                }

                const shuffledQs = qDocs.sort(() => 0.5 - Math.random()).slice(0, 10);
                const matchRef = collection(db, "match_queue");
                const newMatch = await addDoc(matchRef, {
                    group: `room_${currentRoomId}`,
                    status: 'active',
                    grade: roomData.host.grade,
                    player1: {
                        uid: roomData.host.uid,
                        name: roomData.host.name,
                        score: 0,
                        photo: roomData.host.photo,
                        grade: roomData.host.grade
                    },
                    player2: {
                        uid: roomData.guest.uid,
                        name: roomData.guest.name,
                        score: 0,
                        photo: roomData.guest.photo,
                        grade: roomData.guest.grade
                    },
                    questions: shuffledQs,
                    currentIdx: 0,
                    answersCount: 0,
                    player1LastActive: Date.now(),
                    player2LastActive: Date.now(),
                    lastActivity: Date.now(),
                    createdAt: serverTimestamp()
                });

                await updateDoc(doc(db, "rooms", currentRoomId), {
                    status: 'starting',
                    matchId: newMatch.id,
                    lastUpdated: serverTimestamp()
                });

            } catch (error) {
                console.error("Error starting room game:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©');
            }
        }

        async function startRoomMatch(matchId) {
            if(roomListenerUnsubscribe) {
                roomListenerUnsubscribe();
                roomListenerUnsubscribe = null;
            }

            await deleteDoc(doc(db, "rooms", currentRoomId));
            currentRoomId = null;
            
            currentMatchId = matchId;
            currentGameMode = 'online';
            listenToMatch(matchId);
            startConnectionMonitoring(matchId, isRoomHost);
        }

        window.deleteRoom = async function() {
            if(confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©ÿü')) {
                if(currentRoomId) {
                    await deleteDoc(doc(db, "rooms", currentRoomId));
                }
                backToChallenges();
            }
        };

        window.leaveRoom = async function() {
            if(confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©ÿü')) {
                try {
                    const roomDoc = await getDoc(doc(db, "rooms", currentRoomId));
                    if(roomDoc.exists()) {
                        const roomData = roomDoc.data();
                        if(roomData.guest && roomData.guest.uid === currentUser.uid) {
                            await updateDoc(doc(db, "rooms", currentRoomId), {
                                guest: null,
                                lastUpdated: serverTimestamp()
                            });
                        }
                    }
                } catch (error) {
                    console.error("Error leaving room:", error);
                }
                
                backToChallenges();
            }
        };

        window.openInviteFriendsModal = async function() {
            try {
                const friendsList = document.getElementById('friends-list');
                friendsList.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°...</p>';
                
                document.getElementById('invite-friends-modal').classList.remove('hidden');
                
                // Load friends list
                if (userData.friends && userData.friends.length > 0) {
                    let html = '';
                    for (const friendId of userData.friends) {
                        try {
                            const friendDoc = await getDoc(doc(db, "users", friendId));
                            if (friendDoc.exists()) {
                                const friend = friendDoc.data();
                                const isOnline = friend.lastActive && (Date.now() - friend.lastActive.toDate().getTime()) < 5 * 60 * 1000;
                                
                                html += `
                                    <div class="friend-item ${isOnline ? 'online' : 'offline'}">
                                        <div class="flex items-center gap-3">
                                            <img src="${friend.photo}" class="w-10 h-10 rounded-full">
                                            <div>
                                                <p class="font-bold text-gray-800">${friend.name}</p>
                                                <p class="text-xs text-gray-500">${isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ' : '‚ö´ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}</p>
                                            </div>
                                        </div>
                                        <button onclick="inviteFriendToRoom('${friendId}')" class="invite-btn ${isOnline ? '' : 'disabled'}" ${isOnline ? '' : 'disabled'}>
                                            ÿØÿπŸàÿ©
                                        </button>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error("Error loading friend:", error);
                        }
                    }
                    
                    if (html === '') {
                        html = '<p class="text-center text-gray-400">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ°</p>';
                    }
                    
                    friendsList.innerHTML = html;
                } else {
                    friendsList.innerHTML = '<p class="text-center text-gray-400">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ°</p>';
                }
                
            } catch (error) {
                console.error("Error opening invite modal:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°');
            }
        };

        window.inviteFriendToRoom = async function(friendId) {
            try {
                const friendDoc = await getDoc(doc(db, "users", friendId));
                if (!friendDoc.exists()) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿßŸÑÿµÿØŸäŸÇ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                const friend = friendDoc.data();
                
                // Add notification to friend
                const notification = {
                    type: 'room_invite',
                    roomId: currentRoomId,
                    fromUserId: currentUser.uid,
                    fromUserName: userData.name,
                    timestamp: Date.now(),
                    read: false
                };

                await updateDoc(doc(db, "users", friendId), {
                    notifications: [...(friend.notifications || []), notification]
                });

                showBeautifulAlert('success', 'ÿ™ŸÖÿ™ ÿßŸÑÿØÿπŸàÿ©', `ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿØÿπŸàÿ© ÿ•ŸÑŸâ ${friend.name}`);
                document.getElementById('invite-friends-modal').classList.add('hidden');

            } catch (error) {
                console.error("Error inviting friend:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿØÿπŸàÿ©');
            }
        };

        window.sendFriendRequestFromGame = async function() {
            const btn = document.getElementById('game-friend-request-btn');
            const opponentId = btn.dataset.opponentId;
            const opponentName = btn.dataset.opponentName;

            if (!opponentId || opponentId === currentUser.uid) {
                return;
            }

            try {
                const opponentDoc = await getDoc(doc(db, "users", opponentId));
                if (!opponentDoc.exists()) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                const opponent = opponentDoc.data();

                // Check if already friends
                if (userData.friends && userData.friends.includes(opponentId)) {
                    showBeautifulAlert('info', 'ŸÖÿπŸÑŸàŸÖÿ©', 'ÿ£ŸÜÿ™ŸÖÿß ÿµÿØŸäŸÇÿßŸÜ ÿ®ÿßŸÑŸÅÿπŸÑ');
                    return;
                }

                // Check if request already sent
                if (userData.pendingRequests && userData.pendingRequests.includes(opponentId)) {
                    showBeautifulAlert('info', 'ŸÖÿπŸÑŸàŸÖÿ©', 'ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ© ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
                    return;
                }

                // Send friend request
                const notification = {
                    type: 'friend_request',
                    fromUserId: currentUser.uid,
                    fromUserName: userData.name,
                    timestamp: Date.now(),
                    read: false
                };

                const batch = writeBatch(db);
                
                // Add to opponent's friend requests
                batch.update(doc(db, "users", opponentId), {
                    friendRequests: [...(opponent.friendRequests || []), currentUser.uid]
                });

                // Add to user's pending requests
                batch.update(doc(db, "users", currentUser.uid), {
                    pendingRequests: [...(userData.pendingRequests || []), opponentId]
                });

                // Add notification to opponent
                batch.update(doc(db, "users", opponentId), {
                    notifications: [...(opponent.notifications || []), notification]
                });

                await batch.commit();

                btn.classList.add('sent');
                btn.innerHTML = '<i class="fas fa-user-check"></i>';
                
                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ', `ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿµÿØÿßŸÇÿ© ÿ•ŸÑŸâ ${opponentName}`);

            } catch (error) {
                console.error("Error sending friend request:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©');
            }
        };

        async function loadNotifications() {
            try {
                if (!userData) return;
                
                const notifications = userData.notifications || [];
                const unreadCount = notifications.filter(n => !n.read).length;
                
                const badge = document.getElementById('notification-badge');
                const btn = document.getElementById('notifications-btn');
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.classList.remove('hidden');
                    
                    if (notifications.some(n => n.type === 'friend_request' || n.type === 'room_invite')) {
                        btn.classList.add('pulse');
                    }
                } else {
                    badge.classList.add('hidden');
                    btn.classList.remove('pulse');
                }
                
            } catch (error) {
                console.error("Error loading notifications:", error);
            }
        }

        window.openNotifications = function() {
            document.getElementById('notifications-btn').classList.remove('pulse');
            openPage('screen-notifications');
        };

        window.switchNotifTab = function(tab) {
            // Update tab buttons
            document.querySelectorAll('#screen-notifications button[id^="notif-tab-"]').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'border-indigo-600');
                btn.classList.add('text-gray-500');
            });
            
            document.getElementById(`notif-tab-${tab}`).classList.add('text-indigo-600', 'border-indigo-600');
            document.getElementById(`notif-tab-${tab}`).classList.remove('text-gray-500');
            
            // Show selected content
            document.querySelectorAll('#screen-notifications div[id^="notif-"]').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(`notif-${tab}-content`).classList.remove('hidden');
            
            // Load content
            if (tab === 'alerts') loadAlertsContent();
            else if (tab === 'friends') loadFriendsContent();
            else if (tab === 'requests') loadFriendRequestsContent();
            else if (tab === 'pending') loadPendingRequestsContent();
        };

        async function loadAlertsContent() {
            const content = document.getElementById('notif-alerts-content');
            content.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                const notifications = userData.notifications || [];
                const alerts = notifications.filter(n => 
                    n.type === 'game_result' || 
                    n.type === 'daily_reward' || 
                    n.type === 'weekly_prize' ||
                    n.type === 'system'
                ).sort((a, b) => b.timestamp - a.timestamp);
                
                if (alerts.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-400 py-10">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÜÿ®ŸäŸáÿßÿ™</p>';
                    return;
                }
                
                let html = '';
                alerts.forEach(alert => {
                    let icon = 'üîî';
                    let title = 'ÿ™ŸÜÿ®ŸäŸá';
                    let message = '';
                    
                    switch(alert.type) {
                        case 'game_result':
                            icon = alert.result === 'win' ? 'üèÜ' : 'üò¢';
                            title = alert.result === 'win' ? 'ŸÅŸàÿ≤' : 'ÿÆÿ≥ÿßÿ±ÿ©';
                            message = alert.message || 'ÿ™ŸÖ ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ©';
                            break;
                        case 'daily_reward':
                            icon = 'üéÅ';
                            title = 'ŸáÿØŸäÿ© ŸäŸàŸÖŸäÿ©';
                            message = alert.message || 'ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑŸáÿØŸäÿ© ÿßŸÑŸäŸàŸÖŸäÿ©';
                            break;
                        case 'weekly_prize':
                            icon = 'üí∞';
                            title = 'ÿ¨ÿßÿ¶ÿ≤ÿ© ÿ£ÿ≥ÿ®ŸàÿπŸäÿ©';
                            message = alert.message || 'ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©';
                            break;
                        case 'system':
                            icon = '‚öôÔ∏è';
                            title = 'ŸÜÿ∏ÿßŸÖ';
                            message = alert.message || 'ÿ™ŸÜÿ®ŸäŸá ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ';
                            break;
                    }
                    
                    const date = new Date(alert.timestamp).toLocaleDateString('ar-EG');
                    
                    html += `
                        <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">${icon}</div>
                                <div class="flex-1">
                                    <p class="font-bold text-gray-800">${title}</p>
                                    <p class="text-sm text-gray-600">${message}</p>
                                    <p class="text-xs text-gray-400 mt-1">${date}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading alerts:", error);
                content.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™</p>';
            }
        }

        async function loadFriendsContent() {
            const content = document.getElementById('notif-friends-content');
            content.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                if (!userData.friends || userData.friends.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-400 py-10">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ°</p>';
                    return;
                }
                
                let html = '';
                for (const friendId of userData.friends) {
                    try {
                        const friendDoc = await getDoc(doc(db, "users", friendId));
                        if (friendDoc.exists()) {
                            const friend = friendDoc.data();
                            const isOnline = friend.lastActive && (Date.now() - friend.lastActive.toDate().getTime()) < 5 * 60 * 1000;
                            
                            html += `
                                <div class="friend-item ${isOnline ? 'online' : 'offline'}">
                                    <div class="flex items-center gap-3">
                                        <img src="${friend.photo}" class="w-12 h-12 rounded-full">
                                        <div>
                                            <p class="font-bold text-gray-800">${friend.name}</p>
                                            <p class="text-xs text-gray-500">${friend.bio || "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥Ÿäÿ±ÿ© ÿ∞ÿßÿ™Ÿäÿ©"}</p>
                                            <p class="text-xs ${isOnline ? 'text-green-600' : 'text-gray-500'} mt-1">
                                                ${isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ' : '‚ö´ ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="removeFriend('${friendId}')" class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-user-minus"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error("Error loading friend:", error);
                    }
                }
                
                if (html === '') {
                    html = '<p class="text-center text-gray-400 py-10">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ°</p>';
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading friends:", error);
                content.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°</p>';
            }
        }

        async function loadFriendRequestsContent() {
            const content = document.getElementById('notif-requests-content');
            content.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                if (!userData.friendRequests || userData.friendRequests.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-400 py-10">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿµÿØÿßŸÇÿ©</p>';
                    return;
                }
                
                let html = '';
                for (const requesterId of userData.friendRequests) {
                    try {
                        const requesterDoc = await getDoc(doc(db, "users", requesterId));
                        if (requesterDoc.exists()) {
                            const requester = requesterDoc.data();
                            
                            html += `
                                <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                                    <div class="flex items-center gap-3 mb-3">
                                        <img src="${requester.photo}" class="w-12 h-12 rounded-full">
                                        <div>
                                            <p class="font-bold text-gray-800">${requester.name}</p>
                                            <p class="text-xs text-gray-500">${requester.bio || "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥Ÿäÿ±ÿ© ÿ∞ÿßÿ™Ÿäÿ©"}</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button onclick="acceptFriendRequest('${requesterId}')" class="bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 transition">
                                            ŸÇÿ®ŸàŸÑ
                                        </button>
                                        <button onclick="rejectFriendRequest('${requesterId}')" class="bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600 transition">
                                            ÿ±ŸÅÿ∂
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error("Error loading requester:", error);
                    }
                }
                
                if (html === '') {
                    html = '<p class="text-center text-gray-400 py-10">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿµÿØÿßŸÇÿ©</p>';
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading friend requests:", error);
                content.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ©</p>';
            }
        }

        async function loadPendingRequestsContent() {
            const content = document.getElementById('notif-pending-content');
            content.innerHTML = '<p class="text-center text-gray-400">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>';
            
            try {
                if (!userData.pendingRequests || userData.pendingRequests.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-400 py-10">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ŸÖÿπŸÑŸÇÿ©</p>';
                    return;
                }
                
                let html = '';
                for (const pendingId of userData.pendingRequests) {
                    try {
                        const pendingDoc = await getDoc(doc(db, "users", pendingId));
                        if (pendingDoc.exists()) {
                            const pendingUser = pendingDoc.data();
                            
                            html += `
                                <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
                                    <div class="flex items-center gap-3">
                                        <img src="${pendingUser.photo}" class="w-12 h-12 rounded-full">
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-800">${pendingUser.name}</p>
                                            <p class="text-xs text-gray-500">${pendingUser.bio || "ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥Ÿäÿ±ÿ© ÿ∞ÿßÿ™Ÿäÿ©"}</p>
                                            <p class="text-xs text-gray-400 mt-2">ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÇÿ®ŸàŸÑ...</p>
                                        </div>
                                        <button onclick="cancelFriendRequest('${pendingId}')" class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error("Error loading pending user:", error);
                    }
                }
                
                if (html === '') {
                    html = '<p class="text-center text-gray-400 py-10">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ŸÖÿπŸÑŸÇÿ©</p>';
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading pending requests:", error);
                content.innerHTML = '<p class="text-center text-gray-400">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©</p>';
            }
        }

        window.acceptFriendRequest = async function(requesterId) {
            try {
                const requesterDoc = await getDoc(doc(db, "users", requesterId));
                if (!requesterDoc.exists()) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                const requester = requesterDoc.data();
                const batch = writeBatch(db);

                // Remove from user's friend requests
                const updatedRequests = (userData.friendRequests || []).filter(id => id !== requesterId);
                batch.update(doc(db, "users", currentUser.uid), {
                    friendRequests: updatedRequests
                });

                // Remove from requester's pending requests
                const requesterPending = (requester.pendingRequests || []).filter(id => id !== currentUser.uid);
                batch.update(doc(db, "users", requesterId), {
                    pendingRequests: requesterPending
                });

                // Add to user's friends
                const userFriends = [...(userData.friends || []), requesterId];
                batch.update(doc(db, "users", currentUser.uid), {
                    friends: userFriends
                });

                // Add to requester's friends
                const requesterFriends = [...(requester.friends || []), currentUser.uid];
                batch.update(doc(db, "users", requesterId), {
                    friends: requesterFriends
                });

                await batch.commit();

                // Update local user data
                userData.friendRequests = updatedRequests;
                userData.friends = userFriends;

                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑŸÇÿ®ŸàŸÑ', `ÿ£ŸÜÿ™ Ÿà${requester.name} ÿµÿØŸäŸÇÿßŸÜ ÿßŸÑÿ¢ŸÜ`);
                loadFriendRequestsContent();
                loadFriendsContent();

            } catch (error) {
                console.error("Error accepting friend request:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ®ŸàŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©');
            }
        };

        window.rejectFriendRequest = async function(requesterId) {
            try {
                const batch = writeBatch(db);

                // Remove from user's friend requests
                const updatedRequests = (userData.friendRequests || []).filter(id => id !== requesterId);
                batch.update(doc(db, "users", currentUser.uid), {
                    friendRequests: updatedRequests
                });

                // Remove from requester's pending requests
                const requesterDoc = await getDoc(doc(db, "users", requesterId));
                if (requesterDoc.exists()) {
                    const requester = requesterDoc.data();
                    const requesterPending = (requester.pendingRequests || []).filter(id => id !== currentUser.uid);
                    batch.update(doc(db, "users", requesterId), {
                        pendingRequests: requesterPending
                    });
                }

                await batch.commit();

                // Update local user data
                userData.friendRequests = updatedRequests;

                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿ∂', 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©');
                loadFriendRequestsContent();

            } catch (error) {
                console.error("Error rejecting friend request:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ŸÅÿ∂ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©');
            }
        };

        window.cancelFriendRequest = async function(pendingId) {
            try {
                const batch = writeBatch(db);

                // Remove from user's pending requests
                const updatedPending = (userData.pendingRequests || []).filter(id => id !== pendingId);
                batch.update(doc(db, "users", currentUser.uid), {
                    pendingRequests: updatedPending
                });

                // Remove from pending user's friend requests
                const pendingDoc = await getDoc(doc(db, "users", pendingId));
                if (pendingDoc.exists()) {
                    const pendingUser = pendingDoc.data();
                    const pendingRequests = (pendingUser.friendRequests || []).filter(id => id !== currentUser.uid);
                    batch.update(doc(db, "users", pendingId), {
                        friendRequests: pendingRequests
                    });
                }

                await batch.commit();

                // Update local user data
                userData.pendingRequests = updatedPending;

                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°', 'ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©');
                loadPendingRequestsContent();

            } catch (error) {
                console.error("Error canceling friend request:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÑÿ∫ÿßÿ° ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©');
            }
        };

        window.removeFriend = async function(friendId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ≤ÿßŸÑÿ© Ÿáÿ∞ÿß ÿßŸÑÿµÿØŸäŸÇÿü')) {
                return;
            }

            try {
                const friendDoc = await getDoc(doc(db, "users", friendId));
                if (!friendDoc.exists()) {
                    showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿßŸÑÿµÿØŸäŸÇ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    return;
                }

                const friend = friendDoc.data();
                const batch = writeBatch(db);

                // Remove from user's friends
                const userFriends = (userData.friends || []).filter(id => id !== friendId);
                batch.update(doc(db, "users", currentUser.uid), {
                    friends: userFriends
                });

                // Remove from friend's friends
                const friendFriends = (friend.friends || []).filter(id => id !== currentUser.uid);
                batch.update(doc(db, "users", friendId), {
                    friends: friendFriends
                });

                await batch.commit();

                // Update local user data
                userData.friends = userFriends;

                showBeautifulAlert('success', 'ÿ™ŸÖ ÿßŸÑÿ•ÿ≤ÿßŸÑÿ©', 'ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿµÿØŸäŸÇ');
                loadFriendsContent();

            } catch (error) {
                console.error("Error removing friend:", error);
                showBeautifulAlert('error', 'ÿÆÿ∑ÿ£', 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿµÿØŸäŸÇ');
            }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => { 
                n.classList.remove('active'); 
                n.classList.remove('text-indigo-600'); 
                n.classList.add('text-gray-400'); 
            });
            
            const navs = document.querySelectorAll('.nav-item');
            if(tab==='challenges') navs[0].classList.add('active', 'text-indigo-600');
            if(tab==='leaderboard') { 
                navs[1].classList.add('active', 'text-indigo-600'); 
                loadLeaderboard(); 
            }
            if(tab==='schedule') { 
                navs[2].classList.add('active', 'text-indigo-600'); 
                initSchedule(); 
            }
            if(tab==='profile') navs[3].classList.add('active', 'text-indigo-600');
        };
    </script>
</body>
</html>
